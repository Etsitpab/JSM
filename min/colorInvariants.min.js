/**
 * This program is free software: you can redistribute it and/or modify    
 * it under the terms of the GNU General Public License as published by        
 * the Free Software Foundation, either version 3 of the License, or 
 * (at your option) any later version.
 * 
 * This program is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU General Public License for more details.
 * 
 * You should have received a copy of the GNU General Public License
 * along with this program.  If not, see <http://www.gnu.org/licenses/>.
 * 
 * @author Baptiste Mazin     <baptiste.mazin@telecom-paristech.fr> 
 * @author Guillaume Tartavel <guillaume.tartavel@telecom-paristech.fr> 
 */
Matrix.prototype.getColorInvariant=function(e,a){"use strict";if(this.getSize(2)<3){throw new Error("Matrix.getColorInvariant: Image must have at least 3 channels.")}a=a||2;var r=[[.3,.58,.11],[.25,.25,-.5],[.5,-.5,0]];r=[[.06,.63,.27],[.3,.04,-.35],[.34,-.6,.17]];r=[[.33,.34,.33],[.5,0,-.5],[.25,-.5,.25]];var t=Colorspaces.getConversionFunction(r);var l=this.applycform(t);var s=l.gaussianGradient(a);l=l.gaussian(a);var i=l.select([],[],[0]);var n=l.select([],[],[1]);var v=l.select([],[],[2]);var o=s.x.select([],[],[0]),c=s.y.select([],[],[0]);var f=s.x.select([],[],[1]),g=s.y.select([],[],[1]);var x=s.x.select([],[],[2]),h=s.y.select([],[],[2]);var p,u,C;var m;if(e==="H"){p=n["./"](v);var y=n[".^"](2)["+"](v[".^"](2));u=v[".*"](f)["-"](n[".*"](x))["./"](y);C=v[".*"](g)["-"](n[".*"](h))["./"](y)}else if(e==="Cl"){p=n["./"](i);m=i[".^"](2);u=f[".*"](i)["-"](n[".*"](o))["./"](m);C=g[".*"](i)["-"](n[".*"](c))["./"](m)}else if(e==="Cll"){p=v["./"](i);m=i[".^"](2);u=x[".*"](i)["-"](v[".*"](o))["./"](i[".^"](2));C=h[".*"](i)["-"](v[".*"](c))["./"](i[".^"](2))}else if(e==="W"){u=o["./"](i);C=c["./"](i)}else if(e==="Wl"){u=f["./"](i);C=g["./"](i)}else if(e==="Wll"){u=x["./"](i);C=h["./"](i)}else if(e==="Nl"){m=i[".^"](2);u=f[".*"](i)["-"](n[".*"](o))["./"](m);C=g[".*"](i)["-"](n[".*"](c))["./"](m)}else if(e==="Nll"){m=i[".^"](2);var I=n[".^"](2),w=i[".^"](3);u=x[".*"](m)["-"](v[".*"](o[".*"](i)))["-"](f[".*"](n)[".*"](i)[".*"](2))["+"](I[".*"](o)[".*"](2))["./"](w);C=h[".*"](m)["-"](v[".*"](c[".*"](i)))["-"](g[".*"](n)[".*"](i)[".*"](2))["+"](I[".*"](c)[".*"](2))["./"](w)}else{throw new Error("Matrix.getColorInvariant: Unknown Invariant "+e)}var M=Matrix.complex(u,C);var W=M.angle();W=W["./"](Math.PI);var E=W["<"](0);W=W.set(E,W.select(E)["+"](1));return{im:p,x:u,y:C,norm:M.abs(),phase:W}};