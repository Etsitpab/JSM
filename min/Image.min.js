/**
 * This program is free software: you can redistribute it and/or modify    
 * it under the terms of the GNU General Public License as published by        
 * the Free Software Foundation, either version 3 of the License, or 
 * (at your option) any later version.
 * 
 * This program is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU General Public License for more details.
 * 
 * You should have received a copy of the GNU General Public License
 * along with this program.  If not, see <http://www.gnu.org/licenses/>.
 * 
 * @author Baptiste Mazin     <baptiste.mazin@telecom-paristech.fr> 
 * @author Guillaume Tartavel <guillaume.tartavel@telecom-paristech.fr> 
 */
(function(r,t){"use strict";var e=typeof module!=="undefined"&&module.exports?true:false;var a,n,i;if(e){a=require("fs");n=require("canvas");i=n.Image}else{i=Image}var o=function(r,t){var a;if(e){a=new n}else{a=document.createElement("canvas")}a.width=r||0;a.height=t||0;return a};t.convertImage=function(t){var e=new r(this.getSize(),t);var a,n;if(this.isfloat()||this.islogical()){a=[0,1]}else if(this.isinteger()){a=[r.intmin(this.type()),r.intmax(this.type())]}var i=a[0],o=1/(a[1]-a[0]);if(e.isfloat()||this.islogical()){n=[0,1]}else if(e.isinteger()){n=[r.intmin(e.type()),r.intmax(e.type())]}var s=n[0],f=o*(n[1]-n[0]);var v=this.getData(),u=new e.getData;var l,h;for(l=0,h=v.length;l<h;l++){u[l]=(v[l]-i)*f-s}return new r(this.getSize(),u)};t.im2double=function(){return this.convertImage("double")};t.im2single=function(){return this.convertImage("single")};t.im2uint8=function(){return this.convertImage("uint8")};t.im2uint8c=function(){return this.convertImage("uint8c")};t.getImageData=function(){var t;if(this.isfloat()||this.islogical()){t=[0,1]}else if(this.isinteger()){t=[r.intmin(this.type()),r.intmax(this.type())]}var e=t[0],a=255/(t[1]-t[0]);var n=this.getSize(1),i=this.getSize(0);var s=o().getContext("2d").createImageData(n,i);var f=i*n,v;var u=this.getData(),l=s.data;var h,c,g,w,d,p,m;switch(this.getSize(2)){case 1:for(c=0,h=0;c<i;c++){for(g=c,v=c+f;g<v;g+=i){m=(u[g]-e)*a;l[h++]=m;l[h++]=m;l[h++]=m;l[h++]=255}}break;case 2:for(c=0,h=0;c<i;c++){for(g=c,w=c+f,v=c+f;g<v;g+=i,w+=i){m=(u[g]-e)*a;l[h++]=m;l[h++]=m;l[h++]=m;l[h++]=(u[w]-e)*a}}break;case 3:for(c=0,h=0;c<i;c++){for(g=c,w=c+f,d=c+2*f,v=w;g<v;g+=i,w+=i,d+=i){l[h++]=(u[g]-e)*a;l[h++]=(u[w]-e)*a;l[h++]=(u[d]-e)*a;l[h++]=255}}break;case 4:for(c=0,h=0;c<i;c++){for(g=c,w=g+f,d=w+f,p=d+f,v=w;g<v;g+=i,w+=i,d+=i,p+=i){l[h++]=(u[g]-e)*a;l[h++]=(u[w]-e)*a;l[h++]=(u[d]-e)*a;l[h++]=(u[p]-e)*a}}break}return s};t.toImage=function(r){if(e){throw new Error("Matrix.toImage: Canvas doesn't exist.")}var t=o(this.getSize(1),this.getSize(0));var a=this.getImageData();t.getContext("2d").putImageData(a,0,0);var n=new Image;n.src=t.toDataURL();n.onload=r;return n};if(e){r.prototype.imwrite=function(r,t){var e=o(this.getSize(1),this.getSize(0));e.getContext("2d").putImageData(this.getImageData(),0,0);var n=a.createWriteStream(r),i;if(/\.(png)$/i.test(r.toLowerCase())){i=e.pngStream()}else if(/\.(jpeg|jpg)$/i.test(r.toLowerCase())){i=e.jpegStream()}else{throw new Error("Matrix.imwrite: invalid file extension.")}i.on("data",function(r){n.write(r)});if(t){i.on("end",t.bind(this))}}}r.fspecial=function(t,e,a){var n,i,o,s;var f,v,u,l,h,c,g,w;var d,p,m;var y=function(r,t){return Math.exp(-(r*r+t*t)/(2*s*s))};switch(t.toLowerCase()){case"average":if(Tools.isArrayLike(e)){o=e[0];i=e[1]}else{o=e===undefined?3:e;i=o}return r.ones([o,i])["./"](o*i);case"disk":break;case"gaussian":if(Tools.isArrayLike(e)){o=e[0];i=e[1]}else{o=e===undefined?3:e;i=o}s=a===undefined?.5:a;f=[];w=0;for(l=0,v=-(i-1)/2,c=i*o;l<c;l+=o,v++){for(h=l,g=l+o,u=-(o-1)/2;h<g;h++,u++){d=y(v,u);f[h]=d;w+=d}}for(p=0,m=f.length;p<m;p++){f[p]/=w}return new r([o,i],f);case"laplacian":n=e===undefined?.2:e;return new r([3,3],[n/4,(1-n)/4,n/4,(1-n)/4,-1,(1-n)/4,n/4,(1-n)/4,n/4])[".*"](4/(n+1));case"log":if(Tools.isArrayLike(e)){o=e[0];i=e[1]}else{o=e===undefined?3:e;i=o}s=a===undefined?.5:a;f=[];w=0;for(l=0,v=-(i-1)/2,c=i*o;l<c;l+=o,v++){for(h=l,g=l+o,u=-(o-1)/2;h<g;h++,u++){d=y(v,u);f[h]=(v*v+u*u-2*s*s)*d/Math.pow(s,4);w+=d}}for(p=0,m=f.length;p<m;p++){f[p]/=w}w=0;for(p=0,m=f.length;p<m;p++){w+=f[p]}w/=i*o;for(p=0,m=f.length;p<m;p++){f[p]-=w}return new r([o,i],f);case"unsharp":n=e===undefined?.2:e;return new r([3,3],[-n,n-1,-n,n-1,n+5,n-1,-n,n-1,-n])[".*"](1/(n+1));case"prewitt":return new r([3,3],[1,0,-1,1,0,-1,1,0,-1]);case"sobel":return new r([3,3],[1,0,-1,2,0,-2,1,0,-1]);default:return}};t.filter1d=function(t,e){var a=this.constructor.name+".filter1d: ";if(e===undefined){e="C"}if(!t.isvector()){throw new Error("Matrix.filter1d: Kernel must be a vector")}var n=t.getLength(),i=t.getData();if(typeof e==="string"){switch(e.toUpperCase()){case"C":case"CL":e=Math.floor((n-1)/2);break;case"CR":e=Math.ceil((n-1)/2);break;case"L":e=0;break;case"R":e=n-1;break;default:throw new Error(a+"unknown origin position '"+e+"'")}}else if(typeof e==="number"){if(e<0){e+=n}if(e<0||e>=n){throw new Error(a+"origin value must satisfy : |origin| < kernel.length")}}var o=new r(this.getSize(),this.getDataType());var s=this.getData(),f=o.getData();var v=o.getView();var u=v.getStep(2),l=v.getEnd(2);var h=v.getStep(1),c=v.getEnd(1);var g=v.getEnd(0);if(e>=g/2){throw new Error("Matrix.filter1d: Kernel is too large.")}var w,d=g-e;var p,m,y,M,b,x,B;for(p=0;p!==l;p+=u){for(m=p,y=p+c;m!==y;m+=h){for(M=m,b=m+e;M<b;M++){for(w=0,B=0,x=2*m+e-M;x>m;B++,x--){w+=i[B]*s[x]}for(x=m;B<n;B++,x++){w+=i[B]*s[x]}f[M]=w}for(M=m+e,b=m+d;M<b;M++){for(w=0,B=0,x=M-e;B<n;B++,x++){w+=i[B]*s[x]}f[M]=w}for(M=m+d,b=m+g;M<b;M++){for(w=0,B=0,x=M-e;x<b;B++,x++){w+=i[B]*s[x]}for(x=b-2;B<n;B++,x--){w+=i[B]*s[x]}f[M]=w}}}return o};t.separableFilter=function(r,t){if(t===undefined){t=r}return this.filter1d(r).permute([1,0,2]).filter1d(t).permute([1,0,2])};t.gaussian=function(r,t,e){e=e||3;var a=f.gaussian(r,0,e);var n;if(typeof t==="number"){n=f.gaussian(t,0,e)}else{n=a}return this.separableFilter(a,n)};t.gaussianGradient=function(t){if(!t){t=2}var e=f.gaussian(t,1,3);var a=f.gaussian(t,0,3);var n=this.separableFilter(a,e);var i=this.separableFilter(e,a);var o=.5/Math.PI;var s=r.zeros(this.getSize()),v=r.zeros(this.getSize());var u=n.getData(),l=i.getData();var h=s.getData(),c=v.getData();var g,w;for(g=0,w=u.length;g<w;g++){var d=u[g],p=l[g];h[g]=Math.sqrt(d*d+p*p);var m=Math.atan2(p,d)*o;c[g]=m<0?m+1:m}return{x:n,y:i,norm:s,phase:v}};t.gradient=function(t,e,a,n,i){var o=.70710678,s=6.8284271,f=.35355339;var v=.29289322,u=1/s,l=.5/Math.PI;var h={},c,g,w,d,p;var m=this.getSize();var y=this.getDataType();if(t){h.x=new r(m,y);c=h.x.getData()}if(e){h.y=new r(m,y);g=h.y.getData()}if(a){h.norm=new r(m,y);w=h.norm.getData()}if(n){h.phase=new r(m,y);d=h.phase.getData()}if(i){h.laplacian=new r(m,y);p=h.laplacian.getData()}var M=this.getData();var b=this.getView();var x=b.getStep(2),B=b.getEnd(2);var D=b.getStep(1),A=b.getEnd(1);var L=b.getEnd(0);var S,z,R,C,G,E,Y;for(S=0;S!==B;S+=x){for(z=S+D,R=S+A-D;z!==R;z+=D){for(E=z-D,C=z,Y=z+D,G=z+L-2;C<G;C){var I=M[E],F=M[++E],k=M[E+1];var Q=M[C],Z=M[++C],X=M[C+1];var H=M[Y],V=M[++Y],q=M[Y+1];var T=q-I,U=k-H;var J=v*(V-F+f*(T-U));var K=v*(Q-X-f*(T+U));if(t){c[C]=J}if(e){g[C]=K}if(a){w[C]=Math.sqrt(J*J+K*K)}if(n){var j=Math.atan2(-K,J)*l;d[C]=j<0?j+1:j}if(i){p[C]=(o*(I+k+H+q)+(Q+F+V+X))*u-Z}}}}return h};t.conv=function(t,e){if(!this.isvector()||!t.isvector()){throw new Error("Matrix.conv: Input must be vector.")}var a=this.getData(),n=a.length;var i=t.getData(),o=i.length;if(n<o){return t.conv(this,e)}var s=Tools.checkType(this.getDataType());var f=new s(n+o-1),v=f.length;var u,l,h,c,g,w,d;for(g=0,w=o-1;g<w;g++){for(d=0,l=0,h=g+1,c=g;l<h;l++,c--){d+=a[l]*i[c]}f[g]=d}for(g=o-1,u=0,w=n;g<w;g++,u++){for(d=0,l=u,h=g+1,c=o-1;l<h;l++,c--){d+=a[l]*i[c]}f[g]=d}for(g=n,u=n-o+1;g<v;g++,u++){for(d=0,l=u,c=o-1;l<n;l++,c--){d+=a[l]*i[c]}f[g]=d}switch(e){case undefined:case"full":return new r(v,f);case"same":var p=Math.ceil(o/2);return new r(n,f.subarray(p,p+n));case"valid":return new r(n-o+1,f.subarray(o-1,n));default:throw new Error("Matrix.conv: Invalid shape parameter.")}};var s=function(r){var t=r.getView(),e=r.getData();var a=t.getStep(2),n=t.getEnd(2);var i=t.getStep(1),o=t.getEnd(1),s;var f=t.getEnd(0),v;var u,l,h;for(u=0;u<n;u+=a){for(l=u+1,v=u+f;l<v;l++){e[l]+=e[l-1]}for(h=u+i,s=u+o;h<s;h+=i){var c=e[h];e[h]+=e[h-i];for(l=h+1,v=h+f;l<v;l++){c+=e[l];e[l]=e[l-i]+c}}}};t.fastBlur=function(t,e,a){a=a||3;e=e||t;var n=Math.round(Math.sqrt(12/a*t*t+1)/2)*2+1;var i=Math.round(Math.sqrt(12/a*e*e+1)/2)*2+1;var o=r.zeros(this.getSize());var f=this.getView();var v=f.getStep(2),u=f.getEnd(2);var l=f.getStep(1),h=f.getEnd(1);var c=f.getEnd(0);e=i/2|0;t=(n/2|0)*l;var g=n/2|0;var w,d,p,m,y,M,b;var x,B,D;var A=this.im2double();for(var L=0;L<a;L++){s(A);var S=A.getData(),z=o.getData();var R=t+e+l+1,C=t+e,G=-(t+l)+e,E=t-e-1;var Y=S.subarray(C),I=S.subarray(E);for(p=0;p<u;p+=v){for(M=p,y=0,d=p+e+1;M<d;M++,y++){B=y+e+1;for(b=M,m=0,w=M+t+l;b<w;b+=l,m++){z[b]=Y[b]/((m+g+1)*B)}x=1/(n*B);for(b=M+t+l,w=M+h-t;b<w;b+=l){z[b]=(Y[b]-S[b+G])*x}D=S[M+h-l+e];for(b=M+h-t,w=M+h;b<w;b+=l){z[b]=D-S[b+G];z[b]/=(t+w-b)/l*B}}for(m=p,w=p+t+l;m<w;m+=l){x=1/(((m-p+t)/l+1)*i);for(y=m+e+1,d=m+c-e;y<d;y++){z[y]=Y[y]-I[y];z[y]*=x}}x=1/(n*i);for(m=p+t+l,w=p+h-t;m<w;m+=l){for(y=m+e+1,d=m+c-e;y<d;y++){z[y]=(S[y-R]+Y[y]-S[y+G]-I[y])*x}}for(m=p+h-t,w=p+h;m<w;m+=l){x=1/((p+h-m+t)/l*i);for(y=m+e+1,d=m+c-e;y<d;y++){z[y]=S[y-R]+S[p+h-l+y-m+e]-S[p+h-l+y-m-e-1]-S[y+G];z[y]*=x}}for(y=p+c-e,d=p+c;y<d;y++){for(m=y,w=y+t+l;m<w;m+=l){z[m]=S[m-y+p+c-1+t]-I[m];z[m]/=((m-y+t)/l+1)*(e+(c-(y-p)))}x=1/(n*(e+(c-(y-p))));for(m=y+t+l,w=y+h-t;m<w;m+=l){z[m]=S[m-y+p+c-1+t]-S[m-y+p+c-1-t-l]+S[m-R]-I[m];z[m]*=x}for(m=y+h-t,w=y+h;m<w;m+=l){z[m]=S[p+h-l+c-1]+S[m-R]-S[p+m-y+c-1-t-l]-S[p+h-l+y-p-e-1];z[m]/=(h-(m-y)+t)/l*(e+(c-(y-p)))}}}var F=o;o=A;A=F}return F};var f={};f.normalize=function(r){var t;var e=r.length;var a=0;for(t=0;t<e;t++){a+=Math.abs(r[t])}if(a!==0){for(t=0;t<e;t++){r[t]/=a}}return r};f.gaussian=function(t,e,a){var n,i;if(a===undefined){a=3}if(e===undefined){e=0}var o=1+2*Math.ceil(t*Math.sqrt(a*2*Math.log(10)));var s=new r.dataType(o);var f=(o-1)/2;var v=0,u=Math.abs;for(n=0;n<(o+1)/2;n++){i=n-f;var l=1/(Math.sqrt(2*Math.PI)*t);l*=Math.exp(-(i*i)/(2*t*t));s[n]=s[o-1-n]=l}switch(e){case 0:for(n=0,v=0;n<s.length;n++){v+=u(s[n])}break;case 1:for(n=0,v=0;n<s.length;n++){i=n-f;s[n]*=-i/Math.pow(t,2);v+=u(i*s[n])}break;case 2:for(n=0,v=0;n<s.length;n++){i=n-f;s[n]*=i*i/Math.pow(t,4)-1/Math.pow(t,2);v+=u(s[n])}v/=s.length;for(n=0;n<s.length;n++){s[n]-=u(v)}for(n=0,v=0;n<s.length;n++){i=n-f;v+=u(.5*i*i*s[n])}break;default:throw new Error("Kernel.gaussian: Derive order can be 0,1 or 2 but not "+e)}if(v!==0){for(n=0;n<s.length;n++){s[n]/=v}}return new r(s.length,s)};t.imshow=function(r,t){if(e){console.warn("Matrix.imshow: function not available in nodejs.");return}var a=this.constructor.name+".imshow: ";var n=this.getSize(1);var i=this.getSize(0);if(typeof r==="string"&&document.getElementById(r)){r=document.getElementById(r)}var o;if(r===undefined||r===null){r=document.createElement("canvas");o=window.open("","","width="+n,"height="+i);o.document.body.appendChild(r)}if(!(r instanceof HTMLCanvasElement)){throw new Error(a+"Invalid canvas.")}var s=this.getImageData();if(t===undefined||t===1){r.width=n;r.height=i;r.getContext("2d").putImageData(s,0,0)}else{if(t==="fit"){var f=r.width/n;var v=r.height/i;t=Math.min(f,v);t=t>1?1:t}else if(typeof t!=="number"){throw new Error(a+"scale must be a number or 'fit'")}r.width=Math.round(n*t);r.height=Math.round(i*t);var u=document.createElement("canvas");u.width=n;u.height=i;var l=u.getContext("2d");l.putImageData(s,0,0);r.getContext("2d").drawImage(u,0,0,n,i,0,0,r.width,r.height)}return o||this};t.print=function(){var r=this.imshow();r.print();r.close();return this};t.imagesc=function(r,t){var e=this.min().getDataScalar(),a=this.max().getDataScalar();if(e-a===0){return this["-"](e).imshow(r,t)}return this["-"](e)["./"](a-e).imshow(r,t)};t.imtransform=function(t){t=r.toMatrix(t);var e=this.getSize(0),a=this.getSize(1);var n=o(a,e),i=n.getContext("2d");var s=o(),f=s.getContext("2d");var v=r.toMatrix([0,0,1,a,0,1,a,e,1,0,e,1]).reshape([3,4]);var u=t.mtimes(v).transpose();var l=u.max(0).getData(),h=u.min(0).getData();var c=this.getImageData();i.putImageData(c,0,0);var g=t.getData();s.width=l[0]-h[0];s.height=l[1]-h[1];f.translate(-h[0],-h[1]);f.transform(g[0],g[1],g[3],g[4],g[6],g[7]);f.drawImage(n,0,0);return r.imread(s).convertImage(this.type())};t.imhist=function(t){if(!this.ismatrix()){throw new Error("Matrix.imhist: This function only works on grey-level images.")}t=t||256;var e=this.getData();var a=r.zeros(t,1),n=a.getData();var i;if(this.isinteger()){i=r.intmax(this.type())}else if(this.islogical()){i=1;t=2}else if(this.isfloat()){i=1}else{throw new Error("Matrix.imhist: unknow data type.")}var o,s,f=1/i*t;for(o=0,s=e.length;o<s;o++){n[e[o]*f|0]++}return a};(function(){var e=function(r,t){var e=r.length;var a=new Float32Array(t);var n,i=Math.floor;for(n=0;n<e;++n){var o=i(r[n]*t);o=o>=t?t-1:o;++a[o]}var s=1/e;for(n=1;n<t;++n){a[n]+=a[n-1];a[n-1]*=s}a[n-1]*=s;return a};t.histeq=function(t){var a=this.im2double();var n=a;if(this.getSize(2)>1){n=a.applycform("RGB to HSL").get([],[],2)}n=n.getData();var i=e(n,t);var o=Math.floor;for(var s=0;s<n.length;++s){n[s]=i[o(n[s]*(t-1))]}var f=new r([a.size(0),a.size(1)],n);a.set([],[],2,f);if(this.getSize(2)>1){a.applycform("HSL to RGB")}return a}})();t.rgb2gray=function(){if(this.ndims()!==3||this.getSize(2)<3){throw new Error("Matrix.rgb2gray: Matrix must be an "+"image with RGB components.")}var t=this.getSize();t[2]-=2;var e=new r(t,this.getDataType());var a=this.getData(),n=e.getData();var i=this.getView();var o=i.getEnd(0),s;var f=i.getStep(1),v=i.getEnd(1),u;var l=i.getStep(2);var h,c,g,w;for(h=0,u=v;h!==u;h+=f){c=h;g=h+l;w=h+2*l;for(s=h+o;c<s;c++,g++,w++){n[c]=.3*a[c]+.59*a[g]+.11*a[w]}}if(this.getSize(2)===4){var d=n.subarray(l);var p=a.subarray(3*l);d.set(p)}return e}})(Matrix,Matrix.prototype);(function(){var r=function(r,t,e){this.x=r;this.y=t;this.parent=e};r.prototype.initChildren=function(t,e){var a=this.x,n=this.y;if(n+1<e){this.top=new r(a,n+1,this)}if(n-1>=0){this.bottom=new r(a,n-1,this)}if(a+1<t){this.left=new r(a+1,n,this)}if(a-1>=0){this.right=new r(a-1,n,this)}};r.prototype.remove=function(r){if(this.bottom===r){this.bottom=undefined}else if(this.top===r){this.top=undefined}else if(this.right===r){this.right=undefined}else if(this.left===r){this.left=undefined}return this};r.prototype.getNext=function(){if(this.top){return this.top}if(this.bottom){return this.bottom}if(this.left){return this.left}if(this.right){return this.right}if(this.parent){return this.parent.remove(this).getNext()}return undefined};Matrix.prototype.getConnectedComponent=function(t,e,a){var n=this.getSize(0),i=this.getSize(1),o=this.getSize(2);var s=a*a;var f=new Matrix([n,i],"logical"),v=new Matrix([n,i],"logical");var u=f.getData(),l=this.getData(),h=v.getData();window.CC=f;window.IV=v;var c=e+n*t;var g;if(o===1){if(this.type()==="logical"){}else{var w=l[c];g=function(r){var t=l[r]-w;return t*t<s}}}else if(o===3){var d=l[c],p=l[c+n*i],m=l[c+n*i*2];var y=l,M=l.subarray(n*i),b=l.subarray(n*i*2);g=function(r){var t=y[r]-d,e=M[r]-p,a=b[r]-m;return t*t+e*e+a*a<s}}else{throw new Error("Matrix.getConnectedComponent: This function only support "+"images with depth 1 or 3.")}var x=new r(t,e),B=x;while(B!==undefined){var D=B.x,A=B.y,L=A+n*D;if(h[L]===1){B=B.parent.remove(B).getNext();continue}h[L]=1;if(g(L)){u[L]=1;B.initChildren(i,n)}B=B.getNext()}return f};Matrix.prototype.bwconncomp=function(){}})();(function(r,t){"use strict";var e=function(r,t,e,a){var n=t>>1,i=r>>1;return{xS:new Int32Array([0,0,0,i,i,i,e-i,e-i,e-i]),xE:new Int32Array([i,i,i,e-i,e-i,e-i,e,e,e]),yS:new Int32Array([0,n,a-n,0,n,a-n,0,n,a-n]),yE:new Int32Array([n,a-n,a,n,a-n,a,n,a-n,a]),jS:new Int32Array([0,0,0,-i,-i,-i,-i,-i,-i]),jE:new Int32Array([i+1,i+1,i+1,i+1,i+1,i+1,e,e,e]),iS:new Int32Array([0,-n,-n,0,-n,-n,0,-n,-n]),iE:new Int32Array([n+1,n+1,a,n+1,n+1,a,n+1,n+1,a]),lS:new Int32Array([i,i,i,0,0,0,0,0,0]),lE:new Int32Array([r,r,r,r,r,r,i+e,i+e,i+e]),kS:new Int32Array([n,0,0,n,0,0,n,0,0]),kE:new Int32Array([t,t,n+a,t,t,n+a,t,t,n+a]),jxS:new Int32Array([0,0,0,1,1,1,1,1,1]),jxE:new Int32Array([1,1,1,1,1,1,0,0,0]),iyS:new Int32Array([0,1,1,0,1,1,0,1,1]),iyE:new Int32Array([1,1,0,1,1,0,1,1,0])}};var a=function(r,t,e,a,n,i,o,s,f,v,u){var l=-Infinity;for(var h=o,c=v;h<u;h+=e,c+=a){for(var g=i+h,w=s+c,d=f+h;g<d;g++,w++){if(r[g]>l&&t[w]){l=r[g]}}}return l};var n=function(r,t,e,a,n,i,o,s,f,v,u){var l=Infinity;for(var h=o,c=v;h<u;h+=e,c+=a){for(var g=i+h,w=s+c,d=f+h;g<d;g++,w++){if(r[g]<l&&t[w]){l=r[g]}}}return l};var i=function(r,t,e,a,n,i,o,s,f,v,u){var l=0;for(var h=o,c=v;h<u;h+=e,c+=a){for(var g=i+h,w=s+c,d=f+h;g<d;g++,w++){l+=r[g]*t[w]}}return l};var o=function(t,a,n){a=r.toMatrix(a);var i=t.getSize(0),o=t.getSize(1),s=t.getSize(2),f=t.getData();var v=new r(t.getSize(),t.type()),u=v.getData();var l=a.getSize(0),h=a.getSize(1),c=a.getData();var g=e(h,l,o,i);var w=g.xS,d=g.xE,p=g.yS,m=g.yE,y=g.jS,M=g.jE,b=g.iS,x=g.iE,B=g.lS,D=g.kS,A=g.jxS,L=g.jxE,S=g.iyS,z=g.iyE;var R,C,G,E,Y,I,F,k,Q,Z;var X,H,V,q;for(C=0,X=f.length;C<X;C+=o*i){var T=f.subarray(C,C+o*i),U=u.subarray(C,C+o*i);for(R=0;R<9;R++){for(G=w[R],H=d[R],Y=G*i;G<H;G++,Y+=i){var J=(y[R]+(A[R]?G:0))*i,K=(M[R]+(L[R]?G:0))*i;var j=(B[R]-(A[R]?0:G))*l;for(E=p[R],V=m[R],I=E+Y;E<V;E++,I++){var P=b[R]+(S[R]?E:0),N=x[R]+(z[R]?E:0);var O=D[R]-(S[R]?0:E);U[I]=n(T,c,i,l,I,P,J,O,N,j,K)}}}}return v};t.imdilate=function(r){return o(this,r,a)};t.imerode=function(r){return o(this,r,n)};t.imopen=function(r){return o(o(this,r,n),r,a)};t.imclose=function(r){return o(o(this,r,a),r,n)};t.imfilter=function(r){return o(this,r,i)};t.median=function(r){var t=r.length*.5|0;var e=function(r,e,a,n,i,o,s,f,v,u,l){var h=[];for(var c=s,g=u;c<l;c+=a,g+=n){for(var w=o+c,d=f+g,p=v+c;w<p;w++,d++){if(e[d]){h.push(r[w])}}}return h.sort()[t]};return o(this,r,e)};t.imbilateral=function(t,e,a){a=a||3;var n=r.fspecial("gaussian",Math.round(a*t/2)*2+1,t);var i=-1/(2*e);var s=function(r,t,e,a,n,o,s,f,v,u,l){var h=0,c=0,g=r[n];for(var w=s,d=u;w<l;w+=e,d+=a){for(var p=o+w,m=f+d,y=v+w;p<y;p++,m++){var M=g-r[p];var b=t[m]*Math.exp(i*M*M);h+=b;c+=r[p]*b}}return c/h};return o(this,n,s)};r.psnr=function(t,e,a){t=r.toMatrix(t);e=r.toMatrix(e);Tools.checkSizeEquals(t.size(),e.size());if(!Tools.isSet(a)){var n=t.type(),i=e.type();var o=t.isfloat()?1:r.intmax(n)-r.intmin(i);var s=e.isfloat()?1:r.intmax(i)-r.intmin(i);a=Math.max(o,s)}else{a=1}var f=e.getData(),v=t.getData();var u,l,h=0;for(u=0,l=v.length;u<l;u++){var c=f[u]-v[u];h+=c*c}return r.toMatrix(10*Math.log10(a*a*l/h))}})(Matrix,Matrix.prototype);(function(r,t){"use strict";var e=function(r,t,e,a,n,i,o,s,f,v,u,l,h,c,g,w,d){var p,m,y,M,b,x;r+=(s-1)*f-o;a-=o;for(p=r,m=t+e;p<a;p+=n,m+=i){for(y=0,M=p+o,b=0,x=0;y<s;y++,M-=f){b+=l[y]*c[M];x+=h[y]*g[M]}w[m]+=b;d[m]+=x}};var a=function(r,t,e,a,n,i,o,s,f,v,u,l,h,c){var g,w,d,p,m;r+=(s-1)*f-o;a-=o;for(g=r,w=t+e;g<a;g+=n,w+=i){for(d=0,p=g+o,m=0;d<s;d++,p-=f){m+=l[d]*h[p]}c[w]+=m}};var n=function(r,t,e,a,n,i,o,s,f,v,u,l,h,c,g,w,d){var p,m,y,M,b,x;console.log("y0",r,"ny",a,"dy",n,"oys",e,"ody",i);console.log("orig",o,"K",s,"Kdy",f);r+=(s-1)*f-o;a-=o;console.log("y0",r,"ny",a,o);for(p=r,m=t+e;p<a;p+=n,m+=i){var B=[],D=[],A=[],L=[];for(y=0,M=p+o,b=0,x=0;y<s;y++,M-=f){B.push(M);D.push(y);A.push(c[M]);L.push(l[y]);b+=l[y]*c[M];x+=h[y]*g[M]}console.log("y =",p,"oy =",m,B);w[m]+=b;d[m]+=x}console.log("")};var i=function(r,t,e,a,n,i,o,s,f,v,u,l,h,c,g,w,d){var p,m,y,M,b,x;r+=(s-1)*f-o;a-=o;if(w.length!==d.length){throw new Error("Output length error")}if(c.length!==g.length){throw new Error("input length error")}for(p=r,m=t+e;p<a;p+=n,m+=i){for(y=0,M=p+o,b=0,x=0;y<s;y++,M-=f){if(y<0||y>=l.length){throw new Error("Kernel error")}if(M<0||M>=c.length){throw new Error("Input error")}b+=l[y]*c[M];x+=h[y]*g[M]}if(m<0||m>=w.length){throw new Error("Output error")}w[m]+=b;d[m]+=x}};var o=function(r,t,e,a,n,i,o,s,f,v,u,l,h,c){var g,w,d,p,m;r+=(s-1)*f-o;a-=o;for(g=r,w=t+e;g<a;g+=n,w+=i){for(d=0,p=g+o,m=0;d<s;d++,p-=f){if(d<0||d>=l.length){throw new Error("Kernel error")}if(p<0||p>=h.length){throw new Error("Input error")}m+=l[d]*h[p]}if(w<0||w>=c.length){throw new Error("Output error")}c[w]+=m}};var s,f,v;r.dwtmode=function(r){if(r===undefined){return v}r=r.toLowerCase();switch(r){case"per":case"sym":case"symw":case"zpd":case"nn":s=e;f=a;break;case"debug_sym":case"debug_symw":case"debug_zpd":case"debug_nn":r=r.substr(6);s=n;break;case"check_sym":case"check_symw":case"check_zpd":case"check_nn":case"check_per":r=r.substr(6);s=i;f=o;break;default:throw new Error("Matrix.dwtmode: invalid mode "+r+".")}v=r;return v};r.dwtmode("sym");var u=function(t,e,a,n,i,o,v,u,l,h){var c=r.wfilters(n,i?"d":"r");var g=c[0].getData(),w=c[1].getData(),d=g.length;o=(o==="cl"?Math.floor:Math.ceil)((d-1)/2);var p=a.getSize(0)%2?true:false;var m=a.getFirst(0),y=a.getStep(0);var M=a.getEnd(0);var b=h.getFirst(0),x=h.getStep(0);var B=o*y;var D=y;y*=v;var A=a.getIterator(1),L=h.getIterator(1);var S,z,R=A.iterator,C=A.begin,G=A.end();var E,Y,I=L.iterator,F=L.begin;var k,Q,Z,X;var H,V;if(!t||!e){var q=(t||e).getData(),T=(t?u:l).getData(),U=t?g:w;for(z=C(),Y=F();z!==G;z=R(),Y=I()){H=m+z;V=M+z;f(H,Y,b,V,y,x,B,d,D,M,p,U,q,T)}}else{var J=t.getData(),K=e.getData(),j=u.getData(),P=l.getData();for(z=C(),Y=F();z!==G;z=R(),Y=I()){H=m+z;V=M+z;s(H,Y,b,V,y,x,B,d,D,M,p,g,w,J,K,j,P)}}};var l=r.zeros;var h=function(t,e){var a=r.wfilters(t,"d");var n=a[0].getData().length;var i=e%2?true:false;var o=Math.floor,s=Math.ceil;var f=o((n-1)/2),u=s((n-1)/2);var l=n-2,h=n-2+(i?1:0);var c=o(l/4),g=s(h/4);if(i&&n%4!==0){g--}if(v==="per"){}return{lk:f,rk:u,li:l,lo:c,ri:h,ro:g}};var c=function(r){console.log("For "+(r?"odd":"even")+" signal");var t={},e=Math.floor,a=Math.ceil;for(var n=2;n<16;n+=2){t[n]=h(n,r?1:2)}console.table(t,["lk","rk","li","ri","lo","ro"])};var g=function(t,e,a){a=a||0;var n=t.getSize();var i=h(e,n[a]);n[a]=Math.ceil(n[a]/2)+i.ro+i.lo;if(i.li!==0||i.ri!==0){t=t.paddim(v==="per"?"per2":v,a,[i.li,i.ri])}var o=l(n),s=l(n);var f=o.getView().swapDimensions(0,a);var c=t.getView().swapDimensions(0,a);u(t,t,c,e,true,"cr",2,o,s,f);if(v==="per"){var g=r.wfilters(e)[0].numel();var w=Math.ceil((g-2)/4),d=Math.floor((g-2)/4);f=f.restore().selectDimension(a,[w,-d-1]);o=o.extractViewFrom(f);s=s.extractViewFrom(f)}return[o,s]};var w=function(t,e,a,n){a=a||0;var i=t[0]?0:1;var o=t[0],s=t[1];if(v==="per"){var f=r.wfilters(e)[0].numel();var c=Math.ceil((f-2)/4),g=Math.floor((f-2)/4);o=o?o.paddim(v,a,[c,g]):undefined;s=s?s.paddim(v,a,[c,g]):undefined}var w=h(e,(o||s).getSize(a));var d=w.lk+w.rk;var p=(o||s).getSize();p[a]=2*p[a]+1;var m=o?l(p):undefined,y=s?l(p):undefined,M=new MatrixView(p).selectDimension(a,[1,2,-1]);if(m){o.extractViewTo(M,m)}if(y){s.extractViewTo(M,y)}M.restore().swapDimensions(0,a);p[a]-=d;if(n!==undefined&&!Tools.checkSizeEquals(n.getSize(),p)){throw new Error("idwt: Wrong output size.")}n=n||l(p);var b=n.getView().swapDimensions(0,a);u(m,y,M,e,false,"cl",1,n,n,b);return n};var d=function(t,e){var a=t.getSize(0),n=t.getSize(1),i=t.getSize(2);var o=h(e,a);var s=Math.ceil(a/2)+o.ro+o.lo;if(o.li!==0||o.ri!==0){t=t.paddim(v==="per"?"per2":v,0,[o.li,o.ri])}var f=l(s,n,i),c=l(s,n,i);var g=f.getView();var w=t.getView();u(t,t,w,e,true,"cr",2,f,c,g);var d=h(e,n);var p=Math.ceil(n/2)+d.ro+d.lo;if(d.li!==0||d.ri!==0){c=c.paddim(v,1,[d.li,d.ri]);f=f.paddim(v,1,[d.li,d.ri]);g=f.getView()}var m=l(s,p,i),y=l(s,p,i),M=l(s,p,i),b=l(s,p,i);var x=m.getView().swapDimensions(0,1);g.swapDimensions(0,1);u(f,f,g,e,true,"cr",2,m,M,x);u(c,c,g,e,true,"cr",2,y,b,x);if(v==="per"){var B=r.wfilters(e)[0].numel();var D=Math.ceil((B-2)/4),A=Math.floor((B-2)/4);m=m.get([D,-A-1],[D,-A-1]);M=M.get([D,-A-1],[D,-A-1]);y=y.get([D,-A-1],[D,-A-1]);b=b.get([D,-A-1],[D,-A-1])}return[m,M,y,b]};var p=function(t,e){t=t.slice();if(v==="per"){var a=r.wfilters(e)[0].numel();var n=Math.ceil((a-2)/4),i=Math.floor((a-2)/4);for(var o=0;o<4;o++){t[o]=t[o]?t[o].padarray(v==="per"?"per":v,[n,i],[n,i]):undefined}}var s=(t[0]||t[1]||t[2]||t[3]).getSize();var f=h(e,s[0]),c=h(e,s[1]);var g=f.rk+f.lk;var w=c.rk+c.lk;s[0]=2*s[0]+1;var d=t[0]||t[1]?l(s):undefined,p=t[2]||t[3]?l(s):undefined,m=new MatrixView(s);s[0]-=g;s[1]=2*s[1]+1;var y=t[0]||t[2]?l(s):undefined,M=t[1]||t[3]?l(s):undefined,b=new MatrixView(s).select([],[1,2,-1]);if(y){if(d){d.set([1,2,-1],t[0])}if(p){p.set([1,2,-1],t[2])}u(d,p,m,e,false,"cl",1,y,y,b)}if(M){if(d){d.set([1,2,-1],t[1])}if(p){p.set([1,2,-1],t[3])}u(d,p,m,e,false,"cl",1,M,M,b)}s[1]-=w;var x=l(s),B=new MatrixView(s).swapDimensions(0,1);b.restore().swapDimensions(0,1);u(y,M,b,e,false,"cl",1,x,x,B);return x};r.dwtmaxlev=function(t,e){t=r.toMatrix(t).min().getDataScalar();var a=r.wfilters(e);var n=a[0].numel(),i=a[1].numel(),o=a[2].numel(),s=a[3].numel();var f=Math.max(n,i,o,s);var v=Math.floor(Math.log(t/(f-1))/Math.log(2));return v<0?0:v};var m=function(t,e,a,n){var i=new Uint16Array(e+2);i[e+1]=t.getSize(n);var o=r.wfilters(a)[0].numel();var s=Math.ceil((o-2)/4),f=Math.floor((o-2)/4);for(var u=e;u>=1;u--){var l=h(a,i[u+1]);i[u]=Math.ceil(i[u+1]/2)+l.ro+l.lo-(v==="per"?s+f:0)}i[0]=i[1];return r.toMatrix(i)};var y=function(r,t){var e=r.get([],0).getData();var a=e[0];var n=[0,a],i=[];var o,s=e.length-2;for(o=1;o<s+1;o++){i.push(e[o]);a+=e[o];n.push(a)}return{bands:n,outSize:a,subSizes:i,sizes:e,J:s}};var M=function(r,t,e,a){if(r.getSize(a)!==t.sizes[e+1]){var n=r.getView().selectDimension(a,[0,t.sizes[e+1]-1]);r=r.extractViewFrom(n)}return r};r.dwt=g;r.idwt=w;r.wavedec=function(r,t,e,a){a=a||0;var n=m(r,t,e,a);var i=y(n,a);var o=r.getSize();o[a]=i.outSize;var s=l(o),f=s.getView();var v=r,u,h,c;for(var w=t;w>=1;w--){c=g(v,e,a);f.selectDimension(a,[i.bands[w],i.bands[w+1]-1]);c[1].extractViewTo(f,s);f.restore();v=c[0]}f.selectDimension(a,[i.bands[0],i.bands[1]-1]);c[0].extractViewTo(f,s);return[s,n]};r.waverec=function(r,t,e){e=e||0;var a=y(r[1],e);var n=r[0],i=n.getView();var o=i.selectDimension(e,[a.bands[0],a.bands[1]-1]);var s=n.extractViewFrom(o);for(var f=1;f<a.bands.length-1;f++){var v=i.restore().selectDimension(e,[a.bands[f],a.bands[f+1]-1]);var u=n.extractViewFrom(v);s=w([s,u],t,e);s=M(s,a,f,e)}return s};r.upwlev=function(t,e,a){if(t[1].getSize(0)===2){return[new r,new r]}a=a||0;var n=y(t[1],a);var i=t[0],o=i.getView();var s=o.selectDimension(a,[n.bands[0],n.bands[1]-1]);var f=i.extractViewFrom(s);var v=o.restore().selectDimension(a,[n.bands[1],n.bands[2]-1]);var u=i.extractViewFrom(v);var l=w([f,u],e,a);l=M(l,n,1,a);var h=l.getSize(a);var c=o.restore().selectDimension(a,[n.bands[2]-h,-1]);var g=i.extractViewFrom(c);c=g.getView().selectDimension(a,[0,h-1]);l.extractViewTo(c,g);var d=t[1].get([1,-1]);d.set(0,[],d.get(1,[]));return[g,d,f]};r.appcoef=function(t,e,a,n){n=n===undefined?t[1].size()[0]-2:n;var i=t[1].size(0)-2;if(n>i||n<0){throw new Error("Matrix.appcoef: Invalid decomposition level.")}while(i>n){t=r.upwlev(t,e);i=t[1].size(0)-2}var o=y(t[1],a);var s=t[0],f=s.getView();var v=f.selectDimension(a,[o.bands[0],o.bands[1]-1]);return s.extractViewFrom(v)};r.detcoef=function(r,t,e){var a=y(r[1],t);if(e>a.J||e<1){throw new Error("Matrix.detcoef2: Invalid decomposition level.")}var n=a.J-e;var i=r[0],o=i.getView();var s=o.selectDimension(t,[a.bands[1+n],a.bands[2+n]-1]);return i.extractViewFrom(s)};r.wrcoef=function(t,e,a,n,i){var o,s;if(t==="l"){o=r.appcoef(e,a,n,i)}else if(t==="h"){s=r.detcoef(e,n,i)}var f=y(e[1]);for(var v=0;v<i;v++){o=w([o,s],a,n);o=M(o,f,f.J-i+v+1,n);s=undefined}return o};var b=function(t,e,a){var n=r.wfilters(a)[0].numel();var i=Math.ceil((n-2)/4),o=Math.floor((n-2)/4);var s=new Array(e+2);var f=new Array(e+2);var u=new Array(e+2);f[e+1]=t.getSize(0);s[e+1]=t.getSize(1);u[e+1]=t.getSize(2);for(var l=e;l>=1;l--){var c=h(a,f[l+1]),g=h(a,s[l+1]);f[l]=Math.ceil(f[l+1]/2)+c.ro+c.lo-(v==="per"?i+o:0);s[l]=Math.ceil(s[l+1]/2)+g.ro+g.lo-(v==="per"?i+o:0);u[l]=u[l+1]}f[0]=f[1];s[0]=s[1];u[0]=u[1];return r.toMatrix([f,s,u])};var x=function(r){var t=r.get([],0).getData(),e=r.get([],1).getData(),a=r.get([],2).getData();var n=e[0]*t[0]*a[0];var i=[0,n],o=[];var s,f=t.length-2;for(s=1;s<f+1;s++){o.push([t[s],e[s],a[s]]);var v=t[s]*e[s]*a[s];for(var u=0;u<3;u++){n+=v;i.push(n)}}return{bands:i,outSize:n,subSizes:o,ySizes:t,xSizes:e,cSizes:a,J:f}};var B=function(r,t,e){if(r.getSize(0)!==t.ySizes[e+1]||r.getSize(1)!==t.xSizes[e+1]){r=r.get([0,t.ySizes[e+1]-1],[0,t.xSizes[e+1]-1],[])}return r};r.dwt2=d;r.idwt2=p;r.wavedec2=function(t,e,a){var n=b(t,e,a),i=x(n),o=new Float64Array(i.outSize),s;for(var f=e-1,v=3*f;f>=0;f--,v-=3){s=d(t,a);o.subarray(i.bands[v+1],i.bands[v+2]).set(s[1].getData());o.subarray(i.bands[v+2],i.bands[v+3]).set(s[2].getData());o.subarray(i.bands[v+3],i.bands[v+4]).set(s[3].getData());t=s[0]}o.subarray(i.bands[0],i.bands[1]).set(s[0].getData());return[new r([o.length],o),n]};r.waverec2=function(t,e){var a=x(t[1]),n=t[0].getData();var i,o,s,f;i=new r(a.subSizes[0],n.subarray(a.bands[0],a.bands[1]));for(var v=0,u=0,l=a.J;v<l;v++,u+=3){var h=a.subSizes[v];o=new r(h,n.subarray(a.bands[u+1],a.bands[u+2]));s=new r(h,n.subarray(a.bands[u+2],a.bands[u+3]));f=new r(h,n.subarray(a.bands[u+3],a.bands[u+4]));i=p([i,o,s,f],e);i=B(i,a,v+1)}return i};r.upwlev2=function(t,e){if(t[1].getSize(0)===2){return[new r,new r]}var a=x(t[1]),n=t[0].getData();var i=new r(a.subSizes[0],n.subarray(a.bands[0],a.bands[1]));var o=new r(a.subSizes[0],n.subarray(a.bands[1],a.bands[2]));var s=new r(a.subSizes[0],n.subarray(a.bands[2],a.bands[3]));var f=new r(a.subSizes[0],n.subarray(a.bands[3],a.bands[4]));var v=p([i,o,s,f],e);v=B(v,a,1);var u=t[1].get([1,-1]);u.set(0,[],u.get(1,[]));var l=v.numel(),h=n.length-a.bands[4];var c=new Float64Array(l+h);c.subarray(0,l).set(v.getData());c.subarray(l).set(n.subarray(a.bands[4]));return[new r([c.length],c),u,i]};r.appcoef2=function(t,e,a){a=a===undefined?t[1].size()[0]-2:a;var n=t[1].size(0)-2;if(a>n||a<0){throw new Error("Matrix.appcoef2: Invalid decomposition level.")}while(n>a){console.log("upwlev");t=r.upwlev2(t,e);n=t[1].size(0)-2}var i=t[1].get([1,-1]).prod(1).getData();var o=t[0].getData();var s=t[1].get(0).getData();return new r(s,o.subarray(0,i[0]))};r.detcoef2=function(t,e,a){if(t==="all"){return[r.detcoef2("h",e,a),r.detcoef2("v",e,a),r.detcoef2("d",e,a)]}var n=x(e[1]),i=e[0].getData();if(a>n.J||a<1){throw new Error("Matrix.detcoef2: Invalid decomposition level.")}var o=n.J-a;var s=e[1].get([o+1],[]).getData();var f=1+o*3;if(t==="v"){f+=1}else if(t==="d"){f+=2}else if(t!=="h"){throw new Error("Matrix.detcoef2: Wrong type argument")}return new r(s,i.subarray(n.bands[f],n.bands[f+1]))};r.wrcoef2=function(t,e,a,n){var i,o,s,f;if(t==="a"){i=r.appcoef2(e,a,n)}else if(t==="h"){o=r.detcoef2("h",e,n)}else if(t==="v"){s=r.detcoef2("v",e,n)}else if(t==="d"){f=r.detcoef2("d",e,n)}var v=x(e[1]);for(var u=0;u<n;u++){i=p([i,o,s,f],a);i=B(i,v,v.J-n+u+1);o=s=f=undefined}return i};(function(){var e={sym:function(r,t,e){var a=r+t+e,n=new Uint32Array(a);var i,o,s,f=2*r;for(o=t,i=0;o>0;o--,i++){s=(o-1)%f;n[i]=s>=r?f-s-1:s}for(o=0;o<r;o++,i++){n[i]=o}for(o=0;o<e;o++,i++){s=(o+r)%f;n[i]=s>=r?f-s-1:s}return n},symw:function(r,t,e){var a=r+t+e,n=new Uint32Array(a);var i,o,s,f=2*r;i=0;for(o=t;o>0;o--,i++){s=(o-1)%(f-2);n[i]=s>=r-1?f-3-s:s+1}for(o=0;o<r;o++,i++){n[i]=o}for(o=0;o<e;o++,i++){s=(o+r)%(f-2);n[i]=s>=r-1?f-s-2:s}return n},per:function(r,t,e){var a=r+t+e,n=new Int32Array(a);var i,o;for(i=0,o=t;o>0;o--,i++){n[i]=r-(o-1)%r-1}for(o=0;o<r;o++,i++){n[i]=o}for(o=0;o<e;o++,i++){n[i]=o%r}return n},per2:function(r,t,e){var a=r%2;r+=a?1:0;e-=a?1:0;var n=r+t+e,i=new Int32Array(n);var o,s;for(o=0,s=t;s>0;s--,o++){i[o]=r-(s-1)%r-1}for(s=0;s<r;s++,o++){i[o]=s}for(s=0;s<e;s++,o++){i[o]=s%r}if(a){for(o=0;o<i.length;o++){if(i[o]==r-1){i[o]--}}}return i},nn:function(r,t,e){var a=r+t+e,n=new Uint32Array(a);var i,o,s,f;i=0;for(o=t;o>0;o--,i++){n[i]=0}for(o=0;o<r;o++,i++){n[i]=o}for(o=0;o<e;o++,i++){n[i]=r-1}return n}};t.paddim=function(r,t,e){var a=[r];for(var n=0;n<t;n++){a.push([])}a.push(e);return this.padarray.apply(this,a)};t.padarray=function(){var t=Array.prototype.shift.apply(arguments);var a,n=[],i,o;if(t!=="zpd"){var s=e[t];if(s===undefined){throw new Error("Matrix.padarray: Unimplemented mode "+t+".")}for(i=0;i<arguments.length;i++){o=arguments[i];if(Tools.isInteger(o)){a=[s(this.getSize(i),o,o)]}else if(Tools.isArrayLike(o)&&o.length===0){a=[]}else{a=[s(this.getSize(i),o[0],o[1])]}n.push(a)}return this.get.apply(this,n)}var f=this.getSize();

for(i=0;i<arguments.length;i++){o=arguments[i];f[i]=f[i]?f[i]:1;if(Tools.isInteger(o)){a=[o,-o-1];f[i]+=2*o}else if(Tools.isArrayLike(o)&&o.length===0){a=[]}else{a=[o[0],-o[1]-1];f[i]+=o[0]+o[1]}n.push(a)}n.push(this);var v=r.zeros(f);return v.set.apply(v,n)}})()})(Matrix,Matrix.prototype);(function(r,t){"use strict";var e=Tools.arrayFromBase64("AgADAAUABwALAA0AEQATABcAHQAfACUAKQArAC8ANQA7AD0AQwBHAEkATwBTAFkAYQBlAGcAawBt        AHEAfwCDAIkAiwCVAJcAnQCjAKcArQCzALUAvwDBAMUAxwDTAN8A4wDlAOkA7wDxAPsAAQEHAQ0B        DwEVARkBGwElATMBNwE5AT0BSwFRAVsBXQFhAWcBbwF1AXsBfwGFAY0BkQGZAaMBpQGvAbEBtwG7        AcEByQHNAc8B0wHfAecB6wHzAfcB/QEJAgsCHQIjAi0CMwI5AjsCQQJLAlECVwJZAl8CZQJpAmsC        dwKBAoMChwKNApMClQKhAqUCqwKzAr0CxQLPAtcC3QLjAucC7wL1AvkCAQMFAxMDHQMpAysDNQM3        AzsDPQNHA1UDWQNbA18DbQNxA3MDdwOLA48DlwOhA6kDrQOzA7kDxwPLA9ED1wPfA+UD8QP1A/sD        /QMHBAkEDwQZBBsEJQQnBC0EPwRDBEUESQRPBFUEXQRjBGkEfwSBBIsEkwSdBKMEqQSxBL0EwQTH        BM0EzwTVBOEE6wT9BP8EAwUJBQsFEQUVBRcFGwUnBSkFLwVRBVcFXQVlBXcFgQWPBZMFlQWZBZ8F        pwWrBa0FswW/BckFywXPBdEF1QXbBecF8wX7BQcGDQYRBhcGHwYjBisGLwY9BkEGRwZJBk0GUwZV        BlsGZQZ5Bn8GgwaFBp0GoQajBq0GuQa7BsUGzQbTBtkG3wbxBvcG+wb9BgkHEwcfBycHNwdFB0sH        TwdRB1UHVwdhB20Hcwd5B4sHjQedB58HtQe7B8MHyQfNB88H0wfbB+EH6wftB/cHBQgPCBUIIQgj        CCcIKQgzCD8IQQhRCFMIWQhdCF8IaQhxCIMImwifCKUIrQi9CL8IwwjLCNsI3QjhCOkI7wj1CPkI        BQkHCR0JIwklCSsJLwk1CUMJSQlNCU8JVQlZCV8JawlxCXcJhQmJCY8JmwmjCakJrQnHCdkJ4wnr        Ce8J9Qn3Cf0JEwofCiEKMQo5Cj0KSQpXCmEKYwpnCm8KdQp7Cn8KgQqFCosKkwqXCpkKnwqpCqsK        tQq9CsEKzwrZCuUK5wrtCvEK8woDCxELFQsbCyMLKQstCz8LRwtRC1cLXQtlC28LewuJC40LkwuZ        C5sLtwu5C8MLywvPC90L4QvpC/UL+wsHDAsMEQwlDC8MMQxBDFsMXwxhDG0Mcwx3DIMMiQyRDJUM        nQyzDLUMuQw=",Uint16Array);var a=e.length;var n=function(r){if(r===1){return 0}var t=[],n,i,o;for(n=i=0;i<a;i++){if(r%e[i]===0){o=e[i];do{t[n]=o;n++;r=r/o}while(r%o===0)}}if(r!==1){t[n]=r;n++}return t};var i=function(r,t,e){var a=r[t];r[t]=r[e];r[e]=a};var o=function(r,t,e,a){var n=r.length/2,i,o;if(a===1){for(i=0,o=0;i<n;i++){t[i]=r[o++];e[i]=-r[o++]}}else{var s=1/n;for(i=0,o=0;i<n;i++){t[i]=r[o++]*s;e[i]=-r[o++]*s}}};var s=function(r,t){var e=r.length,a,n;var i=new Float64Array(2*e);if(t){for(a=0,n=0;a<e;a++){i[n++]=r[a];i[n++]=-t[a]}}else{for(a=0,n=0;a<e;a++,n++){i[n++]=r[a]}}return i};var f=function(r,t,e){var a,n,o,f,v;var u,l,h,c,g,w;var d,p;var m=r.length,y=s(r,t);var M=m<<1;for(v=1,o=1;v<M;v+=2){if(o>v){i(y,o-1,v-1);i(y,o,v)}a=M>>1;while(a>=2&&o>a){o=o-a;a>>=1}o=o+a}var b=2;while(M>b){f=2*b;w=2*Math.PI/(e*b);u=Math.sin(.5*w);h=-2*u*u;c=Math.sin(w);l=1;g=0;for(a=1;a<b;a+=2){for(v=a-1;v<=M-1;v+=f){o=v+b;d=l*y[o]-g*y[o+1];p=l*y[o+1]+g*y[o];y[o]=y[v]-d;y[o+1]=y[v+1]-p;y[v]+=d;y[v+1]+=p}l=(u=l)*h-g*c+l;g=g*h+u*c+g}b=f}return y};var v=function(r,t,e,a){var n=r.length,i;var o=new Float64Array(n),f=new Float64Array(n);var v=2*Math.PI/n;for(i=0;i<n;i++){o[i]=Math.cos(i*v);f[i]=e*Math.sin(i*v)}var u=s(r,t),l=new Float64Array(2*n);var h,c,g,w,d,p;var m=1,y,M=a.length;for(y=0;y<M;y++){w=a[y];d=n/m/w;p=m*w;for(c=0;c<2*n;c++){l[c]=0}for(h=0;h<w;h++){for(g=0;g<p;g++){var b=g*h%p*d;var x=o[b],B=f[b];var D=2*d*g,A=2*d*(h+g%m*w);for(i=0;i<d;i++,D+=2,A+=2){l[D]+=u[A]*x-u[A+1]*B;l[D+1]+=u[A]*B+u[A+1]*x}}}var L=u;u=l;l=L;m*=w}return u};var u=function(r,t,e,a,i){var s=r.length,u=n(s),l=u.length;var h=!i?1:-1,c;if(s>1&&u[l-1]!==2){c=v(r,t,h,u)}else{c=f(r,t,h)}return o(c,e,a,h)};var l=function(t,e){if(t.isreal()){t.toComplex()}var a=new r(t.getSize(),Float64Array,true);var n=t.getRealData(),i=t.getImagData();var o=a.getRealData(),s=a.getImagData();var f,v,l=t.getSize(0),h=t.numel()/l;for(f=0,v=0;f<h;f++,v+=l){var c=n.subarray(v,l+v),g=i.subarray(v,l+v);var w=o.subarray(v,l+v),d=s.subarray(v,l+v);u(c,g,w,d,e)}return a};t.fft=function(){return l(this,false)};r.fft=function(t){return l(r.toMatrix(t),false)};t.fft2=function(){var r=l(this,false);r=l(r.transpose(),false);return r.transpose()};r.fft2=function(t){var e=l(r.toMatrix(t),false);e=l(e.transpose(),false);return e.transpose()};(function(){var t=function(r,t,e){var a=r.getSize();if(Tools.isSet(t)){if(!Tools.isInteger(t,0)){throw new Error("Matrix.fftshift: Dimension must be a positive integer")}return this.circshift(e(a[t]/2),t)}for(var n=0,i=a.length;n<i;n++){a[n]=e(a[n]/2)}return r.circshift(a)};r.prototype.fftshift=function(r){return t(this,r,Math.floor)};r.prototype.ifftshift=function(r){return t(this,r,Math.ceil)}})();t.ifft=function(){return l(this,true)};r.ifft=function(t){return l(r.toMatrix(t),true)};t.ifft2=function(){return this.fft().transpose().fft().transpose()};r.ifft2=function(t){return r.toMatrix(t).ifft().transpose().ifft().transpose()}})(Matrix,Matrix.prototype);(function(r){function t(r){var e=this.constructor.name+": ";if(r===undefined){this.name="haar"}else{this.name=r.toLowerCase()}if(t.list[this.name]){var a=t.list[this.name];var n=a.normalized!==undefined&&!a.normalized?function(r){return t.filter(r,"norm")}:function(r){return r};this.filterL=n(a.filterL);this.orthogonal=a.orthogonal?true:false;if(a.filterH){this.filterH=n(a.filterH)}if(a.invFilterL){this.invFilterL=n(a.invFilterL)}if(a.invFilterH){this.invFilterH=n(a.invFilterH)}}if(this.filterL===undefined){var i=e+"unknown wavelet '"+r+"'. \n";i+="User-defined wavelets not implemented yet.";throw new Error(i)}var o=function(r,e){return t.filter(r,"conjugate",e?-1:1)};if(!this.filterH&&this.orthogonal){this.filterH=t.filter(o(this.filterL),"mirror")}if(!this.invFilterL){this.invFilterL=o(this.filterH,true)}if(!this.invFilterH){this.invFilterH=o(this.filterL,false)}return this}t.list={haar:{orthogonal:true,normalized:false,filterL:new Float64Array([1,1])},db2:{name:"Daubechies 2",orthogonal:true,normalized:false,filterL:new Float64Array([1+Math.sqrt(3),3+Math.sqrt(3),3-Math.sqrt(3),1-Math.sqrt(3)])},db4:{name:"Daubechies 4",orthogonal:true,filterL:new Float64Array([-.010597401784997278,.032883011666982945,.030841381835986965,-.18703481171888114,-.02798376941698385,.6308807679295904,.7148465705525415,.23037781330885523])},db8:{name:"Daubechies 8",orthogonal:true,filterL:new Float64Array([-.00011747678400228192,.0006754494059985568,-.0003917403729959771,-.00487035299301066,.008746094047015655,.013981027917015516,-.04408825393106472,-.01736930100202211,.128747426620186,.00047248457399797254,-.2840155429624281,-.015829105256023893,.5853546836548691,.6756307362980128,.3128715909144659,.05441584224308161])},sym2:{name:"Symlets 2",orthogonal:true,filterL:new Float64Array([-.12940952255092145,.22414386804185735,.836516303737469,.48296291314469025])},sym4:{name:"Symlets 4",orthogonal:true,filterL:new Float64Array([-.07576571478927333,-.02963552764599851,.49761866763201545,.8037387518059161,.29785779560527736,-.09921954357684722,-.012603967262037833,.0322231006040427])},sym8:{name:"Symlets 8",orthogonal:true,filterL:[-.0033824159510061256,-.0005421323317911481,.03169508781149298,.007607487324917605,-.1432942383508097,-.061273359067658524,.4813596512583722,.7771857517005235,.3644418948353314,-.05194583810770904,-.027219029917056003,.049137179673607506,.003808752013890615,-.01495225833704823,-.0003029205147213668,.0018899503327594609]},coif1:{name:"Coiflets 1",orthogonal:true,filterL:new Float64Array([-.01565572813546454,-.0727326195128539,.38486484686420286,.8525720202122554,.3378976624578092,-.0727326195128539])},coif2:{name:"Coiflets 2",orthogonal:true,filterL:new Float64Array([-.0007205494453645122,-.0018232088707029932,.0056114348193944995,.023680171946334084,-.0594344186464569,-.0764885990783064,.41700518442169254,.8127236354455423,.3861100668211622,-.06737255472196302,-.04146493678175915,.016387336463522112])},coif4:{name:"Coiflets 4",orthogonal:true,filterL:new Float64Array([-17849850030882614e-22,-32596802368833675e-22,31229875865345646e-21,6233903446100713e-20,-.00025997455248771324,-.0005890207562443383,.0012665619292989445,.003751436157278457,-.00565828668661072,-.015211731527946259,.025082261844864097,.03933442712333749,-.09622044203398798,-.06662747426342504,.4343860564914685,.782238930920499,.41530840703043026,-.05607731331675481,-.08126669968087875,.026682300156053072,.016068943964776348,-.0073461663276420935,-.0016294920126017326,.0008923136685823146])},bi13:{name:"Biorthogonal 1-3",orthogonal:false,filterL:new Float64Array([-.08838834764831845,.08838834764831845,.7071067811865476,.7071067811865476,.08838834764831845,-.08838834764831845]),filterH:new Float64Array([0,0,-.7071067811865476,.7071067811865476,0,0])},bi31:{name:"Biorthogonal 3-1",orthogonal:false,filterL:new Float64Array([-.3535533905932738,1.0606601717798214,1.0606601717798214,-.3535533905932738]),filterH:new Float64Array([-.1767766952966369,.5303300858899107,-.5303300858899107,.1767766952966369])},bi68:{name:"Biorthogonal 6-8",orthogonal:false,filterL:new Float64Array([0,.0019088317364812906,-.0019142861290887667,-.016990639867602342,.01193456527972926,.04973290349094079,-.07726317316720414,-.09405920349573646,.4207962846098268,.8259229974584023,.4207962846098268,-.09405920349573646,-.07726317316720414,.04973290349094079,.01193456527972926,-.016990639867602342,-.0019142861290887667,.0019088317364812906]),filterH:new Float64Array([0,0,0,.014426282505624435,-.014467504896790148,-.07872200106262882,.04036797903033992,.41784910915027457,-.7589077294536541,.41784910915027457,.04036797903033992,-.07872200106262882,-.014467504896790148,.014426282505624435,0,0,0,0])},cdf97:{name:"Cohen-Daubechies-Feauveau 9-7",orthogonal:false,filterL:new Float64Array([0,.02674875741080976,-.01686411844287495,-.07822326652898785,.2668641184428723,.6029490182363579,.2668641184428723,-.07822326652898785,-.01686411844287495,.02674875741080976]),filterH:new Float64Array([0,-.09127176311424948,.05754352622849957,.591271763114247,-1.115087052456994,.591271763114247,.05754352622849957,-.09127176311424948,0,0])},rbio13:{name:"Reverse biorthogonal 1-3",orthogonal:false,filterL:new Float64Array([0,0,.7071067811865476,.7071067811865476,0,0]),filterH:new Float64Array([.08838834764831845,.08838834764831845,-.7071067811865476,.7071067811865476,-.08838834764831845,-.08838834764831845])},rbio31:{name:"Reverse biorthogonal 3-1",orthogonal:false,filterL:new Float64Array([.1767766952966369,.5303300858899107,.5303300858899107,.1767766952966369]),filterH:new Float64Array([.3535533905932738,1.0606601717798214,-1.0606601717798214,-.3535533905932738])},rbio33:{name:"Reverse biorthogonal 3-3",orthogonal:false,filterL:new Float64Array([0,0,.1767766952966369,.5303300858899107,.5303300858899107,.1767766952966369,0,0]),filterH:new Float64Array([-.06629126073623884,-.19887378220871652,.15467960838455727,.9943689110435825,-.9943689110435825,-.15467960838455727,.19887378220871652,.06629126073623884])},rbio35:{name:"Reverse biorthogonal 3-5",orthogonal:false,filterL:new Float64Array([0,0,0,0,.1767766952966369,.5303300858899107,.5303300858899107,.1767766952966369,0,0,0,0]),filterH:new Float64Array([.013810679320049757,.04143203796014927,-.052480581416189075,-.26792717880896527,.07181553246425874,.966747552403483,-.966747552403483,-.07181553246425874,.26792717880896527,.052480581416189075,-.04143203796014927,-.013810679320049757])},rbio39:{name:"Reverse biorthogonal 3-9",orthogonal:false,filterL:new Float64Array([0,0,0,0,0,0,0,0,.1767766952966369,.5303300858899107,.5303300858899107,.1767766952966369,0,0,0,0,0,0,0,0]),filterH:new Float64Array([.000679744372783699,.002039233118351097,-.005060319219611981,-.020618912641105536,.014112787930175846,.09913478249423216,-.012300136269419315,-.32019196836077857,-.0020500227115698858,.9421257006782068,-.9421257006782068,.0020500227115698858,.32019196836077857,.012300136269419315,-.09913478249423216,-.014112787930175846,.020618912641105536,.005060319219611981,-.002039233118351097,-.000679744372783699])}};t.filter=function(r,t,e){var a="Wavelet.filter: ";if(e===undefined||e===0){e=1}if(typeof e!=="number"){throw new Error(a+"argument 'factor' must be a number")}if(typeof t!=="string"){throw new Error(a+"argument 'action' must be a string")}t=t.toLowerCase().substr(0,3);var n;var i=r.length;var o=[];var s=1,f=1;if(t==="mir"){for(n=0;n<i;n++){o[n]=e*r[i-1-n]}return o}if(t==="nor"){var v=0;for(n=0;n<i;n++){v+=r[n]*r[n]}e=!v?1:1/Math.sqrt(v)}else if(t==="con"){f=-1}else if(t!=="res"){throw new Error(a+"unknown action")}for(n=0;n<i;n++,s*=f){o[n]=e*s*r[n]}return o};r.wfilters=function(e,a){var n=new t(e);var i=r.toMatrix(n.filterL),o=r.toMatrix(n.filterH),s=r.toMatrix(n.invFilterL),f=r.toMatrix(n.invFilterH);switch(a){case"d":return[i,o];case"r":return[s,f];case"l":return[i,s];case"h":return[o,f];case undefined:return[i,o,s,f];default:throw new Error("Matrix.wfilters: wrong type argument.")}}})(Matrix);(function(r){"use strict";var t={matrix:function(r,t,e,a,n){a=a||1;n=n||3;e=(e||1)*n;var i=t[0],o=t[3],s=t[6];var f=t[1],v=t[4],u=t[7];var l=t[2],h=t[5],c=t[8];for(var g=0,w=a,d=2*a;g<e;g+=n,w+=n,d+=n){var p=r[g],m=r[w],y=r[d];r[g]=i*p+o*m+s*y;r[w]=f*p+v*m+u*y;r[d]=l*p+h*m+c*y}return r},"RGB to RGB":function(r,t,e,a){e=e||1;a=a||3;t=(t||1)*a;for(var n=0,i=e,o=2*e;n<t;n+=a,i+=a,o+=a){var s=r[n],f=r[i],v=r[o];r[n]=s;r[i]=f;r[o]=v}return r},applyFunctionRGB:function(r,t,e,a,n){a=a||1;n=n||3;e=(e||1)*n;for(var i=0,o=a,s=2*a;i<e;i+=n,o+=n,s+=n){var f=t(r[i],r[o],r[s]);r[i]=f[0];r[o]=f[1];r[s]=f[2]}return r},applyFunctionColor:function(r,t,e,a,n){a=a||1;n=n||3;e=(e||1)*n;for(var i=0,o=a,s=2*a;i<e;i+=n,o+=n,s+=n){var f=r[i],v=r[o],u=r[s];var l=t([f,v,u]);r[i]=l[0];r[o]=l[1];r[s]=l[2]}return r},"RGB to GRAY":function(r,t,e,a){e=e||1;a=a||3;t=(t||1)*a;for(var n=0,i=e,o=2*e;n<t;n+=a,i+=a,o+=a){var s=r[n],f=r[i],v=r[o];var u=.2989*s+.587*f+.114*v;r[n]=u;r[i]=u;r[o]=u}return r},"RGB to HSV":function(r,t,e,a){e=e||1;a=a||3;t=(t||1)*a;var n=1/6;for(var i=0,o=e,s=2*e;i<t;i+=a,o+=a,s+=a){var f=r[i],v=r[o],u=r[s];var l=(f>v?f:v)>u?f>v?f:v:u;var h=l-((f<v?f:v)<u?f<v?f:v:u),c=0;if(h!==0){if(l===f){c=(v-u)/h*n}else if(l===v){c=(2+(u-f)/h)*n}else if(l===u){c=(4+(f-v)/h)*n}if(c<0){c+=1}if(l!==0){h/=l}}r[i]=c;r[o]=h;r[s]=l}return r},"HSV to RGB":function(r,t,e,a){e=e||1;a=a||3;t=(t||1)*a;for(var n=0,i=e,o=2*e;n<t;n+=a,i+=a,o+=a){var s=r[n],f=r[i],v=r[o];var u=(s*6|0)%6;var l=s*6-u;var h=v*(1-f);var c=v*(1-l*f);var g=v*(1-(1-l)*f);switch(u){case 0:r[n]=v;r[i]=g;r[o]=h;break;case 1:r[n]=c;r[i]=v;r[o]=h;break;case 2:r[n]=h;r[i]=v;r[o]=g;break;case 3:r[n]=h;r[i]=c;r[o]=v;break;case 4:r[n]=g;r[i]=h;r[o]=v;break;case 5:r[n]=v;r[i]=h;r[o]=c;break}}return r},"RGB to HSL":function(r,t,e,a){e=e||1;a=a||3;t=(t||1)*a;var n=Math.sqrt(3),i=1/(2*Math.PI),o=1/3;for(var s=0,f=e,v=2*e;s<t;s+=a,f+=a,v+=a){var u=r[s],l=r[f],h=r[v];var c=Math.atan2(n*(l-h),2*u-l-h)*i;r[s]=c<0?c+1:c;var g=(u>l?u:l)>h?u>l?u:l:h;var w=(u<l?u:l)<h?u<l?u:l:h;r[f]=g-w;r[v]=(u+l+h)*o}return r},"HSL to RGB":function(r,t,e,a){e=e||1;a=a||3;t=(t||1)*a;var n=Math.PI,i=n/3,o=n*2,s=2*n/3;var f=1/3;var v=Math.sqrt(3)/2,u=1/Math.sqrt(3);for(var l=0,h=e,c=2*e;l<t;l+=a,h+=a,c+=a){var g=r[l],w=r[h],d=r[c];var p=g*o;var m=p;while(m>i){m-=i}var y=v*w/Math.sin(s-m);var M=y*Math.cos(p)*f,b=y*Math.sin(p)*u;r[l]=d+M*2;r[h]=d-M+b;r[c]=d-M-b}return r},"RGB to HSI":function(r,t,e,a){e=e||1;a=a||3;t=(t||1)*a;var n=1/Math.sqrt(3),i=1/Math.sqrt(2),o=1/Math.sqrt(6);for(var s=0,f=e,v=2*e;s<t;s+=a,f+=a,v+=a){var u=r[s],l=r[f],h=r[v];var c=(l-h)*i;var g=(2*u-l-h)*o;r[s]=Math.atan2(c,g);r[f]=Math.sqrt(c*c+g*g);r[v]=(u+l+h)*n}return r},"HSI to RGB":function(r,t,e,a){e=e||1;a=a||3;t=(t||1)*a;var n=Math.sqrt(3),i=Math.sqrt(2),o=Math.sqrt(6);var s=1/6,f=1/3;for(var v=0,u=e,l=2*e;v<t;v+=a,u+=a,l+=a){var h=r[v],c=r[u],g=r[l];var w=c*Math.sin(h);var d=c*Math.cos(h);var p=g*n,m=w*i,y=d*o;var M=(p+y)*f;var b=(2*p+3*m-y)*s;var x=(2*p-3*m-y)*s;r[v]=M;r[u]=b;r[l]=x}return r},"LinearRGB to sRGB":function(r,t,e,a){e=e||1;a=a||3;t=(t||1)*a;var n=.055,i=1/2.4;for(var o=0,s=e,f=2*e;o<t;o+=a,s+=a,f+=a){var v=r[o],u=r[s],l=r[f];r[o]=v>.0031308?1.055*Math.pow(v,i)-n:v*12.92;r[s]=u>.0031308?1.055*Math.pow(u,i)-n:u*12.92;r[f]=l>.0031308?1.055*Math.pow(l,i)-n:l*12.92}return r},"sRGB to LinearRGB":function(r,t,e,a){e=e||1;a=a||3;t=(t||1)*a;var n=1/12.92,i=.055,o=1/1.055;for(var s=0,f=e,v=2*e;s<t;s+=a,f+=a,v+=a){var u=r[s],l=r[f],h=r[v];r[s]=u>.04045?Math.pow((u+i)*o,2.4):u*n;r[f]=l>.04045?Math.pow((l+i)*o,2.4):l*n;r[v]=h>.04045?Math.pow((h+i)*o,2.4):h*n}return r},"RGB to CMY":function(r,t,e,a){e=e||1;a=a||3;t=(t||1)*a;for(var n=0,i=e,o=2*e;n<t;n+=a,i+=a,o+=a){r[n]=1-r[n];r[i]=1-r[i];r[o]=1-r[o]}return r},"CMY to RGB":function(r,t,e,a){e=e||1;a=a||3;t=(t||1)*a;for(var n=0,i=e,o=2*e;n<t;n+=a,i+=a,o+=a){r[n]=1-r[n];r[i]=1-r[i];r[o]=1-r[o]}return r},"RGB to Opponent":function(r,t,e,a){e=e||1;a=a||3;t=(t||1)*a;var n=1/Math.sqrt(3),i=1/Math.sqrt(2),o=1/Math.sqrt(6);for(var s=0,f=e,v=2*e;s<t;s+=a,f+=a,v+=a){var u=r[s],l=r[f],h=r[v];r[s]=(u+l+h)*n;r[f]=(u-l)*i;r[v]=(u+l-2*h)*o}return r},"Opponent to RGB":function(r,t,e,a){e=e||1;a=a||3;t=(t||1)*a;var n=Math.sqrt(3),i=Math.sqrt(2),o=Math.sqrt(6);var s=1/6,f=1/3;for(var v=0,u=e,l=2*e;v<t;v+=a,u+=a,l+=a){var h=r[v],c=r[u],g=r[l];var w=h*n,d=c*i,p=g*o;r[v]=(2*w+3*d+p)*s;r[u]=(2*w-3*d+p)*s;r[l]=(w-p)*f}return r},"RGB to Ohta":function(r,t,e,a){e=e||1;a=a||3;t=(t||1)*a;var n=1/Math.sqrt(3),i=1/Math.sqrt(2),o=1/Math.sqrt(6);for(var s=0,f=e,v=2*e;s<t;s+=a,f+=a,v+=a){var u=r[s],l=r[f],h=r[v];r[s]=(u+l+h)*n;r[f]=(u-h)*i;r[v]=(-u+2*l-h)*o}return r},"Ohta to RGB":function(r,t,e,a){e=e||1;a=a||3;t=(t||1)*a;var n=Math.sqrt(3),i=Math.sqrt(2),o=Math.sqrt(6);var s=1/6,f=1/3;for(var v=0,u=e,l=2*e;v<t;v+=a,u+=a,l+=a){var h=r[v],c=r[u],g=r[l];var w=h*n,d=c*i,p=g*o;r[u]=(w+p)*f;r[v]=(2*w+3*d-p)*s;r[l]=(2*w-3*d-p)*s}return r},"LinearRGB to rgY":function(r,t,e,a){e=e||1;a=a||3;t=(t||1)*a;for(var n=0,i=e,o=2*e;n<t;n+=a,i+=a,o+=a){var s=r[n],f=r[i],v=r[o];var u=s+f+v;if(u>0){var l=1/u;r[n]=s*l;r[i]=f*l;r[o]=u}else{r[n]=1/3;r[i]=1/3;r[o]=0}}return r},"rgY to LinearRGB":function(r,t,e,a){e=e||1;a=a||3;t=(t||1)*a;for(var n=0,i=e,o=2*e;n<t;n+=a,i+=a,o+=a){var s=r[n],f=r[i],v=r[o];r[n]=s*v;r[i]=f*v;r[o]=(1-s-f)*v}return r},getXYZTransform:function(r,e,a){e=e||[.31271,.32902,1];a=a||[.64,.33,1,.3,.6,1,.15,.06,1];var n=t["xyY to XYZ"](e);n=Matrix.toMatrix(n);var a=t["xyY to XYZ"](a,3);a=new Matrix([3,3],a);var i=Matrix.diag(a.inv().mtimes(n));var o=a.mtimes(i);return r?o.inv():o},"LinearRGB to XYZ":function(r,e,a,n,i,o){var s=t.getXYZTransform(false,i,o).getData();t.matrix(r,s,e,a,n);return r},"XYZ to LinearRGB":function(r,e,a,n,i,o){var s=t.getXYZTransform(true,i,o).getData();t.matrix(r,s,e,a,n);return r},"XYZ to Lab":function(r,t,e,a,n){e=e||1;a=a||3;t=(t||1)*a;n=n||[.31271,.32902,1];var i=n[0],o=n[1],s=n[2];var f=i*s/o;var v=(1-i-o)*s/o;var u=1/f,l=1/s,h=1/v;var c=1/3,g=16/116;for(var w=0,d=e,p=2*e;w<t;w+=a,d+=a,p+=a){var m=r[w],y=r[d],M=r[p];var b=m*u;if(b>.008856){b=Math.pow(b,c)}else{b=7.787*b+g}var x=y*l;if(x>.008856){x=Math.pow(x,c)}else{x=7.787*x+g}var B=M*h;if(B>.008856){B=Math.pow(B,c)}else{B=7.787*B+g}r[w]=116*x-16;r[d]=500*(b-x);r[p]=200*(x-B)}return r},"Lab to XYZ":function(r,t,e,a,n){e=e||1;a=a||3;t=(t||1)*a;n=n||[.31271,.32902,1];var i=n[0],o=n[1],s=n[2];var f=i*s/o;var v=(1-i-o)*s/o;var u=Math.pow(.008856,1/3),l=1/7.787;var h=1/116,c=1/500,g=1/200;var w=16/116;for(var d=0,p=e,m=2*e;d<t;d+=a,p+=a,m+=a){var y=r[d],M=r[p],b=r[m];var x=(y+16)*h;var B=x+M*c;var D=x-b*g;if(x>u){x=Math.pow(x,3)}else{x=(x-w)*l}if(B>u){B=Math.pow(B,3)}else{B=(B-w)*l}if(D>u){D=Math.pow(D,3)}else{D=(D-w)*l}r[d]=B*f;r[p]=x*s;r[m]=D*v}return r},"XYZ to Luv":function(r,t,e,a,n){e=e||1;a=a||3;t=(t||1)*a;n=n||[.31271,.32902,1];var i=n[0],o=n[1],s=n[2];var f=i*s/o;var v=(1-i-o)*s/o;var u=1/s;var l=4*f/(f+15*s+3*v);var h=9*s/(f+15*s+3*v);var c=1/3;for(var g=0,w=e,d=2*e;g<t;g+=a,w+=a,d+=a){var p=r[g],m=r[w],y=r[d];var M=m*u;if(M>.008856){M=116*Math.pow(M,c)-16}else{M*=903.3}var b=1/(p+15*m+3*y);b=isFinite(b)?b:0;var x=4*b*p;var B=9*b*m;b=13*M;r[g]=M;r[w]=b*(x-l);r[d]=b*(B-h)}return r},"Luv to XYZ":function(r,t,e,a,n){e=e||1;a=a||3;t=(t||1)*a;n=n||[.31271,.32902,1];var i=n[0],o=n[1],s=n[2];var f=i*s/o;var v=(1-i-o)*s/o;var u=4*f/(f+15*s+3*v);var l=9*s/(f+15*s+3*v);var h=Math.pow(.008856,1/3),c=1/7.787;var g=1/116,w=16/116;for(var d=0,p=e,m=2*e;d<t;d+=a,p+=a,m+=a){var y=r[d],M=r[p],b=r[m];var x=(y+16)*g;if(x>h){x=Math.pow(x,3)}else{x=(x-w)*c}var B=1/(13*y);B=isFinite(B)?B:0;var D=M*B+u;var A=b*B+l;B=x/(4*A);r[d]=9*D*B;r[p]=x;r[m]=(12-3*D-20*A)*B}return r},"Lab to Lch":function(r,t,e,a){e=e||1;a=a||3;t=(t||1)*a;var n=1/(2*Math.PI);for(var i=0,o=e,s=2*e;i<t;i+=a,o+=a,s+=a){var f=r[i],v=r[o],u=r[s];var l=Math.atan2(u,v)*n;r[i]=f;r[o]=Math.sqrt(v*v+u*u);r[s]=l<0?l+1:l}return r},"Lch to Lab":function(r,t,e,a){e=e||1;a=a||3;t=(t||1)*a;var n=Math.PI*2;for(var i=0,o=e,s=2*e;i<t;i+=a,o+=a,s+=a){var f=r[i],v=r[o],u=r[s];var l=u*n;var h=Math.cos(l)*v;var c=Math.sin(l)*v;r[i]=f;r[o]=h;r[s]=c}return r},"RGB to XYZ":function(r,e,a,n){t["sRGB to LinearRGB"](r,e,a,n);t["LinearRGB to XYZ"](r,e,a,n);return r},"XYZ to RGB":function(r,e,a,n){t["XYZ to LinearRGB"](r,e,a,n);t["LinearRGB to sRGB"](r,e,a,n);return r},"RGB to Lab":function(r,e,a,n,i){t["sRGB to LinearRGB"](r,e,a,n);t["LinearRGB to XYZ"](r,e,a,n,i);t["XYZ to Lab"](r,e,a,n,i);return r},"Lab to RGB":function(r,e,a,n){t["Lab to XYZ"](r,e,a,n);t["XYZ to LinearRGB"](r,e,a,n);t["LinearRGB to sRGB"](r,e,a,n);return r},"RGB to Luv":function(r,e,a,n,i){t["sRGB to LinearRGB"](r,e,a,n);t["LinearRGB to XYZ"](r,e,a,n);t["XYZ to Luv"](r,e,a,n,i);return r},"Luv to RGB":function(r,e,a,n,i){t["Luv to XYZ"](r,e,a,n,i);t["XYZ to LinearRGB"](r,e,a,n);t["LinearRGB to sRGB"](r,e,a,n);return r},"RGB to Lch":function(r,e,a,n,i){t["sRGB to LinearRGB"](r,e,a,n);t["LinearRGB to XYZ"](r,e,a,n);t["XYZ to Lab"](r,e,a,n,i);t["Lab to Lch"](r,e,a,n);return r},"Lch to RGB":function(r,e,a,n,i){t["Lch to Lab"](r,e,a,n);t["Lab to XYZ"](r,e,a,n,i);t["XYZ to LinearRGB"](r,e,a,n);t["LinearRGB to sRGB"](r,e,a,n);return r},"XYZ to xyY":function(r,t,e,a,n){e=e||1;a=a||3;t=(t||1)*a;n=n||[.31271,.32902,1];var i=n[0],o=n[1];for(var s=0,f=e,v=2*e;s<t;s+=a,f+=a,v+=a){var u=r[s],l=r[f],h=r[v];var c=1/(u+l+h);if(isFinite(c)){r[s]=u*c;r[f]=l*c;r[v]=l}else{r[s]=i;r[f]=o;r[v]=0}}return r},"xyY to XYZ":function(r,t,e,a){e=e||1;a=a||3;t=(t||1)*a;for(var n=0,i=e,o=2*e;n<t;n+=a,i+=a,o+=a){var s=r[n],f=r[i],v=r[o];var u=v/f;r[n]=s*u;r[i]=v;r[o]=(1-s-f)*u}return r},"XYZ to 1960 uvY":function(r,t,e,a,n){e=e||1;a=a||3;t=(t||1)*a;n=n||[.31271,.32902,1];var i=n[0],o=n[1],s=n[2];var f=i*s/o,v=(1-i-o)*s/o;var u=4*f/(f+15*s+3*v);var l=6*s/(f+15*s+3*v);for(var h=0,c=e,g=2*e;h<t;h+=a,c+=a,g+=a){var w=r[h],d=r[c],p=r[g];if(d===0){r[h]=u;r[c]=l;r[g]=0}else{var m=1/(w+15*d+3*p);r[h]=4*w*m;r[c]=6*d*m;r[g]=d}}return r},"1960 uvY to XYZ":function(r,t,e,a){e=e||1;a=a||3;t=(t||1)*a;var n=6/4,i=1/3;for(var o=0,s=e,f=2*e;o<t;o+=a,s+=a,f+=a){var v=r[o],u=r[s],l=r[f];var h=1/u;var c=n*l*v*h;r[o]=c;r[s]=l;r[f]=(6*l*h-c-15*l)*i}return r},"XYZ to 1976 u'v'Y":function(r,t,e,a,n){e=e||1;a=a||3;t=(t||1)*a;n=n||[.31271,.32902,1];var i=n[0],o=n[1],s=n[2];var f=i*s/o,v=(1-i-o)*s/o;var u=4*f/(f+15*s+3*v);var l=9*s/(f+15*s+3*v);for(var h=0,c=e,g=2*e;h<t;h+=a,c+=a,g+=a){var w=r[h],d=r[c],p=r[g];if(d===0){r[h]=u;r[c]=l;r[g]=0}else{var m=1/(w+15*d+3*p);r[h]=4*w*m;r[c]=9*d*m;r[g]=d}}return r},"1976 u'v'Y to XYZ":function(r,t,e,a){e=e||1;a=a||3;t=(t||1)*a;var n=9/4,i=1/3;for(var o=0,s=e,f=2*e;o<t;o+=a,s+=a,f+=a){var v=r[o],u=r[s],l=r[f];var h=1/u;var c=n*l*v*h;r[o]=c;r[s]=l;r[f]=(9*l*h-c-15*l)*i}return r},"xyY to 1960 uvY":function(r,t,e,a){e=e||1;a=a||3;t=(t||1)*a;for(var n=0,i=e,o=2*e;n<t;n+=a,i+=a,o+=a){var s=r[n],f=r[i];var v=1/(-2*s+12*f+3);r[n]=4*s*v;r[i]=6*f*v}return r},"1960 uvY to xyY":function(r,t,e,a){e=e||1;a=a||3;t=(t||1)*a;for(var n=0,i=e,o=2*e;n<t;n+=a,i+=a,o+=a){var s=r[n],f=r[i];var v=1/(2*s-8*f+4);r[n]=3*s*v;r[i]=2*f*v}return r},"1976 u'v'Y to xyY":function(r,t,e,a){e=e||1;a=a||3;t=(t||1)*a;for(var n=0,i=e,o=2*e;n<t;n+=a,i+=a,o+=a){var s=r[n],f=r[i];var v=1/(6*s-16*f+12);r[n]=9*s*v;r[i]=4*f*v}return r},"xyY to 1976 u'v'Y":function(r,t,e,a){e=e||1;a=a||3;t=(t||1)*a;for(var n=0,i=e,o=2*e;n<t;n+=a,i+=a,o+=a){var s=r[n],f=r[i];var v=1/(-2*s+12*f+3);r[n]=4*s*v;r[i]=9*f*v}return r},"1976 u'v'Y to 1960 uvY":function(r,t,e,a){e=e||1;a=a||3;t=(t||1)*a+e;var n=2/3;for(var i=e;i<t;i+=a){r[i]*=n}return r},"1960 uvY to 1976 u'v'Y":function(r,t,e,a){e=e||1;a=a||3;t=(t||1)*a+e;var n=3/2;for(var i=e;i<t;i+=a){r[i]*=n}return r},"RGB to rgY":function(r,e,a,n){t["sRGB to LinearRGB"](r,e,a,n);t["LinearRGB to rgY"](r,e,a,n);return r},"rgY to RGB":function(r,e,a,n){t["rgY to LinearRGB"](r,e,a,n);t["LinearRGB to sRGB"](r,e,a,n);return r},"rgY to xyY":function(r,e,a,n){t["rgY to LinearRGB"](r,e,a,n);t["LinearRGB to XYZ"](r,e,a,n);t["XYZ to xyY"](r,e,a,n);return r},"xyY to rgY":function(r,e,a,n){t["xyY to XYZ"](r,e,a,n);t["XYZ to LinearRGB"](r,e,a,n);t["LinearRGB to rgY"](r,e,a,n);return r},"RGB to xyY":function(r,e,a,n){t["sRGB to LinearRGB"](r,e,a,n);t["LinearRGB to XYZ"](r,e,a,n);t["XYZ to xyY"](r,e,a,n);return r},"xyY to RGB":function(r,e,a,n){t["xyY to XYZ"](r,e,a,n);t["XYZ to LinearRGB"](r,e,a,n);t["LinearRGB to sRGB"](r,e,a,n);return r},"RGB to 1960 uvY":function(r,e,a,n){t["sRGB to LinearRGB"](r,e,a,n);t["LinearRGB to XYZ"](r,e,a,n);t["XYZ to xyY"](r,e,a,n);t["xyY to 1960 uvY"](r,e,a,n);return r},"1960 uvY to RGB":function(r,e,a,n){t["1960 uvY to xyY"](r,e,a,n);t["xyY to XYZ"](r,e,a,n);t["XYZ to LinearRGB"](r,e,a,n);t["LinearRGB to sRGB"](r,e,a,n);return r},"RGB to 1976 u'v'Y":function(r,e,a,n){t["sRGB to LinearRGB"](r,e,a,n);t["LinearRGB to XYZ"](r,e,a,n);t["XYZ to 1976 u'v'Y"](r,e,a,n);return r},"1976 u'v'Y to RGB":function(r,e,a,n){t["1976 u'v'Y to XYZ"](r,e,a,n);t["XYZ to LinearRGB"](r,e,a,n);t["LinearRGB to sRGB"](r,e,a,n);return r}};r.Colorspaces=t})(Matrix);(function(r,t){"use strict";var e={lab2lch:"Lab to Lch",lab2srgb:"Lab to RGB",lab2xyz:"Lab to XYZ",lch2lab:"Lch to Lab",srgb2cmyk:"RGB to CMY",srgb2lab:"RGB to Lab",srgb2xyz:"RGB to XYZ",upvpl2xyz:"1976 u'v'Y to XYZ",uvl2xyz:"1960 uvY to XYZ",xyl2xyz:"xyY to XYZ",xyz2lab:"XYZ to Lab",xyz2srgb:"XYZ to RGB",xyz2upvpl:"XYZ to 1976 u'v'",xyz2uvl:"XYZ to 1960 uv",xyz2xyl:"XYZ to xyY"};t.applycform=function(t){if(this.ndims()!==3||this.getSize(2)<3){throw new Error("Matrix.applycform: Matrix must be an "+"image with RGB components.")}var a=this.getSize(0)*this.getSize(1);if(typeof t==="string"){if(r.Colorspaces[t]){r.Colorspaces[t](this.getData(),a,a,1)}else if(r.Colorspaces[e[t]]){r.Colorspaces[e[t]](this.getData(),a,a,1)}else{throw new Error("Matrix.applycform: Unknown color transformation "+t)}}else if(typeof t==="function"){if(t.length===3){r.Colorspaces.applyFunctionRGB(this.getData(),t,a,a,1)}else if(t.length===1){r.Colorspaces.applyFunctionColor(this.getData(),t,a,a,1)}}else{t=r.toMatrix(t);if(!Tools.checkSizeEquals(t.size(),[3,3],r.ignoreTrailingDims)){throw new Error("Matrix.applycform: Matrix argument must be 3x3.")}r.Colorspaces.matrix(this.getData(),t.getData(),a,a,1)}return this};r.applycform=function(r,t){return r.getCopy().applycform(t)};t.toColormap=function(t){var e=this.getData(),a=this.getSize(),n=e.length;a[2]=3;var i=new r(a),o=i.getData();var s=o.subarray(0,n),f=o.subarray(n,2*n),v=o.subarray(2*n,3*n);var u,l,h=Math.floor;if(t==="JET"){for(u=0;u<n;u++){l=e[u]*4;if(l>=4){l=3.99}else if(l<0){l=0}switch(h(l*2)%8){case 0:s[u]=0;f[u]=0;v[u]=l+.5;break;case 1:case 2:s[u]=0;v[u]=1;f[u]=l-.5;break;case 3:case 4:s[u]=l-1.5;f[u]=1;v[u]=2.5-l;break;case 5:case 6:s[u]=1;f[u]=3.5-l;v[u]=0;break;case 7:s[u]=4.5-l;f[u]=0;v[u]=0;break}}}else if(t==="HUE"){for(u=0;u<n;u++){var c=e[u];l=h(c*6)%6;var g=c*6-l;switch(l){case 0:s[u]=1;f[u]=g;v[u]=0;break;case 1:s[u]=1-g;f[u]=1;v[u]=0;break;case 2:s[u]=0;f[u]=1;v[u]=g;break;case 3:s[u]=0;f[u]=1-g;v[u]=1;break;case 4:s[u]=g;f[u]=0;v[u]=1;break;case 5:s[u]=1;f[u]=0;v[u]=1-g;break}}}else if(t==="HUE"){o.set(e)}return i};t.correctImage=function(t,e){e=e||r.CIE.getIlluminant("D65");var a=r.CIE.getIlluminantConversionMatrix(e,t);this.applycform("sRGB to LinearRGB").applycform(a).applycform("LinearRGB to sRGB");return this};r.correctImage=function(r,t,e){return r.getCopy().correctImage(t,e)};t.im2CCT=function(){var t=r.CIE["xyY to CCT"];var e=this.getSize();e.pop();var a=new r(e,"single");var n=this.getData(),i=a.getData();var o=this.getView();var s=o.getStep(0),f=o.getEnd(0),v;var u=o.getStep(1),l=o.getEnd(1),h;var c=o.getStep(2);var g,w,d,p,m,y=[];for(g=0,h=l;g!==h;g+=u){w=g;d=g+c;p=g+2*c;for(v=g+f;w!==v;w+=s,d+=s,p+=s){y[0]=n[w];y[1]=n[d];y[2]=n[p];m=t(y);m=m<1668?1668:m>2e4?2e4:m;m=isNaN(m)?24999:m;i[w]=m}}return a};t.CCT2im=function(){var t=r.CIE["CCT to xyY"];var e=this.getSize();e[2]=3;var a=new r(e,"single");var n=this.getData(),i=a.getData();var o=a.getView();var s=o.getStep(0),f=o.getEnd(0),v;var u=o.getStep(1),l=o.getEnd(1),h;var c=o.getStep(2);var g,w,d,p,m=[];for(g=0,h=l;g!==h;g+=u){w=g;d=g+c;p=g+2*c;for(v=g+f;w!==v;w+=s,d+=s,p+=s){m=t(n[w]);i[w]=m[0];i[d]=m[1];i[p]=m[2]}}return a}})(Matrix,Matrix.prototype);