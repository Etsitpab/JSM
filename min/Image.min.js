/**
 * This program is free software: you can redistribute it and/or modify    
 * it under the terms of the GNU General Public License as published by        
 * the Free Software Foundation, either version 3 of the License, or 
 * (at your option) any later version.
 * 
 * This program is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU General Public License for more details.
 * 
 * You should have received a copy of the GNU General Public License
 * along with this program.  If not, see <http://www.gnu.org/licenses/>.
 * 
 * @author Baptiste Mazin     <baptiste.mazin@telecom-paristech.fr> 
 * @author Guillaume Tartavel <guillaume.tartavel@telecom-paristech.fr> 
 */
(function(r,t){"use strict";var e=typeof module!=="undefined"&&module.exports?true:false;var a,i,n;if(e){a=require("fs");i=require("canvas");n=i.Image}else{n=Image}var o=function(r,t){var a;if(e){a=new i}else{a=document.createElement("canvas")}a.width=r||0;a.height=t||0;return a};t.convertImage=function(t){var e=new r(this.getSize(),t);var a,i;if(this.isfloat()||this.islogical()){a=[0,1]}else if(this.isinteger()){a=[r.intmin(this.type()),r.intmax(this.type())]}var n=a[0],o=1/(a[1]-a[0]);if(e.isfloat()||this.islogical()){i=[0,1]}else if(e.isinteger()){i=[r.intmin(e.type()),r.intmax(e.type())]}var s=i[0],f=o*(i[1]-i[0]);var v=this.getData(),u=new e.getData;var h,l;for(h=0,l=v.length;h<l;h++){u[h]=(v[h]-n)*f-s}return new r(this.getSize(),u)};t.im2double=function(){return this.convertImage("double")};t.im2single=function(){return this.convertImage("single")};t.im2uint8=function(){return this.convertImage("uint8")};t.im2uint8c=function(){return this.convertImage("uint8c")};t.getImageData=function(){var t;if(this.isfloat()||this.islogical()){t=[0,1]}else if(this.isinteger()){t=[r.intmin(this.type()),r.intmax(this.type())]}var e=t[0],a=255/(t[1]-t[0]);var i=this.getSize(1),n=this.getSize(0);var s=o().getContext("2d").createImageData(i,n);var f=n*i,v;var u=this.getData(),h=s.data;var l,g,c,w,p,m,M;switch(this.getSize(2)){case 1:for(g=0,l=0;g<n;g++){for(c=g,v=g+f;c<v;c+=n){M=(u[c]-e)*a;h[l++]=M;h[l++]=M;h[l++]=M;h[l++]=255}}break;case 2:for(g=0,l=0;g<n;g++){for(c=g,w=g+f,v=g+f;c<v;c+=n,w+=n){M=(u[c]-e)*a;h[l++]=M;h[l++]=M;h[l++]=M;h[l++]=(u[w]-e)*a}}break;case 3:for(g=0,l=0;g<n;g++){for(c=g,w=g+f,p=g+2*f,v=w;c<v;c+=n,w+=n,p+=n){h[l++]=(u[c]-e)*a;h[l++]=(u[w]-e)*a;h[l++]=(u[p]-e)*a;h[l++]=255}}break;case 4:for(g=0,l=0;g<n;g++){for(c=g,w=c+f,p=w+f,m=p+f,v=w;c<v;c+=n,w+=n,p+=n,m+=n){h[l++]=(u[c]-e)*a;h[l++]=(u[w]-e)*a;h[l++]=(u[p]-e)*a;h[l++]=(u[m]-e)*a}}break}return s};t.toImage=function(r){if(e){throw new Error("Matrix.toImage: Canvas doesn't exist.")}var t=o(this.getSize(1),this.getSize(0));var a=this.getImageData();t.getContext("2d").putImageData(a,0,0);var i=new Image;i.src=t.toDataURL();i.onload=r;return i};if(e){r.prototype.imwrite=function(r,t){var e=o(this.getSize(1),this.getSize(0));e.getContext("2d").putImageData(this.getImageData(),0,0);var i=a.createWriteStream(r),n;if(/\.(png)$/i.test(r.toLowerCase())){n=e.pngStream()}else if(/\.(jpeg|jpg)$/i.test(r.toLowerCase())){n=e.jpegStream()}else{throw new Error("Matrix.imwrite: invalid file extension.")}n.on("data",function(r){i.write(r)});if(t){n.on("end",t.bind(this))}}}r.fspecial=function(t,e,a){var i,n,o,s;var f,v,u,h,l,g,c,w;var p,m,M;var y=function(r,t){return Math.exp(-(r*r+t*t)/(2*s*s))};switch(t.toLowerCase()){case"average":if(Tools.isArrayLike(e)){o=e[0];n=e[1]}else{o=e===undefined?3:e;n=o}return r.ones([o,n])["./"](o*n);case"disk":break;case"gaussian":if(Tools.isArrayLike(e)){o=e[0];n=e[1]}else{o=e===undefined?3:e;n=o}s=a===undefined?.5:a;f=[];w=0;for(h=0,v=-(n-1)/2,g=n*o;h<g;h+=o,v++){for(l=h,c=h+o,u=-(o-1)/2;l<c;l++,u++){p=y(v,u);f[l]=p;w+=p}}for(m=0,M=f.length;m<M;m++){f[m]/=w}return new r([o,n],f);case"laplacian":i=e===undefined?.2:e;return new r([3,3],[i/4,(1-i)/4,i/4,(1-i)/4,-1,(1-i)/4,i/4,(1-i)/4,i/4])[".*"](4/(i+1));case"log":if(Tools.isArrayLike(e)){o=e[0];n=e[1]}else{o=e===undefined?3:e;n=o}s=a===undefined?.5:a;f=[];w=0;for(h=0,v=-(n-1)/2,g=n*o;h<g;h+=o,v++){for(l=h,c=h+o,u=-(o-1)/2;l<c;l++,u++){p=y(v,u);f[l]=(v*v+u*u-2*s*s)*p/Math.pow(s,4);w+=p}}for(m=0,M=f.length;m<M;m++){f[m]/=w}w=0;for(m=0,M=f.length;m<M;m++){w+=f[m]}w/=n*o;for(m=0,M=f.length;m<M;m++){f[m]-=w}return new r([o,n],f);case"unsharp":i=e===undefined?.2:e;return new r([3,3],[-i,i-1,-i,i-1,i+5,i-1,-i,i-1,-i])[".*"](1/(i+1));case"prewitt":return new r([3,3],[1,0,-1,1,0,-1,1,0,-1]);case"sobel":return new r([3,3],[1,0,-1,2,0,-2,1,0,-1]);default:return}};t.filter1d=function(t,e){var a=this.constructor.name+".filter1d: ";if(e===undefined){e="C"}if(!t.isvector()){throw new Error("Matrix.filter1d: Kernel must be a vector")}var i=t.getLength(),n=t.getData();if(typeof e==="string"){switch(e.toUpperCase()){case"C":case"CL":e=Math.floor((i-1)/2);break;case"CR":e=Math.ceil((i-1)/2);break;case"L":e=0;break;case"R":e=i-1;break;default:throw new Error(a+"unknown origin position '"+e+"'")}}else if(typeof e==="number"){if(e<0){e+=i}if(e<0||e>=i){throw new Error(a+"origin value must satisfy : |origin| < kernel.length")}}var o=new r(this.getSize(),this.getDataType());var s=this.getData(),f=o.getData();var v=o.getView();var u=v.getStep(2),h=v.getEnd(2);var l=v.getStep(1),g=v.getEnd(1);var c=v.getEnd(0);if(e>=c/2){throw new Error("Matrix.filter1d: Kernel is too large.")}var w,p=c-e;var m,M,y,d,x,b,L;for(m=0;m!==h;m+=u){for(M=m,y=m+g;M!==y;M+=l){for(d=M,x=M+e;d<x;d++){for(w=0,L=0,b=2*M+e-d;b>M;L++,b--){w+=n[L]*s[b]}for(b=M;L<i;L++,b++){w+=n[L]*s[b]}f[d]=w}for(d=M+e,x=M+p;d<x;d++){for(w=0,L=0,b=d-e;L<i;L++,b++){w+=n[L]*s[b]}f[d]=w}for(d=M+p,x=M+c;d<x;d++){for(w=0,L=0,b=d-e;b<x;L++,b++){w+=n[L]*s[b]}for(b=x-2;L<i;L++,b--){w+=n[L]*s[b]}f[d]=w}}}return o};t.separableFilter=function(r,t){if(t===undefined){t=r}return this.filter1d(r).permute([1,0,2]).filter1d(t).permute([1,0,2])};t.gaussian=function(r,t,e){e=e||3;var a=f.gaussian(r,0,e);var i;if(typeof t==="number"){i=f.gaussian(t,0,e)}else{i=a}return this.separableFilter(a,i)};t.gaussianGradient=function(t){if(!t){t=2}var e=f.gaussian(t,1,3);var a=f.gaussian(t,0,3);var i=this.separableFilter(a,e);var n=this.separableFilter(e,a);var o=.5/Math.PI;var s=r.zeros(this.getSize()),v=r.zeros(this.getSize());var u=i.getData(),h=n.getData();var l=s.getData(),g=v.getData();var c,w;for(c=0,w=u.length;c<w;c++){var p=u[c],m=h[c];l[c]=Math.sqrt(p*p+m*m);var M=Math.atan2(m,p)*o;g[c]=M<0?M+1:M}return{x:i,y:n,norm:s,phase:v}};t.gradient=function(t,e,a,i,n){var o=.70710678,s=6.8284271,f=.35355339;var v=.29289322,u=1/s,h=.5/Math.PI;var l={},g,c,w,p,m;var M=this.getSize();var y=this.getDataType();if(t){l.x=new r(M,y);g=l.x.getData()}if(e){l.y=new r(M,y);c=l.y.getData()}if(a){l.norm=new r(M,y);w=l.norm.getData()}if(i){l.phase=new r(M,y);p=l.phase.getData()}if(n){l.laplacian=new r(M,y);m=l.laplacian.getData()}var d=this.getData();var x=this.getView();var b=x.getStep(2),L=x.getEnd(2);var Y=x.getStep(1),B=x.getEnd(1);var R=x.getEnd(0);var G,S,D,z,E,I,C;for(G=0;G!==L;G+=b){for(S=G+Y,D=G+B-Y;S!==D;S+=Y){for(I=S-Y,z=S,C=S+Y,E=S+R-2;z<E;z){var X=d[I],Z=d[++I],F=d[I+1];var k=d[z],A=d[++z],q=d[z+1];var H=d[C],V=d[++C],T=d[C+1];var j=T-X,P=F-H;var U=v*(V-Z+f*(j-P));var N=v*(k-q-f*(j+P));if(t){g[z]=U}if(e){c[z]=N}if(a){w[z]=Math.sqrt(U*U+N*N)}if(i){var O=Math.atan2(-N,U)*h;p[z]=O<0?O+1:O}if(n){m[z]=(o*(X+F+H+T)+(k+Z+V+q))*u-A}}}}return l};t.conv=function(t,e){if(!this.isvector()||!t.isvector()){throw new Error("Matrix.conv: Input must be vector.")}var a=this.getData(),i=a.length;var n=t.getData(),o=n.length;if(i<o){return t.conv(this,e)}var s=Tools.checkType(this.getDataType());var f=new s(i+o-1),v=f.length;var u,h,l,g,c,w,p;for(c=0,w=o-1;c<w;c++){for(p=0,h=0,l=c+1,g=c;h<l;h++,g--){p+=a[h]*n[g]}f[c]=p}for(c=o-1,u=0,w=i;c<w;c++,u++){for(p=0,h=u,l=c+1,g=o-1;h<l;h++,g--){p+=a[h]*n[g]}f[c]=p}for(c=i,u=i-o+1;c<v;c++,u++){for(p=0,h=u,g=o-1;h<i;h++,g--){p+=a[h]*n[g]}f[c]=p}switch(e){case undefined:case"full":return new r(v,f);case"same":var m=Math.ceil(o/2);return new r(i,f.subarray(m,m+i));case"valid":return new r(i-o+1,f.subarray(o-1,i));default:throw new Error("Matrix.conv: Invalid shape parameter.")}};var s=function(r){var t=r.getView(),e=r.getData();var a=t.getStep(2),i=t.getEnd(2);var n=t.getStep(1),o=t.getEnd(1),s;var f=t.getEnd(0),v;var u,h,l;for(u=0;u<i;u+=a){for(h=u+1,v=u+f;h<v;h++){e[h]+=e[h-1]}for(l=u+n,s=u+o;l<s;l+=n){var g=e[l];e[l]+=e[l-n];for(h=l+1,v=l+f;h<v;h++){g+=e[h];e[h]=e[h-n]+g}}}};t.fastBlur=function(t,e,a){a=a||3;e=e||t;var i=Math.round(Math.sqrt(12/a*t*t+1)/2)*2+1;var n=Math.round(Math.sqrt(12/a*e*e+1)/2)*2+1;var o=r.zeros(this.getSize());var f=this.getView();var v=f.getStep(2),u=f.getEnd(2);var h=f.getStep(1),l=f.getEnd(1);var g=f.getEnd(0);e=n/2|0;t=(i/2|0)*h;var c=i/2|0;var w,p,m,M,y,d,x;var b,L,Y;var B=this.im2double();for(var R=0;R<a;R++){s(B);var G=B.getData(),S=o.getData();var D=t+e+h+1,z=t+e,E=-(t+h)+e,I=t-e-1;var C=G.subarray(z),X=G.subarray(I);for(m=0;m<u;m+=v){for(d=m,y=0,p=m+e+1;d<p;d++,y++){L=y+e+1;for(x=d,M=0,w=d+t+h;x<w;x+=h,M++){S[x]=C[x]/((M+c+1)*L)}b=1/(i*L);for(x=d+t+h,w=d+l-t;x<w;x+=h){S[x]=(C[x]-G[x+E])*b}Y=G[d+l-h+e];for(x=d+l-t,w=d+l;x<w;x+=h){S[x]=Y-G[x+E];S[x]/=(t+w-x)/h*L}}for(M=m,w=m+t+h;M<w;M+=h){b=1/(((M-m+t)/h+1)*n);for(y=M+e+1,p=M+g-e;y<p;y++){S[y]=C[y]-X[y];S[y]*=b}}b=1/(i*n);for(M=m+t+h,w=m+l-t;M<w;M+=h){for(y=M+e+1,p=M+g-e;y<p;y++){S[y]=(G[y-D]+C[y]-G[y+E]-X[y])*b}}for(M=m+l-t,w=m+l;M<w;M+=h){b=1/((m+l-M+t)/h*n);for(y=M+e+1,p=M+g-e;y<p;y++){S[y]=G[y-D]+G[m+l-h+y-M+e]-G[m+l-h+y-M-e-1]-G[y+E];S[y]*=b}}for(y=m+g-e,p=m+g;y<p;y++){for(M=y,w=y+t+h;M<w;M+=h){S[M]=G[M-y+m+g-1+t]-X[M];S[M]/=((M-y+t)/h+1)*(e+(g-(y-m)))}b=1/(i*(e+(g-(y-m))));for(M=y+t+h,w=y+l-t;M<w;M+=h){S[M]=G[M-y+m+g-1+t]-G[M-y+m+g-1-t-h]+G[M-D]-X[M];S[M]*=b}for(M=y+l-t,w=y+l;M<w;M+=h){S[M]=G[m+l-h+g-1]+G[M-D]-G[m+M-y+g-1-t-h]-G[m+l-h+y-m-e-1];S[M]/=(l-(M-y)+t)/h*(e+(g-(y-m)))}}}var Z=o;o=B;B=Z}return Z};var f={};f.normalize=function(r){var t;var e=r.length;var a=0;for(t=0;t<e;t++){a+=Math.abs(r[t])}if(a!==0){for(t=0;t<e;t++){r[t]/=a}}return r};f.gaussian=function(t,e,a){var i,n;if(a===undefined){a=3}if(e===undefined){e=0}var o=1+2*Math.ceil(t*Math.sqrt(a*2*Math.log(10)));var s=new r.dataType(o);var f=(o-1)/2;var v=0,u=Math.abs;for(i=0;i<(o+1)/2;i++){n=i-f;var h=1/(Math.sqrt(2*Math.PI)*t);h*=Math.exp(-(n*n)/(2*t*t));s[i]=s[o-1-i]=h}switch(e){case 0:for(i=0,v=0;i<s.length;i++){v+=u(s[i])}break;case 1:for(i=0,v=0;i<s.length;i++){n=i-f;s[i]*=-n/Math.pow(t,2);v+=u(n*s[i])}break;case 2:for(i=0,v=0;i<s.length;i++){n=i-f;s[i]*=n*n/Math.pow(t,4)-1/Math.pow(t,2);v+=u(s[i])}v/=s.length;for(i=0;i<s.length;i++){s[i]-=u(v)}for(i=0,v=0;i<s.length;i++){n=i-f;v+=u(.5*n*n*s[i])}break;default:throw new Error("Kernel.gaussian: Derive order can be 0,1 or 2 but not "+e)}if(v!==0){for(i=0;i<s.length;i++){s[i]/=v}}return new r(s.length,s)};t.imshow=function(r,t){if(e){console.warn("Matrix.imshow: function not available in nodejs.");return}var a=this.constructor.name+".imshow: ";var i=this.getSize(1);var n=this.getSize(0);if(typeof r==="string"&&document.getElementById(r)){r=document.getElementById(r)}var o;if(r===undefined||r===null){r=document.createElement("canvas");o=window.open("","","width="+i,"height="+n);o.document.body.appendChild(r)}if(!(r instanceof HTMLCanvasElement)){throw new Error(a+"Invalid canvas.")}var s=this.getImageData();if(t===undefined||t===1){r.width=i;r.height=n;r.getContext("2d").putImageData(s,0,0)}else{if(t==="fit"){var f=r.width/i;var v=r.height/n;t=Math.min(f,v);t=t>1?1:t}else if(typeof t!=="number"){throw new Error(a+"scale must be a number or 'fit'")}r.width=Math.round(i*t);r.height=Math.round(n*t);var u=document.createElement("canvas");u.width=i;u.height=n;var h=u.getContext("2d");h.putImageData(s,0,0);r.getContext("2d").drawImage(u,0,0,i,n,0,0,r.width,r.height)}return o||this};t.print=function(){var r=this.imshow();r.print();r.close();return this};t.imagesc=function(r,t){var e=this.min().getDataScalar(),a=this.max().getDataScalar();if(e-a===0){return this["-"](e).imshow(r,t)}return this["-"](e)["./"](a-e).imshow(r,t)};t.imtransform=function(t){t=r.toMatrix(t);var e=this.getSize(0),a=this.getSize(1);var i=o(a,e),n=i.getContext("2d");var s=o(),f=s.getContext("2d");var v=r.toMatrix([0,0,1,a,0,1,a,e,1,0,e,1]).reshape([3,4]);var u=t.mtimes(v).transpose();var h=u.max(0).getData(),l=u.min(0).getData();var g=this.getImageData();n.putImageData(g,0,0);var c=t.getData();s.width=h[0]-l[0];s.height=h[1]-l[1];f.translate(-l[0],-l[1]);f.transform(c[0],c[1],c[3],c[4],c[6],c[7]);f.drawImage(i,0,0);return r.imread(s).convertImage(this.type())};t.imhist=function(t){if(!this.ismatrix()){throw new Error("Matrix.imhist: This function only works on grey-level images.")}t=t||256;var e=this.getData();var a=r.zeros(t,1),i=a.getData();var n;if(this.isinteger()){n=r.intmax(this.type())}else if(this.islogical()){n=1;t=2}else if(this.isfloat()){n=1}else{throw new Error("Matrix.imhist: unknow data type.")}var o,s,f=1/n*t;for(o=0,s=e.length;o<s;o++){i[e[o]*f|0]++}return a};(function(){var e=function(r,t){var e=r.length;var a=new Float32Array(t);var i,n=Math.floor;for(i=0;i<e;++i){var o=n(r[i]*t);o=o>=t?t-1:o;++a[o]}var s=1/e;for(i=1;i<t;++i){a[i]+=a[i-1];a[i-1]*=s}a[i-1]*=s;return a};t.histeq=function(t){var a=this.im2double();var i=a;if(this.getSize(2)>1){i=a.applycform("RGB to HSL").get([],[],2)}i=i.getData();var n=e(i,t);var o=Math.floor;for(var s=0;s<i.length;++s){i[s]=n[o(i[s]*(t-1))]}var f=new r([a.size(0),a.size(1)],i);a.set([],[],2,f);if(this.getSize(2)>1){a.applycform("HSL to RGB")}return a}})();t.rgb2gray=function(){if(this.ndims()!==3||this.getSize(2)<3){throw new Error("Matrix.rgb2gray: Matrix must be an "+"image with RGB components.")}var t=this.getSize();t[2]-=2;var e=new r(t,this.getDataType());var a=this.getData(),i=e.getData();var n=this.getView();var o=n.getEnd(0),s;var f=n.getStep(1),v=n.getEnd(1),u;var h=n.getStep(2);var l,g,c,w;for(l=0,u=v;l!==u;l+=f){g=l;c=l+h;w=l+2*h;for(s=l+o;g<s;g++,c++,w++){i[g]=.3*a[g]+.59*a[c]+.11*a[w]}}if(this.getSize(2)===4){var p=i.subarray(h);var m=a.subarray(3*h);p.set(m)}return e}})(Matrix,Matrix.prototype);(function(){var r=function(r,t,e){this.x=r;this.y=t;this.parent=e};r.prototype.initChildren=function(t,e){var a=this.x,i=this.y;if(i+1<e){this.top=new r(a,i+1,this)}if(i-1>=0){this.bottom=new r(a,i-1,this)}if(a+1<t){this.left=new r(a+1,i,this)}if(a-1>=0){this.right=new r(a-1,i,this)}};r.prototype.remove=function(r){if(this.bottom===r){this.bottom=undefined}else if(this.top===r){this.top=undefined}else if(this.right===r){this.right=undefined}else if(this.left===r){this.left=undefined}return this};r.prototype.getNext=function(){if(this.top){return this.top}if(this.bottom){return this.bottom}if(this.left){return this.left}if(this.right){return this.right}if(this.parent){return this.parent.remove(this).getNext()}return undefined};Matrix.prototype.getConnectedComponent=function(t,e,a){var i=this.getSize(0),n=this.getSize(1),o=this.getSize(2);var s=a*a;var f=new Matrix([i,n],"logical"),v=new Matrix([i,n],"logical");var u=f.getData(),h=this.getData(),l=v.getData();window.CC=f;window.IV=v;var g=e+i*t;var c;if(o===1){if(this.type()==="logical"){}else{var w=h[g];c=function(r){var t=h[r]-w;return t*t<s}}}else if(o===3){var p=h[g],m=h[g+i*n],M=h[g+i*n*2];var y=h,d=h.subarray(i*n),x=h.subarray(i*n*2);c=function(r){var t=y[r]-p,e=d[r]-m,a=x[r]-M;return t*t+e*e+a*a<s}}else{throw new Error("Matrix.getConnectedComponent: This function only support "+"images with depth 1 or 3.")}var b=new r(t,e),L=b;while(L!==undefined){var Y=L.x,B=L.y,R=B+i*Y;if(l[R]===1){L=L.parent.remove(L).getNext();continue}l[R]=1;if(c(R)){u[R]=1;L.initChildren(n,i)}L=L.getNext()}return f};Matrix.prototype.bwconncomp=function(){}})();(function(r,t){"use strict";var e=function(r,t,e,a){var i=t>>1,n=r>>1;return{xS:new Int32Array([0,0,0,n,n,n,e-n,e-n,e-n]),xE:new Int32Array([n,n,n,e-n,e-n,e-n,e,e,e]),yS:new Int32Array([0,i,a-i,0,i,a-i,0,i,a-i]),yE:new Int32Array([i,a-i,a,i,a-i,a,i,a-i,a]),jS:new Int32Array([0,0,0,-n,-n,-n,-n,-n,-n]),jE:new Int32Array([n+1,n+1,n+1,n+1,n+1,n+1,e,e,e]),iS:new Int32Array([0,-i,-i,0,-i,-i,0,-i,-i]),iE:new Int32Array([i+1,i+1,a,i+1,i+1,a,i+1,i+1,a]),lS:new Int32Array([n,n,n,0,0,0,0,0,0]),lE:new Int32Array([r,r,r,r,r,r,n+e,n+e,n+e]),kS:new Int32Array([i,0,0,i,0,0,i,0,0]),kE:new Int32Array([t,t,i+a,t,t,i+a,t,t,i+a]),jxS:new Int32Array([0,0,0,1,1,1,1,1,1]),jxE:new Int32Array([1,1,1,1,1,1,0,0,0]),iyS:new Int32Array([0,1,1,0,1,1,0,1,1]),iyE:new Int32Array([1,1,0,1,1,0,1,1,0])}};var a=function(r,t,e,a,i,n,o,s,f,v,u){var h=-Infinity;for(var l=o,g=v;l<u;l+=e,g+=a){for(var c=n+l,w=s+g,p=f+l;c<p;c++,w++){if(r[c]>h&&t[w]){h=r[c]}}}return h};var i=function(r,t,e,a,i,n,o,s,f,v,u){var h=Infinity;for(var l=o,g=v;l<u;l+=e,g+=a){for(var c=n+l,w=s+g,p=f+l;c<p;c++,w++){if(r[c]<h&&t[w]){h=r[c]}}}return h};var n=function(r,t,e,a,i,n,o,s,f,v,u){var h=0;for(var l=o,g=v;l<u;l+=e,g+=a){for(var c=n+l,w=s+g,p=f+l;c<p;c++,w++){h+=r[c]*t[w]}}return h};var o=function(t,a,i){var n=t.getSize(0),o=t.getSize(1),s=t.getSize(2),f=t.getData();var v=new r(t.getSize(),t.type()),u=v.getData();var h=a.getSize(0),l=a.getSize(1),g=a.getData();var c=e(l,h,o,n);var w=c.xS,p=c.xE,m=c.yS,M=c.yE,y=c.jS,d=c.jE,x=c.iS,b=c.iE,L=c.lS,Y=c.kS,B=c.jxS,R=c.jxE,G=c.iyS,S=c.iyE;var D,z,E,I,C,X,Z,F,k,A;var q,H,V,T;for(z=0,q=f.length;z<q;z+=o*n){var j=f.subarray(z,z+o*n),P=u.subarray(z,z+o*n);for(D=0;D<9;D++){for(E=w[D],H=p[D],C=E*n;E<H;E++,C+=n){var U=(y[D]+(B[D]?E:0))*n,N=(d[D]+(R[D]?E:0))*n;var O=(L[D]-(B[D]?0:E))*h;for(I=m[D],V=M[D],X=I+C;I<V;I++,X++){var K=x[D]+(G[D]?I:0),W=b[D]+(S[D]?I:0);var $=Y[D]-(G[D]?0:I);P[X]=i(j,g,n,h,X,K,U,$,W,O,N)}}}}return v};t.imdilate=function(r){return o(this,r,a)};t.imerode=function(r){return o(this,r,i)};t.imopen=function(r){return o(o(this,r,i),r,a)};t.imclose=function(r){return o(o(this,r,a),r,i)};t.imfilter=function(r){return o(this,r,n)};t.median=function(r){var t=r.length*.5|0;var e=function(r,e,a,i,n,o,s,f,v,u,h){var l=[];for(var g=s,c=u;g<h;g+=a,c+=i){for(var w=o+g,p=f+c,m=v+g;w<m;w++,p++){if(e[p]){l.push(r[w])}}}return l.sort()[t]};return o(this,r,e)};t.imbilateral=function(t,e,a){a=a||3;var i=r.fspecial("gaussian",Math.round(a*t/2)*2+1,t);var n=-1/(2*e);var s=function(r,t,e,a,i,o,s,f,v,u,h){var l=0,g=0,c=r[i];for(var w=s,p=u;w<h;w+=e,p+=a){for(var m=o+w,M=f+p,y=v+w;m<y;m++,M++){var d=c-r[m];var x=t[M]*Math.exp(n*d*d);l+=x;g+=r[m]*x}}return g/l};return o(this,i,s)}})(Matrix,Matrix.prototype);(function(r,t){"use strict";var e=460;var a=new Uint16Array([2,3,5,7,11,13,17,19,23,29,31,37,41,43,47,53,59,61,67,71,73,79,83,89,97,101,103,107,109,113,127,131,137,139,149,151,157,163,167,173,179,181,191,193,197,199,211,223,227,229,233,239,241,251,257,263,269,271,277,281,283,293,307,311,313,317,331,337,347,349,353,359,367,373,379,383,389,397,401,409,419,421,431,433,439,443,449,457,461,463,467,479,487,491,499,503,509,521,523,541,547,557,563,569,571,577,587,593,599,601,607,613,617,619,631,641,643,647,653,659,661,673,677,683,691,701,709,719,727,733,739,743,751,757,761,769,773,787,797,809,811,821,823,827,829,839,853,857,859,863,877,881,883,887,907,911,919,929,937,941,947,953,967,971,977,983,991,997,1009,1013,1019,1021,1031,1033,1039,1049,1051,1061,1063,1069,1087,1091,1093,1097,1103,1109,1117,1123,1129,1151,1153,1163,1171,1181,1187,1193,1201,1213,1217,1223,1229,1231,1237,1249,1259,1277,1279,1283,1289,1291,1297,1301,1303,1307,1319,1321,1327,1361,1367,1373,1381,1399,1409,1423,1427,1429,1433,1439,1447,1451,1453,1459,1471,1481,1483,1487,1489,1493,1499,1511,1523,1531,1543,1549,1553,1559,1567,1571,1579,1583,1597,1601,1607,1609,1613,1619,1621,1627,1637,1657,1663,1667,1669,1693,1697,1699,1709,1721,1723,1733,1741,1747,1753,1759,1777,1783,1787,1789,1801,1811,1823,1831,1847,1861,1867,1871,1873,1877,1879,1889,1901,1907,1913,1931,1933,1949,1951,1973,1979,1987,1993,1997,1999,2003,2011,2017,2027,2029,2039,2053,2063,2069,2081,2083,2087,2089,2099,2111,2113,2129,2131,2137,2141,2143,2153,2161,2179,2203,2207,2213,2221,2237,2239,2243,2251,2267,2269,2273,2281,2287,2293,2297,2309,2311,2333,2339,2341,2347,2351,2357,2371,2377,2381,2383,2389,2393,2399,2411,2417,2423,2437,2441,2447,2459,2467,2473,2477,2503,2521,2531,2539,2543,2549,2551,2557,2579,2591,2593,2609,2617,2621,2633,2647,2657,2659,2663,2671,2677,2683,2687,2689,2693,2699,2707,2711,2713,2719,2729,2731,2741,2749,2753,2767,2777,2789,2791,2797,2801,2803,2819,2833,2837,2843,2851,2857,2861,2879,2887,2897,2903,2909,2917,2927,2939,2953,2957,2963,2969,2971,2999,3001,3011,3019,3023,3037,3041,3049,3061,3067,3079,3083,3089,3109,3119,3121,3137,3163,3167,3169,3181,3187,3191,3203,3209,3217,3221,3229,3251,3253,3257]);var i=function(r){if(r==1){return 0}var t=[],i,n,o;for(i=n=0;n<e;n++){if(r%a[n]===0){o=a[n];do{t[i]=o;i++;r=r/o}while(r%o===0)}}if(r!==1){t[i]=r;i++}return t};var n=function(r,t,e){var a=r[t];r[t]=r[e];r[e]=a};var o=function(r,t,e,a){var i=r.length/2,n,o;if(a===1){for(n=0,o=0;n<i;n++){t[n]=r[o++];e[n]=-r[o++]}}else{var s=1/i;for(n=0,o=0;n<i;n++){t[n]=r[o++]*s;e[n]=-r[o++]*s}}};var s=function(r,t){var e=r.length,a,i;var n=new Float64Array(2*e);if(t){for(a=0,i=0;a<e;a++){n[i++]=r[a];n[i++]=-t[a]}}else{for(a=0,i=0;a<e;a++,i++){n[i++]=r[a]}}return n};var f=function(r,t,e){var a,i,o,f,v;var u,h,l,g,c,w;var p,m;var M=r.length,y=s(r,t);var d=M<<1;for(v=1,o=1;v<d;v+=2){if(o>v){n(y,o-1,v-1);n(y,o,v)}a=d>>1;while(a>=2&&o>a){o=o-a;a>>=1}o=o+a}var x=2;while(d>x){f=2*x;w=2*Math.PI/(e*x);u=Math.sin(.5*w);l=-2*u*u;g=Math.sin(w);h=1;c=0;for(a=1;a<x;a+=2){for(v=a-1;v<=d-1;v+=f){o=v+x;p=h*y[o]-c*y[o+1];m=h*y[o+1]+c*y[o];y[o]=y[v]-p;y[o+1]=y[v+1]-m;y[v]+=p;y[v+1]+=m}h=(u=h)*l-c*g+h;c=c*l+u*g+c}x=f}return y};var v=function(r,t,e,a){var i=r.length;var n=new Float64Array(i),o=new Float64Array(i);var f=2*Math.PI/i;for(h=0;h<i;h++){n[h]=Math.cos(h*f);o[h]=e*Math.sin(h*f)}var v=s(r,t),u=new Float64Array(2*i);var h,l,g,c,w,p,m;var M=1,y,d=a.length;for(y=0;y<d;y++){w=a[y];p=i/M/w;m=M*w;for(g=0;g<2*i;g++){u[g]=0}for(l=0;l<w;l++){for(c=0;c<m;c++){var x=c*l%m*p;var b=n[x],L=o[x];var Y=2*p*c,B=2*p*(l+c%M*w);for(h=0;h<p;h++,Y+=2,B+=2){u[Y]+=v[B]*b-v[B+1]*L;u[Y+1]+=v[B]*L+v[B+1]*b}}}var R=v;v=u;u=R;M*=w}return v};var u=function(r,t,e,a,n){var s=r.length,u=i(s),h=u.length;var l=!n?1:-1,g;if(s>1&&u[h-1]!=2){g=v(r,t,l,u)}else{g=f(r,t,l)}return o(g,e,a,l)};var h=function(t,e){if(t.isreal()){t.toComplex()}var a=new r(t.getSize(),Float64Array,true);var i=t.getRealData(),n=t.getImagData();var o=a.getRealData(),s=a.getImagData();var f=t.getSize(0),v=t.numel()/f;for(var h=0,l=0;h<v;h++,l+=f){var g=i.subarray(l,f+l),c=n.subarray(l,f+l);var w=o.subarray(l,f+l),p=s.subarray(l,f+l);u(g,c,w,p,e)}return a};t.fft=function(){return h(this,false)};r.fft=function(t){return h(r.toMatrix(t),false)};t.fft2=function(){var r=h(this,false);r=h(r.transpose(),false);return r.transpose()};r.fft2=function(t){var e=h(r.toMatrix(t),false);e=h(e.transpose(),false);return e.transpose()};t.ifft=function(){return h(this,true)};r.ifft=function(t){return h(r.toMatrix(t),false)};t.ifft2=function(){return this.fft().transpose().fft().transpose()};r.ifft2=function(t){return r.toMatrix(t).fft().transpose().fft().transpose()}})(Matrix,Matrix.prototype);(function(){function r(t){"use strict";var e=this.constructor.name+": ";if(t===undefined){this.name="haar"}else{this.name=t.toLowerCase()}if(r.list[this.name]){var a=r.list[this.name];var i=a.normalized!==undefined&&!a.normalized?function(t){return r.filter(t,"norm")}:function(r){return r};this.filterL=i(a.filterL);this.orthogonal=a.orthogonal?true:false;if(a.filterH){this.filterH=i(a.filterH)}if(a.invFilterL){this.invFilterL=i(a.invFilterL)}if(a.invFilterH){this.invFilterH=i(a.invFilterH)}}if(this.filterL===undefined){var n=e+"unknown wavelet '"+t+"'. \n";n+="User-defined wavelets not implemented yet.";throw new Error(n)}var o=function(t,e){return r.filter(t,"conjugate",e?-1:1)};if(!this.filterH&&this.orthogonal){this.filterH=r.filter(o(this.filterL),"mirror")}if(!this.invFilterL){this.invFilterL=o(this.filterH,true)}if(!this.invFilterH){this.invFilterH=o(this.filterL,false)}return this}r.list={haar:{orthogonal:true,normalized:false,filterL:new Float64Array([1,1])},db2:{name:"Daubechies 2",orthogonal:true,normalized:false,filterL:new Float64Array([1+Math.sqrt(3),3+Math.sqrt(3),3-Math.sqrt(3),1-Math.sqrt(3)])},db4:{name:"Daubechies 4",orthogonal:true,filterL:new Float64Array([-.010597401784997278,.032883011666982945,.030841381835986965,-.18703481171888114,-.02798376941698385,.6308807679295904,.7148465705525415,.23037781330885523])},db8:{name:"Daubechies 8",orthogonal:true,filterL:new Float64Array([-.00011747678400228192,.0006754494059985568,-.0003917403729959771,-.00487035299301066,.008746094047015655,.013981027917015516,-.04408825393106472,-.01736930100202211,.128747426620186,.00047248457399797254,-.2840155429624281,-.015829105256023893,.5853546836548691,.6756307362980128,.3128715909144659,.05441584224308161])},sym2:{name:"Symlets 2",orthogonal:true,filterL:new Float64Array([-.12940952255092145,.22414386804185735,.836516303737469,.48296291314469025])},sym4:{name:"Symlets 4",orthogonal:true,filterL:new Float64Array([-.07576571478927333,-.02963552764599851,.49761866763201545,.8037387518059161,.29785779560527736,-.09921954357684722,-.012603967262037833,.0322231006040427])},sym8:{name:"Symlets 8",orthogonal:true,filterL:[-.0033824159510061256,-.0005421323317911481,.03169508781149298,.007607487324917605,-.1432942383508097,-.061273359067658524,.4813596512583722,.7771857517005235,.3644418948353314,-.05194583810770904,-.027219029917056003,.049137179673607506,.003808752013890615,-.01495225833704823,-.0003029205147213668,.0018899503327594609]},coif1:{name:"Coiflets 1",orthogonal:true,filterL:new Float64Array([-.01565572813546454,-.0727326195128539,.38486484686420286,.8525720202122554,.3378976624578092,-.0727326195128539])},coif2:{name:"Coiflets 2",orthogonal:true,filterL:new Float64Array([-.0007205494453645122,-.0018232088707029932,.0056114348193944995,.023680171946334084,-.0594344186464569,-.0764885990783064,.41700518442169254,.8127236354455423,.3861100668211622,-.06737255472196302,-.04146493678175915,.016387336463522112])},coif4:{name:"Coiflets 4",orthogonal:true,filterL:new Float64Array([-17849850030882614e-22,-32596802368833675e-22,31229875865345646e-21,6233903446100713e-20,-.00025997455248771324,-.0005890207562443383,.0012665619292989445,.003751436157278457,-.00565828668661072,-.015211731527946259,.025082261844864097,.03933442712333749,-.09622044203398798,-.06662747426342504,.4343860564914685,.782238930920499,.41530840703043026,-.05607731331675481,-.08126669968087875,.026682300156053072,.016068943964776348,-.0073461663276420935,-.0016294920126017326,.0008923136685823146])},bi13:{name:"Biorthogonal 1-3",orthogonal:false,filterL:new Float64Array([-.08838834764831845,.08838834764831845,.7071067811865476,.7071067811865476,.08838834764831845,-.08838834764831845]),filterH:new Float64Array([-.7071067811865476,.7071067811865476])},bi31:{name:"Biorthogonal 3-1",orthogonal:false,filterL:new Float64Array([-.3535533905932738,1.0606601717798214,1.0606601717798214,-.3535533905932738]),filterH:new Float64Array([-.1767766952966369,.5303300858899107,-.5303300858899107,.1767766952966369])},bi68:{name:"Biorthogonal 6-8",orthogonal:false,filterL:new Float64Array([0,.0019088317364812906,-.0019142861290887667,-.016990639867602342,.01193456527972926,.04973290349094079,-.07726317316720414,-.09405920349573646,.4207962846098268,.8259229974584023,.4207962846098268,-.09405920349573646,-.07726317316720414,.04973290349094079,.01193456527972926,-.016990639867602342,-.0019142861290887667,.0019088317364812906]),filterH:new Float64Array([0,.014426282505624435,-.014467504896790148,-.07872200106262882,.04036797903033992,.41784910915027457,-.7589077294536541,.41784910915027457,.04036797903033992,-.07872200106262882,-.014467504896790148,.014426282505624435,0,0])},bi97:{name:"Biorthogonal 9-7",orthogonal:false,filterL:new Float64Array([0,.02674875741080976,-.01686411844287495,-.07822326652898785,.2668641184428723,.6029490182363579,.2668641184428723,-.07822326652898785,-.01686411844287495,.02674875741080976]),filterH:new Float64Array([0,-.09127176311424948,.05754352622849957,.591271763114247,-1.115087052456994,.591271763114247,.05754352622849957,-.09127176311424948,0,0])}};r.filter=function(r,t,e){"use strict";var a="Wavelet.filter: ";if(e===undefined||e===0){e=1}if(typeof e!=="number"){throw new Error(a+"argument 'factor' must be a number")}if(typeof t!=="string"){throw new Error(a+"argument 'action' must be a string")}t=t.toLowerCase().substr(0,3);var i;var n=r.length;var o=[];var s=1,f=1;if(t==="mir"){for(i=0;i<n;i++){o[i]=e*r[n-1-i]}return o}if(t==="nor"){var v=0;for(i=0;i<n;i++){v+=r[i]*r[i]}e=!v?1:1/Math.sqrt(v)}else if(t==="con"){f=-1}else if(t!=="res"){throw new Error(a+"unknown action")}for(i=0;i<n;i++,s*=f){o[i]=e*s*r[i]}return o};Matrix.wfilters=function(t,e){var a=new r(t);var i=Matrix.toMatrix(a.filterL),n=Matrix.toMatrix(a.filterH),o=Matrix.toMatrix(a.invFilterL),s=Matrix.toMatrix(a.invFilterH);if(!e){return[i,n,o,s]}else if(e==="d"){return[i,n]}else if(e==="r"){return[o,s]}else if(e==="l"){return[i,o]}else if(e==="h"){return[n,s]}else{throw new Error("Matrix.wfilters: wrong type argument.")}};var t=function(r,t,e,a,i,n,o,s){"use strict";s=s?true:false;var f=e.length;a=(a==="cl"?Math.floor:Math.ceil)((f-1)/2);var v=t.getFirst(2),u=o.getFirst(2);var h=t.getFirst(1),l=o.getFirst(1);var g=t.getFirst(0),c=o.getFirst(0);var w=t.getStep(2),p=o.getStep(2);var m=t.getStep(1),M=o.getStep(1);var y=t.getStep(0),d=o.getStep(0);var x=t.getEnd(2),b=o.getEnd(2);var L=t.getEnd(1),Y=o.getEnd(1);var B=t.getEnd(0),R=o.getEnd(0);var G=t.getSize(0);var S=r.getData(),D=n.getData();var z,E;var I,C;var X,i,Z,F;var k,A,q;var H=G*y;var V=a*y;var T=y;y*=i;for(z=0,E=0;z<x;z+=w,E+=p){for(k=z+h,C=E+l,A=z+L;k<A;k+=m,C+=M){var j=g+k,P=B+k;for(q=j,I=C+c;q<P;q+=y,I+=d){for(X=0,i=q-V,F=0;X<f;X++,i+=T){Z=i;while(Z<j){Z+=H}while(Z>=P){Z-=H}F+=e[X]*S[Z]}if(s){D[I]+=F}else{D[I]=F}}}}return n};Matrix.dwt2=function(e,a){"use strict";var i=new r(a);var n=i.filterL,o=i.filterH;var s=e.getSize(0),f=e.getSize(1),v=e.getSize(2);var u=Math.ceil(f/2),h=Math.ceil(s/2);var l=Matrix.zeros(h,u,v);var g=Matrix.zeros(h,u,v);var c=Matrix.zeros(h,u,v);var w=Matrix.zeros(h,u,v);var p=l.getView().swapDimensions(0,1),m=g.getView().swapDimensions(0,1),M=c.getView().swapDimensions(0,1),y=w.getView().swapDimensions(0,1);var d=Matrix.zeros(h,f,v),x=Matrix.zeros(h,f,v);var b=d.getView(),L=x.getView();t(e,e.getView(),n,"cl",2,d,b);t(e,e.getView(),o,"cl",2,x,L);b.swapDimensions(0,1);L.swapDimensions(0,1);t(d,b,n,"cl",2,l,p);t(d,b,o,"cl",2,g,m);t(x,L,n,"cl",2,c,M);t(x,L,o,"cl",2,w,y);return[l,g,c,w]};Matrix.idwt2=function(e,a){"use strict";var i=e[0],n=e[2],o=e[1],s=e[3];var f=new r(a);var v=f.invFilterL,u=f.invFilterH;var h=i.getSize(0),l=i.getSize(1),g=i.getSize(2);var c=Matrix.zeros(h*4,l*4,g);c.set([0,2,2*h-1],[0,2,2*l-1],i);c.set([2*h,2,4*h-1],[0,2,2*l-1],o);c.set([0,2,2*h-1],[2*l,2,4*l-1],n);c.set([2*h,2,4*h-1],[2*l,2,4*l-1],s);var w=2*l,p=2*h;var m=Matrix.zeros(h*4,l*4,g);var M=new MatrixView([4*h,4*l,g]).select([0,2*h-1],[0,2*l-1]);var y=new MatrixView([4*h,4*l,g]).select([0,2*h-1],[2*l,4*l-1]);var d=new MatrixView([4*h,4*l,g]).select([2*h,4*h-1],[0,2*l-1]);var x=new MatrixView([4*h,4*l,g]).select([2*h,4*h-1],[2*l,4*l-1]);var b=Matrix.zeros(p,w,g);var L=Matrix.zeros(p,w,g);var Y=b.getView(),B=b.getView();t(c,M,v,"cr",1,b,Y,false);t(c,y,u,"cr",1,b,Y,true);t(c,d,v,"cr",1,L,B,false);t(c,x,u,"cr",1,L,B,true);M=new MatrixView([4*h,4*l,g]).select([0,2,-1],[0,2,-1]).swapDimensions(0,1);Y.swapDimensions(0,1);t(b,Y,v,"cr",1,m,M,false);t(L,Y,u,"cr",1,m,M,true);return m.extractViewFrom(M.swapDimensions(0,1))};var e=function(r,t,e,a,i,n,o,s){"use strict";s=s?true:false;var f=e.length;a=(a==="cl"?Math.floor:Math.ceil)((f-1)/2);var v=t.getFirst(0),u=t.getStep(0);var h=t.getEnd(0),l=t.getSize(0);var g=o.getFirst(0),c=o.getStep(0);var w=r.getData(),p=n.getData();var m,M;var y,i,d,x;var b=l*u;var L=a*u;var Y=u;u*=i;for(m=v,M=g;m<h;m+=u,M+=c){for(y=0,i=m-L,x=0;y<f;y++,i+=Y){d=i;while(d<v){d+=b}while(d>=h){d-=b}x+=e[y]*w[d]}if(s){p[M]+=x}else{p[M]=x}}};Matrix.dwt=function(t,a){var i=new r(a);var n=i.filterL,o=i.filterH;var s=t.getSize(0);var f=Math.ceil(s/2);var v=Matrix.zeros(f,1);var u=Matrix.zeros(f,1);var h=v.getView(),l=u.getView();e(t,t.getView(),n,"cl",2,v,h);e(t,t.getView(),o,"cl",2,u,l);return[v,u]};Matrix.psnr=function(r,t){"use strict";r=Matrix.toMatrix(r);t=Matrix.toMatrix(t);var e=t.getData(),a=r.getData();var i,n,o=0;for(i=0,n=a.length;i<n;i++){var s=e[i]-a[i];o+=s*s}return Matrix.toMatrix(10*Math.log10(n/o))}})();(function(r){"use strict";var t={matrix:function(r,t,e,a,i){a=a||1;
i=i||3;e=(e||1)*i;var n=t[0],o=t[3],s=t[6];var f=t[1],v=t[4],u=t[7];var h=t[2],l=t[5],g=t[8];for(var c=0,w=a,p=2*a;c<e;c+=i,w+=i,p+=i){var m=r[c],M=r[w],y=r[p];r[c]=n*m+o*M+s*y;r[w]=f*m+v*M+u*y;r[p]=h*m+l*M+g*y}return r},"RGB to RGB":function(r,t,e,a){e=e||1;a=a||3;t=(t||1)*a;for(var i=0,n=e,o=2*e;i<t;i+=a,n+=a,o+=a){var s=r[i],f=r[n],v=r[o];r[i]=s;r[n]=f;r[o]=v}return r},applyFunctionRGB:function(r,t,e,a,i){a=a||1;i=i||3;e=(e||1)*i;for(var n=0,o=a,s=2*a;n<e;n+=i,o+=i,s+=i){var f=t(r[n],r[o],r[s]);r[n]=f[0];r[o]=f[1];r[s]=f[2]}return r},applyFunctionColor:function(r,t,e,a,i){a=a||1;i=i||3;e=(e||1)*i;for(var n=0,o=a,s=2*a;n<e;n+=i,o+=i,s+=i){var f=r[n],v=r[o],u=r[s];var h=t([f,v,u]);r[n]=h[0];r[o]=h[1];r[s]=h[2]}return r},"RGB to GRAY":function(r,t,e,a){e=e||1;a=a||3;t=(t||1)*a;for(var i=0,n=e,o=2*e;i<t;i+=a,n+=a,o+=a){var s=r[i],f=r[n],v=r[o];var u=.2989*s+.587*f+.114*v;r[i]=u;r[n]=u;r[o]=u}return r},"RGB to HSV":function(r,t,e,a){e=e||1;a=a||3;t=(t||1)*a;var i=1/6;for(var n=0,o=e,s=2*e;n<t;n+=a,o+=a,s+=a){var f=r[n],v=r[o],u=r[s];var h=(f>v?f:v)>u?f>v?f:v:u;var l=h-((f<v?f:v)<u?f<v?f:v:u),g=0;if(l!==0){if(h===f){g=(v-u)/l*i}else if(h===v){g=(2+(u-f)/l)*i}else if(h===u){g=(4+(f-v)/l)*i}if(g<0){g+=1}if(h!==0){l/=h}}r[n]=g;r[o]=l;r[s]=h}return r},"HSV to RGB":function(r,t,e,a){e=e||1;a=a||3;t=(t||1)*a;for(var i=0,n=e,o=2*e;i<t;i+=a,n+=a,o+=a){var s=r[i],f=r[n],v=r[o];var u=(s*6|0)%6;var h=s*6-u;var l=v*(1-f);var g=v*(1-h*f);var c=v*(1-(1-h)*f);switch(u){case 0:r[i]=v;r[n]=c;r[o]=l;break;case 1:r[i]=g;r[n]=v;r[o]=l;break;case 2:r[i]=l;r[n]=v;r[o]=c;break;case 3:r[i]=l;r[n]=g;r[o]=v;break;case 4:r[i]=c;r[n]=l;r[o]=v;break;case 5:r[i]=v;r[n]=l;r[o]=g;break}}return r},"RGB to HSL":function(r,t,e,a){e=e||1;a=a||3;t=(t||1)*a;var i=Math.sqrt(3),n=1/(2*Math.PI),o=1/3;for(var s=0,f=e,v=2*e;s<t;s+=a,f+=a,v+=a){var u=r[s],h=r[f],l=r[v];var g=Math.atan2(i*(h-l),2*u-h-l)*n;r[s]=g<0?g+1:g;var c=(u>h?u:h)>l?u>h?u:h:l;var w=(u<h?u:h)<l?u<h?u:h:l;r[f]=c-w;r[v]=(u+h+l)*o}return r},"HSL to RGB":function(r,t,e,a){e=e||1;a=a||3;t=(t||1)*a;var i=Math.PI,n=i/3,o=i*2,s=2*i/3;var f=1/3;var v=Math.sqrt(3)/2,u=1/Math.sqrt(3);for(var h=0,l=e,g=2*e;h<t;h+=a,l+=a,g+=a){var c=r[h],w=r[l],p=r[g];var m=c*o;var M=m;while(M>n){M-=n}var y=v*w/Math.sin(s-M);var d=y*Math.cos(m)*f,x=y*Math.sin(m)*u;r[h]=p+d*2;r[l]=p-d+x;r[g]=p-d-x}return r},"RGB to HSI":function(r,t,e,a){e=e||1;a=a||3;t=(t||1)*a;var i=1/Math.sqrt(3),n=1/Math.sqrt(2),o=1/Math.sqrt(6);for(var s=0,f=e,v=2*e;s<t;s+=a,f+=a,v+=a){var u=r[s],h=r[f],l=r[v];var g=(h-l)*n;var c=(2*u-h-l)*o;r[s]=Math.atan2(g,c);r[f]=Math.sqrt(g*g+c*c);r[v]=(u+h+l)*i}return r},"HSI to RGB":function(r,t,e,a){e=e||1;a=a||3;t=(t||1)*a;var i=Math.sqrt(3),n=Math.sqrt(2),o=Math.sqrt(6);var s=1/6,f=1/3;for(var v=0,u=e,h=2*e;v<t;v+=a,u+=a,h+=a){var l=r[v],g=r[u],c=r[h];var w=g*Math.sin(l);var p=g*Math.cos(l);var m=c*i,M=w*n,y=p*o;var d=(m+y)*f;var x=(2*m+3*M-y)*s;var b=(2*m-3*M-y)*s;r[v]=d;r[u]=x;r[h]=b}return r},"LinearRGB to sRGB":function(r,t,e,a){e=e||1;a=a||3;t=(t||1)*a;var i=.055,n=1/2.4;for(var o=0,s=e,f=2*e;o<t;o+=a,s+=a,f+=a){var v=r[o],u=r[s],h=r[f];r[o]=v>.0031308?1.055*Math.pow(v,n)-i:v*12.92;r[s]=u>.0031308?1.055*Math.pow(u,n)-i:u*12.92;r[f]=h>.0031308?1.055*Math.pow(h,n)-i:h*12.92}return r},"sRGB to LinearRGB":function(r,t,e,a){e=e||1;a=a||3;t=(t||1)*a;var i=1/12.92,n=.055,o=1/1.055;for(var s=0,f=e,v=2*e;s<t;s+=a,f+=a,v+=a){var u=r[s],h=r[f],l=r[v];r[s]=u>.04045?Math.pow((u+n)*o,2.4):u*i;r[f]=h>.04045?Math.pow((h+n)*o,2.4):h*i;r[v]=l>.04045?Math.pow((l+n)*o,2.4):l*i}return r},"RGB to CMY":function(r,t,e,a){e=e||1;a=a||3;t=(t||1)*a;for(var i=0,n=e,o=2*e;i<t;i+=a,n+=a,o+=a){r[i]=1-r[i];r[n]=1-r[n];r[o]=1-r[o]}return r},"CMY to RGB":function(r,t,e,a){e=e||1;a=a||3;t=(t||1)*a;for(var i=0,n=e,o=2*e;i<t;i+=a,n+=a,o+=a){r[i]=1-r[i];r[n]=1-r[n];r[o]=1-r[o]}return r},"RGB to Opponent":function(r,t,e,a){e=e||1;a=a||3;t=(t||1)*a;var i=1/Math.sqrt(3),n=1/Math.sqrt(2),o=1/Math.sqrt(6);for(var s=0,f=e,v=2*e;s<t;s+=a,f+=a,v+=a){var u=r[s],h=r[f],l=r[v];r[s]=(u+h+l)*i;r[f]=(u-h)*n;r[v]=(u+h-2*l)*o}return r},"Opponent to RGB":function(r,t,e,a){e=e||1;a=a||3;t=(t||1)*a;var i=Math.sqrt(3),n=Math.sqrt(2),o=Math.sqrt(6);var s=1/6,f=1/3;for(var v=0,u=e,h=2*e;v<t;v+=a,u+=a,h+=a){var l=r[v],g=r[u],c=r[h];var w=l*i,p=g*n,m=c*o;r[v]=(2*w+3*p+m)*s;r[u]=(2*w-3*p+m)*s;r[h]=(w-m)*f}return r},"RGB to Ohta":function(r,t,e,a){e=e||1;a=a||3;t=(t||1)*a;var i=1/Math.sqrt(3),n=1/Math.sqrt(2),o=1/Math.sqrt(6);for(var s=0,f=e,v=2*e;s<t;s+=a,f+=a,v+=a){var u=r[s],h=r[f],l=r[v];r[s]=(u+h+l)*i;r[f]=(u-l)*n;r[v]=(-u+2*h-l)*o}return r},"Ohta to RGB":function(r,t,e,a){e=e||1;a=a||3;t=(t||1)*a;var i=Math.sqrt(3),n=Math.sqrt(2),o=Math.sqrt(6);var s=1/6,f=1/3;for(var v=0,u=e,h=2*e;v<t;v+=a,u+=a,h+=a){var l=r[v],g=r[u],c=r[h];var w=l*i,p=g*n,m=c*o;r[u]=(w+m)*f;r[v]=(2*w+3*p-m)*s;r[h]=(2*w-3*p-m)*s}return r},"LinearRGB to rgY":function(r,t,e,a){e=e||1;a=a||3;t=(t||1)*a;for(var i=0,n=e,o=2*e;i<t;i+=a,n+=a,o+=a){var s=r[i],f=r[n],v=r[o];var u=s+f+v;if(u>0){var h=1/u;r[i]=s*h;r[n]=f*h;r[o]=u}else{r[i]=1/3;r[n]=1/3;r[o]=0}}return r},"rgY to LinearRGB":function(r,t,e,a){e=e||1;a=a||3;t=(t||1)*a;for(var i=0,n=e,o=2*e;i<t;i+=a,n+=a,o+=a){var s=r[i],f=r[n],v=r[o];r[i]=s*v;r[n]=f*v;r[o]=(1-s-f)*v}return r},getXYZTransform:function(r,e,a){e=e||[.31271,.32902,1];a=a||[.64,.33,1,.3,.6,1,.15,.06,1];var i=t["xyY to XYZ"](e);i=Matrix.toMatrix(i);var a=t["xyY to XYZ"](a,3);a=new Matrix([3,3],a);var n=Matrix.diag(a.inv().mtimes(i));var o=a.mtimes(n);return r?o.inv():o},"LinearRGB to XYZ":function(r,e,a,i,n,o){var s=t.getXYZTransform(false,n,o).getData();t.matrix(r,s,e,a,i);return r},"XYZ to LinearRGB":function(r,e,a,i,n,o){var s=t.getXYZTransform(true,n,o).getData();t.matrix(r,s,e,a,i);return r},"XYZ to Lab":function(r,t,e,a,i){e=e||1;a=a||3;t=(t||1)*a;i=i||[.31271,.32902,1];var n=i[0],o=i[1],s=i[2];var f=n*s/o;var v=(1-n-o)*s/o;var u=1/f,h=1/s,l=1/v;var g=1/3,c=16/116;for(var w=0,p=e,m=2*e;w<t;w+=a,p+=a,m+=a){var M=r[w],y=r[p],d=r[m];var x=M*u;if(x>.008856){x=Math.pow(x,g)}else{x=7.787*x+c}var b=y*h;if(b>.008856){b=Math.pow(b,g)}else{b=7.787*b+c}var L=d*l;if(L>.008856){L=Math.pow(L,g)}else{L=7.787*L+c}r[w]=116*b-16;r[p]=500*(x-b);r[m]=200*(b-L)}return r},"Lab to XYZ":function(r,t,e,a,i){e=e||1;a=a||3;t=(t||1)*a;i=i||[.31271,.32902,1];var n=i[0],o=i[1],s=i[2];var f=n*s/o;var v=(1-n-o)*s/o;var u=Math.pow(.008856,1/3),h=1/7.787;var l=1/116,g=1/500,c=1/200;var w=16/116;for(var p=0,m=e,M=2*e;p<t;p+=a,m+=a,M+=a){var y=r[p],d=r[m],x=r[M];var b=(y+16)*l;var L=b+d*g;var Y=b-x*c;if(b>u){b=Math.pow(b,3)}else{b=(b-w)*h}if(L>u){L=Math.pow(L,3)}else{L=(L-w)*h}if(Y>u){Y=Math.pow(Y,3)}else{Y=(Y-w)*h}r[p]=L*f;r[m]=b*s;r[M]=Y*v}return r},"XYZ to Luv":function(r,t,e,a,i){e=e||1;a=a||3;t=(t||1)*a;i=i||[.31271,.32902,1];var n=i[0],o=i[1],s=i[2];var f=n*s/o;var v=(1-n-o)*s/o;var u=1/s;var h=4*f/(f+15*s+3*v);var l=9*s/(f+15*s+3*v);var g=1/3;for(var c=0,w=e,p=2*e;c<t;c+=a,w+=a,p+=a){var m=r[c],M=r[w],y=r[p];var d=M*u;if(d>.008856){d=116*Math.pow(d,g)-16}else{d*=903.3}var x=1/(m+15*M+3*y);x=isFinite(x)?x:0;var b=4*x*m;var L=9*x*M;x=13*d;r[c]=d;r[w]=x*(b-h);r[p]=x*(L-l)}return r},"Luv to XYZ":function(r,t,e,a,i){e=e||1;a=a||3;t=(t||1)*a;i=i||[.31271,.32902,1];var n=i[0],o=i[1],s=i[2];var f=n*s/o;var v=(1-n-o)*s/o;var u=4*f/(f+15*s+3*v);var h=9*s/(f+15*s+3*v);var l=Math.pow(.008856,1/3),g=1/7.787;var c=1/116,w=16/116;for(var p=0,m=e,M=2*e;p<t;p+=a,m+=a,M+=a){var y=r[p],d=r[m],x=r[M];var b=(y+16)*c;if(b>l){b=Math.pow(b,3)}else{b=(b-w)*g}var L=1/(13*y);L=isFinite(L)?L:0;var Y=d*L+u;var B=x*L+h;L=b/(4*B);r[p]=9*Y*L;r[m]=b;r[M]=(12-3*Y-20*B)*L}return r},"Lab to Lch":function(r,t,e,a){e=e||1;a=a||3;t=(t||1)*a;var i=1/(2*Math.PI);for(var n=0,o=e,s=2*e;n<t;n+=a,o+=a,s+=a){var f=r[n],v=r[o],u=r[s];var h=Math.atan2(u,v)*i;r[n]=f;r[o]=Math.sqrt(v*v+u*u);r[s]=h<0?h+1:h}return r},"Lch to Lab":function(r,t,e,a){e=e||1;a=a||3;t=(t||1)*a;var i=Math.PI*2;for(var n=0,o=e,s=2*e;n<t;n+=a,o+=a,s+=a){var f=r[n],v=r[o],u=r[s];var h=u*i;var l=Math.cos(h)*v;var g=Math.sin(h)*v;r[n]=f;r[o]=l;r[s]=g}return r},"RGB to XYZ":function(r,e,a,i){t["sRGB to LinearRGB"](r,e,a,i);t["LinearRGB to XYZ"](r,e,a,i);return r},"XYZ to RGB":function(r,e,a,i){t["XYZ to LinearRGB"](r,e,a,i);t["LinearRGB to sRGB"](r,e,a,i);return r},"RGB to Lab":function(r,e,a,i,n){t["sRGB to LinearRGB"](r,e,a,i);t["LinearRGB to XYZ"](r,e,a,i,n);t["XYZ to Lab"](r,e,a,i,n);return r},"Lab to RGB":function(r,e,a,i){t["Lab to XYZ"](r,e,a,i);t["XYZ to LinearRGB"](r,e,a,i);t["LinearRGB to sRGB"](r,e,a,i);return r},"RGB to Luv":function(r,e,a,i,n){t["sRGB to LinearRGB"](r,e,a,i);t["LinearRGB to XYZ"](r,e,a,i);t["XYZ to Luv"](r,e,a,i,n);return r},"Luv to RGB":function(r,e,a,i,n){t["Luv to XYZ"](r,e,a,i,n);t["XYZ to LinearRGB"](r,e,a,i);t["LinearRGB to sRGB"](r,e,a,i);return r},"RGB to Lch":function(r,e,a,i,n){t["sRGB to LinearRGB"](r,e,a,i);t["LinearRGB to XYZ"](r,e,a,i);t["XYZ to Lab"](r,e,a,i,n);t["Lab to Lch"](r,e,a,i);return r},"Lch to RGB":function(r,e,a,i,n){t["Lch to Lab"](r,e,a,i);t["Lab to XYZ"](r,e,a,i,n);t["XYZ to LinearRGB"](r,e,a,i);t["LinearRGB to sRGB"](r,e,a,i);return r},"XYZ to xyY":function(r,t,e,a,i){e=e||1;a=a||3;t=(t||1)*a;i=i||[.31271,.32902,1];var n=i[0],o=i[1];for(var s=0,f=e,v=2*e;s<t;s+=a,f+=a,v+=a){var u=r[s],h=r[f],l=r[v];var g=1/(u+h+l);if(isFinite(g)){r[s]=u*g;r[f]=h*g;r[v]=h}else{r[s]=n;r[f]=o;r[v]=0}}return r},"xyY to XYZ":function(r,t,e,a){e=e||1;a=a||3;t=(t||1)*a;for(var i=0,n=e,o=2*e;i<t;i+=a,n+=a,o+=a){var s=r[i],f=r[n],v=r[o];var u=v/f;r[i]=s*u;r[n]=v;r[o]=(1-s-f)*u}return r},"XYZ to 1960 uvY":function(r,t,e,a,i){e=e||1;a=a||3;t=(t||1)*a;i=i||[.31271,.32902,1];var n=i[0],o=i[1],s=i[2];var f=n*s/o,v=(1-n-o)*s/o;var u=4*f/(f+15*s+3*v);var h=6*s/(f+15*s+3*v);for(var l=0,g=e,c=2*e;l<t;l+=a,g+=a,c+=a){var w=r[l],p=r[g],m=r[c];if(p===0){r[l]=u;r[g]=h;r[c]=0}else{var M=1/(w+15*p+3*m);r[l]=4*w*M;r[g]=6*p*M;r[c]=p}}return r},"1960 uvY to XYZ":function(r,t,e,a){e=e||1;a=a||3;t=(t||1)*a;var i=6/4,n=1/3;for(var o=0,s=e,f=2*e;o<t;o+=a,s+=a,f+=a){var v=r[o],u=r[s],h=r[f];var l=1/u;var g=i*h*v*l;r[o]=g;r[s]=h;r[f]=(6*h*l-g-15*h)*n}return r},"XYZ to 1976 u'v'Y":function(r,t,e,a,i){e=e||1;a=a||3;t=(t||1)*a;i=i||[.31271,.32902,1];var n=i[0],o=i[1],s=i[2];var f=n*s/o,v=(1-n-o)*s/o;var u=4*f/(f+15*s+3*v);var h=9*s/(f+15*s+3*v);for(var l=0,g=e,c=2*e;l<t;l+=a,g+=a,c+=a){var w=r[l],p=r[g],m=r[c];if(p===0){r[l]=u;r[g]=h;r[c]=0}else{var M=1/(w+15*p+3*m);r[l]=4*w*M;r[g]=9*p*M;r[c]=p}}return r},"1976 u'v'Y to XYZ":function(r,t,e,a){e=e||1;a=a||3;t=(t||1)*a;var i=9/4,n=1/3;for(var o=0,s=e,f=2*e;o<t;o+=a,s+=a,f+=a){var v=r[o],u=r[s],h=r[f];var l=1/u;var g=i*h*v*l;r[o]=g;r[s]=h;r[f]=(9*h*l-g-15*h)*n}return r},"xyY to 1960 uvY":function(r,t,e,a){e=e||1;a=a||3;t=(t||1)*a;for(var i=0,n=e,o=2*e;i<t;i+=a,n+=a,o+=a){var s=r[i],f=r[n];var v=1/(-2*s+12*f+3);r[i]=4*s*v;r[n]=6*f*v}return r},"1960 uvY to xyY":function(r,t,e,a){e=e||1;a=a||3;t=(t||1)*a;for(var i=0,n=e,o=2*e;i<t;i+=a,n+=a,o+=a){var s=r[i],f=r[n];var v=1/(2*s-8*f+4);r[i]=3*s*v;r[n]=2*f*v}return r},"1976 u'v'Y to xyY":function(r,t,e,a){e=e||1;a=a||3;t=(t||1)*a;for(var i=0,n=e,o=2*e;i<t;i+=a,n+=a,o+=a){var s=r[i],f=r[n];var v=1/(6*s-16*f+12);r[i]=9*s*v;r[n]=4*f*v}return r},"xyY to 1976 u'v'Y":function(r,t,e,a){e=e||1;a=a||3;t=(t||1)*a;for(var i=0,n=e,o=2*e;i<t;i+=a,n+=a,o+=a){var s=r[i],f=r[n];var v=1/(-2*s+12*f+3);r[i]=4*s*v;r[n]=9*f*v}return r},"1976 u'v'Y to 1960 uvY":function(r,t,e,a){e=e||1;a=a||3;t=(t||1)*a+e;var i=2/3;for(var n=e;n<t;n+=a){r[n]*=i}return r},"1960 uvY to 1976 u'v'Y":function(r,t,e,a){e=e||1;a=a||3;t=(t||1)*a+e;var i=3/2;for(var n=e;n<t;n+=a){r[n]*=i}return r},"RGB to rgY":function(r,e,a,i){t["sRGB to LinearRGB"](r,e,a,i);t["LinearRGB to rgY"](r,e,a,i);return r},"rgY to RGB":function(r,e,a,i){t["rgY to LinearRGB"](r,e,a,i);t["LinearRGB to sRGB"](r,e,a,i);return r},"rgY to xyY":function(r,e,a,i){t["rgY to LinearRGB"](r,e,a,i);t["LinearRGB to XYZ"](r,e,a,i);t["XYZ to xyY"](r,e,a,i);return r},"xyY to rgY":function(r,e,a,i){t["xyY to XYZ"](r,e,a,i);t["XYZ to LinearRGB"](r,e,a,i);t["LinearRGB to rgY"](r,e,a,i);return r},"RGB to xyY":function(r,e,a,i){t["sRGB to LinearRGB"](r,e,a,i);t["LinearRGB to XYZ"](r,e,a,i);t["XYZ to xyY"](r,e,a,i);return r},"xyY to RGB":function(r,e,a,i){t["xyY to XYZ"](r,e,a,i);t["XYZ to LinearRGB"](r,e,a,i);t["LinearRGB to sRGB"](r,e,a,i);return r},"RGB to 1960 uvY":function(r,e,a,i){t["sRGB to LinearRGB"](r,e,a,i);t["LinearRGB to XYZ"](r,e,a,i);t["XYZ to xyY"](r,e,a,i);t["xyY to 1960 uvY"](r,e,a,i);return r},"1960 uvY to RGB":function(r,e,a,i){t["1960 uvY to xyY"](r,e,a,i);t["xyY to XYZ"](r,e,a,i);t["XYZ to LinearRGB"](r,e,a,i);t["LinearRGB to sRGB"](r,e,a,i);return r},"RGB to 1976 u'v'Y":function(r,e,a,i){t["sRGB to LinearRGB"](r,e,a,i);t["LinearRGB to XYZ"](r,e,a,i);t["XYZ to 1976 u'v'Y"](r,e,a,i);return r},"1976 u'v'Y to RGB":function(r,e,a,i){t["1976 u'v'Y to XYZ"](r,e,a,i);t["XYZ to LinearRGB"](r,e,a,i);t["LinearRGB to sRGB"](r,e,a,i);return r}};r.Colorspaces=t})(Matrix);(function(r,t){"use strict";var e={lab2lch:"Lab to Lch",lab2srgb:"Lab to RGB",lab2xyz:"Lab to XYZ",lch2lab:"Lch to Lab",srgb2cmyk:"RGB to CMY",srgb2lab:"RGB to Lab",srgb2xyz:"RGB to XYZ",upvpl2xyz:"1976 u'v'Y to XYZ",uvl2xyz:"1960 uvY to XYZ",xyl2xyz:"xyY to XYZ",xyz2lab:"XYZ to Lab",xyz2srgb:"XYZ to RGB",xyz2upvpl:"XYZ to 1976 u'v'",xyz2uvl:"XYZ to 1960 uv",xyz2xyl:"XYZ to xyY"};t.applycform=function(t){if(this.ndims()!==3||this.getSize(2)<3){throw new Error("Matrix.applycform: Matrix must be an "+"image with RGB components.")}var a=this.getSize(0)*this.getSize(1);if(typeof t==="string"){if(r.Colorspaces[t]){r.Colorspaces[t](this.getData(),a,a,1)}else if(r.Colorspaces[e[t]]){r.Colorspaces[e[t]](this.getData(),a,a,1)}else{throw new Error("Matrix.applycform: Unknown color transformation "+t)}}else if(typeof t==="function"){if(t.length===3){r.Colorspaces.applyFunctionRGB(this.getData(),t,a,a,1)}else if(t.length===1){r.Colorspaces.applyFunctionColor(this.getData(),t,a,a,1)}}else{t=r.toMatrix(t);if(!Tools.checkSizeEquals(t.size(),[3,3],r.ignoreTrailingDims)){throw new Error("Matrix.applycform: Matrix argument must be 3x3.")}r.Colorspaces.matrix(this.getData(),t.getData(),a,a,1)}return this};r.applycform=function(r,t){return r.getCopy().applycform(t)};t.toColormap=function(t){var e=this.getData(),a=this.getSize(),i=e.length;a[2]=3;var n=new r(a),o=n.getData();var s=o.subarray(0,i),f=o.subarray(i,2*i),v=o.subarray(2*i,3*i);var u,h,l=Math.floor;if(t==="JET"){for(u=0;u<i;u++){h=e[u]*4;if(h>=4){h=3.99}else if(h<0){h=0}switch(l(h*2)%8){case 0:s[u]=0;f[u]=0;v[u]=h+.5;break;case 1:case 2:s[u]=0;v[u]=1;f[u]=h-.5;break;case 3:case 4:s[u]=h-1.5;f[u]=1;v[u]=2.5-h;break;case 5:case 6:s[u]=1;f[u]=3.5-h;v[u]=0;break;case 7:s[u]=4.5-h;f[u]=0;v[u]=0;break}}}else if(t==="HUE"){for(u=0;u<i;u++){var g=e[u];h=l(g*6)%6;var c=g*6-h;switch(h){case 0:s[u]=1;f[u]=c;v[u]=0;break;case 1:s[u]=1-c;f[u]=1;v[u]=0;break;case 2:s[u]=0;f[u]=1;v[u]=c;break;case 3:s[u]=0;f[u]=1-c;v[u]=1;break;case 4:s[u]=c;f[u]=0;v[u]=1;break;case 5:s[u]=1;f[u]=0;v[u]=1-c;break}}}else if(t==="HUE"){o.set(e)}return n};t.correctImage=function(t,e){e=e||r.CIE.getIlluminant("D65");var a=r.CIE.getIlluminantConversionMatrix(e,t);this.applycform("sRGB to LinearRGB").applycform(a).applycform("LinearRGB to sRGB");return this};r.correctImage=function(r,t,e){return r.getCopy().correctImage(t,e)};t.im2CCT=function(){var t=r.CIE["xyY to CCT"];var e=this.getSize();e.pop();var a=new r(e,"single");var i=this.getData(),n=a.getData();var o=this.getView();var s=o.getStep(0),f=o.getEnd(0),v;var u=o.getStep(1),h=o.getEnd(1),l;var g=o.getStep(2);var c,w,p,m,M,y=[];for(c=0,l=h;c!==l;c+=u){w=c;p=c+g;m=c+2*g;for(v=c+f;w!==v;w+=s,p+=s,m+=s){y[0]=i[w];y[1]=i[p];y[2]=i[m];M=t(y);M=M<1668?1668:M>2e4?2e4:M;M=isNaN(M)?24999:M;n[w]=M}}return a};t.CCT2im=function(){var t=r.CIE["CCT to xyY"];var e=this.getSize();e[2]=3;var a=new r(e,"single");var i=this.getData(),n=a.getData();var o=a.getView();var s=o.getStep(0),f=o.getEnd(0),v;var u=o.getStep(1),h=o.getEnd(1),l;var g=o.getStep(2);var c,w,p,m,M=[];for(c=0,l=h;c!==l;c+=u){w=c;p=c+g;m=c+2*g;for(v=c+f;w!==v;w+=s,p+=s,m+=s){M=t(i[w]);n[w]=M[0];n[p]=M[1];n[m]=M[2]}}return a}})(Matrix,Matrix.prototype);