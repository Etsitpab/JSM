/**
 * This program is free software: you can redistribute it and/or modify    
 * it under the terms of the GNU General Public License as published by        
 * the Free Software Foundation, either version 3 of the License, or 
 * (at your option) any later version.
 * 
 * This program is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU General Public License for more details.
 * 
 * You should have received a copy of the GNU General Public License
 * along with this program.  If not, see <http://www.gnu.org/licenses/>.
 * 
 * @author Baptiste Mazin     <baptiste.mazin@telecom-paristech.fr> 
 * @author Guillaume Tartavel <guillaume.tartavel@telecom-paristech.fr> 
 */
(function(r,t){"use strict";var a=typeof module!=="undefined"&&module.exports?true:false;var e,n,i;if(a){e=require("fs");n=require("canvas");i=n.Image}else{i=Image}var o=function(r,t){var e;if(a){e=new n}else{e=document.createElement("canvas")}e.width=r||0;e.height=t||0;return e};t.convertImage=function(t){var a=new r(this.getSize(),t);var e,n;if(this.isfloat()||this.islogical()){e=[0,1]}else if(this.isinteger()){e=[r.intmin(this.type()),r.intmax(this.type())]}var i=e[0],o=1/(e[1]-e[0]);if(a.isfloat()||this.islogical()){n=[0,1]}else if(a.isinteger()){n=[r.intmin(a.type()),r.intmax(a.type())]}var s=n[0],f=o*(n[1]-n[0]);var v=this.getData(),u=new a.getData;var l,h;for(l=0,h=v.length;l<h;l++){u[l]=(v[l]-i)*f-s}return new r(this.getSize(),u)};t.im2double=function(){return this.convertImage("double")};t.im2single=function(){return this.convertImage("single")};t.im2uint8=function(){return this.convertImage("uint8")};t.im2uint8c=function(){return this.convertImage("uint8c")};t.getImageData=function(){var t;if(this.isfloat()||this.islogical()){t=[0,1]}else if(this.isinteger()){t=[r.intmin(this.type()),r.intmax(this.type())]}var a=t[0],e=255/(t[1]-t[0]);var n=this.getSize(1),i=this.getSize(0);var s=o().getContext("2d").createImageData(n,i);var f=i*n,v;var u=this.getData(),l=s.data;var h,g,c,w,p,m,d;switch(this.getSize(2)){case 1:for(g=0,h=0;g<i;g++){for(c=g,v=g+f;c<v;c+=i){d=(u[c]-a)*e;l[h++]=d;l[h++]=d;l[h++]=d;l[h++]=255}}break;case 2:for(g=0,h=0;g<i;g++){for(c=g,w=g+f,v=g+f;c<v;c+=i,w+=i){d=(u[c]-a)*e;l[h++]=d;l[h++]=d;l[h++]=d;l[h++]=(u[w]-a)*e}}break;case 3:for(g=0,h=0;g<i;g++){for(c=g,w=g+f,p=g+2*f,v=w;c<v;c+=i,w+=i,p+=i){l[h++]=(u[c]-a)*e;l[h++]=(u[w]-a)*e;l[h++]=(u[p]-a)*e;l[h++]=255}}break;case 4:for(g=0,h=0;g<i;g++){for(c=g,w=c+f,p=w+f,m=p+f,v=w;c<v;c+=i,w+=i,p+=i,m+=i){l[h++]=(u[c]-a)*e;l[h++]=(u[w]-a)*e;l[h++]=(u[p]-a)*e;l[h++]=(u[m]-a)*e}}break}return s};t.toImage=function(r){if(a){throw new Error("Matrix.toImage: Canvas doesn't exist.")}var t=o(this.getSize(1),this.getSize(0));var e=this.getImageData();t.getContext("2d").putImageData(e,0,0);var n=new Image;n.src=t.toDataURL();n.onload=r;return n};if(a){r.prototype.imwrite=function(r,t){var a=o(this.getSize(1),this.getSize(0));a.getContext("2d").putImageData(this.getImageData(),0,0);var n=e.createWriteStream(r),i;if(/\.(png)$/i.test(r.toLowerCase())){i=a.pngStream()}else if(/\.(jpeg|jpg)$/i.test(r.toLowerCase())){i=a.jpegStream()}else{throw new Error("Matrix.imwrite: invalid file extension.")}i.on("data",function(r){n.write(r)});if(t){i.on("end",t.bind(this))}}}r.fspecial=function(t,a,e){var n,i,o,s;var f,v,u,l,h,g,c,w;var p,m,d;var y=function(r,t){return Math.exp(-(r*r+t*t)/(2*s*s))};switch(t.toLowerCase()){case"average":if(Tools.isArrayLike(a)){o=a[0];i=a[1]}else{o=a===undefined?3:a;i=o}return r.ones([o,i])["./"](o*i);case"disk":break;case"gaussian":if(Tools.isArrayLike(a)){o=a[0];i=a[1]}else{o=a===undefined?3:a;i=o}s=e===undefined?.5:e;f=[];w=0;for(l=0,v=-(i-1)/2,g=i*o;l<g;l+=o,v++){for(h=l,c=l+o,u=-(o-1)/2;h<c;h++,u++){p=y(v,u);f[h]=p;w+=p}}for(m=0,d=f.length;m<d;m++){f[m]/=w}return new r([o,i],f);case"laplacian":n=a===undefined?.2:a;return new r([3,3],[n/4,(1-n)/4,n/4,(1-n)/4,-1,(1-n)/4,n/4,(1-n)/4,n/4])[".*"](4/(n+1));case"log":if(Tools.isArrayLike(a)){o=a[0];i=a[1]}else{o=a===undefined?3:a;i=o}s=e===undefined?.5:e;f=[];w=0;for(l=0,v=-(i-1)/2,g=i*o;l<g;l+=o,v++){for(h=l,c=l+o,u=-(o-1)/2;h<c;h++,u++){p=y(v,u);f[h]=(v*v+u*u-2*s*s)*p/Math.pow(s,4);w+=p}}for(m=0,d=f.length;m<d;m++){f[m]/=w}w=0;for(m=0,d=f.length;m<d;m++){w+=f[m]}w/=i*o;for(m=0,d=f.length;m<d;m++){f[m]-=w}return new r([o,i],f);case"unsharp":n=a===undefined?.2:a;return new r([3,3],[-n,n-1,-n,n-1,n+5,n-1,-n,n-1,-n])[".*"](1/(n+1));case"prewitt":return new r([3,3],[1,0,-1,1,0,-1,1,0,-1]);case"sobel":return new r([3,3],[1,0,-1,2,0,-2,1,0,-1]);default:return}};t.filter1d=function(t,a){var e=this.constructor.name+".filter1d: ";if(a===undefined){a="C"}if(!t.isvector()){throw new Error("Matrix.filter1d: Kernel must be a vector")}var n=t.getLength(),i=t.getData();if(typeof a==="string"){switch(a.toUpperCase()){case"C":case"CL":a=Math.floor((n-1)/2);break;case"CR":a=Math.ceil((n-1)/2);break;case"L":a=0;break;case"R":a=n-1;break;default:throw new Error(e+"unknown origin position '"+a+"'")}}else if(typeof a==="number"){if(a<0){a+=n}if(a<0||a>=n){throw new Error(e+"origin value must satisfy : |origin| < kernel.length")}}var o=new r(this.getSize(),this.getDataType());var s=this.getData(),f=o.getData();var v=o.getView();var u=v.getStep(2),l=v.getEnd(2);var h=v.getStep(1),g=v.getEnd(1);var c=v.getEnd(0);if(a>=c/2){throw new Error("Matrix.filter1d: Kernel is too large.")}var w,p=c-a;var m,d,y,b,M,B,x;for(m=0;m!==l;m+=u){for(d=m,y=m+g;d!==y;d+=h){for(b=d,M=d+a;b<M;b++){for(w=0,x=0,B=2*d+a-b;B>d;x++,B--){w+=i[x]*s[B]}for(B=d;x<n;x++,B++){w+=i[x]*s[B]}f[b]=w}for(b=d+a,M=d+p;b<M;b++){for(w=0,x=0,B=b-a;x<n;x++,B++){w+=i[x]*s[B]}f[b]=w}for(b=d+p,M=d+c;b<M;b++){for(w=0,x=0,B=b-a;B<M;x++,B++){w+=i[x]*s[B]}for(B=M-2;x<n;x++,B--){w+=i[x]*s[B]}f[b]=w}}}return o};t.separableFilter=function(r,t){if(t===undefined){t=r}return this.filter1d(r).permute([1,0,2]).filter1d(t).permute([1,0,2])};t.gaussian=function(r,t,a){a=a||3;var e=f.gaussian(r,0,a);var n;if(typeof t==="number"){n=f.gaussian(t,0,a)}else{n=e}return this.separableFilter(e,n)};t.gaussianGradient=function(t){if(!t){t=2}var a=f.gaussian(t,1,3);var e=f.gaussian(t,0,3);var n=this.separableFilter(e,a);var i=this.separableFilter(a,e);var o=.5/Math.PI;var s=r.zeros(this.getSize()),v=r.zeros(this.getSize());var u=n.getData(),l=i.getData();var h=s.getData(),g=v.getData();var c,w;for(c=0,w=u.length;c<w;c++){var p=u[c],m=l[c];h[c]=Math.sqrt(p*p+m*m);var d=Math.atan2(m,p)*o;g[c]=d<0?d+1:d}return{x:n,y:i,norm:s,phase:v}};t.gradient=function(t,a,e,n,i){var o=.70710678,s=6.8284271,f=.35355339;var v=.29289322,u=1/s,l=.5/Math.PI;var h={},g,c,w,p,m;var d=this.getSize();var y=this.getDataType();if(t){h.x=new r(d,y);g=h.x.getData()}if(a){h.y=new r(d,y);c=h.y.getData()}if(e){h.norm=new r(d,y);w=h.norm.getData()}if(n){h.phase=new r(d,y);p=h.phase.getData()}if(i){h.laplacian=new r(d,y);m=h.laplacian.getData()}var b=this.getData();var M=this.getView();var B=M.getStep(2),x=M.getEnd(2);var D=M.getStep(1),A=M.getEnd(1);var L=M.getEnd(0);var S,R,z,G,C,Y,E;for(S=0;S!==x;S+=B){for(R=S+D,z=S+A-D;R!==z;R+=D){for(Y=R-D,G=R,E=R+D,C=R+L-2;G<C;G){var I=b[Y],F=b[++Y],k=b[Y+1];var Q=b[G],Z=b[++G],X=b[G+1];var H=b[E],q=b[++E],T=b[E+1];var V=T-I,U=k-H;var j=v*(q-F+f*(V-U));var J=v*(Q-X-f*(V+U));if(t){g[G]=j}if(a){c[G]=J}if(e){w[G]=Math.sqrt(j*j+J*J)}if(n){var K=Math.atan2(-J,j)*l;p[G]=K<0?K+1:K}if(i){m[G]=(o*(I+k+H+T)+(Q+F+q+X))*u-Z}}}}return h};t.conv=function(t,a){if(!this.isvector()||!t.isvector()){throw new Error("Matrix.conv: Input must be vector.")}var e=this.getData(),n=e.length;var i=t.getData(),o=i.length;if(n<o){return t.conv(this,a)}var s=Tools.checkType(this.getDataType());var f=new s(n+o-1),v=f.length;var u,l,h,g,c,w,p;for(c=0,w=o-1;c<w;c++){for(p=0,l=0,h=c+1,g=c;l<h;l++,g--){p+=e[l]*i[g]}f[c]=p}for(c=o-1,u=0,w=n;c<w;c++,u++){for(p=0,l=u,h=c+1,g=o-1;l<h;l++,g--){p+=e[l]*i[g]}f[c]=p}for(c=n,u=n-o+1;c<v;c++,u++){for(p=0,l=u,g=o-1;l<n;l++,g--){p+=e[l]*i[g]}f[c]=p}switch(a){case undefined:case"full":return new r(v,f);case"same":var m=Math.ceil(o/2);return new r(n,f.subarray(m,m+n));case"valid":return new r(n-o+1,f.subarray(o-1,n));default:throw new Error("Matrix.conv: Invalid shape parameter.")}};var s=function(r){var t=r.getView(),a=r.getData();var e=t.getStep(2),n=t.getEnd(2);var i=t.getStep(1),o=t.getEnd(1),s;var f=t.getEnd(0),v;var u,l,h;for(u=0;u<n;u+=e){for(l=u+1,v=u+f;l<v;l++){a[l]+=a[l-1]}for(h=u+i,s=u+o;h<s;h+=i){var g=a[h];a[h]+=a[h-i];for(l=h+1,v=h+f;l<v;l++){g+=a[l];a[l]=a[l-i]+g}}}};t.fastBlur=function(t,a,e){e=e||3;a=a||t;var n=Math.round(Math.sqrt(12/e*t*t+1)/2)*2+1;var i=Math.round(Math.sqrt(12/e*a*a+1)/2)*2+1;var o=r.zeros(this.getSize());var f=this.getView();var v=f.getStep(2),u=f.getEnd(2);var l=f.getStep(1),h=f.getEnd(1);var g=f.getEnd(0);a=i/2|0;t=(n/2|0)*l;var c=n/2|0;var w,p,m,d,y,b,M;var B,x,D;var A=this.im2double();for(var L=0;L<e;L++){s(A);var S=A.getData(),R=o.getData();var z=t+a+l+1,G=t+a,C=-(t+l)+a,Y=t-a-1;var E=S.subarray(G),I=S.subarray(Y);for(m=0;m<u;m+=v){for(b=m,y=0,p=m+a+1;b<p;b++,y++){x=y+a+1;for(M=b,d=0,w=b+t+l;M<w;M+=l,d++){R[M]=E[M]/((d+c+1)*x)}B=1/(n*x);for(M=b+t+l,w=b+h-t;M<w;M+=l){R[M]=(E[M]-S[M+C])*B}D=S[b+h-l+a];for(M=b+h-t,w=b+h;M<w;M+=l){R[M]=D-S[M+C];R[M]/=(t+w-M)/l*x}}for(d=m,w=m+t+l;d<w;d+=l){B=1/(((d-m+t)/l+1)*i);for(y=d+a+1,p=d+g-a;y<p;y++){R[y]=E[y]-I[y];R[y]*=B}}B=1/(n*i);for(d=m+t+l,w=m+h-t;d<w;d+=l){for(y=d+a+1,p=d+g-a;y<p;y++){R[y]=(S[y-z]+E[y]-S[y+C]-I[y])*B}}for(d=m+h-t,w=m+h;d<w;d+=l){B=1/((m+h-d+t)/l*i);for(y=d+a+1,p=d+g-a;y<p;y++){R[y]=S[y-z]+S[m+h-l+y-d+a]-S[m+h-l+y-d-a-1]-S[y+C];R[y]*=B}}for(y=m+g-a,p=m+g;y<p;y++){for(d=y,w=y+t+l;d<w;d+=l){R[d]=S[d-y+m+g-1+t]-I[d];R[d]/=((d-y+t)/l+1)*(a+(g-(y-m)))}B=1/(n*(a+(g-(y-m))));for(d=y+t+l,w=y+h-t;d<w;d+=l){R[d]=S[d-y+m+g-1+t]-S[d-y+m+g-1-t-l]+S[d-z]-I[d];R[d]*=B}for(d=y+h-t,w=y+h;d<w;d+=l){R[d]=S[m+h-l+g-1]+S[d-z]-S[m+d-y+g-1-t-l]-S[m+h-l+y-m-a-1];R[d]/=(h-(d-y)+t)/l*(a+(g-(y-m)))}}}var F=o;o=A;A=F}return F};var f={};f.normalize=function(r){var t;var a=r.length;var e=0;for(t=0;t<a;t++){e+=Math.abs(r[t])}if(e!==0){for(t=0;t<a;t++){r[t]/=e}}return r};f.gaussian=function(t,a,e){var n,i;if(e===undefined){e=3}if(a===undefined){a=0}var o=1+2*Math.ceil(t*Math.sqrt(e*2*Math.log(10)));var s=new r.dataType(o);var f=(o-1)/2;var v=0,u=Math.abs;for(n=0;n<(o+1)/2;n++){i=n-f;var l=1/(Math.sqrt(2*Math.PI)*t);l*=Math.exp(-(i*i)/(2*t*t));s[n]=s[o-1-n]=l}switch(a){case 0:for(n=0,v=0;n<s.length;n++){v+=u(s[n])}break;case 1:for(n=0,v=0;n<s.length;n++){i=n-f;s[n]*=-i/Math.pow(t,2);v+=u(i*s[n])}break;case 2:for(n=0,v=0;n<s.length;n++){i=n-f;s[n]*=i*i/Math.pow(t,4)-1/Math.pow(t,2);v+=u(s[n])}v/=s.length;for(n=0;n<s.length;n++){s[n]-=u(v)}for(n=0,v=0;n<s.length;n++){i=n-f;v+=u(.5*i*i*s[n])}break;default:throw new Error("Kernel.gaussian: Derive order can be 0,1 or 2 but not "+a)}if(v!==0){for(n=0;n<s.length;n++){s[n]/=v}}return new r(s.length,s)};t.imshow=function(r,t){if(a){console.warn("Matrix.imshow: function not available in nodejs.");return}var e=this.constructor.name+".imshow: ";var n=this.getSize(1);var i=this.getSize(0);if(typeof r==="string"&&document.getElementById(r)){r=document.getElementById(r)}var o;if(r===undefined||r===null){r=document.createElement("canvas");o=window.open("","","width="+n,"height="+i);o.document.body.appendChild(r)}if(!(r instanceof HTMLCanvasElement)){throw new Error(e+"Invalid canvas.")}var s=this.getImageData();if(t===undefined||t===1){r.width=n;r.height=i;r.getContext("2d").putImageData(s,0,0)}else{if(t==="fit"){var f=r.width/n;var v=r.height/i;t=Math.min(f,v);t=t>1?1:t}else if(typeof t!=="number"){throw new Error(e+"scale must be a number or 'fit'")}r.width=Math.round(n*t);r.height=Math.round(i*t);var u=document.createElement("canvas");u.width=n;u.height=i;var l=u.getContext("2d");l.putImageData(s,0,0);r.getContext("2d").drawImage(u,0,0,n,i,0,0,r.width,r.height)}return o||this};t.print=function(){var r=this.imshow();r.print();r.close();return this};t.imagesc=function(r,t){var a=this.min().getDataScalar(),e=this.max().getDataScalar();if(a-e===0){return this["-"](a).imshow(r,t)}return this["-"](a)["./"](e-a).imshow(r,t)};t.imtransform=function(t){t=r.toMatrix(t);var a=this.getSize(0),e=this.getSize(1);var n=o(e,a),i=n.getContext("2d");var s=o(),f=s.getContext("2d");var v=r.toMatrix([0,0,1,e,0,1,e,a,1,0,a,1]).reshape([3,4]);var u=t.mtimes(v).transpose();var l=u.max(0).getData(),h=u.min(0).getData();var g=this.getImageData();i.putImageData(g,0,0);var c=t.getData();s.width=l[0]-h[0];s.height=l[1]-h[1];f.translate(-h[0],-h[1]);f.transform(c[0],c[1],c[3],c[4],c[6],c[7]);f.drawImage(n,0,0);return r.imread(s).convertImage(this.type())};t.imhist=function(t){if(!this.ismatrix()){throw new Error("Matrix.imhist: This function only works on grey-level images.")}t=t||256;var a=this.getData();var e=r.zeros(t,1),n=e.getData();var i;if(this.isinteger()){i=r.intmax(this.type())}else if(this.islogical()){i=1;t=2}else if(this.isfloat()){i=1}else{throw new Error("Matrix.imhist: unknow data type.")}var o,s,f=1/i*t;for(o=0,s=a.length;o<s;o++){n[a[o]*f|0]++}return e};(function(){var a=function(r,t){var a=r.length;var e=new Float32Array(t);var n,i=Math.floor;for(n=0;n<a;++n){var o=i(r[n]*t);o=o>=t?t-1:o;++e[o]}var s=1/a;for(n=1;n<t;++n){e[n]+=e[n-1];e[n-1]*=s}e[n-1]*=s;return e};t.histeq=function(t){var e=this.im2double();var n=e;if(this.getSize(2)>1){n=e.applycform("RGB to HSL").get([],[],2)}n=n.getData();var i=a(n,t);var o=Math.floor;for(var s=0;s<n.length;++s){n[s]=i[o(n[s]*(t-1))]}var f=new r([e.size(0),e.size(1)],n);e.set([],[],2,f);if(this.getSize(2)>1){e.applycform("HSL to RGB")}return e}})();t.rgb2gray=function(){if(this.ndims()!==3||this.getSize(2)<3){throw new Error("Matrix.rgb2gray: Matrix must be an "+"image with RGB components.")}var t=this.getSize();t[2]-=2;var a=new r(t,this.getDataType());var e=this.getData(),n=a.getData();var i=this.getView();var o=i.getEnd(0),s;var f=i.getStep(1),v=i.getEnd(1),u;var l=i.getStep(2);var h,g,c,w;for(h=0,u=v;h!==u;h+=f){g=h;c=h+l;w=h+2*l;for(s=h+o;g<s;g++,c++,w++){n[g]=.3*e[g]+.59*e[c]+.11*e[w]}}if(this.getSize(2)===4){var p=n.subarray(l);var m=e.subarray(3*l);p.set(m)}return a}})(Matrix,Matrix.prototype);(function(){var r=function(r,t,a){this.x=r;this.y=t;this.parent=a};r.prototype.initChildren=function(t,a){var e=this.x,n=this.y;if(n+1<a){this.top=new r(e,n+1,this)}if(n-1>=0){this.bottom=new r(e,n-1,this)}if(e+1<t){this.left=new r(e+1,n,this)}if(e-1>=0){this.right=new r(e-1,n,this)}};r.prototype.remove=function(r){if(this.bottom===r){this.bottom=undefined}else if(this.top===r){this.top=undefined}else if(this.right===r){this.right=undefined}else if(this.left===r){this.left=undefined}return this};r.prototype.getNext=function(){if(this.top){return this.top}if(this.bottom){return this.bottom}if(this.left){return this.left}if(this.right){return this.right}if(this.parent){return this.parent.remove(this).getNext()}return undefined};Matrix.prototype.getConnectedComponent=function(t,a,e){var n=this.getSize(0),i=this.getSize(1),o=this.getSize(2);var s=e*e;var f=new Matrix([n,i],"logical"),v=new Matrix([n,i],"logical");var u=f.getData(),l=this.getData(),h=v.getData();window.CC=f;window.IV=v;var g=a+n*t;var c;if(o===1){if(this.type()==="logical"){}else{var w=l[g];c=function(r){var t=l[r]-w;return t*t<s}}}else if(o===3){var p=l[g],m=l[g+n*i],d=l[g+n*i*2];var y=l,b=l.subarray(n*i),M=l.subarray(n*i*2);c=function(r){var t=y[r]-p,a=b[r]-m,e=M[r]-d;return t*t+a*a+e*e<s}}else{throw new Error("Matrix.getConnectedComponent: This function only support "+"images with depth 1 or 3.")}var B=new r(t,a),x=B;while(x!==undefined){var D=x.x,A=x.y,L=A+n*D;if(h[L]===1){x=x.parent.remove(x).getNext();continue}h[L]=1;if(c(L)){u[L]=1;x.initChildren(i,n)}x=x.getNext()}return f};Matrix.prototype.bwconncomp=function(){}})();(function(r,t){"use strict";var a=function(r,t,a,e){var n=t>>1,i=r>>1;return{xS:new Int32Array([0,0,0,i,i,i,a-i,a-i,a-i]),xE:new Int32Array([i,i,i,a-i,a-i,a-i,a,a,a]),yS:new Int32Array([0,n,e-n,0,n,e-n,0,n,e-n]),yE:new Int32Array([n,e-n,e,n,e-n,e,n,e-n,e]),jS:new Int32Array([0,0,0,-i,-i,-i,-i,-i,-i]),jE:new Int32Array([i+1,i+1,i+1,i+1,i+1,i+1,a,a,a]),iS:new Int32Array([0,-n,-n,0,-n,-n,0,-n,-n]),iE:new Int32Array([n+1,n+1,e,n+1,n+1,e,n+1,n+1,e]),lS:new Int32Array([i,i,i,0,0,0,0,0,0]),lE:new Int32Array([r,r,r,r,r,r,i+a,i+a,i+a]),kS:new Int32Array([n,0,0,n,0,0,n,0,0]),kE:new Int32Array([t,t,n+e,t,t,n+e,t,t,n+e]),jxS:new Int32Array([0,0,0,1,1,1,1,1,1]),jxE:new Int32Array([1,1,1,1,1,1,0,0,0]),iyS:new Int32Array([0,1,1,0,1,1,0,1,1]),iyE:new Int32Array([1,1,0,1,1,0,1,1,0])}};var e=function(r,t,a,e,n,i,o,s,f,v,u){var l=-Infinity;for(var h=o,g=v;h<u;h+=a,g+=e){for(var c=i+h,w=s+g,p=f+h;c<p;c++,w++){if(r[c]>l&&t[w]){l=r[c]}}}return l};var n=function(r,t,a,e,n,i,o,s,f,v,u){var l=Infinity;for(var h=o,g=v;h<u;h+=a,g+=e){for(var c=i+h,w=s+g,p=f+h;c<p;c++,w++){if(r[c]<l&&t[w]){l=r[c]}}}return l};var i=function(r,t,a,e,n,i,o,s,f,v,u){var l=0;for(var h=o,g=v;h<u;h+=a,g+=e){for(var c=i+h,w=s+g,p=f+h;c<p;c++,w++){l+=r[c]*t[w]}}return l};var o=function(t,e,n){e=r.toMatrix(e);var i=t.getSize(0),o=t.getSize(1),s=t.getSize(2),f=t.getData();var v=new r(t.getSize(),t.type()),u=v.getData();var l=e.getSize(0),h=e.getSize(1),g=e.getData();var c=a(h,l,o,i);var w=c.xS,p=c.xE,m=c.yS,d=c.yE,y=c.jS,b=c.jE,M=c.iS,B=c.iE,x=c.lS,D=c.kS,A=c.jxS,L=c.jxE,S=c.iyS,R=c.iyE;var z,G,C,Y,E,I,F,k,Q,Z;var X,H,q,T;for(G=0,X=f.length;G<X;G+=o*i){var V=f.subarray(G,G+o*i),U=u.subarray(G,G+o*i);for(z=0;z<9;z++){for(C=w[z],H=p[z],E=C*i;C<H;C++,E+=i){var j=(y[z]+(A[z]?C:0))*i,J=(b[z]+(L[z]?C:0))*i;var K=(x[z]-(A[z]?0:C))*l;for(Y=m[z],q=d[z],I=Y+E;Y<q;Y++,I++){var P=M[z]+(S[z]?Y:0),N=B[z]+(R[z]?Y:0);var O=D[z]-(S[z]?0:Y);U[I]=n(V,g,i,l,I,P,j,O,N,K,J)}}}}return v};t.imdilate=function(r){return o(this,r,e)};t.imerode=function(r){return o(this,r,n)};t.imopen=function(r){return o(o(this,r,n),r,e)};t.imclose=function(r){return o(o(this,r,e),r,n)};t.imfilter=function(r){return o(this,r,i)};t.median=function(r){var t=r.length*.5|0;var a=function(r,a,e,n,i,o,s,f,v,u,l){var h=[];for(var g=s,c=u;g<l;g+=e,c+=n){for(var w=o+g,p=f+c,m=v+g;w<m;w++,p++){if(a[p]){h.push(r[w])}}}return h.sort()[t]};return o(this,r,a)};t.imbilateral=function(t,a,e){e=e||3;var n=r.fspecial("gaussian",Math.round(e*t/2)*2+1,t);var i=-1/(2*a);var s=function(r,t,a,e,n,o,s,f,v,u,l){var h=0,g=0,c=r[n];for(var w=s,p=u;w<l;w+=a,p+=e){for(var m=o+w,d=f+p,y=v+w;m<y;m++,d++){var b=c-r[m];var M=t[d]*Math.exp(i*b*b);h+=M;g+=r[m]*M}}return g/h};return o(this,n,s)};r.psnr=function(t,a,e){t=r.toMatrix(t);a=r.toMatrix(a);Tools.checkSizeEquals(t.size(),a.size());if(!Tools.isSet(e)){var n=t.type(),i=a.type();var o=t.isfloat()?1:r.intmax(n)-r.intmin(i);var s=a.isfloat()?1:r.intmax(i)-r.intmin(i);e=Math.max(o,s)}else{e=1}var f=a.getData(),v=t.getData();var u,l,h=0;for(u=0,l=v.length;u<l;u++){var g=f[u]-v[u];h+=g*g}return r.toMatrix(10*Math.log10(e*e*l/h))}})(Matrix,Matrix.prototype);(function(r,t){"use strict";var a=function(r,t,a,e,n,i,o,s,f,v,u,l,h,g,c,w,p){var m,d,y,b,M,B,x;for(m=r,d=t+a;m<e;m+=n,d+=i){for(y=0,b=m+o,M=0,B=0;y<s;y++,b-=f){x=b;while(x<r){x+=v}while(x>=e){x-=v}if(u&&x===e-f){x-=f}M+=l[y]*g[x];B+=h[y]*c[x]}w[d]+=M;p[d]+=B}};var e=function(r,t,a,e,n,i,o,s,f,v,u,l,h,g,c,w,p){var m,d,y,b,M,B,x;r+=s-o-1;e-=o;for(m=r,d=t+a;m<e;m+=n,d+=i){for(y=0,b=m+o,M=0,B=0;y<s;y++,b-=f){M+=l[y]*g[b];B+=h[y]*c[b]}w[d]+=M;p[d]+=B}};var n=function(r,t,a,e,n,i,o,s,f,v,u,l,h,g,c,w,p){var m,d,y,b,M,B,x;r+=s-o-1;e-=o;for(m=r,d=t+a;m<e;m+=n,d+=i){var D=[],A=[];for(y=0,b=m+o,M=0,B=0;y<s;y++,b-=f){D.push(b);A.push(y);M+=l[y]*g[b];B+=h[y]*c[b]}console.log(d,D,m,e);w[d]+=M;p[d]+=B}};var i,o;r.dwtmode=function(r){if(r===undefined){return o}r=r.toLowerCase();switch(r){case"per":i=a;break;case"sym":case"symw":case"zpd":case"nn":i=e;break;default:throw new Error("Matrix.dwtmode: invalid mode "+r+".")}o=r};r.dwtmode("per");var s=function(r,t,a,e,n,o,s,f,v,u){var l=e.length;o=(o==="cl"?Math.floor:Math.ceil)((l-1)/2);var h=a.getSize(0)%2?true:false;var g=a.getFirst(0),c=a.getStep(0);var w=a.getEnd(0)+(h?c:0);var p=u.getFirst(0),m=u.getStep(0);var d=r.getData(),y=t.getData(),b=f.getData(),M=v.getData();var B=o*c;var x=c;c*=s;var D=a.getIterator(1),A=u.getIterator(1);var L,S,R=D.iterator,z=D.begin,G=D.end();var C,Y,E=A.iterator,I=A.begin;var F,k,Q,Z,X;for(S=z(),Y=I();S!==G;S=R(),Y=E()){var H=g+S,q=w+S;i(H,Y,p,q,c,m,B,l,x,w,h,e,n,d,y,b,M)}};var f=r.zeros;var v=function(r,t){var a=t%2?true:false;var e=Math.floor,n=Math.ceil;var i=e((r-1)/2),o=n((r-1)/2);var s=n(o/2)*2+i-1,f=a?n(i/2)*2+o-1:e(i/2)*2+o;var v=n(o/2),u=a?n(i/2):e(i/2);return{lk:i,rk:o,li:s,lo:v,ri:f,ro:u}};var u=function(t,a,e){var n=r.wfilters(a,"d");var i=n[0].getData(),u=n[1].getData();var l=t.getSize();l[e]=Math.ceil(l[e]/2);if(o!=="per"){var h=v(i.length,t.numel());l[e]+=h.ro+h.lo-1;t=t.paddim(o,e,[h.li,h.ri])}var g=f(l),c=f(l);var w=g.getView().swapDimensions(0,e);var p=t.getView().swapDimensions(0,e);s(t,t,p,i,u,"cr",2,g,c,w);return[g,c]};var l=function(t,a,e){var n=r.wfilters(a,"r");var i=n[0].getData(),u=n[1].getData();if(o!=="per"){var l=v(i.length,t[0].numel());t[0]=t[0].paddim(o,e,[0,1]);t[1]=t[1].paddim(o,e,[0,1])}var h=t[0].getSize();h[e]*=2;var g=f(h),c=f(h);var w=o==="per"?0:1;var p=g.getView().selectDimension(e,[w,2,-1]);t[0].extractViewTo(p,g);t[1].extractViewTo(p,c);p.restore().swapDimensions(0,e);if(o!=="per"){h[e]-=l.rk+l.lk+1}var m=f(h);var d=m.getView().swapDimensions(0,e);s(g,c,p,i,u,"cl",1,m,m,d);return m};var h=function(t,a){var e=r.wfilters(a,"d");var n=e[0].getData(),i=e[1].getData();var o=t.getSize(0),v=t.getSize(1),u=t.getSize(2);var l=Math.ceil(v/2),h=Math.ceil(o/2);var g=f(h,v,u),c=f(h,v,u);var w=g.getView();var p=t.getView();s(t,t,p,n,i,"cr",2,g,c,w);var m=f(h,l,u),d=f(h,l,u),y=f(h,l,u),b=f(h,l,u);var M=m.getView().swapDimensions(0,1);w.swapDimensions(0,1);s(g,g,w,n,i,"cr",2,m,y,M);s(c,c,w,n,i,"cr",2,d,b,M);return[m,y,d,b]};var g=function(t,a){var e=r.wfilters(a,"r");var n=e[0].getData(),i=e[1].getData();var o=t[0].getSize(0),v=t[0].getSize(1),u=t[0].getSize(2);var l=f(2*o,v,u),h=f(2*o,v,u);var g=f(2*o,2*v,u),c=f(2*o,2*v,u);var w=f(2*o,2*v,u);var p=l.getView(),m=g.getView();var d=w.getView().swapDimensions(0,1);m.select([],[0,2,-1]);l.set([0,2,-1],t[0]);h.set([0,2,-1],t[2]);s(l,h,p,n,i,"cl",1,g,g,m);l.set([0,2,-1],[],t[1]);h.set([0,2,-1],[],t[3]);s(l,h,p,n,i,"cl",1,c,c,m);m.restore().swapDimensions(0,1);s(g,c,m,n,i,"cl",1,w,w,d);return w};r.dwt=function(r,t,a){a=a||0;return u(r,t,a)};r.idwt=function(r,t,a){a=a||0;return l(r,t,a)};r.dwt2=function(r,t){return h(r,t)};r.idwt2=function(r,t){return g(r,t)};r.wavedec=function(t,a,e,n){n=n||0;var i=new Uint16Array(a+2),o=0;i[a+1]=t.getSize(n);var s;for(s=a;s>=1;s--){i[s]=Math.ceil(i[s+1]/2);o+=i[s]}i[0]=i[1];o+=i[0];var v=[0,i[0]];for(s=2;s<a+2;s++){v[s]=i[s-1]+v[s-1]}var l=t.getSize();l[n]=o;var h=f(l),g=h.getView();var c=t,w,p;for(s=a;s>=1;s--){var m=u(c,e,n);g.selectDimension(n,[v[s],v[s+1]-1]);m[1].extractViewTo(g,h);g.restore();c=m[0]}g.selectDimension(n,[v[0],v[1]-1]);m[0].extractViewTo(g,h);return[h,new r([i.length],i)]};r.waverec=function(r,t,a){a=a||0;var e=r[1].getData();var n=[0,e[0]];var i,o=e.length-2;for(i=2;i<o+2;i++){n[i]=e[i-1]+n[i-1]}var s=r[0];var f=s.getView().selectDimension(a,[n[0],n[1]-1]);var v=s.extractViewFrom(f);for(i=1;i<n.length-1;i++){var u=s.getView().selectDimension(a,[n[i],n[i+1]-1]);var h=s.extractViewFrom(u);if(v.size(a)===h.size(a)+1){f=v.getView().selectDimension(a,[0,-2]);v=v.extractViewFrom(f)}v=l([v,h],t,a)}if(v.size(a)===e[e.length-1]+1){f=v.getView().selectDimension(a,[0,-2]);v=v.extractViewFrom(f)}return v};var c=function(t,a){var e=new Array(a+2);var n=new Array(a+2);var i=new Array(a+2);n[a+1]=t.getSize(0);e[a+1]=t.getSize(1);i[a+1]=t.getSize(2);var o;for(o=a;o>=1;o--){n[o]=Math.ceil(n[o+1]/2);e[o]=Math.ceil(e[o+1]/2);i[o]=i[o+1]}n[0]=n[1];e[0]=e[1];i[0]=i[1];return r.toMatrix([n,e,i])};var w=function(r){var t=r.get([],0).getData(),a=r.get([],1).getData(),e=r.get([],2).getData();var n=a[0]*t[0]*e[0];var i=[0,n],o=[];var s,f=t.length-2;for(s=1;s<f+1;s++){o.push([t[s],a[s],e[s]]);var v=t[s]*a[s]*e[s];for(var u=0;u<3;u++){n+=v;i.push(n)}}return{bands:i,outSize:n,subSizes:o,ySizes:t,xSizes:a,cSizes:e,J:f}};var p=function(r,t,a){if(r.getSize(0)!==t.ySizes[a+1]||r.getSize(1)!==t.xSizes[a+1]){r=r.get([0,t.ySizes[a+1]-1],[0,t.xSizes[a+1]-1],[])}return r};r.wavedec2=function(t,a,e){var n=c(t,a);var i=w(n);var o=new Float64Array(i.outSize);for(var s=a-1,f=3*s;s>=0;s--,f-=3){var v=h(t,e);o.subarray(i.bands[f+1],i.bands[f+2]).set(v[1].getData());o.subarray(i.bands[f+2],i.bands[f+3]).set(v[2].getData());o.subarray(i.bands[f+3],i.bands[f+4]).set(v[3].getData());t=v[0]}o.subarray(i.bands[0],i.bands[1]).set(v[0].getData());return[new r([o.length],o),n]};r.waverec2=function(t,a){var e=w(t[1]),n=t[0].getData();var i,o,s,f;i=new r(e.subSizes[0],n.subarray(e.bands[0],e.bands[1]));for(var v=0,u=0,l=e.J;v<l;v++,u+=3){o=new r(e.subSizes[v],n.subarray(e.bands[u+1],e.bands[u+2]));s=new r(e.subSizes[v],n.subarray(e.bands[u+2],e.bands[u+3]));f=new r(e.subSizes[v],n.subarray(e.bands[u+3],e.bands[u+4]));i=g([i,o,s,f],a);i=p(i,e,v+1)}return i};r.upwlev2=function(t,a){if(t[1].getSize(0)===2){return[new r,new r]}var e=w(t[1]),n=t[0].getData();var i=new r(e.subSizes[0],n.subarray(e.bands[0],e.bands[1]));var o=new r(e.subSizes[0],n.subarray(e.bands[1],e.bands[2]));var s=new r(e.subSizes[0],n.subarray(e.bands[2],e.bands[3]));var f=new r(e.subSizes[0],n.subarray(e.bands[3],e.bands[4]));var v=g([i,o,s,f],a);v=p(v,e,1);var u=t[1].get([1,-1]);u.set(0,[],u.get(1,[]));var l=v.numel(),h=n.length-e.bands[4];var c=new Float64Array(l+h);c.subarray(0,l).set(v.getData());c.subarray(l).set(n.subarray(e.bands[4]));return[new r([c.length],c),u,i]};r.appcoef2=function(t,a,e){var n=t[1].size(0)-2;while(n>e+1){t=r.upwlev2(t,a);n=t[1].size(0)-2}var i=t[1].get([1,-1]).prod(1).getData();var o=t[0].getData();var s=t[1].get(0).getData();return new r(s,o.subarray(0,i[0]))};r.detcoef2=function(t,a,e){if(t==="all"){return[r.detcoef2("h",a,e),r.detcoef2("v",a,e),r.detcoef2("d",a,e)]}var n=w(a[1]),i=a[0].getData();var o=n.J-(e+1);var s=a[1].get([o+1],[]).getData();var f=1+o*3;if(t==="v"){f+=1}else if(t==="d"){f+=2}else if(t!=="h"){throw new Error("Matrix.detcoef2: Wrong type argument")}return new r(s,i.subarray(n.bands[f],n.bands[f+1]))};r.wrcoef2=function(t,a,e,n){var i=w(a[1]),o=i.J;for(var s=0;s<n;s++){a=r.upwlev2(a,e)}var i=w(a[1]),f=a[0].getData();var v,u,l,h;var c=new r(i.subSizes[0]);v=u=l=h=c;if(t==="a"){v=new r(i.subSizes[0],f.subarray(i.bands[0],i.bands[1]))}else if(t==="h"){u=new r(i.subSizes[0],f.subarray(i.bands[1],i.bands[2]))}else if(t==="v"){l=new r(i.subSizes[0],f.subarray(i.bands[2],i.bands[3]))}else if(t==="d"){h=new r(i.subSizes[0],f.subarray(i.bands[3],i.bands[4]))}var v=g([v,u,l,h],e);v=p(v,i,1);var m=a[1].get([1,-1]);m.set(0,[],m.get(1,[]));var d=v.numel(),y=f.length-i.bands[4];var b=new Float64Array(d+y);b.subarray(0,d).set(v.getData());a=[new r([b.length],b),m,v];for(var s=n+1;s<o;s++){a=r.upwlev2(a,e)}return a[0].reshape(a[1].get(0).getData())};r.dwtmaxlev=function(t,a){t=r.toMatrix(t).min().getDataScalar();var e=r.wfilters(a);var n=e[0].numel(),i=e[1].numel(),o=e[2].numel(),s=e[3].numel();var f=Math.max(n,i,o,s);var v=Math.floor(Math.log(t/(f-1))/Math.log(2));return v};(function(){var a={sym:function(r,t,a){var e=r+t+a,n=new Uint32Array(e);var i,o,s,f=2*r;for(o=t,i=0;o>0;o--,i++){s=(o-1)%f;n[i]=s>=r?f-s-1:s}for(o=0;o<r;o++,i++){n[i]=o}for(o=0;o<a;o++,i++){s=(o+r)%f;n[i]=s>=r?f-s-1:s}return n},symw:function(r,t,a){var e=r+t+a,n=new Uint32Array(e);var i,o,s,f=2*r;i=0;for(o=t;o>0;o--,i++){s=(o-1)%(f-2);n[i]=s>=r-1?f-3-s:s+1}for(o=0;o<r;o++,i++){n[i]=o}for(o=0;o<a;o++,i++){s=(o+r)%(f-2);n[i]=s>=r-1?f-s-2:s}return n},per:function(r,t,a){var e=r+t+a,n=new Uint32Array(e);var i,o;i=0;for(o=t;o>0;o--,i++){n[i]=r-o}for(o=0;o<r;o++,i++){n[i]=o}for(o=0;o<a;o++,i++){n[i]=o}return n},nn:function(r,t,a){var e=r+t+a,n=new Uint32Array(e);var i,o,s,f;i=0;for(o=t;o>0;o--,i++){n[i]=0}for(o=0;o<r;o++,i++){n[i]=o}for(o=0;o<a;o++,i++){n[i]=r-1}return n}};t.paddim=function(r,t,a){var e=[r];for(var n=0;n<t;n++){e.push([])}e.push(a);return this.padarray.apply(this,e)};t.padarray=function(){var t=Array.prototype.shift.apply(arguments);if(t!=="zpd"){var e=a[t];if(e===undefined){throw new Error("Matrix.padarray: Unimplemented mode "+t+".")}for(var n=[],i=0;i<arguments.length;i++){var o=arguments[i],s;if(Tools.isInteger(o)){s=[e(this.getSize(i),o,o)]}else if(Tools.isArrayLike(o)&&o.length===0){s=[]}else{s=[e(this.getSize(i),o[0],o[1])]}n.push(s)}return this.get.apply(this,n)}var n=[],f=this.getSize();for(var i=0;i<arguments.length;i++){var o=arguments[i];f[i]=f[i]?f[i]:1;if(Tools.isInteger(o)){s=[o,-o-1];f[i]+=2*o}else if(Tools.isArrayLike(o)&&o.length===0){s=[]}else{s=[o[0],-o[1]-1];f[i]+=o[0]+o[1]}n.push(s)}n.push(this);var v=r.zeros(f);return v.set.apply(v,n)}})();window.addEventListener("load",function(){var t=function(){r.dwtmode("zpd");var t="sym4";var a=r.colon(1,7);a.transpose().display("signal");var e=u(a,t,0);e[0].transpose().display("L");e[1].transpose().display("H");var n=l(e,t,0);n.transpose().display("iwt");r.dwtmode("per")};t()},false)})(Matrix,Matrix.prototype);(function(r,t){"use strict";var a=Tools.arrayFromBase64("AgADAAUABwALAA0AEQATABcAHQAfACUAKQArAC8ANQA7AD0AQwBHAEkATwBTAFkAYQBlAGcAawBt        AHEAfwCDAIkAiwCVAJcAnQCjAKcArQCzALUAvwDBAMUAxwDTAN8A4wDlAOkA7wDxAPsAAQEHAQ0B        DwEVARkBGwElATMBNwE5AT0BSwFRAVsBXQFhAWcBbwF1AXsBfwGFAY0BkQGZAaMBpQGvAbEBtwG7        AcEByQHNAc8B0wHfAecB6wHzAfcB/QEJAgsCHQIjAi0CMwI5AjsCQQJLAlECVwJZAl8CZQJpAmsC        dwKBAoMChwKNApMClQKhAqUCqwKzAr0CxQLPAtcC3QLjAucC7wL1AvkCAQMFAxMDHQMpAysDNQM3        AzsDPQNHA1UDWQNbA18DbQNxA3MDdwOLA48DlwOhA6kDrQOzA7kDxwPLA9ED1wPfA+UD8QP1A/sD        /QMHBAkEDwQZBBsEJQQnBC0EPwRDBEUESQRPBFUEXQRjBGkEfwSBBIsEkwSdBKMEqQSxBL0EwQTH        BM0EzwTVBOEE6wT9BP8EAwUJBQsFEQUVBRcFGwUnBSkFLwVRBVcFXQVlBXcFgQWPBZMFlQWZBZ8F        pwWrBa0FswW/BckFywXPBdEF1QXbBecF8wX7BQcGDQYRBhcGHwYjBisGLwY9BkEGRwZJBk0GUwZV        BlsGZQZ5Bn8GgwaFBp0GoQajBq0GuQa7BsUGzQbTBtkG3wbxBvcG+wb9BgkHEwcfBycHNwdFB0sH        TwdRB1UHVwdhB20Hcwd5B4sHjQedB58HtQe7B8MHyQfNB88H0wfbB+EH6wftB/cHBQgPCBUIIQgj        CCcIKQgzCD8IQQhRCFMIWQhdCF8IaQhxCIMImwifCKUIrQi9CL8IwwjLCNsI3QjhCOkI7wj1CPkI        BQkHCR0JIwklCSsJLwk1CUMJSQlNCU8JVQlZCV8JawlxCXcJhQmJCY8JmwmjCakJrQnHCdkJ4wnr        Ce8J9Qn3Cf0JEwofCiEKMQo5Cj0KSQpXCmEKYwpnCm8KdQp7Cn8KgQqFCosKkwqXCpkKnwqpCqsK        tQq9CsEKzwrZCuUK5wrtCvEK8woDCxELFQsbCyMLKQstCz8LRwtRC1cLXQtlC28LewuJC40LkwuZ        C5sLtwu5C8MLywvPC90L4QvpC/UL+wsHDAsMEQwlDC8MMQxBDFsMXwxhDG0Mcwx3DIMMiQyRDJUM        nQyzDLUMuQw=",Uint16Array);var e=a.length;var n=function(r){if(r===1){return 0}var t=[],n,i,o;for(n=i=0;i<e;i++){if(r%a[i]===0){o=a[i];do{t[n]=o;n++;r=r/o}while(r%o===0)}}if(r!==1){t[n]=r;n++}return t};var i=function(r,t,a){var e=r[t];r[t]=r[a];r[a]=e};var o=function(r,t,a,e){var n=r.length/2,i,o;if(e===1){for(i=0,o=0;i<n;i++){t[i]=r[o++];a[i]=-r[o++]}}else{var s=1/n;for(i=0,o=0;i<n;i++){t[i]=r[o++]*s;a[i]=-r[o++]*s}}};var s=function(r,t){var a=r.length,e,n;var i=new Float64Array(2*a);if(t){for(e=0,n=0;e<a;e++){i[n++]=r[e];i[n++]=-t[e]}}else{for(e=0,n=0;e<a;e++,n++){i[n++]=r[e]}}return i};var f=function(r,t,a){var e,n,o,f,v;var u,l,h,g,c,w;var p,m;var d=r.length,y=s(r,t);var b=d<<1;for(v=1,o=1;v<b;v+=2){if(o>v){i(y,o-1,v-1);i(y,o,v)}e=b>>1;while(e>=2&&o>e){o=o-e;e>>=1}o=o+e}var M=2;while(b>M){f=2*M;w=2*Math.PI/(a*M);u=Math.sin(.5*w);h=-2*u*u;g=Math.sin(w);l=1;c=0;for(e=1;e<M;e+=2){for(v=e-1;v<=b-1;v+=f){o=v+M;p=l*y[o]-c*y[o+1];m=l*y[o+1]+c*y[o];y[o]=y[v]-p;y[o+1]=y[v+1]-m;y[v]+=p;y[v+1]+=m}l=(u=l)*h-c*g+l;c=c*h+u*g+c}M=f}return y};var v=function(r,t,a,e){var n=r.length,i;var o=new Float64Array(n),f=new Float64Array(n);var v=2*Math.PI/n;for(i=0;i<n;i++){o[i]=Math.cos(i*v);f[i]=a*Math.sin(i*v)}var u=s(r,t),l=new Float64Array(2*n);var h,g,c,w,p,m;var d=1,y,b=e.length;for(y=0;y<b;y++){w=e[y];p=n/d/w;m=d*w;for(g=0;g<2*n;g++){l[g]=0}for(h=0;h<w;h++){for(c=0;c<m;c++){var M=c*h%m*p;var B=o[M],x=f[M];var D=2*p*c,A=2*p*(h+c%d*w);for(i=0;i<p;i++,D+=2,A+=2){l[D]+=u[A]*B-u[A+1]*x;l[D+1]+=u[A]*x+u[A+1]*B}}}var L=u;u=l;l=L;d*=w}return u};var u=function(r,t,a,e,i){var s=r.length,u=n(s),l=u.length;var h=!i?1:-1,g;if(s>1&&u[l-1]!==2){g=v(r,t,h,u)}else{g=f(r,t,h)}return o(g,a,e,h)};var l=function(t,a){if(t.isreal()){t.toComplex()}var e=new r(t.getSize(),Float64Array,true);var n=t.getRealData(),i=t.getImagData();var o=e.getRealData(),s=e.getImagData();var f,v,l=t.getSize(0),h=t.numel()/l;for(f=0,v=0;f<h;f++,v+=l){var g=n.subarray(v,l+v),c=i.subarray(v,l+v);var w=o.subarray(v,l+v),p=s.subarray(v,l+v);u(g,c,w,p,a)}return e};t.fft=function(){return l(this,false)};r.fft=function(t){return l(r.toMatrix(t),false)};t.fft2=function(){var r=l(this,false);

r=l(r.transpose(),false);return r.transpose()};r.fft2=function(t){var a=l(r.toMatrix(t),false);a=l(a.transpose(),false);return a.transpose()};(function(){var t=function(r,t,a){var e=r.getSize();if(Tools.isSet(t)){if(!Tools.isInteger(t,0)){throw new Error("Matrix.fftshift: Dimension must be a positive integer")}return this.circshift(a(e[t]/2),t)}for(var n=0,i=e.length;n<i;n++){e[n]=a(e[n]/2)}return r.circshift(e)};r.prototype.fftshift=function(r){return t(this,r,Math.floor)};r.prototype.ifftshift=function(r){return t(this,r,Math.ceil)}})();t.ifft=function(){return l(this,true)};r.ifft=function(t){return l(r.toMatrix(t),true)};t.ifft2=function(){return this.fft().transpose().fft().transpose()};r.ifft2=function(t){return r.toMatrix(t).ifft().transpose().ifft().transpose()}})(Matrix,Matrix.prototype);(function(r){function t(r){var a=this.constructor.name+": ";if(r===undefined){this.name="haar"}else{this.name=r.toLowerCase()}if(t.list[this.name]){var e=t.list[this.name];var n=e.normalized!==undefined&&!e.normalized?function(r){return t.filter(r,"norm")}:function(r){return r};this.filterL=n(e.filterL);this.orthogonal=e.orthogonal?true:false;if(e.filterH){this.filterH=n(e.filterH)}if(e.invFilterL){this.invFilterL=n(e.invFilterL)}if(e.invFilterH){this.invFilterH=n(e.invFilterH)}}if(this.filterL===undefined){var i=a+"unknown wavelet '"+r+"'. \n";i+="User-defined wavelets not implemented yet.";throw new Error(i)}var o=function(r,a){return t.filter(r,"conjugate",a?-1:1)};if(!this.filterH&&this.orthogonal){this.filterH=t.filter(o(this.filterL),"mirror")}if(!this.invFilterL){this.invFilterL=o(this.filterH,true)}if(!this.invFilterH){this.invFilterH=o(this.filterL,false)}return this}t.list={haar:{orthogonal:true,normalized:false,filterL:new Float64Array([1,1])},db2:{name:"Daubechies 2",orthogonal:true,normalized:false,filterL:new Float64Array([1+Math.sqrt(3),3+Math.sqrt(3),3-Math.sqrt(3),1-Math.sqrt(3)])},db4:{name:"Daubechies 4",orthogonal:true,filterL:new Float64Array([-.010597401784997278,.032883011666982945,.030841381835986965,-.18703481171888114,-.02798376941698385,.6308807679295904,.7148465705525415,.23037781330885523])},db8:{name:"Daubechies 8",orthogonal:true,filterL:new Float64Array([-.00011747678400228192,.0006754494059985568,-.0003917403729959771,-.00487035299301066,.008746094047015655,.013981027917015516,-.04408825393106472,-.01736930100202211,.128747426620186,.00047248457399797254,-.2840155429624281,-.015829105256023893,.5853546836548691,.6756307362980128,.3128715909144659,.05441584224308161])},sym2:{name:"Symlets 2",orthogonal:true,filterL:new Float64Array([-.12940952255092145,.22414386804185735,.836516303737469,.48296291314469025])},sym4:{name:"Symlets 4",orthogonal:true,filterL:new Float64Array([-.07576571478927333,-.02963552764599851,.49761866763201545,.8037387518059161,.29785779560527736,-.09921954357684722,-.012603967262037833,.0322231006040427])},sym8:{name:"Symlets 8",orthogonal:true,filterL:[-.0033824159510061256,-.0005421323317911481,.03169508781149298,.007607487324917605,-.1432942383508097,-.061273359067658524,.4813596512583722,.7771857517005235,.3644418948353314,-.05194583810770904,-.027219029917056003,.049137179673607506,.003808752013890615,-.01495225833704823,-.0003029205147213668,.0018899503327594609]},coif1:{name:"Coiflets 1",orthogonal:true,filterL:new Float64Array([-.01565572813546454,-.0727326195128539,.38486484686420286,.8525720202122554,.3378976624578092,-.0727326195128539])},coif2:{name:"Coiflets 2",orthogonal:true,filterL:new Float64Array([-.0007205494453645122,-.0018232088707029932,.0056114348193944995,.023680171946334084,-.0594344186464569,-.0764885990783064,.41700518442169254,.8127236354455423,.3861100668211622,-.06737255472196302,-.04146493678175915,.016387336463522112])},coif4:{name:"Coiflets 4",orthogonal:true,filterL:new Float64Array([-17849850030882614e-22,-32596802368833675e-22,31229875865345646e-21,6233903446100713e-20,-.00025997455248771324,-.0005890207562443383,.0012665619292989445,.003751436157278457,-.00565828668661072,-.015211731527946259,.025082261844864097,.03933442712333749,-.09622044203398798,-.06662747426342504,.4343860564914685,.782238930920499,.41530840703043026,-.05607731331675481,-.08126669968087875,.026682300156053072,.016068943964776348,-.0073461663276420935,-.0016294920126017326,.0008923136685823146])},bi13:{name:"Biorthogonal 1-3",orthogonal:false,filterL:new Float64Array([-.08838834764831845,.08838834764831845,.7071067811865476,.7071067811865476,.08838834764831845,-.08838834764831845]),filterH:new Float64Array([-.7071067811865476,.7071067811865476])},bi31:{name:"Biorthogonal 3-1",orthogonal:false,filterL:new Float64Array([-.3535533905932738,1.0606601717798214,1.0606601717798214,-.3535533905932738]),filterH:new Float64Array([-.1767766952966369,.5303300858899107,-.5303300858899107,.1767766952966369])},bi68:{name:"Biorthogonal 6-8",orthogonal:false,filterL:new Float64Array([0,.0019088317364812906,-.0019142861290887667,-.016990639867602342,.01193456527972926,.04973290349094079,-.07726317316720414,-.09405920349573646,.4207962846098268,.8259229974584023,.4207962846098268,-.09405920349573646,-.07726317316720414,.04973290349094079,.01193456527972926,-.016990639867602342,-.0019142861290887667,.0019088317364812906]),filterH:new Float64Array([0,.014426282505624435,-.014467504896790148,-.07872200106262882,.04036797903033992,.41784910915027457,-.7589077294536541,.41784910915027457,.04036797903033992,-.07872200106262882,-.014467504896790148,.014426282505624435,0,0])},bi97:{name:"Biorthogonal 9-7",orthogonal:false,filterL:new Float64Array([0,.02674875741080976,-.01686411844287495,-.07822326652898785,.2668641184428723,.6029490182363579,.2668641184428723,-.07822326652898785,-.01686411844287495,.02674875741080976]),filterH:new Float64Array([0,-.09127176311424948,.05754352622849957,.591271763114247,-1.115087052456994,.591271763114247,.05754352622849957,-.09127176311424948,0,0])},rbio13:{name:"Reverse biorthogonal 1-3",orthogonal:false,filterL:new Float64Array([0,0,.7071067811865476,.7071067811865476,0,0]),filterH:new Float64Array([.08838834764831845,.08838834764831845,-.7071067811865476,.7071067811865476,-.08838834764831845,-.08838834764831845])},rbio31:{name:"Reverse biorthogonal 3-1",orthogonal:false,filterL:new Float64Array([.1767766952966369,.5303300858899107,.5303300858899107,.1767766952966369]),filterH:new Float64Array([.3535533905932738,1.0606601717798214,-1.0606601717798214,-.3535533905932738])},rbio33:{name:"Reverse biorthogonal 3-3",orthogonal:false,filterL:new Float64Array([0,0,.1767766952966369,.5303300858899107,.5303300858899107,.1767766952966369,0,0]),filterH:new Float64Array([-.06629126073623884,-.19887378220871652,.15467960838455727,.9943689110435825,-.9943689110435825,-.15467960838455727,.19887378220871652,.06629126073623884])},rbio35:{name:"Reverse biorthogonal 3-5",orthogonal:false,filterL:new Float64Array([0,0,0,0,.1767766952966369,.5303300858899107,.5303300858899107,.1767766952966369,0,0,0,0]),filterH:new Float64Array([.013810679320049757,.04143203796014927,-.052480581416189075,-.26792717880896527,.07181553246425874,.966747552403483,-.966747552403483,-.07181553246425874,.26792717880896527,.052480581416189075,-.04143203796014927,-.013810679320049757])},rbio39:{name:"Reverse biorthogonal 3-9",orthogonal:false,filterL:new Float64Array([0,0,0,0,0,0,0,0,.1767766952966369,.5303300858899107,.5303300858899107,.1767766952966369,0,0,0,0,0,0,0,0]),filterH:new Float64Array([.000679744372783699,.002039233118351097,-.005060319219611981,-.020618912641105536,.014112787930175846,.09913478249423216,-.012300136269419315,-.32019196836077857,-.0020500227115698858,.9421257006782068,-.9421257006782068,.0020500227115698858,.32019196836077857,.012300136269419315,-.09913478249423216,-.014112787930175846,.020618912641105536,.005060319219611981,-.002039233118351097,-.000679744372783699])}};t.filter=function(r,t,a){var e="Wavelet.filter: ";if(a===undefined||a===0){a=1}if(typeof a!=="number"){throw new Error(e+"argument 'factor' must be a number")}if(typeof t!=="string"){throw new Error(e+"argument 'action' must be a string")}t=t.toLowerCase().substr(0,3);var n;var i=r.length;var o=[];var s=1,f=1;if(t==="mir"){for(n=0;n<i;n++){o[n]=a*r[i-1-n]}return o}if(t==="nor"){var v=0;for(n=0;n<i;n++){v+=r[n]*r[n]}a=!v?1:1/Math.sqrt(v)}else if(t==="con"){f=-1}else if(t!=="res"){throw new Error(e+"unknown action")}for(n=0;n<i;n++,s*=f){o[n]=a*s*r[n]}return o};r.wfilters=function(a,e){var n=new t(a);var i=r.toMatrix(n.filterL),o=r.toMatrix(n.filterH),s=r.toMatrix(n.invFilterL),f=r.toMatrix(n.invFilterH);switch(e){case"d":return[i,o];case"r":return[s,f];case"l":return[i,s];case"h":return[o,f];case undefined:return[i,o,s,f];default:throw new Error("Matrix.wfilters: wrong type argument.")}}})(Matrix);(function(r){"use strict";var t={matrix:function(r,t,a,e,n){e=e||1;n=n||3;a=(a||1)*n;var i=t[0],o=t[3],s=t[6];var f=t[1],v=t[4],u=t[7];var l=t[2],h=t[5],g=t[8];for(var c=0,w=e,p=2*e;c<a;c+=n,w+=n,p+=n){var m=r[c],d=r[w],y=r[p];r[c]=i*m+o*d+s*y;r[w]=f*m+v*d+u*y;r[p]=l*m+h*d+g*y}return r},"RGB to RGB":function(r,t,a,e){a=a||1;e=e||3;t=(t||1)*e;for(var n=0,i=a,o=2*a;n<t;n+=e,i+=e,o+=e){var s=r[n],f=r[i],v=r[o];r[n]=s;r[i]=f;r[o]=v}return r},applyFunctionRGB:function(r,t,a,e,n){e=e||1;n=n||3;a=(a||1)*n;for(var i=0,o=e,s=2*e;i<a;i+=n,o+=n,s+=n){var f=t(r[i],r[o],r[s]);r[i]=f[0];r[o]=f[1];r[s]=f[2]}return r},applyFunctionColor:function(r,t,a,e,n){e=e||1;n=n||3;a=(a||1)*n;for(var i=0,o=e,s=2*e;i<a;i+=n,o+=n,s+=n){var f=r[i],v=r[o],u=r[s];var l=t([f,v,u]);r[i]=l[0];r[o]=l[1];r[s]=l[2]}return r},"RGB to GRAY":function(r,t,a,e){a=a||1;e=e||3;t=(t||1)*e;for(var n=0,i=a,o=2*a;n<t;n+=e,i+=e,o+=e){var s=r[n],f=r[i],v=r[o];var u=.2989*s+.587*f+.114*v;r[n]=u;r[i]=u;r[o]=u}return r},"RGB to HSV":function(r,t,a,e){a=a||1;e=e||3;t=(t||1)*e;var n=1/6;for(var i=0,o=a,s=2*a;i<t;i+=e,o+=e,s+=e){var f=r[i],v=r[o],u=r[s];var l=(f>v?f:v)>u?f>v?f:v:u;var h=l-((f<v?f:v)<u?f<v?f:v:u),g=0;if(h!==0){if(l===f){g=(v-u)/h*n}else if(l===v){g=(2+(u-f)/h)*n}else if(l===u){g=(4+(f-v)/h)*n}if(g<0){g+=1}if(l!==0){h/=l}}r[i]=g;r[o]=h;r[s]=l}return r},"HSV to RGB":function(r,t,a,e){a=a||1;e=e||3;t=(t||1)*e;for(var n=0,i=a,o=2*a;n<t;n+=e,i+=e,o+=e){var s=r[n],f=r[i],v=r[o];var u=(s*6|0)%6;var l=s*6-u;var h=v*(1-f);var g=v*(1-l*f);var c=v*(1-(1-l)*f);switch(u){case 0:r[n]=v;r[i]=c;r[o]=h;break;case 1:r[n]=g;r[i]=v;r[o]=h;break;case 2:r[n]=h;r[i]=v;r[o]=c;break;case 3:r[n]=h;r[i]=g;r[o]=v;break;case 4:r[n]=c;r[i]=h;r[o]=v;break;case 5:r[n]=v;r[i]=h;r[o]=g;break}}return r},"RGB to HSL":function(r,t,a,e){a=a||1;e=e||3;t=(t||1)*e;var n=Math.sqrt(3),i=1/(2*Math.PI),o=1/3;for(var s=0,f=a,v=2*a;s<t;s+=e,f+=e,v+=e){var u=r[s],l=r[f],h=r[v];var g=Math.atan2(n*(l-h),2*u-l-h)*i;r[s]=g<0?g+1:g;var c=(u>l?u:l)>h?u>l?u:l:h;var w=(u<l?u:l)<h?u<l?u:l:h;r[f]=c-w;r[v]=(u+l+h)*o}return r},"HSL to RGB":function(r,t,a,e){a=a||1;e=e||3;t=(t||1)*e;var n=Math.PI,i=n/3,o=n*2,s=2*n/3;var f=1/3;var v=Math.sqrt(3)/2,u=1/Math.sqrt(3);for(var l=0,h=a,g=2*a;l<t;l+=e,h+=e,g+=e){var c=r[l],w=r[h],p=r[g];var m=c*o;var d=m;while(d>i){d-=i}var y=v*w/Math.sin(s-d);var b=y*Math.cos(m)*f,M=y*Math.sin(m)*u;r[l]=p+b*2;r[h]=p-b+M;r[g]=p-b-M}return r},"RGB to HSI":function(r,t,a,e){a=a||1;e=e||3;t=(t||1)*e;var n=1/Math.sqrt(3),i=1/Math.sqrt(2),o=1/Math.sqrt(6);for(var s=0,f=a,v=2*a;s<t;s+=e,f+=e,v+=e){var u=r[s],l=r[f],h=r[v];var g=(l-h)*i;var c=(2*u-l-h)*o;r[s]=Math.atan2(g,c);r[f]=Math.sqrt(g*g+c*c);r[v]=(u+l+h)*n}return r},"HSI to RGB":function(r,t,a,e){a=a||1;e=e||3;t=(t||1)*e;var n=Math.sqrt(3),i=Math.sqrt(2),o=Math.sqrt(6);var s=1/6,f=1/3;for(var v=0,u=a,l=2*a;v<t;v+=e,u+=e,l+=e){var h=r[v],g=r[u],c=r[l];var w=g*Math.sin(h);var p=g*Math.cos(h);var m=c*n,d=w*i,y=p*o;var b=(m+y)*f;var M=(2*m+3*d-y)*s;var B=(2*m-3*d-y)*s;r[v]=b;r[u]=M;r[l]=B}return r},"LinearRGB to sRGB":function(r,t,a,e){a=a||1;e=e||3;t=(t||1)*e;var n=.055,i=1/2.4;for(var o=0,s=a,f=2*a;o<t;o+=e,s+=e,f+=e){var v=r[o],u=r[s],l=r[f];r[o]=v>.0031308?1.055*Math.pow(v,i)-n:v*12.92;r[s]=u>.0031308?1.055*Math.pow(u,i)-n:u*12.92;r[f]=l>.0031308?1.055*Math.pow(l,i)-n:l*12.92}return r},"sRGB to LinearRGB":function(r,t,a,e){a=a||1;e=e||3;t=(t||1)*e;var n=1/12.92,i=.055,o=1/1.055;for(var s=0,f=a,v=2*a;s<t;s+=e,f+=e,v+=e){var u=r[s],l=r[f],h=r[v];r[s]=u>.04045?Math.pow((u+i)*o,2.4):u*n;r[f]=l>.04045?Math.pow((l+i)*o,2.4):l*n;r[v]=h>.04045?Math.pow((h+i)*o,2.4):h*n}return r},"RGB to CMY":function(r,t,a,e){a=a||1;e=e||3;t=(t||1)*e;for(var n=0,i=a,o=2*a;n<t;n+=e,i+=e,o+=e){r[n]=1-r[n];r[i]=1-r[i];r[o]=1-r[o]}return r},"CMY to RGB":function(r,t,a,e){a=a||1;e=e||3;t=(t||1)*e;for(var n=0,i=a,o=2*a;n<t;n+=e,i+=e,o+=e){r[n]=1-r[n];r[i]=1-r[i];r[o]=1-r[o]}return r},"RGB to Opponent":function(r,t,a,e){a=a||1;e=e||3;t=(t||1)*e;var n=1/Math.sqrt(3),i=1/Math.sqrt(2),o=1/Math.sqrt(6);for(var s=0,f=a,v=2*a;s<t;s+=e,f+=e,v+=e){var u=r[s],l=r[f],h=r[v];r[s]=(u+l+h)*n;r[f]=(u-l)*i;r[v]=(u+l-2*h)*o}return r},"Opponent to RGB":function(r,t,a,e){a=a||1;e=e||3;t=(t||1)*e;var n=Math.sqrt(3),i=Math.sqrt(2),o=Math.sqrt(6);var s=1/6,f=1/3;for(var v=0,u=a,l=2*a;v<t;v+=e,u+=e,l+=e){var h=r[v],g=r[u],c=r[l];var w=h*n,p=g*i,m=c*o;r[v]=(2*w+3*p+m)*s;r[u]=(2*w-3*p+m)*s;r[l]=(w-m)*f}return r},"RGB to Ohta":function(r,t,a,e){a=a||1;e=e||3;t=(t||1)*e;var n=1/Math.sqrt(3),i=1/Math.sqrt(2),o=1/Math.sqrt(6);for(var s=0,f=a,v=2*a;s<t;s+=e,f+=e,v+=e){var u=r[s],l=r[f],h=r[v];r[s]=(u+l+h)*n;r[f]=(u-h)*i;r[v]=(-u+2*l-h)*o}return r},"Ohta to RGB":function(r,t,a,e){a=a||1;e=e||3;t=(t||1)*e;var n=Math.sqrt(3),i=Math.sqrt(2),o=Math.sqrt(6);var s=1/6,f=1/3;for(var v=0,u=a,l=2*a;v<t;v+=e,u+=e,l+=e){var h=r[v],g=r[u],c=r[l];var w=h*n,p=g*i,m=c*o;r[u]=(w+m)*f;r[v]=(2*w+3*p-m)*s;r[l]=(2*w-3*p-m)*s}return r},"LinearRGB to rgY":function(r,t,a,e){a=a||1;e=e||3;t=(t||1)*e;for(var n=0,i=a,o=2*a;n<t;n+=e,i+=e,o+=e){var s=r[n],f=r[i],v=r[o];var u=s+f+v;if(u>0){var l=1/u;r[n]=s*l;r[i]=f*l;r[o]=u}else{r[n]=1/3;r[i]=1/3;r[o]=0}}return r},"rgY to LinearRGB":function(r,t,a,e){a=a||1;e=e||3;t=(t||1)*e;for(var n=0,i=a,o=2*a;n<t;n+=e,i+=e,o+=e){var s=r[n],f=r[i],v=r[o];r[n]=s*v;r[i]=f*v;r[o]=(1-s-f)*v}return r},getXYZTransform:function(r,a,e){a=a||[.31271,.32902,1];e=e||[.64,.33,1,.3,.6,1,.15,.06,1];var n=t["xyY to XYZ"](a);n=Matrix.toMatrix(n);var e=t["xyY to XYZ"](e,3);e=new Matrix([3,3],e);var i=Matrix.diag(e.inv().mtimes(n));var o=e.mtimes(i);return r?o.inv():o},"LinearRGB to XYZ":function(r,a,e,n,i,o){var s=t.getXYZTransform(false,i,o).getData();t.matrix(r,s,a,e,n);return r},"XYZ to LinearRGB":function(r,a,e,n,i,o){var s=t.getXYZTransform(true,i,o).getData();t.matrix(r,s,a,e,n);return r},"XYZ to Lab":function(r,t,a,e,n){a=a||1;e=e||3;t=(t||1)*e;n=n||[.31271,.32902,1];var i=n[0],o=n[1],s=n[2];var f=i*s/o;var v=(1-i-o)*s/o;var u=1/f,l=1/s,h=1/v;var g=1/3,c=16/116;for(var w=0,p=a,m=2*a;w<t;w+=e,p+=e,m+=e){var d=r[w],y=r[p],b=r[m];var M=d*u;if(M>.008856){M=Math.pow(M,g)}else{M=7.787*M+c}var B=y*l;if(B>.008856){B=Math.pow(B,g)}else{B=7.787*B+c}var x=b*h;if(x>.008856){x=Math.pow(x,g)}else{x=7.787*x+c}r[w]=116*B-16;r[p]=500*(M-B);r[m]=200*(B-x)}return r},"Lab to XYZ":function(r,t,a,e,n){a=a||1;e=e||3;t=(t||1)*e;n=n||[.31271,.32902,1];var i=n[0],o=n[1],s=n[2];var f=i*s/o;var v=(1-i-o)*s/o;var u=Math.pow(.008856,1/3),l=1/7.787;var h=1/116,g=1/500,c=1/200;var w=16/116;for(var p=0,m=a,d=2*a;p<t;p+=e,m+=e,d+=e){var y=r[p],b=r[m],M=r[d];var B=(y+16)*h;var x=B+b*g;var D=B-M*c;if(B>u){B=Math.pow(B,3)}else{B=(B-w)*l}if(x>u){x=Math.pow(x,3)}else{x=(x-w)*l}if(D>u){D=Math.pow(D,3)}else{D=(D-w)*l}r[p]=x*f;r[m]=B*s;r[d]=D*v}return r},"XYZ to Luv":function(r,t,a,e,n){a=a||1;e=e||3;t=(t||1)*e;n=n||[.31271,.32902,1];var i=n[0],o=n[1],s=n[2];var f=i*s/o;var v=(1-i-o)*s/o;var u=1/s;var l=4*f/(f+15*s+3*v);var h=9*s/(f+15*s+3*v);var g=1/3;for(var c=0,w=a,p=2*a;c<t;c+=e,w+=e,p+=e){var m=r[c],d=r[w],y=r[p];var b=d*u;if(b>.008856){b=116*Math.pow(b,g)-16}else{b*=903.3}var M=1/(m+15*d+3*y);M=isFinite(M)?M:0;var B=4*M*m;var x=9*M*d;M=13*b;r[c]=b;r[w]=M*(B-l);r[p]=M*(x-h)}return r},"Luv to XYZ":function(r,t,a,e,n){a=a||1;e=e||3;t=(t||1)*e;n=n||[.31271,.32902,1];var i=n[0],o=n[1],s=n[2];var f=i*s/o;var v=(1-i-o)*s/o;var u=4*f/(f+15*s+3*v);var l=9*s/(f+15*s+3*v);var h=Math.pow(.008856,1/3),g=1/7.787;var c=1/116,w=16/116;for(var p=0,m=a,d=2*a;p<t;p+=e,m+=e,d+=e){var y=r[p],b=r[m],M=r[d];var B=(y+16)*c;if(B>h){B=Math.pow(B,3)}else{B=(B-w)*g}var x=1/(13*y);x=isFinite(x)?x:0;var D=b*x+u;var A=M*x+l;x=B/(4*A);r[p]=9*D*x;r[m]=B;r[d]=(12-3*D-20*A)*x}return r},"Lab to Lch":function(r,t,a,e){a=a||1;e=e||3;t=(t||1)*e;var n=1/(2*Math.PI);for(var i=0,o=a,s=2*a;i<t;i+=e,o+=e,s+=e){var f=r[i],v=r[o],u=r[s];var l=Math.atan2(u,v)*n;r[i]=f;r[o]=Math.sqrt(v*v+u*u);r[s]=l<0?l+1:l}return r},"Lch to Lab":function(r,t,a,e){a=a||1;e=e||3;t=(t||1)*e;var n=Math.PI*2;for(var i=0,o=a,s=2*a;i<t;i+=e,o+=e,s+=e){var f=r[i],v=r[o],u=r[s];var l=u*n;var h=Math.cos(l)*v;var g=Math.sin(l)*v;r[i]=f;r[o]=h;r[s]=g}return r},"RGB to XYZ":function(r,a,e,n){t["sRGB to LinearRGB"](r,a,e,n);t["LinearRGB to XYZ"](r,a,e,n);return r},"XYZ to RGB":function(r,a,e,n){t["XYZ to LinearRGB"](r,a,e,n);t["LinearRGB to sRGB"](r,a,e,n);return r},"RGB to Lab":function(r,a,e,n,i){t["sRGB to LinearRGB"](r,a,e,n);t["LinearRGB to XYZ"](r,a,e,n,i);t["XYZ to Lab"](r,a,e,n,i);return r},"Lab to RGB":function(r,a,e,n){t["Lab to XYZ"](r,a,e,n);t["XYZ to LinearRGB"](r,a,e,n);t["LinearRGB to sRGB"](r,a,e,n);return r},"RGB to Luv":function(r,a,e,n,i){t["sRGB to LinearRGB"](r,a,e,n);t["LinearRGB to XYZ"](r,a,e,n);t["XYZ to Luv"](r,a,e,n,i);return r},"Luv to RGB":function(r,a,e,n,i){t["Luv to XYZ"](r,a,e,n,i);t["XYZ to LinearRGB"](r,a,e,n);t["LinearRGB to sRGB"](r,a,e,n);return r},"RGB to Lch":function(r,a,e,n,i){t["sRGB to LinearRGB"](r,a,e,n);t["LinearRGB to XYZ"](r,a,e,n);t["XYZ to Lab"](r,a,e,n,i);t["Lab to Lch"](r,a,e,n);return r},"Lch to RGB":function(r,a,e,n,i){t["Lch to Lab"](r,a,e,n);t["Lab to XYZ"](r,a,e,n,i);t["XYZ to LinearRGB"](r,a,e,n);t["LinearRGB to sRGB"](r,a,e,n);return r},"XYZ to xyY":function(r,t,a,e,n){a=a||1;e=e||3;t=(t||1)*e;n=n||[.31271,.32902,1];var i=n[0],o=n[1];for(var s=0,f=a,v=2*a;s<t;s+=e,f+=e,v+=e){var u=r[s],l=r[f],h=r[v];var g=1/(u+l+h);if(isFinite(g)){r[s]=u*g;r[f]=l*g;r[v]=l}else{r[s]=i;r[f]=o;r[v]=0}}return r},"xyY to XYZ":function(r,t,a,e){a=a||1;e=e||3;t=(t||1)*e;for(var n=0,i=a,o=2*a;n<t;n+=e,i+=e,o+=e){var s=r[n],f=r[i],v=r[o];var u=v/f;r[n]=s*u;r[i]=v;r[o]=(1-s-f)*u}return r},"XYZ to 1960 uvY":function(r,t,a,e,n){a=a||1;e=e||3;t=(t||1)*e;n=n||[.31271,.32902,1];var i=n[0],o=n[1],s=n[2];var f=i*s/o,v=(1-i-o)*s/o;var u=4*f/(f+15*s+3*v);var l=6*s/(f+15*s+3*v);for(var h=0,g=a,c=2*a;h<t;h+=e,g+=e,c+=e){var w=r[h],p=r[g],m=r[c];if(p===0){r[h]=u;r[g]=l;r[c]=0}else{var d=1/(w+15*p+3*m);r[h]=4*w*d;r[g]=6*p*d;r[c]=p}}return r},"1960 uvY to XYZ":function(r,t,a,e){a=a||1;e=e||3;t=(t||1)*e;var n=6/4,i=1/3;for(var o=0,s=a,f=2*a;o<t;o+=e,s+=e,f+=e){var v=r[o],u=r[s],l=r[f];var h=1/u;var g=n*l*v*h;r[o]=g;r[s]=l;r[f]=(6*l*h-g-15*l)*i}return r},"XYZ to 1976 u'v'Y":function(r,t,a,e,n){a=a||1;e=e||3;t=(t||1)*e;n=n||[.31271,.32902,1];var i=n[0],o=n[1],s=n[2];var f=i*s/o,v=(1-i-o)*s/o;var u=4*f/(f+15*s+3*v);var l=9*s/(f+15*s+3*v);for(var h=0,g=a,c=2*a;h<t;h+=e,g+=e,c+=e){var w=r[h],p=r[g],m=r[c];if(p===0){r[h]=u;r[g]=l;r[c]=0}else{var d=1/(w+15*p+3*m);r[h]=4*w*d;r[g]=9*p*d;r[c]=p}}return r},"1976 u'v'Y to XYZ":function(r,t,a,e){a=a||1;e=e||3;t=(t||1)*e;var n=9/4,i=1/3;for(var o=0,s=a,f=2*a;o<t;o+=e,s+=e,f+=e){var v=r[o],u=r[s],l=r[f];var h=1/u;var g=n*l*v*h;r[o]=g;r[s]=l;r[f]=(9*l*h-g-15*l)*i}return r},"xyY to 1960 uvY":function(r,t,a,e){a=a||1;e=e||3;t=(t||1)*e;for(var n=0,i=a,o=2*a;n<t;n+=e,i+=e,o+=e){var s=r[n],f=r[i];var v=1/(-2*s+12*f+3);r[n]=4*s*v;r[i]=6*f*v}return r},"1960 uvY to xyY":function(r,t,a,e){a=a||1;e=e||3;t=(t||1)*e;for(var n=0,i=a,o=2*a;n<t;n+=e,i+=e,o+=e){var s=r[n],f=r[i];var v=1/(2*s-8*f+4);r[n]=3*s*v;r[i]=2*f*v}return r},"1976 u'v'Y to xyY":function(r,t,a,e){a=a||1;e=e||3;t=(t||1)*e;for(var n=0,i=a,o=2*a;n<t;n+=e,i+=e,o+=e){var s=r[n],f=r[i];var v=1/(6*s-16*f+12);r[n]=9*s*v;r[i]=4*f*v}return r},"xyY to 1976 u'v'Y":function(r,t,a,e){a=a||1;e=e||3;t=(t||1)*e;for(var n=0,i=a,o=2*a;n<t;n+=e,i+=e,o+=e){var s=r[n],f=r[i];var v=1/(-2*s+12*f+3);r[n]=4*s*v;r[i]=9*f*v}return r},"1976 u'v'Y to 1960 uvY":function(r,t,a,e){a=a||1;e=e||3;t=(t||1)*e+a;var n=2/3;for(var i=a;i<t;i+=e){r[i]*=n}return r},"1960 uvY to 1976 u'v'Y":function(r,t,a,e){a=a||1;e=e||3;t=(t||1)*e+a;var n=3/2;for(var i=a;i<t;i+=e){r[i]*=n}return r},"RGB to rgY":function(r,a,e,n){t["sRGB to LinearRGB"](r,a,e,n);t["LinearRGB to rgY"](r,a,e,n);return r},"rgY to RGB":function(r,a,e,n){t["rgY to LinearRGB"](r,a,e,n);t["LinearRGB to sRGB"](r,a,e,n);return r},"rgY to xyY":function(r,a,e,n){t["rgY to LinearRGB"](r,a,e,n);t["LinearRGB to XYZ"](r,a,e,n);t["XYZ to xyY"](r,a,e,n);return r},"xyY to rgY":function(r,a,e,n){t["xyY to XYZ"](r,a,e,n);t["XYZ to LinearRGB"](r,a,e,n);t["LinearRGB to rgY"](r,a,e,n);return r},"RGB to xyY":function(r,a,e,n){t["sRGB to LinearRGB"](r,a,e,n);t["LinearRGB to XYZ"](r,a,e,n);t["XYZ to xyY"](r,a,e,n);return r},"xyY to RGB":function(r,a,e,n){t["xyY to XYZ"](r,a,e,n);t["XYZ to LinearRGB"](r,a,e,n);t["LinearRGB to sRGB"](r,a,e,n);return r},"RGB to 1960 uvY":function(r,a,e,n){t["sRGB to LinearRGB"](r,a,e,n);t["LinearRGB to XYZ"](r,a,e,n);t["XYZ to xyY"](r,a,e,n);t["xyY to 1960 uvY"](r,a,e,n);return r},"1960 uvY to RGB":function(r,a,e,n){t["1960 uvY to xyY"](r,a,e,n);t["xyY to XYZ"](r,a,e,n);t["XYZ to LinearRGB"](r,a,e,n);t["LinearRGB to sRGB"](r,a,e,n);return r},"RGB to 1976 u'v'Y":function(r,a,e,n){t["sRGB to LinearRGB"](r,a,e,n);t["LinearRGB to XYZ"](r,a,e,n);t["XYZ to 1976 u'v'Y"](r,a,e,n);return r},"1976 u'v'Y to RGB":function(r,a,e,n){t["1976 u'v'Y to XYZ"](r,a,e,n);t["XYZ to LinearRGB"](r,a,e,n);t["LinearRGB to sRGB"](r,a,e,n);return r}};r.Colorspaces=t})(Matrix);(function(r,t){"use strict";var a={lab2lch:"Lab to Lch",lab2srgb:"Lab to RGB",lab2xyz:"Lab to XYZ",lch2lab:"Lch to Lab",srgb2cmyk:"RGB to CMY",srgb2lab:"RGB to Lab",srgb2xyz:"RGB to XYZ",upvpl2xyz:"1976 u'v'Y to XYZ",uvl2xyz:"1960 uvY to XYZ",xyl2xyz:"xyY to XYZ",xyz2lab:"XYZ to Lab",xyz2srgb:"XYZ to RGB",xyz2upvpl:"XYZ to 1976 u'v'",xyz2uvl:"XYZ to 1960 uv",xyz2xyl:"XYZ to xyY"};t.applycform=function(t){if(this.ndims()!==3||this.getSize(2)<3){throw new Error("Matrix.applycform: Matrix must be an "+"image with RGB components.")}var e=this.getSize(0)*this.getSize(1);if(typeof t==="string"){if(r.Colorspaces[t]){r.Colorspaces[t](this.getData(),e,e,1)}else if(r.Colorspaces[a[t]]){r.Colorspaces[a[t]](this.getData(),e,e,1)}else{throw new Error("Matrix.applycform: Unknown color transformation "+t)}}else if(typeof t==="function"){if(t.length===3){r.Colorspaces.applyFunctionRGB(this.getData(),t,e,e,1)}else if(t.length===1){r.Colorspaces.applyFunctionColor(this.getData(),t,e,e,1)}}else{t=r.toMatrix(t);if(!Tools.checkSizeEquals(t.size(),[3,3],r.ignoreTrailingDims)){throw new Error("Matrix.applycform: Matrix argument must be 3x3.")}r.Colorspaces.matrix(this.getData(),t.getData(),e,e,1)}return this};r.applycform=function(r,t){return r.getCopy().applycform(t)};t.toColormap=function(t){var a=this.getData(),e=this.getSize(),n=a.length;e[2]=3;var i=new r(e),o=i.getData();var s=o.subarray(0,n),f=o.subarray(n,2*n),v=o.subarray(2*n,3*n);var u,l,h=Math.floor;if(t==="JET"){for(u=0;u<n;u++){l=a[u]*4;if(l>=4){l=3.99}else if(l<0){l=0}switch(h(l*2)%8){case 0:s[u]=0;f[u]=0;v[u]=l+.5;break;case 1:case 2:s[u]=0;v[u]=1;f[u]=l-.5;break;case 3:case 4:s[u]=l-1.5;f[u]=1;v[u]=2.5-l;break;case 5:case 6:s[u]=1;f[u]=3.5-l;v[u]=0;break;case 7:s[u]=4.5-l;f[u]=0;v[u]=0;break}}}else if(t==="HUE"){for(u=0;u<n;u++){var g=a[u];l=h(g*6)%6;var c=g*6-l;switch(l){case 0:s[u]=1;f[u]=c;v[u]=0;break;case 1:s[u]=1-c;f[u]=1;v[u]=0;break;case 2:s[u]=0;f[u]=1;v[u]=c;break;case 3:s[u]=0;f[u]=1-c;v[u]=1;break;case 4:s[u]=c;f[u]=0;v[u]=1;break;case 5:s[u]=1;f[u]=0;v[u]=1-c;break}}}else if(t==="HUE"){o.set(a)}return i};t.correctImage=function(t,a){a=a||r.CIE.getIlluminant("D65");var e=r.CIE.getIlluminantConversionMatrix(a,t);this.applycform("sRGB to LinearRGB").applycform(e).applycform("LinearRGB to sRGB");return this};r.correctImage=function(r,t,a){return r.getCopy().correctImage(t,a)};t.im2CCT=function(){var t=r.CIE["xyY to CCT"];var a=this.getSize();a.pop();var e=new r(a,"single");var n=this.getData(),i=e.getData();var o=this.getView();var s=o.getStep(0),f=o.getEnd(0),v;var u=o.getStep(1),l=o.getEnd(1),h;var g=o.getStep(2);var c,w,p,m,d,y=[];for(c=0,h=l;c!==h;c+=u){w=c;p=c+g;m=c+2*g;for(v=c+f;w!==v;w+=s,p+=s,m+=s){y[0]=n[w];y[1]=n[p];y[2]=n[m];d=t(y);d=d<1668?1668:d>2e4?2e4:d;d=isNaN(d)?24999:d;i[w]=d}}return e};t.CCT2im=function(){var t=r.CIE["CCT to xyY"];var a=this.getSize();a[2]=3;var e=new r(a,"single");var n=this.getData(),i=e.getData();var o=e.getView();var s=o.getStep(0),f=o.getEnd(0),v;var u=o.getStep(1),l=o.getEnd(1),h;var g=o.getStep(2);var c,w,p,m,d=[];for(c=0,h=l;c!==h;c+=u){w=c;p=c+g;m=c+2*g;for(v=c+f;w!==v;w+=s,p+=s,m+=s){d=t(n[w]);i[w]=d[0];i[p]=d[1];i[m]=d[2]}}return e}})(Matrix,Matrix.prototype);