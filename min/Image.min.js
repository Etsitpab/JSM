/**
 * This program is free software: you can redistribute it and/or modify    
 * it under the terms of the GNU General Public License as published by        
 * the Free Software Foundation, either version 3 of the License, or 
 * (at your option) any later version.
 * 
 * This program is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU General Public License for more details.
 * 
 * You should have received a copy of the GNU General Public License
 * along with this program.  If not, see <http://www.gnu.org/licenses/>.
 * 
 * @author Baptiste Mazin     <baptiste.mazin@telecom-paristech.fr> 
 * @author Guillaume Tartavel <guillaume.tartavel@telecom-paristech.fr> 
 */
(function(t,r){"use strict";var e=typeof module!=="undefined"&&module.exports?true:false;var a,i,n;if(e){a=require("fs");i=require("canvas");n=i.Image}else{n=Image}var o=function(t,r){var a;if(e){a=new i}else{a=document.createElement("canvas")}a.width=t||0;a.height=r||0;return a};r.convertImage=function(r){var e=new t(this.getSize(),r);var a,i;if(this.isfloat()||this.islogical()){a=[0,1]}else if(this.isinteger()){a=[t.intmin(this.type()),t.intmax(this.type())]}var n=a[0],o=1/(a[1]-a[0]);if(e.isfloat()||this.islogical()){i=[0,1]}else if(e.isinteger()){i=[t.intmin(e.type()),t.intmax(e.type())]}var s=i[0],f=o*(i[1]-i[0]);var v=this.getData(),h=new e.getData;var u,l;for(u=0,l=v.length;u<l;u++){h[u]=(v[u]-n)*f-s}return new t(this.getSize(),h)};r.im2double=function(){return this.convertImage("double")};r.im2single=function(){return this.convertImage("single")};r.im2uint8=function(){return this.convertImage("uint8")};r.im2uint8c=function(){return this.convertImage("uint8c")};r.getImageData=function(){var r;if(this.isfloat()||this.islogical()){r=[0,1]}else if(this.isinteger()){r=[t.intmin(this.type()),t.intmax(this.type())]}var e=r[0],a=255/(r[1]-r[0]);var i=this.getSize(1),n=this.getSize(0);var s=o().getContext("2d").createImageData(i,n);var f=n*i,v;var h=this.getData(),u=s.data;var l,g,c,w,d,p,m;switch(this.getSize(2)){case 1:for(g=0,l=0;g<n;g++){for(c=g,v=g+f;c<v;c+=n){m=(h[c]-e)*a;u[l++]=m;u[l++]=m;u[l++]=m;u[l++]=255}}break;case 2:for(g=0,l=0;g<n;g++){for(c=g,w=g+f,v=g+f;c<v;c+=n,w+=n){m=(h[c]-e)*a;u[l++]=m;u[l++]=m;u[l++]=m;u[l++]=(h[w]-e)*a}}break;case 3:for(g=0,l=0;g<n;g++){for(c=g,w=g+f,d=g+2*f,v=w;c<v;c+=n,w+=n,d+=n){u[l++]=(h[c]-e)*a;u[l++]=(h[w]-e)*a;u[l++]=(h[d]-e)*a;u[l++]=255}}break;case 4:for(g=0,l=0;g<n;g++){for(c=g,w=c+f,d=w+f,p=d+f,v=w;c<v;c+=n,w+=n,d+=n,p+=n){u[l++]=(h[c]-e)*a;u[l++]=(h[w]-e)*a;u[l++]=(h[d]-e)*a;u[l++]=(h[p]-e)*a}}break}return s};r.toImage=function(t){if(e){throw new Error("Matrix.toImage: Canvas doesn't exist.")}var r=o(this.getSize(1),this.getSize(0));var a=this.getImageData();r.getContext("2d").putImageData(a,0,0);var i=new Image;i.src=r.toDataURL();i.onload=t;return i};if(e){t.prototype.imwrite=function(t,r){var e=o(this.getSize(1),this.getSize(0));e.getContext("2d").putImageData(this.getImageData(),0,0);var i=a.createWriteStream(t),n;if(/\.(png)$/i.test(t.toLowerCase())){n=e.pngStream()}else if(/\.(jpeg|jpg)$/i.test(t.toLowerCase())){n=e.jpegStream()}else{throw new Error("Matrix.imwrite: invalid file extension.")}n.on("data",function(t){i.write(t)});if(r){n.on("end",r.bind(this))}}}t.fspecial=function(r,e,a){var i,n,o,s;var f,v,h,u,l,g,c,w;var d,p,m;var y=function(t,r){return Math.exp(-(t*t+r*r)/(2*s*s))};switch(r.toLowerCase()){case"average":if(Tools.isArrayLike(e)){o=e[0];n=e[1]}else{o=e===undefined?3:e;n=o}return t.ones([o,n])["./"](o*n);case"disk":break;case"gaussian":if(Tools.isArrayLike(e)){o=e[0];n=e[1]}else{o=e===undefined?3:e;n=o}s=a===undefined?.5:a;f=[];w=0;for(u=0,v=-(n-1)/2,g=n*o;u<g;u+=o,v++){for(l=u,c=u+o,h=-(o-1)/2;l<c;l++,h++){d=y(v,h);f[l]=d;w+=d}}for(p=0,m=f.length;p<m;p++){f[p]/=w}return new t([o,n],f);case"laplacian":i=e===undefined?.2:e;return new t([3,3],[i/4,(1-i)/4,i/4,(1-i)/4,-1,(1-i)/4,i/4,(1-i)/4,i/4])[".*"](4/(i+1));case"log":if(Tools.isArrayLike(e)){o=e[0];n=e[1]}else{o=e===undefined?3:e;n=o}s=a===undefined?.5:a;f=[];w=0;for(u=0,v=-(n-1)/2,g=n*o;u<g;u+=o,v++){for(l=u,c=u+o,h=-(o-1)/2;l<c;l++,h++){d=y(v,h);f[l]=(v*v+h*h-2*s*s)*d/Math.pow(s,4);w+=d}}for(p=0,m=f.length;p<m;p++){f[p]/=w}w=0;for(p=0,m=f.length;p<m;p++){w+=f[p]}w/=n*o;for(p=0,m=f.length;p<m;p++){f[p]-=w}return new t([o,n],f);case"unsharp":i=e===undefined?.2:e;return new t([3,3],[-i,i-1,-i,i-1,i+5,i-1,-i,i-1,-i])[".*"](1/(i+1));case"prewitt":return new t([3,3],[1,0,-1,1,0,-1,1,0,-1]);case"sobel":return new t([3,3],[1,0,-1,2,0,-2,1,0,-1]);default:return}};r.filter1d=function(r,e){var a=this.constructor.name+".filter1d: ";if(e===undefined){e="C"}if(!r.isvector()){throw new Error("Matrix.filter1d: Kernel must be a vector")}var i=r.getLength(),n=r.getData();if(typeof e==="string"){switch(e.toUpperCase()){case"C":case"CL":e=Math.floor((i-1)/2);break;case"CR":e=Math.ceil((i-1)/2);break;case"L":e=0;break;case"R":e=i-1;break;default:throw new Error(a+"unknown origin position '"+e+"'")}}else if(typeof e==="number"){if(e<0){e+=i}if(e<0||e>=i){throw new Error(a+"origin value must satisfy : |origin| < kernel.length")}}var o=new t(this.getSize(),this.getDataType());var s=this.getData(),f=o.getData();var v=o.getView();var h=v.getStep(2),u=v.getEnd(2);var l=v.getStep(1),g=v.getEnd(1);var c=v.getEnd(0);if(e>=c/2){throw new Error("Matrix.filter1d: Kernel is too large.")}var w,d=c-e;var p,m,y,M,L,b,x;for(p=0;p!==u;p+=h){for(m=p,y=p+g;m!==y;m+=l){for(M=m,L=m+e;M<L;M++){for(w=0,x=0,b=2*m+e-M;b>m;x++,b--){w+=n[x]*s[b]}for(b=m;x<i;x++,b++){w+=n[x]*s[b]}f[M]=w}for(M=m+e,L=m+d;M<L;M++){for(w=0,x=0,b=M-e;x<i;x++,b++){w+=n[x]*s[b]}f[M]=w}for(M=m+d,L=m+c;M<L;M++){for(w=0,x=0,b=M-e;b<L;x++,b++){w+=n[x]*s[b]}for(b=L-2;x<i;x++,b--){w+=n[x]*s[b]}f[M]=w}}}return o};r.separableFilter=function(t,r){if(r===undefined){r=t}return this.filter1d(t).permute([1,0,2]).filter1d(r).permute([1,0,2])};r.gaussian=function(t,r,e){e=e||3;var a=f.gaussian(t,0,e);var i;if(typeof r==="number"){i=f.gaussian(r,0,e)}else{i=a}return this.separableFilter(a,i)};r.gaussianGradient=function(r){if(!r){r=2}var e=f.gaussian(r,1,3);var a=f.gaussian(r,0,3);var i=this.separableFilter(a,e);var n=this.separableFilter(e,a);var o=.5/Math.PI;var s=t.zeros(this.getSize()),v=t.zeros(this.getSize());var h=i.getData(),u=n.getData();var l=s.getData(),g=v.getData();var c,w;for(c=0,w=h.length;c<w;c++){var d=h[c],p=u[c];l[c]=Math.sqrt(d*d+p*p);var m=Math.atan2(p,d)*o;g[c]=m<0?m+1:m}return{x:i,y:n,norm:s,phase:v}};r.gradient=function(r,e,a,i,n){var o=.70710678,s=6.8284271,f=.35355339;var v=.29289322,h=1/s,u=.5/Math.PI;var l={},g,c,w,d,p;var m=this.getSize();var y=this.getDataType();if(r){l.x=new t(m,y);g=l.x.getData()}if(e){l.y=new t(m,y);c=l.y.getData()}if(a){l.norm=new t(m,y);w=l.norm.getData()}if(i){l.phase=new t(m,y);d=l.phase.getData()}if(n){l.laplacian=new t(m,y);p=l.laplacian.getData()}var M=this.getData();var L=this.getView();var b=L.getStep(2),x=L.getEnd(2);var Y=L.getStep(1),B=L.getEnd(1);var R=L.getEnd(0);var S,G,D,z,E,I,C;for(S=0;S!==x;S+=b){for(G=S+Y,D=S+B-Y;G!==D;G+=Y){for(I=G-Y,z=G,C=G+Y,E=G+R-2;z<E;z){var X=M[I],Z=M[++I],H=M[I+1];var k=M[z],q=M[++z],F=M[z+1];var A=M[C],T=M[++C],V=M[C+1];var j=V-X,_=H-A;var P=v*(T-Z+f*(j-_));var W=v*(k-F-f*(j+_));if(r){g[z]=P}if(e){c[z]=W}if(a){w[z]=Math.sqrt(P*P+W*W)}if(i){var U=Math.atan2(-W,P)*u;d[z]=U<0?U+1:U}if(n){p[z]=(o*(X+H+A+V)+(k+Z+T+F))*h-q}}}}return l};r.conv=function(r,e){if(!this.isvector()||!r.isvector()){throw new Error("Matrix.conv: Input must be vector.")}var a=this.getData(),i=a.length;var n=r.getData(),o=n.length;if(i<o){return r.conv(this,e)}var s=Tools.checkType(this.getDataType());var f=new s(i+o-1),v=f.length;var h,u,l,g,c,w,d;for(c=0,w=o-1;c<w;c++){for(d=0,u=0,l=c+1,g=c;u<l;u++,g--){d+=a[u]*n[g]}f[c]=d}for(c=o-1,h=0,w=i;c<w;c++,h++){for(d=0,u=h,l=c+1,g=o-1;u<l;u++,g--){d+=a[u]*n[g]}f[c]=d}for(c=i,h=i-o+1;c<v;c++,h++){for(d=0,u=h,g=o-1;u<i;u++,g--){d+=a[u]*n[g]}f[c]=d}switch(e){case undefined:case"full":return new t(v,f);case"same":var p=Math.ceil(o/2);return new t(i,f.subarray(p,p+i));case"valid":return new t(i-o+1,f.subarray(o-1,i));default:throw new Error("Matrix.conv: Invalid shape parameter.")}};var s=function(t){var r=t.getView(),e=t.getData();var a=r.getStep(2),i=r.getEnd(2);var n=r.getStep(1),o=r.getEnd(1),s;var f=r.getEnd(0),v;var h,u,l;for(h=0;h<i;h+=a){for(u=h+1,v=h+f;u<v;u++){e[u]+=e[u-1]}for(l=h+n,s=h+o;l<s;l+=n){var g=e[l];e[l]+=e[l-n];for(u=l+1,v=l+f;u<v;u++){g+=e[u];e[u]=e[u-n]+g}}}};r.fastBlur=function(r,e,a){a=a||3;e=e||r;var i=Math.round(Math.sqrt(12/a*r*r+1)/2)*2+1;var n=Math.round(Math.sqrt(12/a*e*e+1)/2)*2+1;var o=t.zeros(this.getSize());var f=this.getView();var v=f.getStep(2),h=f.getEnd(2);var u=f.getStep(1),l=f.getEnd(1);var g=f.getEnd(0);e=n/2|0;r=(i/2|0)*u;var c=i/2|0;var w,d,p,m,y,M,L;var b,x,Y;var B=this.im2double();for(var R=0;R<a;R++){s(B);var S=B.getData(),G=o.getData();var D=r+e+u+1,z=r+e,E=-(r+u)+e,I=r-e-1;var C=S.subarray(z),X=S.subarray(I);for(p=0;p<h;p+=v){for(M=p,y=0,d=p+e+1;M<d;M++,y++){x=y+e+1;for(L=M,m=0,w=M+r+u;L<w;L+=u,m++){G[L]=C[L]/((m+c+1)*x)}b=1/(i*x);for(L=M+r+u,w=M+l-r;L<w;L+=u){G[L]=(C[L]-S[L+E])*b}Y=S[M+l-u+e];for(L=M+l-r,w=M+l;L<w;L+=u){G[L]=Y-S[L+E];G[L]/=(r+w-L)/u*x}}for(m=p,w=p+r+u;m<w;m+=u){b=1/(((m-p+r)/u+1)*n);for(y=m+e+1,d=m+g-e;y<d;y++){G[y]=C[y]-X[y];G[y]*=b}}b=1/(i*n);for(m=p+r+u,w=p+l-r;m<w;m+=u){for(y=m+e+1,d=m+g-e;y<d;y++){G[y]=(S[y-D]+C[y]-S[y+E]-X[y])*b}}for(m=p+l-r,w=p+l;m<w;m+=u){b=1/((p+l-m+r)/u*n);for(y=m+e+1,d=m+g-e;y<d;y++){G[y]=S[y-D]+S[p+l-u+y-m+e]-S[p+l-u+y-m-e-1]-S[y+E];G[y]*=b}}for(y=p+g-e,d=p+g;y<d;y++){for(m=y,w=y+r+u;m<w;m+=u){G[m]=S[m-y+p+g-1+r]-X[m];G[m]/=((m-y+r)/u+1)*(e+(g-(y-p)))}b=1/(i*(e+(g-(y-p))));for(m=y+r+u,w=y+l-r;m<w;m+=u){G[m]=S[m-y+p+g-1+r]-S[m-y+p+g-1-r-u]+S[m-D]-X[m];G[m]*=b}for(m=y+l-r,w=y+l;m<w;m+=u){G[m]=S[p+l-u+g-1]+S[m-D]-S[p+m-y+g-1-r-u]-S[p+l-u+y-p-e-1];G[m]/=(l-(m-y)+r)/u*(e+(g-(y-p)))}}}var Z=o;o=B;B=Z}return Z};var f={};f.normalize=function(t){var r;var e=t.length;var a=0;for(r=0;r<e;r++){a+=Math.abs(t[r])}if(a!==0){for(r=0;r<e;r++){t[r]/=a}}return t};f.gaussian=function(r,e,a){var i,n;if(a===undefined){a=3}if(e===undefined){e=0}var o=1+2*Math.ceil(r*Math.sqrt(a*2*Math.log(10)));var s=new t.dataType(o);var f=(o-1)/2;var v=0,h=Math.abs;for(i=0;i<(o+1)/2;i++){n=i-f;var u=1/(Math.sqrt(2*Math.PI)*r);u*=Math.exp(-(n*n)/(2*r*r));s[i]=s[o-1-i]=u}switch(e){case 0:for(i=0,v=0;i<s.length;i++){v+=h(s[i])}break;case 1:for(i=0,v=0;i<s.length;i++){n=i-f;s[i]*=-n/Math.pow(r,2);v+=h(n*s[i])}break;case 2:for(i=0,v=0;i<s.length;i++){n=i-f;s[i]*=n*n/Math.pow(r,4)-1/Math.pow(r,2);v+=h(s[i])}v/=s.length;for(i=0;i<s.length;i++){s[i]-=h(v)}for(i=0,v=0;i<s.length;i++){n=i-f;v+=h(.5*n*n*s[i])}break;default:throw new Error("Kernel.gaussian: Derive order can be 0,1 or 2 but not "+e)}if(v!==0){for(i=0;i<s.length;i++){s[i]/=v}}return new t(s.length,s)};r.imshow=function(t,r){if(e){console.warn("Matrix.imshow: function not available in nodejs.");return}var a=this.constructor.name+".imshow: ";var i=this.getSize(1);var n=this.getSize(0);if(typeof t==="string"&&document.getElementById(t)){t=document.getElementById(t)}var o;if(t===undefined||t===null){t=document.createElement("canvas");o=window.open("","","width="+i,"height="+n);o.document.body.appendChild(t)}if(!(t instanceof HTMLCanvasElement)){throw new Error(a+"Invalid canvas.")}var s=this.getImageData();if(r===undefined||r===1){t.width=i;t.height=n;t.getContext("2d").putImageData(s,0,0)}else{if(r==="fit"){var f=t.width/i;var v=t.height/n;r=Math.min(f,v);r=r>1?1:r}else if(typeof r!=="number"){throw new Error(a+"scale must be a number or 'fit'")}t.width=Math.round(i*r);t.height=Math.round(n*r);var h=document.createElement("canvas");h.width=i;h.height=n;var u=h.getContext("2d");u.putImageData(s,0,0);t.getContext("2d").drawImage(h,0,0,i,n,0,0,t.width,t.height)}return o||this};r.print=function(){var t=this.imshow();t.print();t.close();return this};r.imagesc=function(t,r){var e=this.min().getDataScalar(),a=this.max().getDataScalar();if(e-a===0){return this["-"](e).imshow(t,r)}return this["-"](e)["./"](a-e).imshow(t,r)};r.imtransform=function(r){r=t.toMatrix(r);var e=this.getSize(0),a=this.getSize(1);var i=o(a,e),n=i.getContext("2d");var s=o(),f=s.getContext("2d");var v=t.toMatrix([0,0,1,a,0,1,a,e,1,0,e,1]).reshape([3,4]);var h=r.mtimes(v).transpose();var u=h.max(0).getData(),l=h.min(0).getData();var g=this.getImageData();n.putImageData(g,0,0);var c=r.getData();s.width=u[0]-l[0];s.height=u[1]-l[1];f.translate(-l[0],-l[1]);f.transform(c[0],c[1],c[3],c[4],c[6],c[7]);f.drawImage(i,0,0);return t.imread(s).convertImage(this.type())};r.imhist=function(r){if(!this.ismatrix()){throw new Error("Matrix.imhist: This function only works on grey-level images.")}r=r||256;var e=this.getData();var a=t.zeros(r,1),i=a.getData();var n;if(this.isinteger()){n=t.intmax(this.type())}else if(this.islogical()){n=1;r=2}else if(this.isfloat()){n=1}else{throw new Error("Matrix.imhist: unknow data type.")}var o,s,f=1/n*r;for(o=0,s=e.length;o<s;o++){i[e[o]*f|0]++}return a};(function(){var e=function(t,r){var e=t.length;var a=new Float32Array(r);var i,n=Math.floor;for(i=0;i<e;++i){var o=n(t[i]*r);o=o>=r?r-1:o;++a[o]}var s=1/e;for(i=1;i<r;++i){a[i]+=a[i-1];a[i-1]*=s}a[i-1]*=s;return a};r.histeq=function(r){var a=this.im2double();var i=a;if(this.getSize(2)>1){i=a.applycform("RGB to HSL").get([],[],2)}i=i.getData();var n=e(i,r);var o=Math.floor;for(var s=0;s<i.length;++s){i[s]=n[o(i[s]*(r-1))]}var f=new t([a.size(0),a.size(1)],i);a.set([],[],2,f);if(this.getSize(2)>1){a.applycform("HSL to RGB")}return a}})();r.rgb2gray=function(){if(this.ndims()!==3||this.getSize(2)<3){throw new Error("Matrix.rgb2gray: Matrix must be an "+"image with RGB components.")}var r=this.getSize();r[2]-=2;var e=new t(r,this.getDataType());var a=this.getData(),i=e.getData();var n=this.getView();var o=n.getEnd(0),s;var f=n.getStep(1),v=n.getEnd(1),h;var u=n.getStep(2);var l,g,c,w;for(l=0,h=v;l!==h;l+=f){g=l;c=l+u;w=l+2*u;for(s=l+o;g<s;g++,c++,w++){i[g]=.3*a[g]+.59*a[c]+.11*a[w]}}if(this.getSize(2)===4){var d=i.subarray(u);var p=a.subarray(3*u);d.set(p)}return e}})(Matrix,Matrix.prototype);(function(){var t=function(t,r,e){this.x=t;this.y=r;this.parent=e};t.prototype.initChildren=function(r,e){var a=this.x,i=this.y;if(i+1<e){this.top=new t(a,i+1,this)}if(i-1>=0){this.bottom=new t(a,i-1,this)}if(a+1<r){this.left=new t(a+1,i,this)}if(a-1>=0){this.right=new t(a-1,i,this)}};t.prototype.remove=function(t){if(this.bottom===t){this.bottom=undefined}else if(this.top===t){this.top=undefined}else if(this.right===t){this.right=undefined}else if(this.left===t){this.left=undefined}return this};t.prototype.getNext=function(){if(this.top){return this.top}if(this.bottom){return this.bottom}if(this.left){return this.left}if(this.right){return this.right}if(this.parent){return this.parent.remove(this).getNext()}return undefined};Matrix.prototype.getConnectedComponent=function(r,e,a){var i=this.getSize(0),n=this.getSize(1),o=this.getSize(2);var s=a*a;var f=new Matrix([i,n],"logical"),v=new Matrix([i,n],"logical");var h=f.getData(),u=this.getData(),l=v.getData();window.CC=f;window.IV=v;var g=e+i*r;var c;if(o===1){if(this.type()==="logical"){}else{var w=u[g];c=function(t){var r=u[t]-w;return r*r<s}}}else if(o===3){var d=u[g],p=u[g+i*n],m=u[g+i*n*2];var y=u,M=u.subarray(i*n),L=u.subarray(i*n*2);c=function(t){var r=y[t]-d,e=M[t]-p,a=L[t]-m;return r*r+e*e+a*a<s}}else{throw new Error("Matrix.getConnectedComponent: This function only support "+"images with depth 1 or 3.")}var b=new t(r,e),x=b;while(x!==undefined){var Y=x.x,B=x.y,R=B+i*Y;if(l[R]===1){x=x.parent.remove(x).getNext();continue}l[R]=1;if(c(R)){h[R]=1;x.initChildren(n,i)}x=x.getNext()}return f};Matrix.prototype.bwconncomp=function(){}})();(function(t,r){"use strict";var e=function(t,r,e,a){var i=r>>1,n=t>>1;return{xS:new Int32Array([0,0,0,n,n,n,e-n,e-n,e-n]),xE:new Int32Array([n,n,n,e-n,e-n,e-n,e,e,e]),yS:new Int32Array([0,i,a-i,0,i,a-i,0,i,a-i]),yE:new Int32Array([i,a-i,a,i,a-i,a,i,a-i,a]),jS:new Int32Array([0,0,0,-n,-n,-n,-n,-n,-n]),jE:new Int32Array([n+1,n+1,n+1,n+1,n+1,n+1,e,e,e]),iS:new Int32Array([0,-i,-i,0,-i,-i,0,-i,-i]),iE:new Int32Array([i+1,i+1,a,i+1,i+1,a,i+1,i+1,a]),lS:new Int32Array([n,n,n,0,0,0,0,0,0]),lE:new Int32Array([t,t,t,t,t,t,n+e,n+e,n+e]),kS:new Int32Array([i,0,0,i,0,0,i,0,0]),kE:new Int32Array([r,r,i+a,r,r,i+a,r,r,i+a]),jxS:new Int32Array([0,0,0,1,1,1,1,1,1]),jxE:new Int32Array([1,1,1,1,1,1,0,0,0]),iyS:new Int32Array([0,1,1,0,1,1,0,1,1]),iyE:new Int32Array([1,1,0,1,1,0,1,1,0])}};var a=function(t,r,e,a,i,n,o,s,f,v,h){var u=-Infinity;for(var l=o,g=v;l<h;l+=e,g+=a){for(var c=n+l,w=s+g,d=f+l;c<d;c++,w++){if(t[c]>u&&r[w]){u=t[c]}}}return u};var i=function(t,r,e,a,i,n,o,s,f,v,h){var u=Infinity;for(var l=o,g=v;l<h;l+=e,g+=a){for(var c=n+l,w=s+g,d=f+l;c<d;c++,w++){if(t[c]<u&&r[w]){u=t[c]}}}return u};var n=function(t,r,e,a,i,n,o,s,f,v,h){var u=0;for(var l=o,g=v;l<h;l+=e,g+=a){for(var c=n+l,w=s+g,d=f+l;c<d;c++,w++){u+=t[c]*r[w]}}return u};var o=function(r,a,i){var n=r.getSize(0),o=r.getSize(1),s=r.getSize(2),f=r.getData();var v=new t(r.getSize(),r.type()),h=v.getData();var u=a.getSize(0),l=a.getSize(1),g=a.getData();var c=e(l,u,o,n);var w=c.xS,d=c.xE,p=c.yS,m=c.yE,y=c.jS,M=c.jE,L=c.iS,b=c.iE,x=c.lS,Y=c.kS,B=c.jxS,R=c.jxE,S=c.iyS,G=c.iyE;var D,z,E,I,C,X,Z,H,k,q;var F,A,T,V;for(z=0,F=f.length;z<F;z+=o*n){var j=f.subarray(z,z+o*n),_=h.subarray(z,z+o*n);for(D=0;D<9;D++){for(E=w[D],A=d[D],C=E*n;E<A;E++,C+=n){var P=(y[D]+(B[D]?E:0))*n,W=(M[D]+(R[D]?E:0))*n;var U=(x[D]-(B[D]?0:E))*u;for(I=p[D],T=m[D],X=I+C;I<T;I++,X++){var N=L[D]+(S[D]?I:0),O=b[D]+(G[D]?I:0);var J=Y[D]-(S[D]?0:I);_[X]=i(j,g,n,u,X,N,P,J,O,U,W)}}}}return v};r.imdilate=function(t){return o(this,t,a)};r.imerode=function(t){return o(this,t,i)};r.imopen=function(t){return o(o(this,t,i),t,a)};r.imclose=function(t){return o(o(this,t,a),t,i)};r.imfilter=function(t){return o(this,t,n)};r.median=function(t){var r=t.length*.5|0;var e=function(t,e,a,i,n,o,s,f,v,h,u){var l=[];for(var g=s,c=h;g<u;g+=a,c+=i){for(var w=o+g,d=f+c,p=v+g;w<p;w++,d++){if(e[d]){l.push(t[w])}}}return l.sort()[r]};return o(this,t,e)};r.imbilateral=function(r,e,a){a=a||3;var i=t.fspecial("gaussian",Math.round(a*r/2)*2+1,r);var n=-1/(2*e);var s=function(t,r,e,a,i,o,s,f,v,h,u){var l=0,g=0,c=t[i];for(var w=s,d=h;w<u;w+=e,d+=a){for(var p=o+w,m=f+d,y=v+w;p<y;p++,m++){var M=c-t[p];var L=r[m]*Math.exp(n*M*M);l+=L;g+=t[p]*L}}return g/l};return o(this,i,s)}})(Matrix,Matrix.prototype);(function(t,r){"use strict";var e=460;var a=new Uint16Array([2,3,5,7,11,13,17,19,23,29,31,37,41,43,47,53,59,61,67,71,73,79,83,89,97,101,103,107,109,113,127,131,137,139,149,151,157,163,167,173,179,181,191,193,197,199,211,223,227,229,233,239,241,251,257,263,269,271,277,281,283,293,307,311,313,317,331,337,347,349,353,359,367,373,379,383,389,397,401,409,419,421,431,433,439,443,449,457,461,463,467,479,487,491,499,503,509,521,523,541,547,557,563,569,571,577,587,593,599,601,607,613,617,619,631,641,643,647,653,659,661,673,677,683,691,701,709,719,727,733,739,743,751,757,761,769,773,787,797,809,811,821,823,827,829,839,853,857,859,863,877,881,883,887,907,911,919,929,937,941,947,953,967,971,977,983,991,997,1009,1013,1019,1021,1031,1033,1039,1049,1051,1061,1063,1069,1087,1091,1093,1097,1103,1109,1117,1123,1129,1151,1153,1163,1171,1181,1187,1193,1201,1213,1217,1223,1229,1231,1237,1249,1259,1277,1279,1283,1289,1291,1297,1301,1303,1307,1319,1321,1327,1361,1367,1373,1381,1399,1409,1423,1427,1429,1433,1439,1447,1451,1453,1459,1471,1481,1483,1487,1489,1493,1499,1511,1523,1531,1543,1549,1553,1559,1567,1571,1579,1583,1597,1601,1607,1609,1613,1619,1621,1627,1637,1657,1663,1667,1669,1693,1697,1699,1709,1721,1723,1733,1741,1747,1753,1759,1777,1783,1787,1789,1801,1811,1823,1831,1847,1861,1867,1871,1873,1877,1879,1889,1901,1907,1913,1931,1933,1949,1951,1973,1979,1987,1993,1997,1999,2003,2011,2017,2027,2029,2039,2053,2063,2069,2081,2083,2087,2089,2099,2111,2113,2129,2131,2137,2141,2143,2153,2161,2179,2203,2207,2213,2221,2237,2239,2243,2251,2267,2269,2273,2281,2287,2293,2297,2309,2311,2333,2339,2341,2347,2351,2357,2371,2377,2381,2383,2389,2393,2399,2411,2417,2423,2437,2441,2447,2459,2467,2473,2477,2503,2521,2531,2539,2543,2549,2551,2557,2579,2591,2593,2609,2617,2621,2633,2647,2657,2659,2663,2671,2677,2683,2687,2689,2693,2699,2707,2711,2713,2719,2729,2731,2741,2749,2753,2767,2777,2789,2791,2797,2801,2803,2819,2833,2837,2843,2851,2857,2861,2879,2887,2897,2903,2909,2917,2927,2939,2953,2957,2963,2969,2971,2999,3001,3011,3019,3023,3037,3041,3049,3061,3067,3079,3083,3089,3109,3119,3121,3137,3163,3167,3169,3181,3187,3191,3203,3209,3217,3221,3229,3251,3253,3257]);var i=function(t){if(t==1){return 0}var r=[],i,n,o;for(i=n=0;n<e;n++){if(t%a[n]===0){o=a[n];do{r[i]=o;i++;t=t/o}while(t%o===0)}}if(t!==1){r[i]=t;i++}return r};var n=function(t,r,e){var a=t[r];t[r]=t[e];t[e]=a};var o=function(t,r,e,a){var i=t.length/2,n,o;if(a===1){for(n=0,o=0;n<i;n++){r[n]=t[o++];e[n]=-t[o++]}}else{var s=1/i;for(n=0,o=0;n<i;n++){r[n]=t[o++]*s;e[n]=-t[o++]*s}}};var s=function(t,r){var e=t.length,a,i;var n=new Float64Array(2*e);if(r){for(a=0,i=0;a<e;a++){n[i++]=t[a];n[i++]=-r[a]}}else{for(a=0,i=0;a<e;a++,i++){n[i++]=t[a]}}return n};var f=function(t,r,e){var a,i,o,f,v;var h,u,l,g,c,w;var d,p;var m=t.length,y=s(t,r);var M=m<<1;for(v=1,o=1;v<M;v+=2){if(o>v){n(y,o-1,v-1);n(y,o,v)}a=M>>1;while(a>=2&&o>a){o=o-a;a>>=1}o=o+a}var L=2;while(M>L){f=2*L;w=2*Math.PI/(e*L);h=Math.sin(.5*w);l=-2*h*h;g=Math.sin(w);u=1;c=0;for(a=1;a<L;a+=2){for(v=a-1;v<=M-1;v+=f){o=v+L;d=u*y[o]-c*y[o+1];p=u*y[o+1]+c*y[o];y[o]=y[v]-d;y[o+1]=y[v+1]-p;y[v]+=d;y[v+1]+=p}u=(h=u)*l-c*g+u;c=c*l+h*g+c}L=f}return y};var v=function(t,r,e,a){var i=t.length;var n=new Float64Array(i),o=new Float64Array(i);var f=2*Math.PI/i;for(u=0;u<i;u++){n[u]=Math.cos(u*f);o[u]=e*Math.sin(u*f)}var v=s(t,r),h=new Float64Array(2*i);var u,l,g,c,w,d,p;var m=1,y,M=a.length;for(y=0;y<M;y++){w=a[y];d=i/m/w;p=m*w;for(g=0;g<2*i;g++){h[g]=0}for(l=0;l<w;l++){for(c=0;c<p;c++){var L=c*l%p*d;var b=n[L],x=o[L];var Y=2*d*c,B=2*d*(l+c%m*w);for(u=0;u<d;u++,Y+=2,B+=2){h[Y]+=v[B]*b-v[B+1]*x;h[Y+1]+=v[B]*x+v[B+1]*b}}}var R=v;v=h;h=R;m*=w}return v};var h=function(t,r,e,a,n){var s=t.length,h=i(s),u=h.length;var l=!n?1:-1,g;if(s>1&&h[u-1]!=2){g=v(t,r,l,h)}else{g=f(t,r,l)}return o(g,e,a,l)};var u=function(r,e){if(r.isreal()){r.toComplex()}var a=new t(r.getSize(),Float64Array,true);var i=r.getRealData(),n=r.getImagData();var o=a.getRealData(),s=a.getImagData();var f=r.getSize(0),v=r.numel()/f;for(var u=0,l=0;u<v;u++,l+=f){var g=i.subarray(l,f+l),c=n.subarray(l,f+l);var w=o.subarray(l,f+l),d=s.subarray(l,f+l);h(g,c,w,d,e)}return a};r.fft=function(){return u(this,false)};t.fft=function(r){return u(t.toMatrix(r),false)};r.fft2=function(){var t=u(this,false);t=u(t.transpose(),false);return t.transpose()};t.fft2=function(r){var e=u(t.toMatrix(r),false);e=u(e.transpose(),false);return e.transpose()};r.ifft=function(){return u(this,true)};t.ifft=function(r){return u(t.toMatrix(r),false)};r.ifft2=function(){return this.fft().transpose().fft().transpose()};t.ifft2=function(r){return t.toMatrix(r).fft().transpose().fft().transpose()}})(Matrix,Matrix.prototype);(function(){function t(r){"use strict";var e=this.constructor.name+": ";if(r===undefined){this.name="haar"}else{this.name=r.toLowerCase()}if(t.list[this.name]){var a=t.list[this.name];var i=a.normalized!==undefined&&!a.normalized?function(r){return t.filter(r,"norm")}:function(t){return t};this.filterL=i(a.filterL);this.orthogonal=a.orthogonal?true:false;if(a.filterH){this.filterH=i(a.filterH)}if(a.invFilterL){this.invFilterL=i(a.invFilterL)}if(a.invFilterH){this.invFilterH=i(a.invFilterH)}}if(this.filterL===undefined){var n=e+"unknown wavelet '"+r+"'. \n";n+="User-defined wavelets not implemented yet.";throw new Error(n)}var o=function(r,e){return t.filter(r,"conjugate",e?-1:1)};if(!this.filterH&&this.orthogonal){this.filterH=t.filter(o(this.filterL),"mirror")}if(!this.invFilterL){this.invFilterL=o(this.filterH,true)}if(!this.invFilterH){this.invFilterH=o(this.filterL,false)}return this}t.list=t.list||{haar:{orthogonal:true,normalized:false,filterL:[1,1]},db2:{name:"Daubechies 2",orthogonal:true,normalized:false,filterL:[1+Math.sqrt(3),3+Math.sqrt(3),3-Math.sqrt(3),1-Math.sqrt(3)]},db4:{name:"Daubechies 4",orthogonal:true,filterL:[-.010597401784997278,.032883011666982945,.030841381835986965,-.18703481171888114,-.02798376941698385,.6308807679295904,.7148465705525415,.23037781330885523]},db8:{name:"Daubechies 8",orthogonal:true,filterL:[-.00011747678400228192,.0006754494059985568,-.0003917403729959771,-.00487035299301066,.008746094047015655,.013981027917015516,-.04408825393106472,-.01736930100202211,.128747426620186,.00047248457399797254,-.2840155429624281,-.015829105256023893,.5853546836548691,.6756307362980128,.3128715909144659,.05441584224308161]},sym2:{name:"Symlets 2",orthogonal:true,filterL:[-.12940952255092145,.22414386804185735,.836516303737469,.48296291314469025]},sym4:{name:"Symlets 4",orthogonal:true,filterL:[-.07576571478927333,-.02963552764599851,.49761866763201545,.8037387518059161,.29785779560527736,-.09921954357684722,-.012603967262037833,.0322231006040427]},sym8:{name:"Symlets 8",orthogonal:true,filterL:[-.0033824159510061256,-.0005421323317911481,.03169508781149298,.007607487324917605,-.1432942383508097,-.061273359067658524,.4813596512583722,.7771857517005235,.3644418948353314,-.05194583810770904,-.027219029917056003,.049137179673607506,.003808752013890615,-.01495225833704823,-.0003029205147213668,.0018899503327594609]},coif1:{name:"Coiflets 1",orthogonal:true,filterL:[-.01565572813546454,-.0727326195128539,.38486484686420286,.8525720202122554,.3378976624578092,-.0727326195128539]},coif2:{name:"Coiflets 2",orthogonal:true,filterL:[-.0007205494453645122,-.0018232088707029932,.0056114348193944995,.023680171946334084,-.0594344186464569,-.0764885990783064,.41700518442169254,.8127236354455423,.3861100668211622,-.06737255472196302,-.04146493678175915,.016387336463522112]},coif4:{name:"Coiflets 4",orthogonal:true,filterL:[-17849850030882614e-22,-32596802368833675e-22,31229875865345646e-21,6233903446100713e-20,-.00025997455248771324,-.0005890207562443383,.0012665619292989445,.003751436157278457,-.00565828668661072,-.015211731527946259,.025082261844864097,.03933442712333749,-.09622044203398798,-.06662747426342504,.4343860564914685,.782238930920499,.41530840703043026,-.05607731331675481,-.08126669968087875,.026682300156053072,.016068943964776348,-.0073461663276420935,-.0016294920126017326,.0008923136685823146]},bi13:{name:"Biorthogonal 1-3",orthogonal:false,filterL:[-.08838834764831845,.08838834764831845,.7071067811865476,.7071067811865476,.08838834764831845,-.08838834764831845],filterH:[-.7071067811865476,.7071067811865476]},bi31:{name:"Biorthogonal 3-1",orthogonal:false,filterL:[-.3535533905932738,1.0606601717798214,1.0606601717798214,-.3535533905932738],filterH:[-.1767766952966369,.5303300858899107,-.5303300858899107,.1767766952966369]},bi68:{name:"Biorthogonal 6-8",orthogonal:false,filterL:[0,.0019088317364812906,-.0019142861290887667,-.016990639867602342,.01193456527972926,.04973290349094079,-.07726317316720414,-.09405920349573646,.4207962846098268,.8259229974584023,.4207962846098268,-.09405920349573646,-.07726317316720414,.04973290349094079,.01193456527972926,-.016990639867602342,-.0019142861290887667,.0019088317364812906],filterH:[0,.014426282505624435,-.014467504896790148,-.07872200106262882,.04036797903033992,.41784910915027457,-.7589077294536541,.41784910915027457,.04036797903033992,-.07872200106262882,-.014467504896790148,.014426282505624435,0,0]},bi97:{name:"Biorthogonal 9-7",orthogonal:false,filterL:[0,.02674875741080976,-.01686411844287495,-.07822326652898785,.2668641184428723,.6029490182363579,.2668641184428723,-.07822326652898785,-.01686411844287495,.02674875741080976],filterH:[0,-.09127176311424948,.05754352622849957,.591271763114247,-1.115087052456994,.591271763114247,.05754352622849957,-.09127176311424948,0,0]}};t.filter=function(t,r,e){"use strict";var a="Wavelet.filter: ";if(e===undefined||e===0){e=1}if(typeof e!=="number"){throw new Error(a+"argument 'factor' must be a number")}if(typeof r!=="string"){throw new Error(a+"argument 'action' must be a string")}r=r.toLowerCase().substr(0,3);var i;var n=t.length;var o=[];var s=1,f=1;if(r==="mir"){for(i=0;i<n;i++){o[i]=e*t[n-1-i]}return o}if(r==="nor"){var v=0;for(i=0;i<n;i++){v+=t[i]*t[i]}e=!v?1:1/Math.sqrt(v)}else if(r==="con"){f=-1}else if(r!=="res"){throw new Error(a+"unknown action")}for(i=0;i<n;i++,s*=f){o[i]=e*s*t[i]}return o};function r(e,a,i,n){"use strict";if(e instanceof Matrix){if(a!==undefined&&typeof a!=="boolean"){throw new Error("WT: argument 'redundant' must be boolean")}if(n===undefined){n=3}else if(typeof n!=="number"){throw new Error("WT: argument 'level' must be an integer")}this.width=e.getSize(1);this.height=e.getSize(0);this.chan=e.getSize(2);this.redundant=a?true:false;this.level=n===undefined?3:n;this.wavelet=i instanceof t?i:new t(i);this.tmp=e;this.wt2()}else if(e instanceof r){this.width=e.width;this.height=e.height;this.chan=e.chan;this.redundant=e.redundant;this.level=e.level;this.wavelet=e.wavelet;this.data=e.data.getCopy();this.subband=[];var o,s;for(o=0;o<e.subband.length;o++){this.subband[o]={};for(s in e.subband[o]){if(e.subband[o].hasOwnProperty(s)&&e.subband[o][s]instanceof ImageJS){this.subband[o][s]=e.subband[o][s].getView();this.subband[o][s].data=this.data.data}}}}else{throw new Error("WT: first parameter must be an ImageJS or a WT")}return this}Matrix.prototype._filter1d=function(t,r,e,a,i,n,o){"use strict";o=o?true:false;var s=1,f=1;if(typeof a==="number"){s=a}else if(typeof a==="object"){s=a.Dout||s;f=a.Dker||f}var v=r.length;e=e==="cl"?Math.floor((v-1)/2):Math.ceil((v-1)/2);var h=t.getFirst(1),u=n.getFirst(1);var l=t.getFirst(0),g=n.getFirst(0);var c=t.getStep(2),w=n.getStep(2);var d=t.getStep(1),p=n.getStep(1);var m=t.getStep(0),y=n.getStep(0);var M=t.getEnd(2);var L=t.getEnd(1);var b=t.getEnd(0);var x=this.getData(),Y=i.getData();var B=t.getSize(0),R=B*m;var S,G,D;var z,E,I,C;var X,Z,H,k;e=e*m*s;for(z=0,S=0;z<M;z+=c,S+=w){for(E=z+h,G=S+u,I=z+L;E<I;E+=d,G+=p){var q=l+E,F=b+E;for(C=q,D=G+g;C<F;C+=m*s,D+=y){for(X=0,Z=C-e,k=0;X<v;X++,Z+=m){H=Z;while(H<q){H+=R}while(H>=F){H-=R}k+=r[X]*x[H]}if(o){Y[D]+=k}else{Y[D]=k}}}}return i};r.prototype.getScalesParameters=function(){"use strict";var t=this.width;var r=this.height;var e=1;var a=[];var i;for(i=this.level;i>0;i--,e*=2){if(!this.redundant){t=Math.ceil(t/2);r=Math.ceil(r/2)}a[i]={width:t,height:r,pow:e,cumWidth:0,cumHeight:0}}a[0]={width:t,height:r,pow:e,cumWidth:0,cumHeight:0};t=r=0;for(i=0;i<=this.level;i++){a[i].cumWidth=t;a[i].cumHeight=r;t+=a[i].width;r+=a[i].height}return a};r.prototype.wt2=function(){"use strict";var t=this.wavelet;var r=this.tmp;var e=this.getScalesParameters();window.scaleList=e;var a=e[e.length-1];var i=a.cumWidth+a.width;var n=a.cumHeight+a.height;if(this.redundant){}this.data=Matrix.zeros(n,i,r.getSize(2));var o=this.data.getView(),s=this.data.getView();var f=this.data.getView(),v=this.data.getView();this.subband=[];if(this.redundant){}var h=this.redundant?this.height:Math.ceil(this.height/2);var u=Matrix.zeros(2*h,this.width,r.getSize(2));var l=u.getView().select([0,h-1]);var g=u.getView().select([h,-1]);var c=r.getView();window.buffer=u;window.data=this.data;while(e.length>1){var w=e.pop();var d=this.redundant?{Dker:w.pow}:{Dout:2};l.select([0,w.height-1]);g.select([0,w.height-1]);r._filter1d(o,t.filterL,"cl",d,u,l);r._filter1d(o,t.filterH,"cl",d,u,g);if(this.redundant){}else{o.select([0,w.height-1],[0,w.width-1]);s.select([0,w.height-1],[w.width,2*w.width-1]);f.select([w.height,2*w.height-1],[0,w.width-1]);v.select([w.height,2*w.height-1],[w.width,2*w.width-1])}this.subband[e.length]={HL:new MatrixView(f),LH:new MatrixView(s),HH:new MatrixView(v)};l.swapDimensions(0,1);g.swapDimensions(0,1);o.swapDimensions(0,1);s.swapDimensions(0,1);f.swapDimensions(0,1);v.swapDimensions(0,1);u._filter1d(l,t.filterL,"cl",d,this.data,o);u._filter1d(l,t.filterH,"cl",d,this.data,s);u._filter1d(g,t.filterL,"cl",d,this.data,f);u._filter1d(g,t.filterH,"cl",d,this.data,v);l.swapDimensions(0,1);g.swapDimensions(0,1);o.restore().select([0,w.height-1],[0,w.width-1]);s.restore();f.restore();v.restore();l.select([],[0,w.width-1]);g.select([],[0,w.width-1]);r=this.data}this.subband[0]={LL:r.getView()}};r.prototype.iwt2=function(r){"use strict";var e=this.redundant;var a=e?.5:1;var i=t.filter(this.wavelet.invFilterL,"rescale",a);var n=t.filter(this.wavelet.invFilterH,"rescale",a);var o;if(!e){var s=this.data.getSize();if(s.length<3){s.push(1)}var f=Matrix.zeros(s[0]*2,s[1]*2,s[2]||1);f=f.set([0,2,-1],[0,2,-1],[],this.data);
window.data2=f;var v=function(t,r,e){var a=s[0]*e,i=s[1]*e;var n=Math.pow(2,this.level-t+1);var o=a/n,f=i/n;var v=new MatrixView([a,i,s[2]]);if(r==="LL"){v.select([0,2*o-1],[0,2*f-1])}else if(r==="LH"){v.select([0,o-1],[f,2*f-1])}else if(r==="HL"){v.select([o,2*o-1],[0,f-1])}else if(r==="HH"){v.select([o,2*o-1],[f,2*f-1])}return v}.bind(this)}var h=e?this.width:2*Math.ceil(this.width/2);var u=e?this.height:2*Math.ceil(this.height/2);var l=Matrix.zeros(u*2*a,h*2*a,s[2]);var g=Matrix.zeros(2*u,h,s[2]);var c,w;var d,p=Math.pow(2,this.level-1);var m=f;var y={};for(d=1;d<=this.level;d++,p/=2){y.LL=v(d-1,"LL",e?1:2),y.HL=v(d,"HL",e?1:2);y.LH=v(d,"LH",e?1:2);y.HH=v(d,"HH",e?1:2);var M=!e?1:{Dker:p};if(!e){var L=[0,y.LL.getSize(1)-1];c=g.getView().select([0,y.LL.getSize(0)-1],L);w=g.getView().select([u,u+y.LL.getSize(0)-1],L)}m._filter1d(y.LL,i,"cr",M,g,c,false);f._filter1d(y.HL,n,"cr",M,g,c,true);f._filter1d(y.LH,i,"cr",M,g,w,false);f._filter1d(y.HH,n,"cr",M,g,w,true);c.swapDimensions(0,1);w.swapDimensions(0,1);m=l;if(!e){y.LL=v(d,"LL",2);y.LL.select([0,2,-1],[0,2,-1])}y.LL.swapDimensions(0,1);g._filter1d(c,i,"cr",M,m,y.LL,false);g._filter1d(w,n,"cr",M,m,y.LL,true);c.swapDimensions(0,1);w.swapDimensions(0,1)}return l.extractViewFrom(y.LL.swapDimensions(0,1))};Matrix.psnr=function(t,r){"use strict";t=Matrix.toMatrix(t);r=Matrix.toMatrix(r);var e=r.getData(),a=t.getData();var i,n,o=0;for(i=0,n=a.length;i<n;i++){var s=e[i]-a[i];o+=s*s}return Matrix.toMatrix(10*Math.log10(n/o))};Matrix.prototype.dwt2=function(t){var e=new r(this,false,t,1);return e.data};Matrix.prototype.idwt2=function(){}})();(function(t){"use strict";var r={matrix:function(t,r,e,a,i){a=a||1;i=i||3;e=(e||1)*i;var n=r[0],o=r[3],s=r[6];var f=r[1],v=r[4],h=r[7];var u=r[2],l=r[5],g=r[8];for(var c=0,w=a,d=2*a;c<e;c+=i,w+=i,d+=i){var p=t[c],m=t[w],y=t[d];t[c]=n*p+o*m+s*y;t[w]=f*p+v*m+h*y;t[d]=u*p+l*m+g*y}return t},"RGB to RGB":function(t,r,e,a){e=e||1;a=a||3;r=(r||1)*a;for(var i=0,n=e,o=2*e;i<r;i+=a,n+=a,o+=a){var s=t[i],f=t[n],v=t[o];t[i]=s;t[n]=f;t[o]=v}return t},applyFunctionRGB:function(t,r,e,a,i){a=a||1;i=i||3;e=(e||1)*i;for(var n=0,o=a,s=2*a;n<e;n+=i,o+=i,s+=i){var f=r(t[n],t[o],t[s]);t[n]=f[0];t[o]=f[1];t[s]=f[2]}return t},applyFunctionColor:function(t,r,e,a,i){a=a||1;i=i||3;e=(e||1)*i;for(var n=0,o=a,s=2*a;n<e;n+=i,o+=i,s+=i){var f=t[n],v=t[o],h=t[s];var u=r([f,v,h]);t[n]=u[0];t[o]=u[1];t[s]=u[2]}return t},"RGB to GRAY":function(t,r,e,a){e=e||1;a=a||3;r=(r||1)*a;for(var i=0,n=e,o=2*e;i<r;i+=a,n+=a,o+=a){var s=t[i],f=t[n],v=t[o];var h=.2989*s+.587*f+.114*v;t[i]=h;t[n]=h;t[o]=h}return t},"RGB to HSV":function(t,r,e,a){e=e||1;a=a||3;r=(r||1)*a;var i=1/6;for(var n=0,o=e,s=2*e;n<r;n+=a,o+=a,s+=a){var f=t[n],v=t[o],h=t[s];var u=(f>v?f:v)>h?f>v?f:v:h;var l=u-((f<v?f:v)<h?f<v?f:v:h),g=0;if(l!==0){if(u===f){g=(v-h)/l*i}else if(u===v){g=(2+(h-f)/l)*i}else if(u===h){g=(4+(f-v)/l)*i}if(g<0){g+=1}if(u!==0){l/=u}}t[n]=g;t[o]=l;t[s]=u}return t},"HSV to RGB":function(t,r,e,a){e=e||1;a=a||3;r=(r||1)*a;for(var i=0,n=e,o=2*e;i<r;i+=a,n+=a,o+=a){var s=t[i],f=t[n],v=t[o];var h=(s*6|0)%6;var u=s*6-h;var l=v*(1-f);var g=v*(1-u*f);var c=v*(1-(1-u)*f);switch(h){case 0:t[i]=v;t[n]=c;t[o]=l;break;case 1:t[i]=g;t[n]=v;t[o]=l;break;case 2:t[i]=l;t[n]=v;t[o]=c;break;case 3:t[i]=l;t[n]=g;t[o]=v;break;case 4:t[i]=c;t[n]=l;t[o]=v;break;case 5:t[i]=v;t[n]=l;t[o]=g;break}}return t},"RGB to HSL":function(t,r,e,a){e=e||1;a=a||3;r=(r||1)*a;var i=Math.sqrt(3),n=1/(2*Math.PI),o=1/3;for(var s=0,f=e,v=2*e;s<r;s+=a,f+=a,v+=a){var h=t[s],u=t[f],l=t[v];var g=Math.atan2(i*(u-l),2*h-u-l)*n;t[s]=g<0?g+1:g;var c=(h>u?h:u)>l?h>u?h:u:l;var w=(h<u?h:u)<l?h<u?h:u:l;t[f]=c-w;t[v]=(h+u+l)*o}return t},"HSL to RGB":function(t,r,e,a){e=e||1;a=a||3;r=(r||1)*a;var i=Math.PI,n=i/3,o=i*2,s=2*i/3;var f=1/3;var v=Math.sqrt(3)/2,h=1/Math.sqrt(3);for(var u=0,l=e,g=2*e;u<r;u+=a,l+=a,g+=a){var c=t[u],w=t[l],d=t[g];var p=c*o;var m=p;while(m>n){m-=n}var y=v*w/Math.sin(s-m);var M=y*Math.cos(p)*f,L=y*Math.sin(p)*h;t[u]=d+M*2;t[l]=d-M+L;t[g]=d-M-L}return t},"RGB to HSI":function(t,r,e,a){e=e||1;a=a||3;r=(r||1)*a;var i=1/Math.sqrt(3),n=1/Math.sqrt(2),o=1/Math.sqrt(6);for(var s=0,f=e,v=2*e;s<r;s+=a,f+=a,v+=a){var h=t[s],u=t[f],l=t[v];var g=(u-l)*n;var c=(2*h-u-l)*o;t[s]=Math.atan2(g,c);t[f]=Math.sqrt(g*g+c*c);t[v]=(h+u+l)*i}return t},"HSI to RGB":function(t,r,e,a){e=e||1;a=a||3;r=(r||1)*a;var i=Math.sqrt(3),n=Math.sqrt(2),o=Math.sqrt(6);var s=1/6,f=1/3;for(var v=0,h=e,u=2*e;v<r;v+=a,h+=a,u+=a){var l=t[v],g=t[h],c=t[u];var w=g*Math.sin(l);var d=g*Math.cos(l);var p=c*i,m=w*n,y=d*o;var M=(p+y)*f;var L=(2*p+3*m-y)*s;var b=(2*p-3*m-y)*s;t[v]=M;t[h]=L;t[u]=b}return t},"LinearRGB to sRGB":function(t,r,e,a){e=e||1;a=a||3;r=(r||1)*a;var i=.055,n=1/2.4;for(var o=0,s=e,f=2*e;o<r;o+=a,s+=a,f+=a){var v=t[o],h=t[s],u=t[f];t[o]=v>.0031308?1.055*Math.pow(v,n)-i:v*12.92;t[s]=h>.0031308?1.055*Math.pow(h,n)-i:h*12.92;t[f]=u>.0031308?1.055*Math.pow(u,n)-i:u*12.92}return t},"sRGB to LinearRGB":function(t,r,e,a){e=e||1;a=a||3;r=(r||1)*a;var i=1/12.92,n=.055,o=1/1.055;for(var s=0,f=e,v=2*e;s<r;s+=a,f+=a,v+=a){var h=t[s],u=t[f],l=t[v];t[s]=h>.04045?Math.pow((h+n)*o,2.4):h*i;t[f]=u>.04045?Math.pow((u+n)*o,2.4):u*i;t[v]=l>.04045?Math.pow((l+n)*o,2.4):l*i}return t},"RGB to CMY":function(t,r,e,a){e=e||1;a=a||3;r=(r||1)*a;for(var i=0,n=e,o=2*e;i<r;i+=a,n+=a,o+=a){t[i]=1-t[i];t[n]=1-t[n];t[o]=1-t[o]}return t},"CMY to RGB":function(t,r,e,a){e=e||1;a=a||3;r=(r||1)*a;for(var i=0,n=e,o=2*e;i<r;i+=a,n+=a,o+=a){t[i]=1-t[i];t[n]=1-t[n];t[o]=1-t[o]}return t},"RGB to Opponent":function(t,r,e,a){e=e||1;a=a||3;r=(r||1)*a;var i=1/Math.sqrt(3),n=1/Math.sqrt(2),o=1/Math.sqrt(6);for(var s=0,f=e,v=2*e;s<r;s+=a,f+=a,v+=a){var h=t[s],u=t[f],l=t[v];t[s]=(h+u+l)*i;t[f]=(h-u)*n;t[v]=(h+u-2*l)*o}return t},"Opponent to RGB":function(t,r,e,a){e=e||1;a=a||3;r=(r||1)*a;var i=Math.sqrt(3),n=Math.sqrt(2),o=Math.sqrt(6);var s=1/6,f=1/3;for(var v=0,h=e,u=2*e;v<r;v+=a,h+=a,u+=a){var l=t[v],g=t[h],c=t[u];var w=l*i,d=g*n,p=c*o;t[v]=(2*w+3*d+p)*s;t[h]=(2*w-3*d+p)*s;t[u]=(w-p)*f}return t},"RGB to Ohta":function(t,r,e,a){e=e||1;a=a||3;r=(r||1)*a;var i=1/Math.sqrt(3),n=1/Math.sqrt(2),o=1/Math.sqrt(6);for(var s=0,f=e,v=2*e;s<r;s+=a,f+=a,v+=a){var h=t[s],u=t[f],l=t[v];t[s]=(h+u+l)*i;t[f]=(h-l)*n;t[v]=(-h+2*u-l)*o}return t},"Ohta to RGB":function(t,r,e,a){e=e||1;a=a||3;r=(r||1)*a;var i=Math.sqrt(3),n=Math.sqrt(2),o=Math.sqrt(6);var s=1/6,f=1/3;for(var v=0,h=e,u=2*e;v<r;v+=a,h+=a,u+=a){var l=t[v],g=t[h],c=t[u];var w=l*i,d=g*n,p=c*o;t[h]=(w+p)*f;t[v]=(2*w+3*d-p)*s;t[u]=(2*w-3*d-p)*s}return t},"LinearRGB to rgY":function(t,r,e,a){e=e||1;a=a||3;r=(r||1)*a;for(var i=0,n=e,o=2*e;i<r;i+=a,n+=a,o+=a){var s=t[i],f=t[n],v=t[o];var h=s+f+v;if(h>0){var u=1/h;t[i]=s*u;t[n]=f*u;t[o]=h}else{t[i]=1/3;t[n]=1/3;t[o]=0}}return t},"rgY to LinearRGB":function(t,r,e,a){e=e||1;a=a||3;r=(r||1)*a;for(var i=0,n=e,o=2*e;i<r;i+=a,n+=a,o+=a){var s=t[i],f=t[n],v=t[o];t[i]=s*v;t[n]=f*v;t[o]=(1-s-f)*v}return t},getXYZTransform:function(t,e,a){e=e||[.31271,.32902,1];a=a||[.64,.33,1,.3,.6,1,.15,.06,1];var i=r["xyY to XYZ"](e);i=Matrix.toMatrix(i);var a=r["xyY to XYZ"](a,3);a=new Matrix([3,3],a);var n=Matrix.diag(a.inv().mtimes(i));var o=a.mtimes(n);return t?o.inv():o},"LinearRGB to XYZ":function(t,e,a,i,n,o){var s=r.getXYZTransform(false,n,o).getData();r.matrix(t,s,e,a,i);return t},"XYZ to LinearRGB":function(t,e,a,i,n,o){var s=r.getXYZTransform(true,n,o).getData();r.matrix(t,s,e,a,i);return t},"XYZ to Lab":function(t,r,e,a,i){e=e||1;a=a||3;r=(r||1)*a;i=i||[.31271,.32902,1];var n=i[0],o=i[1],s=i[2];var f=n*s/o;var v=(1-n-o)*s/o;var h=1/f,u=1/s,l=1/v;var g=1/3,c=16/116;for(var w=0,d=e,p=2*e;w<r;w+=a,d+=a,p+=a){var m=t[w],y=t[d],M=t[p];var L=m*h;if(L>.008856){L=Math.pow(L,g)}else{L=7.787*L+c}var b=y*u;if(b>.008856){b=Math.pow(b,g)}else{b=7.787*b+c}var x=M*l;if(x>.008856){x=Math.pow(x,g)}else{x=7.787*x+c}t[w]=116*b-16;t[d]=500*(L-b);t[p]=200*(b-x)}return t},"Lab to XYZ":function(t,r,e,a,i){e=e||1;a=a||3;r=(r||1)*a;i=i||[.31271,.32902,1];var n=i[0],o=i[1],s=i[2];var f=n*s/o;var v=(1-n-o)*s/o;var h=Math.pow(.008856,1/3),u=1/7.787;var l=1/116,g=1/500,c=1/200;var w=16/116;for(var d=0,p=e,m=2*e;d<r;d+=a,p+=a,m+=a){var y=t[d],M=t[p],L=t[m];var b=(y+16)*l;var x=b+M*g;var Y=b-L*c;if(b>h){b=Math.pow(b,3)}else{b=(b-w)*u}if(x>h){x=Math.pow(x,3)}else{x=(x-w)*u}if(Y>h){Y=Math.pow(Y,3)}else{Y=(Y-w)*u}t[d]=x*f;t[p]=b*s;t[m]=Y*v}return t},"XYZ to Luv":function(t,r,e,a,i){e=e||1;a=a||3;r=(r||1)*a;i=i||[.31271,.32902,1];var n=i[0],o=i[1],s=i[2];var f=n*s/o;var v=(1-n-o)*s/o;var h=1/s;var u=4*f/(f+15*s+3*v);var l=9*s/(f+15*s+3*v);var g=1/3;for(var c=0,w=e,d=2*e;c<r;c+=a,w+=a,d+=a){var p=t[c],m=t[w],y=t[d];var M=m*h;if(M>.008856){M=116*Math.pow(M,g)-16}else{M*=903.3}var L=1/(p+15*m+3*y);L=isFinite(L)?L:0;var b=4*L*p;var x=9*L*m;L=13*M;t[c]=M;t[w]=L*(b-u);t[d]=L*(x-l)}return t},"Luv to XYZ":function(t,r,e,a,i){e=e||1;a=a||3;r=(r||1)*a;i=i||[.31271,.32902,1];var n=i[0],o=i[1],s=i[2];var f=n*s/o;var v=(1-n-o)*s/o;var h=4*f/(f+15*s+3*v);var u=9*s/(f+15*s+3*v);var l=Math.pow(.008856,1/3),g=1/7.787;var c=1/116,w=16/116;for(var d=0,p=e,m=2*e;d<r;d+=a,p+=a,m+=a){var y=t[d],M=t[p],L=t[m];var b=(y+16)*c;if(b>l){b=Math.pow(b,3)}else{b=(b-w)*g}var x=1/(13*y);x=isFinite(x)?x:0;var Y=M*x+h;var B=L*x+u;x=b/(4*B);t[d]=9*Y*x;t[p]=b;t[m]=(12-3*Y-20*B)*x}return t},"Lab to Lch":function(t,r,e,a){e=e||1;a=a||3;r=(r||1)*a;var i=1/(2*Math.PI);for(var n=0,o=e,s=2*e;n<r;n+=a,o+=a,s+=a){var f=t[n],v=t[o],h=t[s];var u=Math.atan2(h,v)*i;t[n]=f;t[o]=Math.sqrt(v*v+h*h);t[s]=u<0?u+1:u}return t},"Lch to Lab":function(t,r,e,a){e=e||1;a=a||3;r=(r||1)*a;var i=Math.PI*2;for(var n=0,o=e,s=2*e;n<r;n+=a,o+=a,s+=a){var f=t[n],v=t[o],h=t[s];var u=h*i;var l=Math.cos(u)*v;var g=Math.sin(u)*v;t[n]=f;t[o]=l;t[s]=g}return t},"RGB to XYZ":function(t,e,a,i){r["sRGB to LinearRGB"](t,e,a,i);r["LinearRGB to XYZ"](t,e,a,i);return t},"XYZ to RGB":function(t,e,a,i){r["XYZ to LinearRGB"](t,e,a,i);r["LinearRGB to sRGB"](t,e,a,i);return t},"RGB to Lab":function(t,e,a,i,n){r["sRGB to LinearRGB"](t,e,a,i);r["LinearRGB to XYZ"](t,e,a,i,n);r["XYZ to Lab"](t,e,a,i,n);return t},"Lab to RGB":function(t,e,a,i){r["Lab to XYZ"](t,e,a,i);r["XYZ to LinearRGB"](t,e,a,i);r["LinearRGB to sRGB"](t,e,a,i);return t},"RGB to Luv":function(t,e,a,i,n){r["sRGB to LinearRGB"](t,e,a,i);r["LinearRGB to XYZ"](t,e,a,i);r["XYZ to Luv"](t,e,a,i,n);return t},"Luv to RGB":function(t,e,a,i,n){r["Luv to XYZ"](t,e,a,i,n);r["XYZ to LinearRGB"](t,e,a,i);r["LinearRGB to sRGB"](t,e,a,i);return t},"RGB to Lch":function(t,e,a,i,n){r["sRGB to LinearRGB"](t,e,a,i);r["LinearRGB to XYZ"](t,e,a,i);r["XYZ to Lab"](t,e,a,i,n);r["Lab to Lch"](t,e,a,i);return t},"Lch to RGB":function(t,e,a,i,n){r["Lch to Lab"](t,e,a,i);r["Lab to XYZ"](t,e,a,i,n);r["XYZ to LinearRGB"](t,e,a,i);r["LinearRGB to sRGB"](t,e,a,i);return t},"XYZ to xyY":function(t,r,e,a,i){e=e||1;a=a||3;r=(r||1)*a;i=i||[.31271,.32902,1];var n=i[0],o=i[1];for(var s=0,f=e,v=2*e;s<r;s+=a,f+=a,v+=a){var h=t[s],u=t[f],l=t[v];var g=1/(h+u+l);if(isFinite(g)){t[s]=h*g;t[f]=u*g;t[v]=u}else{t[s]=n;t[f]=o;t[v]=0}}return t},"xyY to XYZ":function(t,r,e,a){e=e||1;a=a||3;r=(r||1)*a;for(var i=0,n=e,o=2*e;i<r;i+=a,n+=a,o+=a){var s=t[i],f=t[n],v=t[o];var h=v/f;t[i]=s*h;t[n]=v;t[o]=(1-s-f)*h}return t},"XYZ to 1960 uvY":function(t,r,e,a,i){e=e||1;a=a||3;r=(r||1)*a;i=i||[.31271,.32902,1];var n=i[0],o=i[1],s=i[2];var f=n*s/o,v=(1-n-o)*s/o;var h=4*f/(f+15*s+3*v);var u=6*s/(f+15*s+3*v);for(var l=0,g=e,c=2*e;l<r;l+=a,g+=a,c+=a){var w=t[l],d=t[g],p=t[c];if(d===0){t[l]=h;t[g]=u;t[c]=0}else{var m=1/(w+15*d+3*p);t[l]=4*w*m;t[g]=6*d*m;t[c]=d}}return t},"1960 uvY to XYZ":function(t,r,e,a){e=e||1;a=a||3;r=(r||1)*a;var i=6/4,n=1/3;for(var o=0,s=e,f=2*e;o<r;o+=a,s+=a,f+=a){var v=t[o],h=t[s],u=t[f];var l=1/h;var g=i*u*v*l;t[o]=g;t[s]=u;t[f]=(6*u*l-g-15*u)*n}return t},"XYZ to 1976 u'v'Y":function(t,r,e,a,i){e=e||1;a=a||3;r=(r||1)*a;i=i||[.31271,.32902,1];var n=i[0],o=i[1],s=i[2];var f=n*s/o,v=(1-n-o)*s/o;var h=4*f/(f+15*s+3*v);var u=9*s/(f+15*s+3*v);for(var l=0,g=e,c=2*e;l<r;l+=a,g+=a,c+=a){var w=t[l],d=t[g],p=t[c];if(d===0){t[l]=h;t[g]=u;t[c]=0}else{var m=1/(w+15*d+3*p);t[l]=4*w*m;t[g]=9*d*m;t[c]=d}}return t},"1976 u'v'Y to XYZ":function(t,r,e,a){e=e||1;a=a||3;r=(r||1)*a;var i=9/4,n=1/3;for(var o=0,s=e,f=2*e;o<r;o+=a,s+=a,f+=a){var v=t[o],h=t[s],u=t[f];var l=1/h;var g=i*u*v*l;t[o]=g;t[s]=u;t[f]=(9*u*l-g-15*u)*n}return t},"xyY to 1960 uvY":function(t,r,e,a){e=e||1;a=a||3;r=(r||1)*a;for(var i=0,n=e,o=2*e;i<r;i+=a,n+=a,o+=a){var s=t[i],f=t[n];var v=1/(-2*s+12*f+3);t[i]=4*s*v;t[n]=6*f*v}return t},"1960 uvY to xyY":function(t,r,e,a){e=e||1;a=a||3;r=(r||1)*a;for(var i=0,n=e,o=2*e;i<r;i+=a,n+=a,o+=a){var s=t[i],f=t[n];var v=1/(2*s-8*f+4);t[i]=3*s*v;t[n]=2*f*v}return t},"1976 u'v'Y to xyY":function(t,r,e,a){e=e||1;a=a||3;r=(r||1)*a;for(var i=0,n=e,o=2*e;i<r;i+=a,n+=a,o+=a){var s=t[i],f=t[n];var v=1/(6*s-16*f+12);t[i]=9*s*v;t[n]=4*f*v}return t},"xyY to 1976 u'v'Y":function(t,r,e,a){e=e||1;a=a||3;r=(r||1)*a;for(var i=0,n=e,o=2*e;i<r;i+=a,n+=a,o+=a){var s=t[i],f=t[n];var v=1/(-2*s+12*f+3);t[i]=4*s*v;t[n]=9*f*v}return t},"1976 u'v'Y to 1960 uvY":function(t,r,e,a){e=e||1;a=a||3;r=(r||1)*a+e;var i=2/3;for(var n=e;n<r;n+=a){t[n]*=i}return t},"1960 uvY to 1976 u'v'Y":function(t,r,e,a){e=e||1;a=a||3;r=(r||1)*a+e;var i=3/2;for(var n=e;n<r;n+=a){t[n]*=i}return t},"RGB to rgY":function(t,e,a,i){r["sRGB to LinearRGB"](t,e,a,i);r["LinearRGB to rgY"](t,e,a,i);return t},"rgY to RGB":function(t,e,a,i){r["rgY to LinearRGB"](t,e,a,i);r["LinearRGB to sRGB"](t,e,a,i);return t},"rgY to xyY":function(t,e,a,i){r["rgY to LinearRGB"](t,e,a,i);r["LinearRGB to XYZ"](t,e,a,i);r["XYZ to xyY"](t,e,a,i);return t},"xyY to rgY":function(t,e,a,i){r["xyY to XYZ"](t,e,a,i);r["XYZ to LinearRGB"](t,e,a,i);r["LinearRGB to rgY"](t,e,a,i);return t},"RGB to xyY":function(t,e,a,i){r["sRGB to LinearRGB"](t,e,a,i);r["LinearRGB to XYZ"](t,e,a,i);r["XYZ to xyY"](t,e,a,i);return t},"xyY to RGB":function(t,e,a,i){r["xyY to XYZ"](t,e,a,i);r["XYZ to LinearRGB"](t,e,a,i);r["LinearRGB to sRGB"](t,e,a,i);return t},"RGB to 1960 uvY":function(t,e,a,i){r["sRGB to LinearRGB"](t,e,a,i);r["LinearRGB to XYZ"](t,e,a,i);r["XYZ to xyY"](t,e,a,i);r["xyY to 1960 uvY"](t,e,a,i);return t},"1960 uvY to RGB":function(t,e,a,i){r["1960 uvY to xyY"](t,e,a,i);r["xyY to XYZ"](t,e,a,i);r["XYZ to LinearRGB"](t,e,a,i);r["LinearRGB to sRGB"](t,e,a,i);return t},"RGB to 1976 u'v'Y":function(t,e,a,i){r["sRGB to LinearRGB"](t,e,a,i);r["LinearRGB to XYZ"](t,e,a,i);r["XYZ to 1976 u'v'Y"](t,e,a,i);return t},"1976 u'v'Y to RGB":function(t,e,a,i){r["1976 u'v'Y to XYZ"](t,e,a,i);r["XYZ to LinearRGB"](t,e,a,i);r["LinearRGB to sRGB"](t,e,a,i);return t}};t.Colorspaces=r})(Matrix);(function(t,r){"use strict";var e={lab2lch:"Lab to Lch",lab2srgb:"Lab to RGB",lab2xyz:"Lab to XYZ",lch2lab:"Lch to Lab",srgb2cmyk:"RGB to CMY",srgb2lab:"RGB to Lab",srgb2xyz:"RGB to XYZ",upvpl2xyz:"1976 u'v'Y to XYZ",uvl2xyz:"1960 uvY to XYZ",xyl2xyz:"xyY to XYZ",xyz2lab:"XYZ to Lab",xyz2srgb:"XYZ to RGB",xyz2upvpl:"XYZ to 1976 u'v'",xyz2uvl:"XYZ to 1960 uv",xyz2xyl:"XYZ to xyY"};r.applycform=function(r){if(this.ndims()!==3||this.getSize(2)<3){throw new Error("Matrix.applycform: Matrix must be an "+"image with RGB components.")}var a=this.getSize(0)*this.getSize(1);if(typeof r==="string"){if(t.Colorspaces[r]){t.Colorspaces[r](this.getData(),a,a,1)}else if(t.Colorspaces[e[r]]){t.Colorspaces[e[r]](this.getData(),a,a,1)}else{throw new Error("Matrix.applycform: Unknown color transformation "+r)}}else if(typeof r==="function"){if(r.length===3){t.Colorspaces.applyFunctionRGB(this.getData(),r,a,a,1)}else if(r.length===1){t.Colorspaces.applyFunctionColor(this.getData(),r,a,a,1)}}else{r=t.toMatrix(r);if(!Tools.checkSizeEquals(r.size(),[3,3],t.ignoreTrailingDims)){throw new Error("Matrix.applycform: Matrix argument must be 3x3.")}t.Colorspaces.matrix(this.getData(),r.getData(),a,a,1)}return this};t.applycform=function(t,r){return t.getCopy().applycform(r)};r.toColormap=function(r){var e=this.getData(),a=this.getSize(),i=e.length;a[2]=3;var n=new t(a),o=n.getData();var s=o.subarray(0,i),f=o.subarray(i,2*i),v=o.subarray(2*i,3*i);var h,u,l=Math.floor;if(r==="JET"){for(h=0;h<i;h++){u=e[h]*4;if(u>=4){u=3.99}else if(u<0){u=0}switch(l(u*2)%8){case 0:s[h]=0;f[h]=0;v[h]=u+.5;break;case 1:case 2:s[h]=0;v[h]=1;f[h]=u-.5;break;case 3:case 4:s[h]=u-1.5;f[h]=1;v[h]=2.5-u;break;case 5:case 6:s[h]=1;f[h]=3.5-u;v[h]=0;break;case 7:s[h]=4.5-u;f[h]=0;v[h]=0;break}}}else if(r==="HUE"){for(h=0;h<i;h++){var g=e[h];u=l(g*6)%6;var c=g*6-u;switch(u){case 0:s[h]=1;f[h]=c;v[h]=0;break;case 1:s[h]=1-c;f[h]=1;v[h]=0;break;case 2:s[h]=0;f[h]=1;v[h]=c;break;case 3:s[h]=0;f[h]=1-c;v[h]=1;break;case 4:s[h]=c;f[h]=0;v[h]=1;break;case 5:s[h]=1;f[h]=0;v[h]=1-c;break}}}else if(r==="HUE"){o.set(e)}return n};r.correctImage=function(r,e){e=e||t.CIE.getIlluminant("D65");var a=t.CIE.getIlluminantConversionMatrix(e,r);this.applycform("sRGB to LinearRGB").applycform(a).applycform("LinearRGB to sRGB");return this};t.correctImage=function(t,r,e){return t.getCopy().correctImage(r,e)};r.im2CCT=function(){var r=t.CIE["xyY to CCT"];var e=this.getSize();e.pop();var a=new t(e,"single");var i=this.getData(),n=a.getData();var o=this.getView();var s=o.getStep(0),f=o.getEnd(0),v;var h=o.getStep(1),u=o.getEnd(1),l;var g=o.getStep(2);var c,w,d,p,m,y=[];for(c=0,l=u;c!==l;c+=h){w=c;d=c+g;p=c+2*g;for(v=c+f;w!==v;w+=s,d+=s,p+=s){y[0]=i[w];y[1]=i[d];y[2]=i[p];m=r(y);m=m<1668?1668:m>2e4?2e4:m;m=isNaN(m)?24999:m;n[w]=m}}return a};r.CCT2im=function(){var r=t.CIE["CCT to xyY"];var e=this.getSize();e[2]=3;var a=new t(e,"single");var i=this.getData(),n=a.getData();var o=a.getView();var s=o.getStep(0),f=o.getEnd(0),v;var h=o.getStep(1),u=o.getEnd(1),l;var g=o.getStep(2);var c,w,d,p,m=[];for(c=0,l=u;c!==l;c+=h){w=c;d=c+g;p=c+2*g;for(v=c+f;w!==v;w+=s,d+=s,p+=s){m=r(i[w]);n[w]=m[0];n[d]=m[1];n[p]=m[2]}}return a}})(Matrix,Matrix.prototype);