/**
 * This program is free software: you can redistribute it and/or modify    
 * it under the terms of the GNU General Public License as published by        
 * the Free Software Foundation, either version 3 of the License, or 
 * (at your option) any later version.
 * 
 * This program is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU General Public License for more details.
 * 
 * You should have received a copy of the GNU General Public License
 * along with this program.  If not, see <http://www.gnu.org/licenses/>.
 * 
 * @author Baptiste Mazin     <baptiste.mazin@telecom-paristech.fr> 
 * @author Guillaume Tartavel <guillaume.tartavel@telecom-paristech.fr> 
 */
(function(r,t){"use strict";var a=typeof module!=="undefined"&&module.exports?true:false;var e,i,n;if(a){e=require("fs");i=require("canvas");n=i.Image}else{n=Image}var o=function(r,t){var e;if(a){e=new i}else{e=document.createElement("canvas")}e.width=r||0;e.height=t||0;return e};t.convertImage=function(t){var a=new r(this.getSize(),t);var e,i;if(this.isfloat()||this.islogical()){e=[0,1]}else if(this.isinteger()){e=[r.intmin(this.type()),r.intmax(this.type())]}var n=e[0],o=1/(e[1]-e[0]);if(a.isfloat()||this.islogical()){i=[0,1]}else if(a.isinteger()){i=[r.intmin(a.type()),r.intmax(a.type())]}var s=i[0],v=o*(i[1]-i[0]);var f=this.getData(),u=new a.getData;var h,l;for(h=0,l=f.length;h<l;h++){u[h]=(f[h]-n)*v-s}return new r(this.getSize(),u)};t.im2double=function(){return this.convertImage("double")};t.im2single=function(){return this.convertImage("single")};t.im2uint8=function(){return this.convertImage("uint8")};t.im2uint8c=function(){return this.convertImage("uint8c")};t.getImageData=function(){var t;if(this.isfloat()||this.islogical()){t=[0,1]}else if(this.isinteger()){t=[r.intmin(this.type()),r.intmax(this.type())]}var a=t[0],e=255/(t[1]-t[0]);var i=this.getSize(1),n=this.getSize(0);var s=o().getContext("2d").createImageData(i,n);var v=n*i,f;var u=this.getData(),h=s.data;var l,g,c,w,p,M,m;switch(this.getSize(2)){case 1:for(g=0,l=0;g<n;g++){for(c=g,f=g+v;c<f;c+=n){m=(u[c]-a)*e;h[l++]=m;h[l++]=m;h[l++]=m;h[l++]=255}}break;case 2:for(g=0,l=0;g<n;g++){for(c=g,w=g+v,f=g+v;c<f;c+=n,w+=n){m=(u[c]-a)*e;h[l++]=m;h[l++]=m;h[l++]=m;h[l++]=(u[w]-a)*e}}break;case 3:for(g=0,l=0;g<n;g++){for(c=g,w=g+v,p=g+2*v,f=w;c<f;c+=n,w+=n,p+=n){h[l++]=(u[c]-a)*e;h[l++]=(u[w]-a)*e;h[l++]=(u[p]-a)*e;h[l++]=255}}break;case 4:for(g=0,l=0;g<n;g++){for(c=g,w=c+v,p=w+v,M=p+v,f=w;c<f;c+=n,w+=n,p+=n,M+=n){h[l++]=(u[c]-a)*e;h[l++]=(u[w]-a)*e;h[l++]=(u[p]-a)*e;h[l++]=(u[M]-a)*e}}break}return s};t.toImage=function(r){if(a){throw new Error("Matrix.toImage: Canvas doesn't exist.")}var t=o(this.getSize(1),this.getSize(0));var e=this.getImageData();t.getContext("2d").putImageData(e,0,0);var i=new Image;i.src=t.toDataURL();i.onload=r;return i};if(a){r.prototype.imwrite=function(r,t){var a=o(this.getSize(1),this.getSize(0));a.getContext("2d").putImageData(this.getImageData(),0,0);var i=e.createWriteStream(r),n;if(/\.(png)$/i.test(r.toLowerCase())){n=a.pngStream()}else if(/\.(jpeg|jpg)$/i.test(r.toLowerCase())){n=a.jpegStream()}else{throw new Error("Matrix.imwrite: invalid file extension.")}n.on("data",function(r){i.write(r)});if(t){n.on("end",t.bind(this))}}}r.fspecial=function(t,a,e){var i,n,o,s;var v,f,u,h,l,g,c,w;var p,M,m;var y=function(r,t){return Math.exp(-(r*r+t*t)/(2*s*s))};switch(t.toLowerCase()){case"average":if(Tools.isArrayLike(a)){o=a[0];n=a[1]}else{o=a===undefined?3:a;n=o}return r.ones([o,n])["./"](o*n);case"disk":break;case"gaussian":if(Tools.isArrayLike(a)){o=a[0];n=a[1]}else{o=a===undefined?3:a;n=o}s=e===undefined?.5:e;v=[];w=0;for(h=0,f=-(n-1)/2,g=n*o;h<g;h+=o,f++){for(l=h,c=h+o,u=-(o-1)/2;l<c;l++,u++){p=y(f,u);v[l]=p;w+=p}}for(M=0,m=v.length;M<m;M++){v[M]/=w}return new r([o,n],v);case"laplacian":i=a===undefined?.2:a;return new r([3,3],[i/4,(1-i)/4,i/4,(1-i)/4,-1,(1-i)/4,i/4,(1-i)/4,i/4])[".*"](4/(i+1));case"log":if(Tools.isArrayLike(a)){o=a[0];n=a[1]}else{o=a===undefined?3:a;n=o}s=e===undefined?.5:e;v=[];w=0;for(h=0,f=-(n-1)/2,g=n*o;h<g;h+=o,f++){for(l=h,c=h+o,u=-(o-1)/2;l<c;l++,u++){p=y(f,u);v[l]=(f*f+u*u-2*s*s)*p/Math.pow(s,4);w+=p}}for(M=0,m=v.length;M<m;M++){v[M]/=w}w=0;for(M=0,m=v.length;M<m;M++){w+=v[M]}w/=n*o;for(M=0,m=v.length;M<m;M++){v[M]-=w}return new r([o,n],v);case"unsharp":i=a===undefined?.2:a;return new r([3,3],[-i,i-1,-i,i-1,i+5,i-1,-i,i-1,-i])[".*"](1/(i+1));case"prewitt":return new r([3,3],[1,0,-1,1,0,-1,1,0,-1]);case"sobel":return new r([3,3],[1,0,-1,2,0,-2,1,0,-1]);default:return}};t.filter1d=function(t,a){var e=this.constructor.name+".filter1d: ";if(a===undefined){a="C"}if(!t.isvector()){throw new Error("Matrix.filter1d: Kernel must be a vector")}var i=t.getLength(),n=t.getData();if(typeof a==="string"){switch(a.toUpperCase()){case"C":case"CL":a=Math.floor((i-1)/2);break;case"CR":a=Math.ceil((i-1)/2);break;case"L":a=0;break;case"R":a=i-1;break;default:throw new Error(e+"unknown origin position '"+a+"'")}}else if(typeof a==="number"){if(a<0){a+=i}if(a<0||a>=i){throw new Error(e+"origin value must satisfy : |origin| < kernel.length")}}var o=new r(this.getSize(),this.getDataType());var s=this.getData(),v=o.getData();var f=o.getView();var u=f.getStep(2),h=f.getEnd(2);var l=f.getStep(1),g=f.getEnd(1);var c=f.getEnd(0);if(a>=c/2){throw new Error("Matrix.filter1d: Kernel is too large.")}var w,p=c-a;var M,m,y,x,d,B,b;for(M=0;M!==h;M+=u){for(m=M,y=M+g;m!==y;m+=l){for(x=m,d=m+a;x<d;x++){for(w=0,b=0,B=2*m+a-x;B>m;b++,B--){w+=n[b]*s[B]}for(B=m;b<i;b++,B++){w+=n[b]*s[B]}v[x]=w}for(x=m+a,d=m+p;x<d;x++){for(w=0,b=0,B=x-a;b<i;b++,B++){w+=n[b]*s[B]}v[x]=w}for(x=m+p,d=m+c;x<d;x++){for(w=0,b=0,B=x-a;B<d;b++,B++){w+=n[b]*s[B]}for(B=d-2;b<i;b++,B--){w+=n[b]*s[B]}v[x]=w}}}return o};t.separableFilter=function(r,t){if(t===undefined){t=r}return this.filter1d(r).permute([1,0,2]).filter1d(t).permute([1,0,2])};t.gaussian=function(r,t,a){a=a||3;var e=v.gaussian(r,0,a);var i;if(typeof t==="number"){i=v.gaussian(t,0,a)}else{i=e}return this.separableFilter(e,i)};t.gaussianGradient=function(t){if(!t){t=2}var a=v.gaussian(t,1,3);var e=v.gaussian(t,0,3);var i=this.separableFilter(e,a);var n=this.separableFilter(a,e);var o=.5/Math.PI;var s=r.zeros(this.getSize()),f=r.zeros(this.getSize());var u=i.getData(),h=n.getData();var l=s.getData(),g=f.getData();var c,w;for(c=0,w=u.length;c<w;c++){var p=u[c],M=h[c];l[c]=Math.sqrt(p*p+M*M);var m=Math.atan2(M,p)*o;g[c]=m<0?m+1:m}return{x:i,y:n,norm:s,phase:f}};t.gradient=function(t,a,e,i,n){var o=.70710678,s=6.8284271,v=.35355339;var f=.29289322,u=1/s,h=.5/Math.PI;var l={},g,c,w,p,M;var m=this.getSize();var y=this.getDataType();if(t){l.x=new r(m,y);g=l.x.getData()}if(a){l.y=new r(m,y);c=l.y.getData()}if(e){l.norm=new r(m,y);w=l.norm.getData()}if(i){l.phase=new r(m,y);p=l.phase.getData()}if(n){l.laplacian=new r(m,y);M=l.laplacian.getData()}var x=this.getData();var d=this.getView();var B=d.getStep(2),b=d.getEnd(2);var D=d.getStep(1),L=d.getEnd(1);var A=d.getEnd(0);var G,C,R,Y,S,E,z;for(G=0;G!==b;G+=B){for(C=G+D,R=G+L-D;C!==R;C+=D){for(E=C-D,Y=C,z=C+D,S=C+A-2;Y<S;Y){var I=x[E],F=x[++E],Q=x[E+1];var k=x[Y],Z=x[++Y],X=x[Y+1];var H=x[z],q=x[++z],V=x[z+1];var T=V-I,j=Q-H;var U=f*(q-F+v*(T-j));var K=f*(k-X-v*(T+j));if(t){g[Y]=U}if(a){c[Y]=K}if(e){w[Y]=Math.sqrt(U*U+K*K)}if(i){var J=Math.atan2(-K,U)*h;p[Y]=J<0?J+1:J}if(n){M[Y]=(o*(I+Q+H+V)+(k+F+q+X))*u-Z}}}}return l};t.conv=function(t,a){if(!this.isvector()||!t.isvector()){throw new Error("Matrix.conv: Input must be vector.")}var e=this.getData(),i=e.length;var n=t.getData(),o=n.length;if(i<o){return t.conv(this,a)}var s=Tools.checkType(this.getDataType());var v=new s(i+o-1),f=v.length;var u,h,l,g,c,w,p;for(c=0,w=o-1;c<w;c++){for(p=0,h=0,l=c+1,g=c;h<l;h++,g--){p+=e[h]*n[g]}v[c]=p}for(c=o-1,u=0,w=i;c<w;c++,u++){for(p=0,h=u,l=c+1,g=o-1;h<l;h++,g--){p+=e[h]*n[g]}v[c]=p}for(c=i,u=i-o+1;c<f;c++,u++){for(p=0,h=u,g=o-1;h<i;h++,g--){p+=e[h]*n[g]}v[c]=p}switch(a){case undefined:case"full":return new r(f,v);case"same":var M=Math.ceil(o/2);return new r(i,v.subarray(M,M+i));case"valid":return new r(i-o+1,v.subarray(o-1,i));default:throw new Error("Matrix.conv: Invalid shape parameter.")}};var s=function(r){var t=r.getView(),a=r.getData();var e=t.getStep(2),i=t.getEnd(2);var n=t.getStep(1),o=t.getEnd(1),s;var v=t.getEnd(0),f;var u,h,l;for(u=0;u<i;u+=e){for(h=u+1,f=u+v;h<f;h++){a[h]+=a[h-1]}for(l=u+n,s=u+o;l<s;l+=n){var g=a[l];a[l]+=a[l-n];for(h=l+1,f=l+v;h<f;h++){g+=a[h];a[h]=a[h-n]+g}}}};t.fastBlur=function(t,a,e){e=e||3;a=a||t;var i=Math.round(Math.sqrt(12/e*t*t+1)/2)*2+1;var n=Math.round(Math.sqrt(12/e*a*a+1)/2)*2+1;var o=r.zeros(this.getSize());var v=this.getView();var f=v.getStep(2),u=v.getEnd(2);var h=v.getStep(1),l=v.getEnd(1);var g=v.getEnd(0);a=n/2|0;t=(i/2|0)*h;var c=i/2|0;var w,p,M,m,y,x,d;var B,b,D;var L=this.im2double();for(var A=0;A<e;A++){s(L);var G=L.getData(),C=o.getData();var R=t+a+h+1,Y=t+a,S=-(t+h)+a,E=t-a-1;var z=G.subarray(Y),I=G.subarray(E);for(M=0;M<u;M+=f){for(x=M,y=0,p=M+a+1;x<p;x++,y++){b=y+a+1;for(d=x,m=0,w=x+t+h;d<w;d+=h,m++){C[d]=z[d]/((m+c+1)*b)}B=1/(i*b);for(d=x+t+h,w=x+l-t;d<w;d+=h){C[d]=(z[d]-G[d+S])*B}D=G[x+l-h+a];for(d=x+l-t,w=x+l;d<w;d+=h){C[d]=D-G[d+S];C[d]/=(t+w-d)/h*b}}for(m=M,w=M+t+h;m<w;m+=h){B=1/(((m-M+t)/h+1)*n);for(y=m+a+1,p=m+g-a;y<p;y++){C[y]=z[y]-I[y];C[y]*=B}}B=1/(i*n);for(m=M+t+h,w=M+l-t;m<w;m+=h){for(y=m+a+1,p=m+g-a;y<p;y++){C[y]=(G[y-R]+z[y]-G[y+S]-I[y])*B}}for(m=M+l-t,w=M+l;m<w;m+=h){B=1/((M+l-m+t)/h*n);for(y=m+a+1,p=m+g-a;y<p;y++){C[y]=G[y-R]+G[M+l-h+y-m+a]-G[M+l-h+y-m-a-1]-G[y+S];C[y]*=B}}for(y=M+g-a,p=M+g;y<p;y++){for(m=y,w=y+t+h;m<w;m+=h){C[m]=G[m-y+M+g-1+t]-I[m];C[m]/=((m-y+t)/h+1)*(a+(g-(y-M)))}B=1/(i*(a+(g-(y-M))));for(m=y+t+h,w=y+l-t;m<w;m+=h){C[m]=G[m-y+M+g-1+t]-G[m-y+M+g-1-t-h]+G[m-R]-I[m];C[m]*=B}for(m=y+l-t,w=y+l;m<w;m+=h){C[m]=G[M+l-h+g-1]+G[m-R]-G[M+m-y+g-1-t-h]-G[M+l-h+y-M-a-1];C[m]/=(l-(m-y)+t)/h*(a+(g-(y-M)))}}}var F=o;o=L;L=F}return F};var v={};v.normalize=function(r){var t;var a=r.length;var e=0;for(t=0;t<a;t++){e+=Math.abs(r[t])}if(e!==0){for(t=0;t<a;t++){r[t]/=e}}return r};v.gaussian=function(t,a,e){var i,n;if(e===undefined){e=3}if(a===undefined){a=0}var o=1+2*Math.ceil(t*Math.sqrt(e*2*Math.log(10)));var s=new r.dataType(o);var v=(o-1)/2;var f=0,u=Math.abs;for(i=0;i<(o+1)/2;i++){n=i-v;var h=1/(Math.sqrt(2*Math.PI)*t);h*=Math.exp(-(n*n)/(2*t*t));s[i]=s[o-1-i]=h}switch(a){case 0:for(i=0,f=0;i<s.length;i++){f+=u(s[i])}break;case 1:for(i=0,f=0;i<s.length;i++){n=i-v;s[i]*=-n/Math.pow(t,2);f+=u(n*s[i])}break;case 2:for(i=0,f=0;i<s.length;i++){n=i-v;s[i]*=n*n/Math.pow(t,4)-1/Math.pow(t,2);f+=u(s[i])}f/=s.length;for(i=0;i<s.length;i++){s[i]-=u(f)}for(i=0,f=0;i<s.length;i++){n=i-v;f+=u(.5*n*n*s[i])}break;default:throw new Error("Kernel.gaussian: Derive order can be 0,1 or 2 but not "+a)}if(f!==0){for(i=0;i<s.length;i++){s[i]/=f}}return new r(s.length,s)};t.imshow=function(r,t){if(a){console.warn("Matrix.imshow: function not available in nodejs.");return}var e=this.constructor.name+".imshow: ";var i=this.getSize(1);var n=this.getSize(0);if(typeof r==="string"&&document.getElementById(r)){r=document.getElementById(r)}var o;if(r===undefined||r===null){r=document.createElement("canvas");o=window.open("","","width="+i,"height="+n);o.document.body.appendChild(r)}if(!(r instanceof HTMLCanvasElement)){throw new Error(e+"Invalid canvas.")}var s=this.getImageData();if(t===undefined||t===1){r.width=i;r.height=n;r.getContext("2d").putImageData(s,0,0)}else{if(t==="fit"){var v=r.width/i;var f=r.height/n;t=Math.min(v,f);t=t>1?1:t}else if(typeof t!=="number"){throw new Error(e+"scale must be a number or 'fit'")}r.width=Math.round(i*t);r.height=Math.round(n*t);var u=document.createElement("canvas");u.width=i;u.height=n;var h=u.getContext("2d");h.putImageData(s,0,0);r.getContext("2d").drawImage(u,0,0,i,n,0,0,r.width,r.height)}return o||this};t.print=function(){var r=this.imshow();r.print();r.close();return this};t.imagesc=function(r,t){var a=this.min().getDataScalar(),e=this.max().getDataScalar();if(a-e===0){return this["-"](a).imshow(r,t)}return this["-"](a)["./"](e-a).imshow(r,t)};t.imtransform=function(t){t=r.toMatrix(t);var a=this.getSize(0),e=this.getSize(1);var i=o(e,a),n=i.getContext("2d");var s=o(),v=s.getContext("2d");var f=r.toMatrix([0,0,1,e,0,1,e,a,1,0,a,1]).reshape([3,4]);var u=t.mtimes(f).transpose();var h=u.max(0).getData(),l=u.min(0).getData();var g=this.getImageData();n.putImageData(g,0,0);var c=t.getData();s.width=h[0]-l[0];s.height=h[1]-l[1];v.translate(-l[0],-l[1]);v.transform(c[0],c[1],c[3],c[4],c[6],c[7]);v.drawImage(i,0,0);return r.imread(s).convertImage(this.type())};t.imhist=function(t){if(!this.ismatrix()){throw new Error("Matrix.imhist: This function only works on grey-level images.")}t=t||256;var a=this.getData();var e=r.zeros(t,1),i=e.getData();var n;if(this.isinteger()){n=r.intmax(this.type())}else if(this.islogical()){n=1;t=2}else if(this.isfloat()){n=1}else{throw new Error("Matrix.imhist: unknow data type.")}var o,s,v=1/n*t;for(o=0,s=a.length;o<s;o++){i[a[o]*v|0]++}return e};(function(){var a=function(r,t){var a=r.length;var e=new Float32Array(t);var i,n=Math.floor;for(i=0;i<a;++i){var o=n(r[i]*t);o=o>=t?t-1:o;++e[o]}var s=1/a;for(i=1;i<t;++i){e[i]+=e[i-1];e[i-1]*=s}e[i-1]*=s;return e};t.histeq=function(t){var e=this.im2double();var i=e;if(this.getSize(2)>1){i=e.applycform("RGB to HSL").get([],[],2)}i=i.getData();var n=a(i,t);var o=Math.floor;for(var s=0;s<i.length;++s){i[s]=n[o(i[s]*(t-1))]}var v=new r([e.size(0),e.size(1)],i);e.set([],[],2,v);if(this.getSize(2)>1){e.applycform("HSL to RGB")}return e}})();t.rgb2gray=function(){if(this.ndims()!==3||this.getSize(2)<3){throw new Error("Matrix.rgb2gray: Matrix must be an "+"image with RGB components.")}var t=this.getSize();t[2]-=2;var a=new r(t,this.getDataType());var e=this.getData(),i=a.getData();var n=this.getView();var o=n.getEnd(0),s;var v=n.getStep(1),f=n.getEnd(1),u;var h=n.getStep(2);var l,g,c,w;for(l=0,u=f;l!==u;l+=v){g=l;c=l+h;w=l+2*h;for(s=l+o;g<s;g++,c++,w++){i[g]=.3*e[g]+.59*e[c]+.11*e[w]}}if(this.getSize(2)===4){var p=i.subarray(h);var M=e.subarray(3*h);p.set(M)}return a}})(Matrix,Matrix.prototype);(function(){var r=function(r,t,a){this.x=r;this.y=t;this.parent=a};r.prototype.initChildren=function(t,a){var e=this.x,i=this.y;if(i+1<a){this.top=new r(e,i+1,this)}if(i-1>=0){this.bottom=new r(e,i-1,this)}if(e+1<t){this.left=new r(e+1,i,this)}if(e-1>=0){this.right=new r(e-1,i,this)}};r.prototype.remove=function(r){if(this.bottom===r){this.bottom=undefined}else if(this.top===r){this.top=undefined}else if(this.right===r){this.right=undefined}else if(this.left===r){this.left=undefined}return this};r.prototype.getNext=function(){if(this.top){return this.top}if(this.bottom){return this.bottom}if(this.left){return this.left}if(this.right){return this.right}if(this.parent){return this.parent.remove(this).getNext()}return undefined};Matrix.prototype.getConnectedComponent=function(t,a,e){var i=this.getSize(0),n=this.getSize(1),o=this.getSize(2);var s=e*e;var v=new Matrix([i,n],"logical"),f=new Matrix([i,n],"logical");var u=v.getData(),h=this.getData(),l=f.getData();window.CC=v;window.IV=f;var g=a+i*t;var c;if(o===1){if(this.type()==="logical"){}else{var w=h[g];c=function(r){var t=h[r]-w;return t*t<s}}}else if(o===3){var p=h[g],M=h[g+i*n],m=h[g+i*n*2];var y=h,x=h.subarray(i*n),d=h.subarray(i*n*2);c=function(r){var t=y[r]-p,a=x[r]-M,e=d[r]-m;return t*t+a*a+e*e<s}}else{throw new Error("Matrix.getConnectedComponent: This function only support "+"images with depth 1 or 3.")}var B=new r(t,a),b=B;while(b!==undefined){var D=b.x,L=b.y,A=L+i*D;if(l[A]===1){b=b.parent.remove(b).getNext();continue}l[A]=1;if(c(A)){u[A]=1;b.initChildren(n,i)}b=b.getNext()}return v};Matrix.prototype.bwconncomp=function(){}})();(function(r,t){"use strict";var a=function(r,t,a,e){var i=t>>1,n=r>>1;return{xS:new Int32Array([0,0,0,n,n,n,a-n,a-n,a-n]),xE:new Int32Array([n,n,n,a-n,a-n,a-n,a,a,a]),yS:new Int32Array([0,i,e-i,0,i,e-i,0,i,e-i]),yE:new Int32Array([i,e-i,e,i,e-i,e,i,e-i,e]),jS:new Int32Array([0,0,0,-n,-n,-n,-n,-n,-n]),jE:new Int32Array([n+1,n+1,n+1,n+1,n+1,n+1,a,a,a]),iS:new Int32Array([0,-i,-i,0,-i,-i,0,-i,-i]),iE:new Int32Array([i+1,i+1,e,i+1,i+1,e,i+1,i+1,e]),lS:new Int32Array([n,n,n,0,0,0,0,0,0]),lE:new Int32Array([r,r,r,r,r,r,n+a,n+a,n+a]),kS:new Int32Array([i,0,0,i,0,0,i,0,0]),kE:new Int32Array([t,t,i+e,t,t,i+e,t,t,i+e]),jxS:new Int32Array([0,0,0,1,1,1,1,1,1]),jxE:new Int32Array([1,1,1,1,1,1,0,0,0]),iyS:new Int32Array([0,1,1,0,1,1,0,1,1]),iyE:new Int32Array([1,1,0,1,1,0,1,1,0])}};var e=function(r,t,a,e,i,n,o,s,v,f,u){var h=-Infinity;for(var l=o,g=f;l<u;l+=a,g+=e){for(var c=n+l,w=s+g,p=v+l;c<p;c++,w++){if(r[c]>h&&t[w]){h=r[c]}}}return h};var i=function(r,t,a,e,i,n,o,s,v,f,u){var h=Infinity;for(var l=o,g=f;l<u;l+=a,g+=e){for(var c=n+l,w=s+g,p=v+l;c<p;c++,w++){if(r[c]<h&&t[w]){h=r[c]}}}return h};var n=function(r,t,a,e,i,n,o,s,v,f,u){var h=0;for(var l=o,g=f;l<u;l+=a,g+=e){for(var c=n+l,w=s+g,p=v+l;c<p;c++,w++){h+=r[c]*t[w]}}return h};var o=function(t,e,i){e=r.toMatrix(e);var n=t.getSize(0),o=t.getSize(1),s=t.getSize(2),v=t.getData();var f=new r(t.getSize(),t.type()),u=f.getData();var h=e.getSize(0),l=e.getSize(1),g=e.getData();var c=a(l,h,o,n);var w=c.xS,p=c.xE,M=c.yS,m=c.yE,y=c.jS,x=c.jE,d=c.iS,B=c.iE,b=c.lS,D=c.kS,L=c.jxS,A=c.jxE,G=c.iyS,C=c.iyE;var R,Y,S,E,z,I,F,Q,k,Z;var X,H,q,V;for(Y=0,X=v.length;Y<X;Y+=o*n){var T=v.subarray(Y,Y+o*n),j=u.subarray(Y,Y+o*n);for(R=0;R<9;R++){for(S=w[R],H=p[R],z=S*n;S<H;S++,z+=n){var U=(y[R]+(L[R]?S:0))*n,K=(x[R]+(A[R]?S:0))*n;var J=(b[R]-(L[R]?0:S))*h;for(E=M[R],q=m[R],I=E+z;E<q;E++,I++){var P=d[R]+(G[R]?E:0),N=B[R]+(C[R]?E:0);var O=D[R]-(G[R]?0:E);j[I]=i(T,g,n,h,I,P,U,O,N,J,K)}}}}return f};t.imdilate=function(r){return o(this,r,e)};t.imerode=function(r){return o(this,r,i)};t.imopen=function(r){return o(o(this,r,i),r,e)};t.imclose=function(r){return o(o(this,r,e),r,i)};t.imfilter=function(r){return o(this,r,n)};t.median=function(r){var t=r.length*.5|0;var a=function(r,a,e,i,n,o,s,v,f,u,h){var l=[];for(var g=s,c=u;g<h;g+=e,c+=i){for(var w=o+g,p=v+c,M=f+g;w<M;w++,p++){if(a[p]){l.push(r[w])}}}return l.sort()[t]};return o(this,r,a)};t.imbilateral=function(t,a,e){e=e||3;var i=r.fspecial("gaussian",Math.round(e*t/2)*2+1,t);var n=-1/(2*a);var s=function(r,t,a,e,i,o,s,v,f,u,h){var l=0,g=0,c=r[i];for(var w=s,p=u;w<h;w+=a,p+=e){for(var M=o+w,m=v+p,y=f+w;M<y;M++,m++){var x=c-r[M];var d=t[m]*Math.exp(n*x*x);l+=d;g+=r[M]*d}}return g/l};return o(this,i,s)};r.psnr=function(t,a,e){t=r.toMatrix(t);a=r.toMatrix(a);Tools.checkSizeEquals(t.size(),a.size());if(!Tools.isSet(e)){var i=t.type(),n=a.type();var o=t.isfloat()?1:r.intmax(i)-r.intmin(n);var s=a.isfloat()?1:r.intmax(n)-r.intmin(n);e=Math.max(o,s)}else{e=1}var v=a.getData(),f=t.getData();var u,h,l=0;for(u=0,h=f.length;u<h;u++){var g=v[u]-f[u];l+=g*g}return r.toMatrix(10*Math.log10(e*e*h/l))}})(Matrix,Matrix.prototype);(function(){"use strict";function r(t){var a=this.constructor.name+": ";if(t===undefined){this.name="haar"}else{this.name=t.toLowerCase()}if(r.list[this.name]){var e=r.list[this.name];var i=e.normalized!==undefined&&!e.normalized?function(t){return r.filter(t,"norm")}:function(r){return r};this.filterL=i(e.filterL);this.orthogonal=e.orthogonal?true:false;if(e.filterH){this.filterH=i(e.filterH)}if(e.invFilterL){this.invFilterL=i(e.invFilterL)}if(e.invFilterH){this.invFilterH=i(e.invFilterH)}}if(this.filterL===undefined){var n=a+"unknown wavelet '"+t+"'. \n";n+="User-defined wavelets not implemented yet.";throw new Error(n)}var o=function(t,a){return r.filter(t,"conjugate",a?-1:1)};if(!this.filterH&&this.orthogonal){this.filterH=r.filter(o(this.filterL),"mirror")}if(!this.invFilterL){this.invFilterL=o(this.filterH,true)}if(!this.invFilterH){this.invFilterH=o(this.filterL,false)}return this}r.list={haar:{orthogonal:true,normalized:false,filterL:new Float64Array([1,1])},db2:{name:"Daubechies 2",orthogonal:true,normalized:false,filterL:new Float64Array([1+Math.sqrt(3),3+Math.sqrt(3),3-Math.sqrt(3),1-Math.sqrt(3)])},db4:{name:"Daubechies 4",orthogonal:true,filterL:new Float64Array([-.010597401784997278,.032883011666982945,.030841381835986965,-.18703481171888114,-.02798376941698385,.6308807679295904,.7148465705525415,.23037781330885523])},db8:{name:"Daubechies 8",orthogonal:true,filterL:new Float64Array([-.00011747678400228192,.0006754494059985568,-.0003917403729959771,-.00487035299301066,.008746094047015655,.013981027917015516,-.04408825393106472,-.01736930100202211,.128747426620186,.00047248457399797254,-.2840155429624281,-.015829105256023893,.5853546836548691,.6756307362980128,.3128715909144659,.05441584224308161])},sym2:{name:"Symlets 2",orthogonal:true,filterL:new Float64Array([-.12940952255092145,.22414386804185735,.836516303737469,.48296291314469025])},sym4:{name:"Symlets 4",orthogonal:true,filterL:new Float64Array([-.07576571478927333,-.02963552764599851,.49761866763201545,.8037387518059161,.29785779560527736,-.09921954357684722,-.012603967262037833,.0322231006040427])},sym8:{name:"Symlets 8",orthogonal:true,filterL:[-.0033824159510061256,-.0005421323317911481,.03169508781149298,.007607487324917605,-.1432942383508097,-.061273359067658524,.4813596512583722,.7771857517005235,.3644418948353314,-.05194583810770904,-.027219029917056003,.049137179673607506,.003808752013890615,-.01495225833704823,-.0003029205147213668,.0018899503327594609]},coif1:{name:"Coiflets 1",orthogonal:true,filterL:new Float64Array([-.01565572813546454,-.0727326195128539,.38486484686420286,.8525720202122554,.3378976624578092,-.0727326195128539])},coif2:{name:"Coiflets 2",orthogonal:true,filterL:new Float64Array([-.0007205494453645122,-.0018232088707029932,.0056114348193944995,.023680171946334084,-.0594344186464569,-.0764885990783064,.41700518442169254,.8127236354455423,.3861100668211622,-.06737255472196302,-.04146493678175915,.016387336463522112])},coif4:{name:"Coiflets 4",orthogonal:true,filterL:new Float64Array([-17849850030882614e-22,-32596802368833675e-22,31229875865345646e-21,6233903446100713e-20,-.00025997455248771324,-.0005890207562443383,.0012665619292989445,.003751436157278457,-.00565828668661072,-.015211731527946259,.025082261844864097,.03933442712333749,-.09622044203398798,-.06662747426342504,.4343860564914685,.782238930920499,.41530840703043026,-.05607731331675481,-.08126669968087875,.026682300156053072,.016068943964776348,-.0073461663276420935,-.0016294920126017326,.0008923136685823146])},bi13:{name:"Biorthogonal 1-3",orthogonal:false,filterL:new Float64Array([-.08838834764831845,.08838834764831845,.7071067811865476,.7071067811865476,.08838834764831845,-.08838834764831845]),filterH:new Float64Array([-.7071067811865476,.7071067811865476])},bi31:{name:"Biorthogonal 3-1",orthogonal:false,filterL:new Float64Array([-.3535533905932738,1.0606601717798214,1.0606601717798214,-.3535533905932738]),filterH:new Float64Array([-.1767766952966369,.5303300858899107,-.5303300858899107,.1767766952966369])},bi68:{name:"Biorthogonal 6-8",orthogonal:false,filterL:new Float64Array([0,.0019088317364812906,-.0019142861290887667,-.016990639867602342,.01193456527972926,.04973290349094079,-.07726317316720414,-.09405920349573646,.4207962846098268,.8259229974584023,.4207962846098268,-.09405920349573646,-.07726317316720414,.04973290349094079,.01193456527972926,-.016990639867602342,-.0019142861290887667,.0019088317364812906]),filterH:new Float64Array([0,.014426282505624435,-.014467504896790148,-.07872200106262882,.04036797903033992,.41784910915027457,-.7589077294536541,.41784910915027457,.04036797903033992,-.07872200106262882,-.014467504896790148,.014426282505624435,0,0])},bi97:{name:"Biorthogonal 9-7",orthogonal:false,filterL:new Float64Array([0,.02674875741080976,-.01686411844287495,-.07822326652898785,.2668641184428723,.6029490182363579,.2668641184428723,-.07822326652898785,-.01686411844287495,.02674875741080976]),filterH:new Float64Array([0,-.09127176311424948,.05754352622849957,.591271763114247,-1.115087052456994,.591271763114247,.05754352622849957,-.09127176311424948,0,0])}};r.filter=function(r,t,a){var e="Wavelet.filter: ";if(a===undefined||a===0){a=1}if(typeof a!=="number"){throw new Error(e+"argument 'factor' must be a number")}if(typeof t!=="string"){throw new Error(e+"argument 'action' must be a string")}t=t.toLowerCase().substr(0,3);var i;var n=r.length;var o=[];var s=1,v=1;if(t==="mir"){for(i=0;i<n;i++){o[i]=a*r[n-1-i]}return o}if(t==="nor"){var f=0;for(i=0;i<n;i++){f+=r[i]*r[i]}a=!f?1:1/Math.sqrt(f)}else if(t==="con"){v=-1}else if(t!=="res"){throw new Error(e+"unknown action")}for(i=0;i<n;i++,s*=v){o[i]=a*s*r[i]}return o};Matrix.wfilters=function(t,a){var e=new r(t);var i=Matrix.toMatrix(e.filterL),n=Matrix.toMatrix(e.filterH),o=Matrix.toMatrix(e.invFilterL),s=Matrix.toMatrix(e.invFilterH);switch(a){case"d":return[i,n];case"r":return[o,s];case"l":return[i,o];case"h":return[n,s];case undefined:return[i,n,o,s];default:throw new Error("Matrix.wfilters: wrong type argument.")}};var t=function(r,t,a,e,i,n,o,s,v,f,u,h,l,g,c,w,p){var M,m,y,x,d,B,b;for(M=r,m=t+a;M<e;M+=i,m+=n){for(y=0,x=M+o,d=0,B=0;y<s;y++,x-=v){b=x;while(b<r){b+=f}while(b>=e){b-=f}if(u&&b===e-v){b-=v}d+=h[y]*g[b];B+=l[y]*c[b]}w[m]+=d;p[m]+=B}};var a=function(r,a,e,i,n,o,s,v,f,u){var h=i.length;o=(o==="cl"?Math.floor:Math.ceil)((h-1)/2);var l=e.getSize(0)%2?true:false;var g=e.getFirst(0),c=e.getStep(0);var w=e.getEnd(0)+(l?c:0);var p=u.getFirst(0),M=u.getStep(0);var m=r.getData(),y=a.getData(),x=v.getData(),d=f.getData();var B=o*c;var b=c;c*=s;var D=e.getIterator(1),L=u.getIterator(1);var A,G,C=D.iterator,R=D.begin,Y=D.end();var S,E,z=L.iterator,I=L.begin;var F,Q,k,Z,X;for(G=R(),E=I();G!==Y;G=C(),E=z()){var H=g+G,q=w+G;t(H,E,p,q,c,M,B,h,b,w,l,i,n,m,y,x,d)}};var e=Matrix.zeros;var i=function(t,i,n){var o=new r(i),s=o.filterL,v=o.filterH;var f=t.getSize();f[n]=Math.ceil(f[n]/2);var u=e(f),h=e(f);var l=u.getView().swapDimensions(0,n);var g=t.getView().swapDimensions(0,n);a(t,t,g,s,v,"cr",2,u,h,l);return[u,h]};var n=function(t,i,n){var o=new r(i);var s=o.invFilterL,v=o.invFilterH;var f=t[0].getSize();f[n]=f[n]*2;var u=e(f),h=e(f);var l=u.getView().selectDimension(n,[0,2,-1]);t[0].extractViewTo(l,u);t[1].extractViewTo(l,h);l.restore().swapDimensions(0,n);var g=e(f);var c=g.getView().swapDimensions(0,n);a(u,h,l,s,v,"cl",1,g,g,c);return g};var o=function(t,i){var n=new r(i);var o=n.filterL,s=n.filterH;var v=t.getSize(0),f=t.getSize(1),u=t.getSize(2);var h=Math.ceil(f/2),l=Math.ceil(v/2);var g=e(l,f,u),c=e(l,f,u);var w=g.getView();var p=t.getView();a(t,t,p,o,s,"cr",2,g,c,w);var M=e(l,h,u),m=e(l,h,u),y=e(l,h,u),x=e(l,h,u);var d=M.getView().swapDimensions(0,1);w.swapDimensions(0,1);a(g,g,w,o,s,"cr",2,M,y,d);a(c,c,w,o,s,"cr",2,m,x,d);return[M,y,m,x]};var s=function(t,i){var n=new r(i);var o=n.invFilterL,s=n.invFilterH;var v=t[0].getSize(0),f=t[0].getSize(1),u=t[0].getSize(2);var h=e(2*v,f,u),l=e(2*v,f,u);var g=e(2*v,2*f,u),c=e(2*v,2*f,u);var w=e(2*v,2*f,u);var p=h.getView(),M=g.getView();var m=w.getView().swapDimensions(0,1);M.select([],[0,2,-1]);h.set([0,2,-1],t[0]);l.set([0,2,-1],t[2]);a(h,l,p,o,s,"cl",1,g,g,M);h.set([0,2,-1],[],t[1]);l.set([0,2,-1],[],t[3]);a(h,l,p,o,s,"cl",1,c,c,M);M.restore().swapDimensions(0,1);a(g,c,M,o,s,"cl",1,w,w,m);return w};Matrix.dwt=function(r,t,a){a=a||0;return i(r,t,a)};Matrix.idwt=function(r,t,a){a=a||0;return n(r,t,a)};Matrix.dwt2=function(r,t){return o(r,t)};Matrix.idwt2=function(r,t){return s(r,t)};Matrix.wavedec=function(r,t,a,n){n=n||0;var o=new Uint16Array(t+2),s=0;o[t+1]=r.getSize(n);var v;for(v=t;v>=1;v--){o[v]=Math.ceil(o[v+1]/2);s+=o[v]}o[0]=o[1];s+=o[0];var f=[0,o[0]];for(v=2;v<t+2;v++){f[v]=o[v-1]+f[v-1]}var u=r.getSize();u[n]=s;var h=e(u),l=h.getView();var g=r,c,w;for(v=t;v>=1;v--){var p=i(g,a,n);l.selectDimension(n,[f[v],f[v+1]-1]);p[1].extractViewTo(l,h);l.restore();g=p[0]}l.selectDimension(n,[f[0],f[1]-1]);p[0].extractViewTo(l,h);return[h,new Matrix([o.length],o)]};Matrix.waverec=function(r,t,a){a=a||0;var e=r[1].getData();var i=[0,e[0]];var o,s=e.length-2;for(o=2;o<s+2;o++){i[o]=e[o-1]+i[o-1]}var v=r[0];var f=v.getView().selectDimension(a,[i[0],i[1]-1]);var u=v.extractViewFrom(f);for(o=1;o<i.length-1;o++){var h=v.getView().selectDimension(a,[i[o],i[o+1]-1]);var l=v.extractViewFrom(h);if(u.size(a)===l.size(a)+1){f=u.getView().selectDimension(a,[0,-2]);u=u.extractViewFrom(f)}u=n([u,l],t,a)}if(u.size(a)===e[e.length-1]+1){f=u.getView().selectDimension(a,[0,-2]);u=u.extractViewFrom(f)}return u};Matrix.wavedec2=function(r,t,a){var e=new Array(t+2);var i=new Array(t+2);var n=new Array(t+2);i[t+1]=r.getSize(0);e[t+1]=r.getSize(1);n[t+1]=r.getSize(2);var s;for(s=t;s>=1;s--){i[s]=Math.ceil(i[s+1]/2);e[s]=Math.ceil(e[s+1]/2);n[s]=n[s+1]}i[0]=i[1];e[0]=e[1];n[0]=n[1];var v=e[0]*i[0]*n[0];var f=[0,v];for(s=2;s<t+2;s++){var u=i[s-1]*e[s-1]*n[s-1];for(var h=0;h<3;h++){v+=u;f.push(v)}}var l=new Float64Array(v);var g=r,c,w;for(s=t;s>=1;s--){var p=o(g,a);var r=1+3*(s-1);l.subarray(f[r],f[r+1]).set(p[1].getData());l.subarray(f[r+1],f[r+2]).set(p[2].getData());l.subarray(f[r+2],f[r+3]).set(p[3].getData());g=p[0]}l.subarray(f[0],f[1]).set(p[0].getData());return[new Matrix([v],l),Matrix.toMatrix([i,e,n])]};Matrix.waverec2=function(r,t){var a=r[1].get([],0).getData();var e=r[1].get([],1).getData();var i=r[1].get([],2).getData();var n=e[0]*a[0]*i[0];var o=[0,n];var v,f=a.length-2;for(v=2;v<f+2;v++){var u=a[v-1]*e[v-1]*i[v-1];for(var h=0;h<3;h++){n+=u;o.push(n)}}var l=r[0].getData();var g=[a[0],e[0],i[0]];var c,w,p,M;c=new Matrix(g,l.subarray(o[0],o[1]));for(v=1;v<f+1;v++){if(c.getSize(0)!==a[v]||c.getSize(1)!==e[v]){c=c.get([0,a[v]-1],[0,e[v]-1],[])}var m=1+3*(v-1);g=[a[v],e[v],i[v]];w=new Matrix(g,l.subarray(o[m],o[m+1]));p=new Matrix(g,l.subarray(o[m+1],o[m+2]));M=new Matrix(g,l.subarray(o[m+2],o[m+3]));c=s([c,w,p,M],t)}if(c.getSize(0)!==a[v]||c.getSize(1)!==e[v]){c=c.get([0,a[v]-1],[0,e[v]-1],[])}return c};Matrix.upwlev2=function(r,t){var a=r[1].get([],0).getData();var e=r[1].get([],1).getData();var i=r[1].get([],2).getData();if(e.length===2){return[new Matrix,new Matrix,Matrix.reshape(r[0],r[1].get(0,[]).getData())]}var n=e[0]*a[0]*i[0];var o=[0,n];var v,f=a.length-2;for(v=2;v<f+2;v++){var u=a[v-1]*e[v-1]*i[v-1];for(var h=0;h<3;h++){n+=u;o.push(n)}}var l=r[0].getData();var g=[a[0],e[0],i[0]];var c,w,p,M;v=1;var m=new Matrix(g,l.subarray(o[0],o[1]));var y=1+3*(v-1);g=[a[v],e[v],i[v]];w=new Matrix(g,l.subarray(o[y],o[y+1]));p=new Matrix(g,l.subarray(o[y+1],o[y+2]));M=new Matrix(g,l.subarray(o[y+2],o[y+3]));c=s([m,w,p,M],t);if(c.getSize(0)!==a[v]||c.getSize(1)!==e[v]){c=c.get([0,a[v+1]-1],[0,e[v+1]-1],[])}var x=r[1].get([1,-1]);x.set(0,[],x.get(1,[]));var d=new Float64Array(c.numel()+o[o.length-1]-o[y+3]);d.subarray(0,c.numel()).set(c.getData());d.subarray(c.numel(),c.numel()+o[o.length-1]-o[y+3]).set(l.subarray(o[y+3]));return[new Matrix([d.length],d),x,m]};Matrix.appcoef2=function(r,t,a){var e=r[1].size(0)-2;while(e>a+1){r=Matrix.upwlev2(r,t);e=r[1].size(0)-2}var i=r[1].get([1,-1]).prod(1).getData();var n=i[0];var o=r[0].getData();var s=r[1].get(0).getData();return new Matrix(s,o.subarray(0,i[0]))};Matrix.detcoef2=function(r,t,a){var e=t[1].get([1,-1]).prod(1).getData();var i=t[1].size(0)-2;var n=e[0],o=[0,n];var s;for(s=0;s<i;s++){for(var v=0;v<3;v++){n+=e[s];o.push(n)}}var f=t[0].getData();var u=i-(a+1);var h=t[1].get([u+1],[]).getData();var l=1+u*3;if(r==="h"){var g=o[l],c=o[l+1]}else if(r==="v"){var g=o[l+1],c=o[l+2]}else if(r==="d"){var g=o[l+2],c=o[l+3]}else if(r==="all"){return[Matrix.detcoef2("h",t,a),Matrix.detcoef2("v",t,a),Matrix.detcoef2("d",t,a)]}return new Matrix(h,f.subarray(g,c))};Matrix.dwtmaxlev=function(t,a){t=Matrix.toMatrix(t).min().getDataScalar();var e=new r(a);var i=e.filterL.length,n=e.filterH.length,o=e.invFilterL.length,s=e.invFilterH.length;var v=Math.max(i,n,o,s);var f=Math.floor(Math.log(t/(v-1))/Math.log(2));return f};Matrix.wrcoef2=function(r,t,a,e){}})();(function(r,t){"use strict";var a=Tools.arrayFromBase64("AgADAAUABwALAA0AEQATABcAHQAfACUAKQArAC8ANQA7AD0AQwBHAEkATwBTAFkAYQBlAGcAawBt        AHEAfwCDAIkAiwCVAJcAnQCjAKcArQCzALUAvwDBAMUAxwDTAN8A4wDlAOkA7wDxAPsAAQEHAQ0B        DwEVARkBGwElATMBNwE5AT0BSwFRAVsBXQFhAWcBbwF1AXsBfwGFAY0BkQGZAaMBpQGvAbEBtwG7        AcEByQHNAc8B0wHfAecB6wHzAfcB/QEJAgsCHQIjAi0CMwI5AjsCQQJLAlECVwJZAl8CZQJpAmsC        dwKBAoMChwKNApMClQKhAqUCqwKzAr0CxQLPAtcC3QLjAucC7wL1AvkCAQMFAxMDHQMpAysDNQM3        AzsDPQNHA1UDWQNbA18DbQNxA3MDdwOLA48DlwOhA6kDrQOzA7kDxwPLA9ED1wPfA+UD8QP1A/sD        /QMHBAkEDwQZBBsEJQQnBC0EPwRDBEUESQRPBFUEXQRjBGkEfwSBBIsEkwSdBKMEqQSxBL0EwQTH        BM0EzwTVBOEE6wT9BP8EAwUJBQsFEQUVBRcFGwUnBSkFLwVRBVcFXQVlBXcFgQWPBZMFlQWZBZ8F        pwWrBa0FswW/BckFywXPBdEF1QXbBecF8wX7BQcGDQYRBhcGHwYjBisGLwY9BkEGRwZJBk0GUwZV        BlsGZQZ5Bn8GgwaFBp0GoQajBq0GuQa7BsUGzQbTBtkG3wbxBvcG+wb9BgkHEwcfBycHNwdFB0sH        TwdRB1UHVwdhB20Hcwd5B4sHjQedB58HtQe7B8MHyQfNB88H0wfbB+EH6wftB/cHBQgPCBUIIQgj        CCcIKQgzCD8IQQhRCFMIWQhdCF8IaQhxCIMImwifCKUIrQi9CL8IwwjLCNsI3QjhCOkI7wj1CPkI        BQkHCR0JIwklCSsJLwk1CUMJSQlNCU8JVQlZCV8JawlxCXcJhQmJCY8JmwmjCakJrQnHCdkJ4wnr        Ce8J9Qn3Cf0JEwofCiEKMQo5Cj0KSQpXCmEKYwpnCm8KdQp7Cn8KgQqFCosKkwqXCpkKnwqpCqsK        tQq9CsEKzwrZCuUK5wrtCvEK8woDCxELFQsbCyMLKQstCz8LRwtRC1cLXQtlC28LewuJC40LkwuZ        C5sLtwu5C8MLywvPC90L4QvpC/UL+wsHDAsMEQwlDC8MMQxBDFsMXwxhDG0Mcwx3DIMMiQyRDJUM        nQyzDLUMuQw=",Uint16Array);

var e=a.length;var i=function(r){if(r===1){return 0}var t=[],i,n,o;for(i=n=0;n<e;n++){if(r%a[n]===0){o=a[n];do{t[i]=o;i++;r=r/o}while(r%o===0)}}if(r!==1){t[i]=r;i++}return t};var n=function(r,t,a){var e=r[t];r[t]=r[a];r[a]=e};var o=function(r,t,a,e){var i=r.length/2,n,o;if(e===1){for(n=0,o=0;n<i;n++){t[n]=r[o++];a[n]=-r[o++]}}else{var s=1/i;for(n=0,o=0;n<i;n++){t[n]=r[o++]*s;a[n]=-r[o++]*s}}};var s=function(r,t){var a=r.length,e,i;var n=new Float64Array(2*a);if(t){for(e=0,i=0;e<a;e++){n[i++]=r[e];n[i++]=-t[e]}}else{for(e=0,i=0;e<a;e++,i++){n[i++]=r[e]}}return n};var v=function(r,t,a){var e,i,o,v,f;var u,h,l,g,c,w;var p,M;var m=r.length,y=s(r,t);var x=m<<1;for(f=1,o=1;f<x;f+=2){if(o>f){n(y,o-1,f-1);n(y,o,f)}e=x>>1;while(e>=2&&o>e){o=o-e;e>>=1}o=o+e}var d=2;while(x>d){v=2*d;w=2*Math.PI/(a*d);u=Math.sin(.5*w);l=-2*u*u;g=Math.sin(w);h=1;c=0;for(e=1;e<d;e+=2){for(f=e-1;f<=x-1;f+=v){o=f+d;p=h*y[o]-c*y[o+1];M=h*y[o+1]+c*y[o];y[o]=y[f]-p;y[o+1]=y[f+1]-M;y[f]+=p;y[f+1]+=M}h=(u=h)*l-c*g+h;c=c*l+u*g+c}d=v}return y};var f=function(r,t,a,e){var i=r.length,n;var o=new Float64Array(i),v=new Float64Array(i);var f=2*Math.PI/i;for(n=0;n<i;n++){o[n]=Math.cos(n*f);v[n]=a*Math.sin(n*f)}var u=s(r,t),h=new Float64Array(2*i);var l,g,c,w,p,M;var m=1,y,x=e.length;for(y=0;y<x;y++){w=e[y];p=i/m/w;M=m*w;for(g=0;g<2*i;g++){h[g]=0}for(l=0;l<w;l++){for(c=0;c<M;c++){var d=c*l%M*p;var B=o[d],b=v[d];var D=2*p*c,L=2*p*(l+c%m*w);for(n=0;n<p;n++,D+=2,L+=2){h[D]+=u[L]*B-u[L+1]*b;h[D+1]+=u[L]*b+u[L+1]*B}}}var A=u;u=h;h=A;m*=w}return u};var u=function(r,t,a,e,n){var s=r.length,u=i(s),h=u.length;var l=!n?1:-1,g;if(s>1&&u[h-1]!==2){g=f(r,t,l,u)}else{g=v(r,t,l)}return o(g,a,e,l)};var h=function(t,a){if(t.isreal()){t.toComplex()}var e=new r(t.getSize(),Float64Array,true);var i=t.getRealData(),n=t.getImagData();var o=e.getRealData(),s=e.getImagData();var v,f,h=t.getSize(0),l=t.numel()/h;for(v=0,f=0;v<l;v++,f+=h){var g=i.subarray(f,h+f),c=n.subarray(f,h+f);var w=o.subarray(f,h+f),p=s.subarray(f,h+f);u(g,c,w,p,a)}return e};t.fft=function(){return h(this,false)};r.fft=function(t){return h(r.toMatrix(t),false)};t.fft2=function(){var r=h(this,false);r=h(r.transpose(),false);return r.transpose()};r.fft2=function(t){var a=h(r.toMatrix(t),false);a=h(a.transpose(),false);return a.transpose()};r.prototype.fftshift=function(t,a){var e=r.zeros(this.size());if(this.ndims()===2||this.ndims()===3){var i=this.getSize(0),n=this.getSize(1);var o=[0,Math.floor(i/2)],s=[Math.ceil(i/2),i-1];var v=[0,Math.floor(n/2)],f=[Math.ceil(n/2),n-1];e.set(o,v,this.get(o,v).get([-1,0],[-1,0]).conj());e.set(o,f,this.get(o,f).get([-1,0],[-1,0]).conj());e.set(s,v,this.get(s,v).get([-1,0],[-1,0]).conj());e.set(s,f,this.get(s,f).get([-1,0],[-1,0]).conj())}return e};t.ifft=function(){return h(this,true)};r.ifft=function(t){return h(r.toMatrix(t),true)};t.ifft2=function(){return this.fft().transpose().fft().transpose()};r.ifft2=function(t){return r.toMatrix(t).ifft().transpose().ifft().transpose()}})(Matrix,Matrix.prototype);(function(r){"use strict";var t={matrix:function(r,t,a,e,i){e=e||1;i=i||3;a=(a||1)*i;var n=t[0],o=t[3],s=t[6];var v=t[1],f=t[4],u=t[7];var h=t[2],l=t[5],g=t[8];for(var c=0,w=e,p=2*e;c<a;c+=i,w+=i,p+=i){var M=r[c],m=r[w],y=r[p];r[c]=n*M+o*m+s*y;r[w]=v*M+f*m+u*y;r[p]=h*M+l*m+g*y}return r},"RGB to RGB":function(r,t,a,e){a=a||1;e=e||3;t=(t||1)*e;for(var i=0,n=a,o=2*a;i<t;i+=e,n+=e,o+=e){var s=r[i],v=r[n],f=r[o];r[i]=s;r[n]=v;r[o]=f}return r},applyFunctionRGB:function(r,t,a,e,i){e=e||1;i=i||3;a=(a||1)*i;for(var n=0,o=e,s=2*e;n<a;n+=i,o+=i,s+=i){var v=t(r[n],r[o],r[s]);r[n]=v[0];r[o]=v[1];r[s]=v[2]}return r},applyFunctionColor:function(r,t,a,e,i){e=e||1;i=i||3;a=(a||1)*i;for(var n=0,o=e,s=2*e;n<a;n+=i,o+=i,s+=i){var v=r[n],f=r[o],u=r[s];var h=t([v,f,u]);r[n]=h[0];r[o]=h[1];r[s]=h[2]}return r},"RGB to GRAY":function(r,t,a,e){a=a||1;e=e||3;t=(t||1)*e;for(var i=0,n=a,o=2*a;i<t;i+=e,n+=e,o+=e){var s=r[i],v=r[n],f=r[o];var u=.2989*s+.587*v+.114*f;r[i]=u;r[n]=u;r[o]=u}return r},"RGB to HSV":function(r,t,a,e){a=a||1;e=e||3;t=(t||1)*e;var i=1/6;for(var n=0,o=a,s=2*a;n<t;n+=e,o+=e,s+=e){var v=r[n],f=r[o],u=r[s];var h=(v>f?v:f)>u?v>f?v:f:u;var l=h-((v<f?v:f)<u?v<f?v:f:u),g=0;if(l!==0){if(h===v){g=(f-u)/l*i}else if(h===f){g=(2+(u-v)/l)*i}else if(h===u){g=(4+(v-f)/l)*i}if(g<0){g+=1}if(h!==0){l/=h}}r[n]=g;r[o]=l;r[s]=h}return r},"HSV to RGB":function(r,t,a,e){a=a||1;e=e||3;t=(t||1)*e;for(var i=0,n=a,o=2*a;i<t;i+=e,n+=e,o+=e){var s=r[i],v=r[n],f=r[o];var u=(s*6|0)%6;var h=s*6-u;var l=f*(1-v);var g=f*(1-h*v);var c=f*(1-(1-h)*v);switch(u){case 0:r[i]=f;r[n]=c;r[o]=l;break;case 1:r[i]=g;r[n]=f;r[o]=l;break;case 2:r[i]=l;r[n]=f;r[o]=c;break;case 3:r[i]=l;r[n]=g;r[o]=f;break;case 4:r[i]=c;r[n]=l;r[o]=f;break;case 5:r[i]=f;r[n]=l;r[o]=g;break}}return r},"RGB to HSL":function(r,t,a,e){a=a||1;e=e||3;t=(t||1)*e;var i=Math.sqrt(3),n=1/(2*Math.PI),o=1/3;for(var s=0,v=a,f=2*a;s<t;s+=e,v+=e,f+=e){var u=r[s],h=r[v],l=r[f];var g=Math.atan2(i*(h-l),2*u-h-l)*n;r[s]=g<0?g+1:g;var c=(u>h?u:h)>l?u>h?u:h:l;var w=(u<h?u:h)<l?u<h?u:h:l;r[v]=c-w;r[f]=(u+h+l)*o}return r},"HSL to RGB":function(r,t,a,e){a=a||1;e=e||3;t=(t||1)*e;var i=Math.PI,n=i/3,o=i*2,s=2*i/3;var v=1/3;var f=Math.sqrt(3)/2,u=1/Math.sqrt(3);for(var h=0,l=a,g=2*a;h<t;h+=e,l+=e,g+=e){var c=r[h],w=r[l],p=r[g];var M=c*o;var m=M;while(m>n){m-=n}var y=f*w/Math.sin(s-m);var x=y*Math.cos(M)*v,d=y*Math.sin(M)*u;r[h]=p+x*2;r[l]=p-x+d;r[g]=p-x-d}return r},"RGB to HSI":function(r,t,a,e){a=a||1;e=e||3;t=(t||1)*e;var i=1/Math.sqrt(3),n=1/Math.sqrt(2),o=1/Math.sqrt(6);for(var s=0,v=a,f=2*a;s<t;s+=e,v+=e,f+=e){var u=r[s],h=r[v],l=r[f];var g=(h-l)*n;var c=(2*u-h-l)*o;r[s]=Math.atan2(g,c);r[v]=Math.sqrt(g*g+c*c);r[f]=(u+h+l)*i}return r},"HSI to RGB":function(r,t,a,e){a=a||1;e=e||3;t=(t||1)*e;var i=Math.sqrt(3),n=Math.sqrt(2),o=Math.sqrt(6);var s=1/6,v=1/3;for(var f=0,u=a,h=2*a;f<t;f+=e,u+=e,h+=e){var l=r[f],g=r[u],c=r[h];var w=g*Math.sin(l);var p=g*Math.cos(l);var M=c*i,m=w*n,y=p*o;var x=(M+y)*v;var d=(2*M+3*m-y)*s;var B=(2*M-3*m-y)*s;r[f]=x;r[u]=d;r[h]=B}return r},"LinearRGB to sRGB":function(r,t,a,e){a=a||1;e=e||3;t=(t||1)*e;var i=.055,n=1/2.4;for(var o=0,s=a,v=2*a;o<t;o+=e,s+=e,v+=e){var f=r[o],u=r[s],h=r[v];r[o]=f>.0031308?1.055*Math.pow(f,n)-i:f*12.92;r[s]=u>.0031308?1.055*Math.pow(u,n)-i:u*12.92;r[v]=h>.0031308?1.055*Math.pow(h,n)-i:h*12.92}return r},"sRGB to LinearRGB":function(r,t,a,e){a=a||1;e=e||3;t=(t||1)*e;var i=1/12.92,n=.055,o=1/1.055;for(var s=0,v=a,f=2*a;s<t;s+=e,v+=e,f+=e){var u=r[s],h=r[v],l=r[f];r[s]=u>.04045?Math.pow((u+n)*o,2.4):u*i;r[v]=h>.04045?Math.pow((h+n)*o,2.4):h*i;r[f]=l>.04045?Math.pow((l+n)*o,2.4):l*i}return r},"RGB to CMY":function(r,t,a,e){a=a||1;e=e||3;t=(t||1)*e;for(var i=0,n=a,o=2*a;i<t;i+=e,n+=e,o+=e){r[i]=1-r[i];r[n]=1-r[n];r[o]=1-r[o]}return r},"CMY to RGB":function(r,t,a,e){a=a||1;e=e||3;t=(t||1)*e;for(var i=0,n=a,o=2*a;i<t;i+=e,n+=e,o+=e){r[i]=1-r[i];r[n]=1-r[n];r[o]=1-r[o]}return r},"RGB to Opponent":function(r,t,a,e){a=a||1;e=e||3;t=(t||1)*e;var i=1/Math.sqrt(3),n=1/Math.sqrt(2),o=1/Math.sqrt(6);for(var s=0,v=a,f=2*a;s<t;s+=e,v+=e,f+=e){var u=r[s],h=r[v],l=r[f];r[s]=(u+h+l)*i;r[v]=(u-h)*n;r[f]=(u+h-2*l)*o}return r},"Opponent to RGB":function(r,t,a,e){a=a||1;e=e||3;t=(t||1)*e;var i=Math.sqrt(3),n=Math.sqrt(2),o=Math.sqrt(6);var s=1/6,v=1/3;for(var f=0,u=a,h=2*a;f<t;f+=e,u+=e,h+=e){var l=r[f],g=r[u],c=r[h];var w=l*i,p=g*n,M=c*o;r[f]=(2*w+3*p+M)*s;r[u]=(2*w-3*p+M)*s;r[h]=(w-M)*v}return r},"RGB to Ohta":function(r,t,a,e){a=a||1;e=e||3;t=(t||1)*e;var i=1/Math.sqrt(3),n=1/Math.sqrt(2),o=1/Math.sqrt(6);for(var s=0,v=a,f=2*a;s<t;s+=e,v+=e,f+=e){var u=r[s],h=r[v],l=r[f];r[s]=(u+h+l)*i;r[v]=(u-l)*n;r[f]=(-u+2*h-l)*o}return r},"Ohta to RGB":function(r,t,a,e){a=a||1;e=e||3;t=(t||1)*e;var i=Math.sqrt(3),n=Math.sqrt(2),o=Math.sqrt(6);var s=1/6,v=1/3;for(var f=0,u=a,h=2*a;f<t;f+=e,u+=e,h+=e){var l=r[f],g=r[u],c=r[h];var w=l*i,p=g*n,M=c*o;r[u]=(w+M)*v;r[f]=(2*w+3*p-M)*s;r[h]=(2*w-3*p-M)*s}return r},"LinearRGB to rgY":function(r,t,a,e){a=a||1;e=e||3;t=(t||1)*e;for(var i=0,n=a,o=2*a;i<t;i+=e,n+=e,o+=e){var s=r[i],v=r[n],f=r[o];var u=s+v+f;if(u>0){var h=1/u;r[i]=s*h;r[n]=v*h;r[o]=u}else{r[i]=1/3;r[n]=1/3;r[o]=0}}return r},"rgY to LinearRGB":function(r,t,a,e){a=a||1;e=e||3;t=(t||1)*e;for(var i=0,n=a,o=2*a;i<t;i+=e,n+=e,o+=e){var s=r[i],v=r[n],f=r[o];r[i]=s*f;r[n]=v*f;r[o]=(1-s-v)*f}return r},getXYZTransform:function(r,a,e){a=a||[.31271,.32902,1];e=e||[.64,.33,1,.3,.6,1,.15,.06,1];var i=t["xyY to XYZ"](a);i=Matrix.toMatrix(i);var e=t["xyY to XYZ"](e,3);e=new Matrix([3,3],e);var n=Matrix.diag(e.inv().mtimes(i));var o=e.mtimes(n);return r?o.inv():o},"LinearRGB to XYZ":function(r,a,e,i,n,o){var s=t.getXYZTransform(false,n,o).getData();t.matrix(r,s,a,e,i);return r},"XYZ to LinearRGB":function(r,a,e,i,n,o){var s=t.getXYZTransform(true,n,o).getData();t.matrix(r,s,a,e,i);return r},"XYZ to Lab":function(r,t,a,e,i){a=a||1;e=e||3;t=(t||1)*e;i=i||[.31271,.32902,1];var n=i[0],o=i[1],s=i[2];var v=n*s/o;var f=(1-n-o)*s/o;var u=1/v,h=1/s,l=1/f;var g=1/3,c=16/116;for(var w=0,p=a,M=2*a;w<t;w+=e,p+=e,M+=e){var m=r[w],y=r[p],x=r[M];var d=m*u;if(d>.008856){d=Math.pow(d,g)}else{d=7.787*d+c}var B=y*h;if(B>.008856){B=Math.pow(B,g)}else{B=7.787*B+c}var b=x*l;if(b>.008856){b=Math.pow(b,g)}else{b=7.787*b+c}r[w]=116*B-16;r[p]=500*(d-B);r[M]=200*(B-b)}return r},"Lab to XYZ":function(r,t,a,e,i){a=a||1;e=e||3;t=(t||1)*e;i=i||[.31271,.32902,1];var n=i[0],o=i[1],s=i[2];var v=n*s/o;var f=(1-n-o)*s/o;var u=Math.pow(.008856,1/3),h=1/7.787;var l=1/116,g=1/500,c=1/200;var w=16/116;for(var p=0,M=a,m=2*a;p<t;p+=e,M+=e,m+=e){var y=r[p],x=r[M],d=r[m];var B=(y+16)*l;var b=B+x*g;var D=B-d*c;if(B>u){B=Math.pow(B,3)}else{B=(B-w)*h}if(b>u){b=Math.pow(b,3)}else{b=(b-w)*h}if(D>u){D=Math.pow(D,3)}else{D=(D-w)*h}r[p]=b*v;r[M]=B*s;r[m]=D*f}return r},"XYZ to Luv":function(r,t,a,e,i){a=a||1;e=e||3;t=(t||1)*e;i=i||[.31271,.32902,1];var n=i[0],o=i[1],s=i[2];var v=n*s/o;var f=(1-n-o)*s/o;var u=1/s;var h=4*v/(v+15*s+3*f);var l=9*s/(v+15*s+3*f);var g=1/3;for(var c=0,w=a,p=2*a;c<t;c+=e,w+=e,p+=e){var M=r[c],m=r[w],y=r[p];var x=m*u;if(x>.008856){x=116*Math.pow(x,g)-16}else{x*=903.3}var d=1/(M+15*m+3*y);d=isFinite(d)?d:0;var B=4*d*M;var b=9*d*m;d=13*x;r[c]=x;r[w]=d*(B-h);r[p]=d*(b-l)}return r},"Luv to XYZ":function(r,t,a,e,i){a=a||1;e=e||3;t=(t||1)*e;i=i||[.31271,.32902,1];var n=i[0],o=i[1],s=i[2];var v=n*s/o;var f=(1-n-o)*s/o;var u=4*v/(v+15*s+3*f);var h=9*s/(v+15*s+3*f);var l=Math.pow(.008856,1/3),g=1/7.787;var c=1/116,w=16/116;for(var p=0,M=a,m=2*a;p<t;p+=e,M+=e,m+=e){var y=r[p],x=r[M],d=r[m];var B=(y+16)*c;if(B>l){B=Math.pow(B,3)}else{B=(B-w)*g}var b=1/(13*y);b=isFinite(b)?b:0;var D=x*b+u;var L=d*b+h;b=B/(4*L);r[p]=9*D*b;r[M]=B;r[m]=(12-3*D-20*L)*b}return r},"Lab to Lch":function(r,t,a,e){a=a||1;e=e||3;t=(t||1)*e;var i=1/(2*Math.PI);for(var n=0,o=a,s=2*a;n<t;n+=e,o+=e,s+=e){var v=r[n],f=r[o],u=r[s];var h=Math.atan2(u,f)*i;r[n]=v;r[o]=Math.sqrt(f*f+u*u);r[s]=h<0?h+1:h}return r},"Lch to Lab":function(r,t,a,e){a=a||1;e=e||3;t=(t||1)*e;var i=Math.PI*2;for(var n=0,o=a,s=2*a;n<t;n+=e,o+=e,s+=e){var v=r[n],f=r[o],u=r[s];var h=u*i;var l=Math.cos(h)*f;var g=Math.sin(h)*f;r[n]=v;r[o]=l;r[s]=g}return r},"RGB to XYZ":function(r,a,e,i){t["sRGB to LinearRGB"](r,a,e,i);t["LinearRGB to XYZ"](r,a,e,i);return r},"XYZ to RGB":function(r,a,e,i){t["XYZ to LinearRGB"](r,a,e,i);t["LinearRGB to sRGB"](r,a,e,i);return r},"RGB to Lab":function(r,a,e,i,n){t["sRGB to LinearRGB"](r,a,e,i);t["LinearRGB to XYZ"](r,a,e,i,n);t["XYZ to Lab"](r,a,e,i,n);return r},"Lab to RGB":function(r,a,e,i){t["Lab to XYZ"](r,a,e,i);t["XYZ to LinearRGB"](r,a,e,i);t["LinearRGB to sRGB"](r,a,e,i);return r},"RGB to Luv":function(r,a,e,i,n){t["sRGB to LinearRGB"](r,a,e,i);t["LinearRGB to XYZ"](r,a,e,i);t["XYZ to Luv"](r,a,e,i,n);return r},"Luv to RGB":function(r,a,e,i,n){t["Luv to XYZ"](r,a,e,i,n);t["XYZ to LinearRGB"](r,a,e,i);t["LinearRGB to sRGB"](r,a,e,i);return r},"RGB to Lch":function(r,a,e,i,n){t["sRGB to LinearRGB"](r,a,e,i);t["LinearRGB to XYZ"](r,a,e,i);t["XYZ to Lab"](r,a,e,i,n);t["Lab to Lch"](r,a,e,i);return r},"Lch to RGB":function(r,a,e,i,n){t["Lch to Lab"](r,a,e,i);t["Lab to XYZ"](r,a,e,i,n);t["XYZ to LinearRGB"](r,a,e,i);t["LinearRGB to sRGB"](r,a,e,i);return r},"XYZ to xyY":function(r,t,a,e,i){a=a||1;e=e||3;t=(t||1)*e;i=i||[.31271,.32902,1];var n=i[0],o=i[1];for(var s=0,v=a,f=2*a;s<t;s+=e,v+=e,f+=e){var u=r[s],h=r[v],l=r[f];var g=1/(u+h+l);if(isFinite(g)){r[s]=u*g;r[v]=h*g;r[f]=h}else{r[s]=n;r[v]=o;r[f]=0}}return r},"xyY to XYZ":function(r,t,a,e){a=a||1;e=e||3;t=(t||1)*e;for(var i=0,n=a,o=2*a;i<t;i+=e,n+=e,o+=e){var s=r[i],v=r[n],f=r[o];var u=f/v;r[i]=s*u;r[n]=f;r[o]=(1-s-v)*u}return r},"XYZ to 1960 uvY":function(r,t,a,e,i){a=a||1;e=e||3;t=(t||1)*e;i=i||[.31271,.32902,1];var n=i[0],o=i[1],s=i[2];var v=n*s/o,f=(1-n-o)*s/o;var u=4*v/(v+15*s+3*f);var h=6*s/(v+15*s+3*f);for(var l=0,g=a,c=2*a;l<t;l+=e,g+=e,c+=e){var w=r[l],p=r[g],M=r[c];if(p===0){r[l]=u;r[g]=h;r[c]=0}else{var m=1/(w+15*p+3*M);r[l]=4*w*m;r[g]=6*p*m;r[c]=p}}return r},"1960 uvY to XYZ":function(r,t,a,e){a=a||1;e=e||3;t=(t||1)*e;var i=6/4,n=1/3;for(var o=0,s=a,v=2*a;o<t;o+=e,s+=e,v+=e){var f=r[o],u=r[s],h=r[v];var l=1/u;var g=i*h*f*l;r[o]=g;r[s]=h;r[v]=(6*h*l-g-15*h)*n}return r},"XYZ to 1976 u'v'Y":function(r,t,a,e,i){a=a||1;e=e||3;t=(t||1)*e;i=i||[.31271,.32902,1];var n=i[0],o=i[1],s=i[2];var v=n*s/o,f=(1-n-o)*s/o;var u=4*v/(v+15*s+3*f);var h=9*s/(v+15*s+3*f);for(var l=0,g=a,c=2*a;l<t;l+=e,g+=e,c+=e){var w=r[l],p=r[g],M=r[c];if(p===0){r[l]=u;r[g]=h;r[c]=0}else{var m=1/(w+15*p+3*M);r[l]=4*w*m;r[g]=9*p*m;r[c]=p}}return r},"1976 u'v'Y to XYZ":function(r,t,a,e){a=a||1;e=e||3;t=(t||1)*e;var i=9/4,n=1/3;for(var o=0,s=a,v=2*a;o<t;o+=e,s+=e,v+=e){var f=r[o],u=r[s],h=r[v];var l=1/u;var g=i*h*f*l;r[o]=g;r[s]=h;r[v]=(9*h*l-g-15*h)*n}return r},"xyY to 1960 uvY":function(r,t,a,e){a=a||1;e=e||3;t=(t||1)*e;for(var i=0,n=a,o=2*a;i<t;i+=e,n+=e,o+=e){var s=r[i],v=r[n];var f=1/(-2*s+12*v+3);r[i]=4*s*f;r[n]=6*v*f}return r},"1960 uvY to xyY":function(r,t,a,e){a=a||1;e=e||3;t=(t||1)*e;for(var i=0,n=a,o=2*a;i<t;i+=e,n+=e,o+=e){var s=r[i],v=r[n];var f=1/(2*s-8*v+4);r[i]=3*s*f;r[n]=2*v*f}return r},"1976 u'v'Y to xyY":function(r,t,a,e){a=a||1;e=e||3;t=(t||1)*e;for(var i=0,n=a,o=2*a;i<t;i+=e,n+=e,o+=e){var s=r[i],v=r[n];var f=1/(6*s-16*v+12);r[i]=9*s*f;r[n]=4*v*f}return r},"xyY to 1976 u'v'Y":function(r,t,a,e){a=a||1;e=e||3;t=(t||1)*e;for(var i=0,n=a,o=2*a;i<t;i+=e,n+=e,o+=e){var s=r[i],v=r[n];var f=1/(-2*s+12*v+3);r[i]=4*s*f;r[n]=9*v*f}return r},"1976 u'v'Y to 1960 uvY":function(r,t,a,e){a=a||1;e=e||3;t=(t||1)*e+a;var i=2/3;for(var n=a;n<t;n+=e){r[n]*=i}return r},"1960 uvY to 1976 u'v'Y":function(r,t,a,e){a=a||1;e=e||3;t=(t||1)*e+a;var i=3/2;for(var n=a;n<t;n+=e){r[n]*=i}return r},"RGB to rgY":function(r,a,e,i){t["sRGB to LinearRGB"](r,a,e,i);t["LinearRGB to rgY"](r,a,e,i);return r},"rgY to RGB":function(r,a,e,i){t["rgY to LinearRGB"](r,a,e,i);t["LinearRGB to sRGB"](r,a,e,i);return r},"rgY to xyY":function(r,a,e,i){t["rgY to LinearRGB"](r,a,e,i);t["LinearRGB to XYZ"](r,a,e,i);t["XYZ to xyY"](r,a,e,i);return r},"xyY to rgY":function(r,a,e,i){t["xyY to XYZ"](r,a,e,i);t["XYZ to LinearRGB"](r,a,e,i);t["LinearRGB to rgY"](r,a,e,i);return r},"RGB to xyY":function(r,a,e,i){t["sRGB to LinearRGB"](r,a,e,i);t["LinearRGB to XYZ"](r,a,e,i);t["XYZ to xyY"](r,a,e,i);return r},"xyY to RGB":function(r,a,e,i){t["xyY to XYZ"](r,a,e,i);t["XYZ to LinearRGB"](r,a,e,i);t["LinearRGB to sRGB"](r,a,e,i);return r},"RGB to 1960 uvY":function(r,a,e,i){t["sRGB to LinearRGB"](r,a,e,i);t["LinearRGB to XYZ"](r,a,e,i);t["XYZ to xyY"](r,a,e,i);t["xyY to 1960 uvY"](r,a,e,i);return r},"1960 uvY to RGB":function(r,a,e,i){t["1960 uvY to xyY"](r,a,e,i);t["xyY to XYZ"](r,a,e,i);t["XYZ to LinearRGB"](r,a,e,i);t["LinearRGB to sRGB"](r,a,e,i);return r},"RGB to 1976 u'v'Y":function(r,a,e,i){t["sRGB to LinearRGB"](r,a,e,i);t["LinearRGB to XYZ"](r,a,e,i);t["XYZ to 1976 u'v'Y"](r,a,e,i);return r},"1976 u'v'Y to RGB":function(r,a,e,i){t["1976 u'v'Y to XYZ"](r,a,e,i);t["XYZ to LinearRGB"](r,a,e,i);t["LinearRGB to sRGB"](r,a,e,i);return r}};r.Colorspaces=t})(Matrix);(function(r,t){"use strict";var a={lab2lch:"Lab to Lch",lab2srgb:"Lab to RGB",lab2xyz:"Lab to XYZ",lch2lab:"Lch to Lab",srgb2cmyk:"RGB to CMY",srgb2lab:"RGB to Lab",srgb2xyz:"RGB to XYZ",upvpl2xyz:"1976 u'v'Y to XYZ",uvl2xyz:"1960 uvY to XYZ",xyl2xyz:"xyY to XYZ",xyz2lab:"XYZ to Lab",xyz2srgb:"XYZ to RGB",xyz2upvpl:"XYZ to 1976 u'v'",xyz2uvl:"XYZ to 1960 uv",xyz2xyl:"XYZ to xyY"};t.applycform=function(t){if(this.ndims()!==3||this.getSize(2)<3){throw new Error("Matrix.applycform: Matrix must be an "+"image with RGB components.")}var e=this.getSize(0)*this.getSize(1);if(typeof t==="string"){if(r.Colorspaces[t]){r.Colorspaces[t](this.getData(),e,e,1)}else if(r.Colorspaces[a[t]]){r.Colorspaces[a[t]](this.getData(),e,e,1)}else{throw new Error("Matrix.applycform: Unknown color transformation "+t)}}else if(typeof t==="function"){if(t.length===3){r.Colorspaces.applyFunctionRGB(this.getData(),t,e,e,1)}else if(t.length===1){r.Colorspaces.applyFunctionColor(this.getData(),t,e,e,1)}}else{t=r.toMatrix(t);if(!Tools.checkSizeEquals(t.size(),[3,3],r.ignoreTrailingDims)){throw new Error("Matrix.applycform: Matrix argument must be 3x3.")}r.Colorspaces.matrix(this.getData(),t.getData(),e,e,1)}return this};r.applycform=function(r,t){return r.getCopy().applycform(t)};t.toColormap=function(t){var a=this.getData(),e=this.getSize(),i=a.length;e[2]=3;var n=new r(e),o=n.getData();var s=o.subarray(0,i),v=o.subarray(i,2*i),f=o.subarray(2*i,3*i);var u,h,l=Math.floor;if(t==="JET"){for(u=0;u<i;u++){h=a[u]*4;if(h>=4){h=3.99}else if(h<0){h=0}switch(l(h*2)%8){case 0:s[u]=0;v[u]=0;f[u]=h+.5;break;case 1:case 2:s[u]=0;f[u]=1;v[u]=h-.5;break;case 3:case 4:s[u]=h-1.5;v[u]=1;f[u]=2.5-h;break;case 5:case 6:s[u]=1;v[u]=3.5-h;f[u]=0;break;case 7:s[u]=4.5-h;v[u]=0;f[u]=0;break}}}else if(t==="HUE"){for(u=0;u<i;u++){var g=a[u];h=l(g*6)%6;var c=g*6-h;switch(h){case 0:s[u]=1;v[u]=c;f[u]=0;break;case 1:s[u]=1-c;v[u]=1;f[u]=0;break;case 2:s[u]=0;v[u]=1;f[u]=c;break;case 3:s[u]=0;v[u]=1-c;f[u]=1;break;case 4:s[u]=c;v[u]=0;f[u]=1;break;case 5:s[u]=1;v[u]=0;f[u]=1-c;break}}}else if(t==="HUE"){o.set(a)}return n};t.correctImage=function(t,a){a=a||r.CIE.getIlluminant("D65");var e=r.CIE.getIlluminantConversionMatrix(a,t);this.applycform("sRGB to LinearRGB").applycform(e).applycform("LinearRGB to sRGB");return this};r.correctImage=function(r,t,a){return r.getCopy().correctImage(t,a)};t.im2CCT=function(){var t=r.CIE["xyY to CCT"];var a=this.getSize();a.pop();var e=new r(a,"single");var i=this.getData(),n=e.getData();var o=this.getView();var s=o.getStep(0),v=o.getEnd(0),f;var u=o.getStep(1),h=o.getEnd(1),l;var g=o.getStep(2);var c,w,p,M,m,y=[];for(c=0,l=h;c!==l;c+=u){w=c;p=c+g;M=c+2*g;for(f=c+v;w!==f;w+=s,p+=s,M+=s){y[0]=i[w];y[1]=i[p];y[2]=i[M];m=t(y);m=m<1668?1668:m>2e4?2e4:m;m=isNaN(m)?24999:m;n[w]=m}}return e};t.CCT2im=function(){var t=r.CIE["CCT to xyY"];var a=this.getSize();a[2]=3;var e=new r(a,"single");var i=this.getData(),n=e.getData();var o=e.getView();var s=o.getStep(0),v=o.getEnd(0),f;var u=o.getStep(1),h=o.getEnd(1),l;var g=o.getStep(2);var c,w,p,M,m=[];for(c=0,l=h;c!==l;c+=u){w=c;p=c+g;M=c+2*g;for(f=c+v;w!==f;w+=s,p+=s,M+=s){m=t(i[w]);n[w]=m[0];n[p]=m[1];n[M]=m[2]}}return e}})(Matrix,Matrix.prototype);