/**
 * This program is free software: you can redistribute it and/or modify    
 * it under the terms of the GNU General Public License as published by        
 * the Free Software Foundation, either version 3 of the License, or 
 * (at your option) any later version.
 * 
 * This program is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU General Public License for more details.
 * 
 * You should have received a copy of the GNU General Public License
 * along with this program.  If not, see <http://www.gnu.org/licenses/>.
 * 
 * @author Baptiste Mazin     <baptiste.mazin@telecom-paristech.fr> 
 * @author Guillaume Tartavel <guillaume.tartavel@telecom-paristech.fr> 
 */
(function(){"use strict";window.USE_CST=true;var a=function(a,r,e,t,i){var n=a[0]>0?a[0]:-a[0];for(var v=1,u=a.length;v<u;v++){var s=a[v]>0?a[v]:-a[v];if(s>n){n=s}}var f=Math.max(1.01/255,n/e);var o,d,l=Math.pow;var c=window.USE_CST?1/l(255,i-1):1;for(var v=0;v<u;v++){var h=a[v]>0?1:-1,x=h===1?a[v]:-a[v];if(x<=f){continue}var M=r[v]>0?r[v]:-r[v],p=x;for(var m=0;m<5;m++){o=p-x-t*i*l(M/p,i);d=1+t*i*i*M/l(p,1+i)*c;p=p-o/d}a[v]=p*h}return a};Matrix.prototype.colorEnhancementTest=function(r,e,t,i,n,v){n=n===undefined?.1:n;r=r===undefined?.5:r;e=e===undefined?15/255:e;i=i===undefined?"sym4":i;t=t===undefined?20:t;v=v===undefined?"channel":v;var u=this.im2double(),s=Matrix.zeros(u.size());var f=Matrix.dwtmaxlev([this.size(0),this.size(1)],i);var o=u.size(2),d=[];var l=[],c=[],h=[];var x;var M=Matrix.wfilters(i,"d")[0].sum().getDataScalar();M=Math.pow(M,2*f);var p;for(var m=0;m<o;m++){d[m]=Matrix.wavedec2(u.get([],[],m),f,i);var w=Matrix.appcoef2(d[m],i,f-1);l[m]=w.mean().getDataScalar()}var g=(l[0]+l[1]+l[2])/3;for(var m=0;m<o;m++){var w=Matrix.appcoef2(d[m],i,f-1);if(v==="image"){p=g}else if(v==="channel"){p=l[m]}else if(v==="half"){p=M*.5}w["*="](1-n)["+="](p*n)}for(var m=0;m<o;m++){for(var y=f-1;y>=0;y--){var b=d[m][0].getData();var z=d[m][1].value([0,0])*d[m][1].value([0,1]);w=b.subarray(0,z);a(b.subarray(2*z,3*z),w,t,e,r);a(b.subarray(z,2*z),w,t,e,r);a(b.subarray(3*z,4*z),w,t,e,r);d[m]=Matrix.upwlev2(d[m],i)}var D=d[m][0].reshape(d[m][1].get(0).getData());s.set([],[],m,D)}return s};Matrix.prototype.colorEnhancement=function(r,e,t,i,n){n=n===undefined?.1:n;r=r===undefined?.5:r;e=e===undefined?15/255:e;i=i===undefined?"sym4":i;t=t===undefined?20:t;var v=this.im2double();var u=Matrix.zeros(v.size());var s=Matrix.dwtmaxlev([this.size(0),this.size(1)],i);for(var f=0;f<v.size(2);f++){var o=v.get([],[],f);var d=Matrix.wavedec2(o,s,i);var l=Matrix.appcoef2(d,i,s-1);l["*="](1-n)["+="](l.mean()[".*"](n));for(var c=s-1;c>=0;c--){var h=d[0].getData();var x=d[1].value([0,0])*d[1].value([0,1]);l=h.subarray(0,x);a(h.subarray(2*x,3*x),l,t,e,r);a(h.subarray(x,2*x),l,t,e,r);a(h.subarray(3*x,4*x),l,t,e,r);d=Matrix.upwlev2(d,i)}var o=d[0].reshape(d[1].get(0).getData());u.set([],[],f,o)}return u}})();