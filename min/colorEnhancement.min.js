/**
 * This program is free software: you can redistribute it and/or modify    
 * it under the terms of the GNU General Public License as published by        
 * the Free Software Foundation, either version 3 of the License, or 
 * (at your option) any later version.
 * 
 * This program is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU General Public License for more details.
 * 
 * You should have received a copy of the GNU General Public License
 * along with this program.  If not, see <http://www.gnu.org/licenses/>.
 * 
 * @author Baptiste Mazin     <baptiste.mazin@telecom-paristech.fr> 
 * @author Guillaume Tartavel <guillaume.tartavel@telecom-paristech.fr> 
 */
(function(){"use strict";window.USE_CST=true;window.EDO_RES=false;var a=function(a,e,r,t,i){var n=a[0]>0?a[0]:-a[0];for(var v=1,s=a.length;v<s;v++){var u=a[v]>0?a[v]:-a[v];if(u>n){n=u}}var f=Math.max(1.01/255,n/r);var o,d,l=Math.pow;var c=window.USE_CST?1/l(255,i-1):1;for(v=0;v<s;v++){var w=a[v]>0?1:-1,x=w===1?a[v]:-a[v];if(x<=f){continue}var h=e[v]>0?e[v]:-e[v],M=x;for(var p=0;p<5;p++){o=M-x-t*i*l(h/M,i);d=1+t*i*i*h/l(M,1+i)*c;M=M-o/d}a[v]=M*w}return a};Matrix.prototype.colorEnhancementTest=function(e,r,t,i,n,v){n=n===undefined?.1:n;e=e===undefined?.5:e;r=r===undefined?15/255:r;i=i===undefined?"sym4":i;t=t===undefined?20:t;v=v===undefined?"channel":v;var s=this.im2double(),u=Matrix.zeros(s.size());var f=Matrix.dwtmaxlev([this.size(0),this.size(1)],i);if(window.EDO_RES){f=f-1}var o=s.size(2),d=[];var l=[],c=[],w=[];var x=Matrix.wfilters(i,"d")[0].sum().getDataScalar();x=Math.pow(x,2*f);var h;var M,p=0;for(var m=0;m<o;m++){d[m]=Matrix.wavedec2(s.get([],[],m),f,i);M=Matrix.appcoef2(d[m],i,f);l[m]=M.mean().getDataScalar();w[m]=M.min().getDataScalar();c[m]=M.max().getDataScalar();p+=l[m]/o}for(m=0;m<o;m++){M=Matrix.appcoef2(d[m],i,f);if(v==="image"){h=p}else if(v==="channel"){h=l[m]}else if(v==="half"){h=x*.5}if(window.EDO_RES){M["-="](w[m])["*="](x/(c[m]-w[m]))}M["*="](1-n)["+="](h*n)}for(m=0;m<o;m++){for(var g=f-1;g>=0;g--){var y=d[m][0].getData();var D=d[m][1].value([0,0])*d[m][1].value([0,1]);M=y.subarray(0,D);a(y.subarray(2*D,3*D),M,t,r,e);a(y.subarray(D,2*D),M,t,r,e);a(y.subarray(3*D,4*D),M,t,r,e);d[m]=Matrix.upwlev2(d[m],i)}var S=d[m][0].reshape(d[m][1].get(0).getData());u.set([],[],m,S)}return u};Matrix.prototype.colorEnhancement=function(e,r,t,i,n){n=n===undefined?.1:n;e=e===undefined?.5:e;r=r===undefined?15/255:r;i=i===undefined?"sym4":i;t=t===undefined?20:t;var v=this.im2double();var s=Matrix.zeros(v.size());var u=Matrix.dwtmaxlev([this.size(0),this.size(1)],i);for(var f=0;f<v.size(2);f++){var o=v.get([],[],f);var d=Matrix.wavedec2(o,u,i);var l=Matrix.appcoef2(d,i,u-1);l["*="](1-n)["+="](l.mean()[".*"](n));for(var c=u-1;c>=0;c--){var w=d[0].getData();var x=d[1].value([0,0])*d[1].value([0,1]);l=w.subarray(0,x);a(w.subarray(2*x,3*x),l,t,r,e);a(w.subarray(x,2*x),l,t,r,e);a(w.subarray(3*x,4*x),l,t,r,e);d=Matrix.upwlev2(d,i)}o=d[0].reshape(d[1].get(0).getData());s.set([],[],f,o)}return s}})();