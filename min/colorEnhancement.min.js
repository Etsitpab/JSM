/**
 * This program is free software: you can redistribute it and/or modify    
 * it under the terms of the GNU General Public License as published by        
 * the Free Software Foundation, either version 3 of the License, or 
 * (at your option) any later version.
 * 
 * This program is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU General Public License for more details.
 * 
 * You should have received a copy of the GNU General Public License
 * along with this program.  If not, see <http://www.gnu.org/licenses/>.
 * 
 * @author Baptiste Mazin     <baptiste.mazin@telecom-paristech.fr> 
 * @author Guillaume Tartavel <guillaume.tartavel@telecom-paristech.fr> 
 */
(function(){"use strict";window.USE_CST=true;var a=function(a,r,e,t,i){var n=a[0]>0?a[0]:-a[0];for(var v=1,u=a.length;v<u;v++){var s=a[v]>0?a[v]:-a[v];if(s>n){n=s}}var f=Math.max(1.01/255,n/e);var o,d,l=Math.pow;var c=window.USE_CST?1/l(255,i-1):1;for(var v=0;v<u;v++){var h=a[v]>0?1:-1,x=h===1?a[v]:-a[v];if(x<=f){continue}var M=r[v]>0?r[v]:-r[v],m=x;for(var p=0;p<5;p++){o=m-x-t*i*l(M/m,i);d=1+t*i*i*M/l(m,1+i)*c;m=m-o/d}a[v]=m*h}return a};Matrix.prototype.colorEnhancementTest=function(r,e,t,i,n,v){n=n===undefined?.1:n;r=r===undefined?.5:r;e=e===undefined?15/255:e;i=i===undefined?"sym4":i;t=t===undefined?20:t;v=v===undefined?"channel":v;var u=this.im2double(),s=Matrix.zeros(u.size());var f=Matrix.dwtmaxlev([this.size(0),this.size(1)],i);var o=u.size(2),d=[];var l=[],c=[],h=[];var x;var M=Matrix.wfilters(i,"d")[0].sum().getDataScalar();M=Math.pow(M,2*f);var m;var p=0;for(var g=0;g<o;g++){d[g]=Matrix.wavedec2(u.get([],[],g),f,i);var w=Matrix.appcoef2(d[g],i,f-1);l[g]=w.mean().getDataScalar();h[g]=w.min().getDataScalar();c[g]=w.max().getDataScalar();p+=l[g]/o}var y=Math.min(h[0],h[1],h[2]);var b=Math.max(c[0],c[1],c[2]);for(var g=0;g<o;g++){var w=Matrix.appcoef2(d[g],i,f-1);if(v==="image"){m=p}else if(v==="channel"){m=l[g]}else if(v==="half"){m=M*.5}w["*="](1-n)["+="](m*n)}for(var g=0;g<o;g++){for(var z=f-1;z>=0;z--){var D=d[g][0].getData();var S=d[g][1].value([0,0])*d[g][1].value([0,1]);w=D.subarray(0,S);a(D.subarray(2*S,3*S),w,t,e,r);a(D.subarray(S,2*S),w,t,e,r);a(D.subarray(3*S,4*S),w,t,e,r);d[g]=Matrix.upwlev2(d[g],i)}var E=d[g][0].reshape(d[g][1].get(0).getData());s.set([],[],g,E)}return s};Matrix.prototype.colorEnhancement=function(r,e,t,i,n){n=n===undefined?.1:n;r=r===undefined?.5:r;e=e===undefined?15/255:e;i=i===undefined?"sym4":i;t=t===undefined?20:t;var v=this.im2double();var u=Matrix.zeros(v.size());var s=Matrix.dwtmaxlev([this.size(0),this.size(1)],i);for(var f=0;f<v.size(2);f++){var o=v.get([],[],f);var d=Matrix.wavedec2(o,s,i);var l=Matrix.appcoef2(d,i,s-1);l["*="](1-n)["+="](l.mean()[".*"](n));for(var c=s-1;c>=0;c--){var h=d[0].getData();var x=d[1].value([0,0])*d[1].value([0,1]);l=h.subarray(0,x);a(h.subarray(2*x,3*x),l,t,e,r);a(h.subarray(x,2*x),l,t,e,r);a(h.subarray(3*x,4*x),l,t,e,r);d=Matrix.upwlev2(d,i)}var o=d[0].reshape(d[1].get(0).getData());u.set([],[],f,o)}return u}})();