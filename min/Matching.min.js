/**
 * This program is free software: you can redistribute it and/or modify    
 * it under the terms of the GNU General Public License as published by        
 * the Free Software Foundation, either version 3 of the License, or 
 * (at your option) any later version.
 * 
 * This program is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU General Public License for more details.
 * 
 * You should have received a copy of the GNU General Public License
 * along with this program.  If not, see <http://www.gnu.org/licenses/>.
 * 
 * @author Baptiste Mazin     <baptiste.mazin@telecom-paristech.fr> 
 * @author Guillaume Tartavel <guillaume.tartavel@telecom-paristech.fr> 
 */
var Matching={};if(typeof window==="undefined"){var JSM=require("../modules/JSM.js");var Matrix=JSM.Matrix;var Tools=JSM.Tools;module.exports.Matching=Matching}var root=typeof window==="undefined"?module.exports:window;(function(t){function r(t,r){var e=t.nBin,a=t.nSector,i=[];var n=r||new Float32Array(e*a);var s;for(s=0;s<a;s++){i[s]=n.subarray(s*e,(s+1)*e)}this.descriptor=t;this.histograms=i;this.nBin=e;this.nSector=a;this.data=n;this.pps=new Float32Array(a);this.sum=new Float32Array(a)}r.prototype={extractModes:function(){var t=this.histograms;var r=this.sum;var e=this.pps;var a,i;this.modes=[];for(a=0,i=t.length;a<i;a++){var n=r[a]/e[a];this.modes[a]=extractModes(t[a],true,0,e[a],n,n*n)}return this},modesToHistograms:function(){var t=this.histograms,r;var e=this.modes,a;var i=this.nBin;var n,s,o,h;var c=Math.round;for(n=0,o=r.length;n<o;n++){r=t[n];for(s=0,h=i;s<h;s++){r[s]=0}a=e[n];for(s=0,h=a.length;s<h;s++){r[c(a[s].phase*i)]=a[s].norm}}return this},normalizeModes:function(){var t=this.modes;var r,e,a,i,n;var s=this.sum;for(r=0,n=0,a=s.length;r<a;r++){n+=s[r]}n=n>0?1/n:0;for(r=0,a=t.length;r<a;r++){for(e=0,i=t[r].length;e<i;e++){t[r][e].norm*=n}}return this},processModes:function(){var t=this.modes;var r,e,a,i;for(r=0,a=t.length;r<a;r++){if(t[r].length>1){t[r].slice(0,1)}for(e=0,i=t[r].length;e<i;e++){var n=t[r][e].phase;var s=t[r][e].norm;var o=4,h=.2;n=Math.floor(n*o)/o;s=Math.floor(s*o/h)+1;s=(s>=o?o:s)/o;t[r][e].phase=n;t[r][e].norm=s}}return this},normalizeHistograms:function(){var t=this.histograms;var r=this.pps;var e,a,i,n,s;for(e=0,i=t.length,s=0;e<i;e++){if(r[e]!==0){for(a=0,n=t[e].length;a<n;a++){t[e][a]/=r[e];s+=t[e][a]}}}s=s>0?1/s:0;for(e=0;e<i;e++){for(a=0,n=t[e].length;a<n;a++){t[e][a]*=s}}return this},cumulHistograms:function(){var t=this.histograms,r=this.nBin,e=this.nSector;this.cumulatedData=new Float32Array(r*e);this.cumulatedHistograms=[];var a=this.cumulatedHistograms;var i,n,s;for(i=0;i<e;i++){a[i]=this.cumulatedData.subarray(i*r,(i+1)*r);a[i][0]=t[i][0];for(n=1,s=a[i].length;n<s;n++){a[i][n]=a[i][n-1]+t[i][n]}for(n=1,s=a[i].length;n<s;n++){a[i][n]=a[i][n-1]+t[i][n]}}return this},toString:function(){var t="";var r=this.histograms;var e,a,i,n;for(e=0,i=r.length;e<i;e++){for(a=0,n=r[e].length;a<n;a++){t+=r[e][a]+" "}t+="\n"}return t}};t.DescriptorData=r})(Matching);var root=typeof window==="undefined"?module.exports:window;(function(t){var r=function(t,r){if(t<0){t+=1}var e=Math.floor(t*r+.5);return e>=r?e-r:e};function e(t){var r,e;for(r in t){if(t.hasOwnProperty(r)){this[r]=t[r]}}if(this.name===undefined){throw new Error("Descriptor: Name should be specified.")}this.nSector=0;for(r=0,e=this.sectors.length;r<e;r++){this.nSector+=this.sectors[r]}if(this.rings===undefined){this.setRingsFromSectors()}if(this.colorspace.name!=="RGB"){this.convert="RGB to "+this.colorspace.name}return this}e.prototype={nBin:8,relativeOrientation:true,sectors:[1,4,4],rings:[.25,.75,1],extractModes:false,distance:"L1",normalize:false,type:"GRADIENT",colorspace:{name:"Ohta",channels:0},setRingsFromSectors:function(){var t=[],r=this.nSector,e=this.sectors;t[0]=Math.sqrt(e[0]/r);var a,i;for(a=1,i=e.length-1;a<i;a++){t[a]=Math.sqrt(e[a]/r+t[a-1]*t[a-1])}t[a]=1;this.rings=t;return this},getDataStructure:function(t){return new DescriptorData(this,t)},getHistogramNumber:function(t,e,a,i){var n=t*t+e*e,s=0;var o=this.rings,h=this.sectors;while(n>i*i*o[s]*o[s]){s++}if(s>=o.length){throw new Error("Error getHistogramNumber: Point out of descriptor")}var c=Math.atan2(e,t)/(2*Math.PI);c=(c<0?c+1:c)-a;var l=r(c,h[s]);var p,f=l;for(p=0;p<s;p++){f+=h[p]}return f},extractWeightedHistograms:function(e,a,i){i=new t.DescriptorData(this,i);var n=i.histograms;var s=i.pps;var o=i.sum;var h=a.phase.getData(),c=a.norm.getData();var l=a.norm.getSize(0);var p=Math.floor(l/2),f=p*p;var v=this.relativeOrientation===true?e:0;var u,g,m,d;var y,S,w,M;for(g=0,m=0,y=-p;g<l;g++,m+=l,y++){for(u=0,d=m,w=y*y,S=p;u<l;u++,d++,S--){M=w+S*S;if(M>f){c[d]=0;h[d]=0;continue}var x=r(h[d]-v,this.nBin);var D=this.getHistogramNumber(S,y,e,p);var k=c[d];s[D]++;o[D]+=k;n[D][x]+=k}}return i},normalizeColor:function(t){var r=1/t.mean[0];var e=1/t.mean[1];var a=1/t.mean[2];var i=t.patch.getCopy();var n=i.getData();var s=i.getSize(0);var o=Math.floor(s/2),h=o*o;var c,l,p,f;var v,u,g,m,d=s*s;for(l=0,p=0,v=-o;l<s;l++,p+=s,v++){for(c=0,f=p,g=v*v,u=o;c<s;c++,f++,u--){m=g+u*u;if(m>h){continue}n[f]*=r;n[f+d]*=e;n[f+2*d]*=a}}return{patch:i,mean:t.mean,mask:t.mask}},getPatch:function(t){if(this.normalize===true){t=this.normalizeColor(t)}var r=this.colorspace;if(r.name!=="RGB"){t=t.patch.applycform(this.convert)}switch(this.type){case"GRADIENT":t=t.get([],[],r.channels).gradient(0,0,1,1);break;case"WEIGHTED-HISTOGRAMS":t={norm:t.get([],[],r.weightChannel),phase:t.get([],[],r.phaseChannel)};break;default:throw new Error("Descriptor: Unknown type: "+this.type+".")}return t},extractFromPatch:function(t,r,e){var a=this.getPatch(r);var i=this.extractWeightedHistograms(t,a,e);this.data=i;if(this.extractModes===true){i.extractModes();i.normalizeModes();i.processModes()}if(this.distance==="CEMD"){i.normalizeHistograms();i.cumulHistograms()}else{i.normalizeHistograms()}return i}};(function(){var t=function(t,r,e){var a,i,n,s,o,h=new Float32Array(e);for(a=0;a<e;a++){h[a]=r[a]-t[a]}for(s=0,a=1;a<e;a++){o=h[a]-h[0];s+=o>0?o:-o}for(i=1;i<e;i++){for(n=0,a=0;a<i;a++){o=h[a]-h[i];n+=o>0?o:-o}for(a++;a<e;a++){o=h[a]-h[i];n+=o>0?o:-o}s=n<s?n:s}return s/e};var r=function(t,r,e){var a,i,n;for(i=0,n=0;n<e;n++){a=t[n]-r[n];i+=a>0?a:-a}return i/e};var a=function(t,r,e){var a,i,n;for(i=0,n=0;n<e;n++){a=t[n]-r[n];i+=a*a}return i/e};var i=Math.min,n=Math.max;function s(t,r){var e=t>r?t-r:r-t;return e>1/2?1-e:e}var o=function(t,r){var e=0,a=0,h=0,c=0,l=0,p=0,f=0,v=0;if(t.length>0){e=t[0].phase;a=t[0].norm}if(t.length>1){h=t[1].phase;c=t[1].norm}if(r.length>0){l=r[0].phase;p=r[0].norm}if(r.length>1){f=r[1].phase;v=r[1].norm}if(a+c>p+v){return o(r,t)}var u=0,g=0,m=0;var d=s(e,l),y=s(e,f);var S=s(h,l),w=s(h,f);var M=d-y;var x=S-w;var D=a+c-v;if(n(M,x)<=0){if(p>=a+c){u=a;g=c}else{if(M<=x){if(p>=a){u=a;g=p-a}else{u=p;g=0}}else{if(p>=c){u=p-c;g=c}else{u=0;g=p}}}}else if(i(M,x)>=0){if(D<=0){u=0;g=0}else{if(M<=x){if(D>=a){u=a;g=p-a}else{u=p;g=0}}else{if(D>=c){u=D-c;g=c}else{u=0;g=c}}}}else{if(M<=x){if(p<=a){u=p;g=0}else{if(D<=a){u=a;g=0}else{u=a;g=D-a}}}else{if(p<=c){u=0;g=p}else{if(D<=c){u=0;g=c}else{u=D-c;g=c}}}}m=u*M+g*x+a*y+c*w;m+=(p+v-a-c)*.5;return m};e.prototype.computeDistances=function(e,i){var n=this.nSector,s=this.nBin;var h,c,l=i.length;var p=[];for(h=0;h<n;h++){p[h]=new Float32Array(l)}var f,v;var u,g;if(this.distance==="L1"){g="histograms";u=r}else if(this.distance==="L2"){g="histograms";u=a}else if(this.distance==="CEMD"){g="cumulatedHistograms";u=t}else if(this.distance==="D2M"){g="modes";u=o}if(!u){throw new Error("Sift.computeDistances: Unknown distance: "+this.distance)}f=e[g];for(c=0;c<l;c++){v=i[c][g];for(h=0;h<n;h++){p[h][c]=u(f[h],v[h],s)}}return p}})();t.Descriptor=e;t.descriptorDB={R:new e({name:"R",colorspace:{name:"RGB",channels:0}}),G:new e({name:"G",colorspace:{name:"RGB",channels:1}}),B:new e({name:"B",colorspace:{name:"RGB",channels:2}}),H:new e({name:"H",colorspace:{name:"HSL",channels:0}}),S:new e({name:"S",colorspace:{name:"HSL",channels:1}}),L:new e({name:"L",colorspace:{name:"HSL",channels:2}}),SIFT:new e({name:"SIFT"}),OHTA1:new e({name:"OHTA1",colorspace:{name:"Ohta",channels:1}}),OHTA2:new e({name:"OHTA2",colorspace:{name:"Ohta",channels:2}}),OPP1:new e({name:"OPP1",colorspace:{name:"Opponent",channels:1}}),OPP2:new e({name:"OPP2",colorspace:{name:"Opponent",channels:2}}),OHTAN1:new e({name:"OHTAN1",colorspace:{name:"OhtaNorm",channels:1}}),OHTAN2:new e({name:"OHTAN2",colorspace:{name:"OhtaNorm",channels:2}}),"HUE-NORM":new e({name:"HUE-NORM",type:"WEIGHTED-HISTOGRAMS",colorspace:{name:"HSL",weightChannel:1,phaseChannel:0},normalize:true,relativeOrientation:false}),HUE:new e({name:"HUE",type:"WEIGHTED-HISTOGRAMS",colorspace:{name:"HSL",weightChannel:1,phaseChannel:0},normalize:false,relativeOrientation:false})}})(Matching);var root=typeof window==="undefined"?module.exports:window;(function(t){function r(t,r,e,a,i){this.k1=r;this.k1.number=t;this.k2=a;this.k2.number=e;this.distance=i}r.prototype.isValid=false;r.compar=function(t,r){return t.distance-r.distance};r.prototype.toString=function(){var t=this.k1.toString(true,true,false,false)+" ";t+=this.k2.toString(true,true,false,false)+" ";t+=this.distance;t+=" "+(this.isValid?1:0);return t};t.Match=r})(Matching);var root=typeof window==="undefined"?module.exports:window;(function(t){var r=function(t,r){if(t<0){t+=1}var e=Math.floor(t*r+.5);return e>=r?e-r:e};function e(t,r,e,a){this.x=t;this.y=r;this.sigma=e;this.laplacian=a}e.prototype.nBin=36;e.prototype.algorithm="max";e.prototype.factorSize=12;e.prototype.descriptors=[t.descriptorDB["SIFT"]];e.prototype.criterion="NN-DR";e.prototype.toString=function(t,r,e,a){t=t===undefined?true:t;r=r===undefined?true:r;e=e===undefined?true:e;a=a===undefined?true:a;var i="";if(t){i+=this.x+" "}if(r){i+=this.y+" "}if(e){i+=this.sigma+" "}if(this.orientation!==undefined&a){i+=" "+this.orientation}return i};e.prototype.getCopy=function(){var t=new e(this.x,this.y,this.sigma,this.laplacian);t.nScale=this.nScale;if(this.histogram){t.histogram=this.histogram}if(this.patch){t.patch=this.patch}if(this.descriptorsData){t.descriptorsData=this.descriptorsData}if(this.orientation){t.orientation=this.orientation}return t};e.prototype.extractMainOrientation_old=function(t,e){this.histogram=new Float32Array(this.nBin);var a=this.histogram;var i=this.nBin;e=(e||this.algorithm).toLowerCase();this.algorithm=e;var n=r;t=t.gradient(0,0,1,1);var s=t.phase.getData(),o=t.norm.getData();var h=t.norm.getSize(0);var c=Math.floor(h/2),l=c*c;var p=0;var f=Math.exp,v=-16/l;var u,g,m,d,y,S,w;for(m=0,d=0;m<h;m++,d+=h){for(u=0,y=d,S=(m-c)*(m-c);u<h;u++,y++){w=S+(u-c)*(u-c);if(w>l){o[y]=0;s[y]=0;continue}var M=n(s[y],i);p++;a[M]+=o[y]}}var x=[];switch(e){case"ac":var D=0;for(u=0;u<i;u++){D+=a[u]}D=D/p;a.nPoints=p;a.lambda=D;var k=extractModes(a,true,0,p,D,D*D);a.modes=k;for(u=0,g=k.length;u<g;u++){x.push(k[u].phase)}return x;case"max":var T=0;for(u=0,g=a.length;u<g;u++){if(a[u]>a[T]){T=u}}return[T/i];default:throw new Error("Keypoint.extractMainOrientation: "+"Wrong algorithm choice: "+this.algorithm+".")}};e.prototype.extractMainOrientation=function(t,e){this.histogram=new Float32Array(this.nBin);var a=this.histogram;var i=this.nBin;e=(e||this.algorithm).toLowerCase();this.algorithm=e;var n=r;var s=t.phase.getData(),o=t.norm.getData(),h=t.view;var c=h.getFirst(1),l=h.getStep(1),p=h.getFirst(0);var f=h.getSize(0);var v=Math.floor(f/2),u=v*v;var g=0;var m=Math.exp,d=-16/u;var y,S,w,M,x,D,k;for(w=0,M=c;w<f;w++,M+=l){for(y=0,x=M+p,D=(w-v)*(w-v);y<f;y++,x++){k=D+(y-v)*(y-v);if(k>u){continue}if(x>=s.length){console.log(x,s.length,y,w,M);throw new Error}var T=n(s[x],i);g++;a[T]+=o[x]}}var P=[];switch(e){case"ac":var O=0;for(y=0;y<i;y++){O+=a[y]}O=O/g;a.nPoints=g;a.lambda=O;var b=extractModes(a,true,0,g,O,O*O);a.modes=b;for(y=0,S=b.length;y<S;y++){P.push(b[y].phase)}return P;case"max":var z=0;for(y=0,S=a.length;y<S;y++){if(a[y]>a[z]){z=y}}return[z/i];default:throw new Error("Keypoint.extractMainOrientation: "+"Wrong algorithm choice: "+this.algorithm+".")}};e.prototype.extractDescriptors=function(t,r,e){this.descriptors=r||this.descriptors;r=this.descriptors;this.descriptorsData={};var a,i,n,s;var o,h=this.orientation;for(a=0,i=r.length;a<i;a++){n=r[a];s=n.name;o=n.extractFromPatch(h,t,e[s]);this.descriptorsData[s]=o}return this};e.prototype.computeDistances=function(t,r){r=r||this.descriptorsData;var e=function(t,r){var e=[],a,i;for(a=0,i=t.length;a<i;a++){e[a]=t[a].descriptorsData[r]}return e};var a={length:t.length};var i;for(i in r){if(r.hasOwnProperty(i)){var n=this.descriptorsData[i];var s=e(t,i);var o=n.descriptor;a[i]=o.computeDistances(n,s)}}return a};var a=function(t,r){var e=t.length;var i=r.length;if(e<i){return a(r,t)}var n=new Float32Array(e+i-1),s=n.length;var o,h,c,l,p,f,v;for(p=0,f=i-1;p<f;p++){for(v=0,h=0,c=p+1,l=p;h<c;h++,l--){v+=t[h]*r[l]}n[p]=v}for(p=i-1,o=0,f=e;p<f;p++,o++){for(v=0,h=o,c=p+1,l=i-1;h<c;h++,l--){v+=t[h]*r[l]}n[p]=v}for(p=e,o=e-i+1;p<s;p++,o++){for(v=0,h=o,l=i-1;h<e;h++,l--){v+=t[h]*r[l]}n[p]=v}return n};var i=function(t,r,e){var a=Math.round;var i,n=t.length;var s=new Float32Array(r);for(i=0;i<n;i++){var o=a(t[i]*e);if(o>=r){s[r-1]++}else{s[o]++}}var h=1/n;for(i=0;i<r;i++){s[i]*=h}return s};var n=function(t,r){var e=t.length,a=new Float32Array(e),i,n,s,o,h;for(o in t){if(t.hasOwnProperty(o)){var c=t[o];for(n=0;n<e;n++){h=t[o].length;for(i=0,s=0;s<h;s++){i+=c[s][n]}a[n]+=i}}}if(r){r=1/r;for(n=0;n<e;n++){a[n]*=r}}return a};var s=function(t,r,e){var a={};var n,s,o;var h=new Float32Array(t.length);var c=function(t,r){var e,a;for(e=0,a=r.length;e<a;e++){t[e]+=r[e]}return t};for(s in t){if(t.hasOwnProperty(s)&&s!=="length"){a[s]=[];for(n=0,o=t[s].length;n<o;n++){a[s][n]=i(t[s][n],r,e);h=c(h,t[s][n])}}}return{histograms:a,sum:h}};var o=function(t){var r;var e,i,n;for(e in t){if(t.hasOwnProperty(e)){i=0;if(r===undefined){r=t[e][0];i=1}for(n=t[e].length;i<n;i++){r=a(r,t[e][i])}}}for(i=1,n=r.length;i<n;i++){r[i]+=r[i-1]}return r};var h=function(t){var r=n(t);var e,a,i=0,s=r[0];for(e=1,a=r.length;e<a;e++){if(r[e]<s){s=r[e];i=e}}return[i,s]};var c=function(t){var r=n(t);var e=0,a=r[0];var i,s;if(r[1]<a){i=e;s=a;e=1;a=r[1]}else{i=1;s=r[1]}var o,h;for(o=2,h=r.length;o<h;o++){if(r[o]<s){if(r[o]<a){s=a;i=e;e=o;a=r[o]}else{s=r[o];i=o}}}return[e,a/s]};var l=100,p=.15,f=l/p;var v=function(t){var r=s(t,l,f);var e=r.histograms,a=r.sum;var i=o(e);var n,h,c=0,p=a[0];for(n=1,h=a.length;n<h;n++){if(a[n]<p){c=n;p=a[n]}}var v=Math.round(p*f);p=i[v]*a.length;return[c,p]};var u=function(t){var r=s(t,l,f);var e=r.histograms,a=r.sum;var i=o(e);var n,h,c=[],p=Math.round;for(n=0,h=a.length;n<h;n++){var v=p(a[n]*f);var u=i[v]*h;if(u<10){c.push([n,u])}}return c};e.NNDT=h;e.NNAC=v;e.NNDR=c;e.AC=u;e.prototype.match=function(r,e,a){e=e||this.criterion;var i=this.computeDistances(r,a);var n,s=[];if(e==="NN-DT"){n=h(i);s.push(new t.Match(0,this,n[0],r[n[0]],n[1]))}else if(e==="NN-DR"){n=c(i);s.push(new t.Match(0,this,n[0],r[n[0]],n[1]))}else if(e==="NN-AC"){n=v(i);s.push(new t.Match(0,this,n[0],r[n[0]],n[1]))}else if(e==="AC"){var o=u(i);var l,p;for(l=0,p=o.length;l<p;l++){n=o[l];s.push(new Match(0,this,n[0],r[n[0]],n[1]))}}return s};t.Keypoint=e})(Matching);var root=typeof window==="undefined"?module.exports:window;(function(t){function r(t,r,e,a){if(t instanceof Matrix!==true){throw new Error("ScaleSpace: Image must be provided.")}this.image=t.im2single();if(r!==undefined){this.nScale=r}if(e!==undefined){this.sigmaInit=e}if(a!==undefined){this.scaleRatio=a}this.scale=[]}r.prototype={nScale:13,sigmaInit:.63,scaleRatio:1.26,lapThresh:.004,harrisThresh:1e4,keypointsToString:function(){var t,r,e=this.keypoints;var a="";for(t=0,r=e.length;t<r;t++){a+=e[t].toString()+"\n"}return a},descriptorsToString:function(t){var r,e,a=this.keypoints;var i="";for(r=0,e=a.length;r<e;r++){i+=a[r].descriptorsData[t].toString()}return i},getImage:function(t,r,e){if(r===undefined){r=this.image}else{r=r.toLowerCase();if(r==="blur"||r==="gray"){r=this.scale[t][r]}else if(r==="phase-norm"){}else{r=this.scale[t].gradient[r]}}if(e===true){return r.rdivide(r.max())}return r},computeScaleSpace:function(t,r,e){this.nScale=t||this.nScale;this.sigmaInit=r||this.sigmaInit;this.scaleRatio=e||this.scaleRatio;t=this.nScale;r=this.sigmaInit;e=this.scaleRatio;var a=this.image;var i;for(i=0;i<t;i++){var n={};n.sigma=r*Math.pow(e,i);n.blur=a.gaussian(n.sigma);n.gray=n.blur.rgb2gray();n.gradient=n.gray.gradient(1,1,1,1,1);var s=Math.pow(n.sigma,2);n.gradient.laplacian.abs().times(s);this.scale[i]=n}return this},precomputeMaxLaplacian:function(){var r=this.scale;r.maxLap=[];var e=[0,0,0];var a=this.image.getView();var i=a.getStep(1),n=a.getEnd(1);var s=a.getEnd(0);var o;var h,c,l,p,f,v,u,g,m,d,y,S,w;for(h=1,c=r.length-1;h<c;h++){e[0]=r[h-1].gradient.laplacian.getData();e[1]=r[h].gradient.laplacian.getData();e[2]=r[h+1].gradient.laplacian.getData();for(l=i,p=n-i,S=1;l<p;l+=i,S++){for(f=l+1,v=l+s-1,w=1;f<v;f++,w++){var M=e[1][f];for(o=true,u=0;u<3;u++){var x=e[u];for(g=f-i,m=f+2*i;g<m;g+=i){for(d=g-1,y=g+2;d<y;d++){if(M<x[d]){o=false;g=m;u=3;break}}}}if(o){var D=new t.Keypoint(S,w,r[h].sigma,M);D.nScale=h;r.maxLap.push(D)}}}}return this},precomputeHarris:function(){var t=this.scale;var r=this.image.size(1);var e=this.image.size(0);var a,i,n;for(a=1,i=this.nScale-1;a<i;a++){var s=t[a].gradient;s.xy=new Matrix([e,r],"single");var o=s.xy.getData();var h=s.x.getData();var c=s.y.getData();for(n=e*r;n--;n){o[n]=h[n]*c[n];h[n]*=h[n];c[n]*=c[n]}var l=t[a].sigma*1.4;s.xy=s.xy.gaussian(l);s.x=s.x.gaussian(l);s.y=s.y.gaussian(l)}return this},laplacianThreshold:function(t){this.lapThresh=t||this.lapThresh;t=this.lapThresh;var r=this.scale,e=this.image.size(0);var a,i,n=[];for(a=0,i=r.maxLap.length;a<i;a++){var s=r.maxLap[a];var o=r[s.nScale].gradient.laplacian.getData();var h=o[s.x*e+s.y];if(h>t){n.push(s)}}this.keypoints=n;return this},harrisThreshold:function(t){this.harrisThresh=t||this.harrisThresh;t=this.harrisThresh;function r(t,r,e,a,i){return 4228250625*(t*r-e*e-.04*(t+r)*(t+r))-.2*i/(a*a*a*a)}var e=this;var a=this.image.getSize(0);var i,n,s=[];for(i=0,n=e.keypoints.length;i<n;i++){var o=e.keypoints[i];var h=e.scale[o.nScale];var c=h.gradient.x.getData()[o.x*a+o.y];var l=h.gradient.y.getData()[o.x*a+o.y];var p=h.gradient.xy.getData()[o.x*a+o.y];if(r(c,l,p,h.sigma,t)>0){s.push(o)}}this.keypoints=s;return this},normalizePatch:function(t){var r=t.getData();var e=t.getSize(0),a=Math.floor(e/2);var i=a*a,n=-2/i;var s=Matrix.ones(e,e,"logical"),o=s.getData();var h,c,l,p,f,v;var u,g,m,d,y=e*e;var S=0,w=0,M=0,x=0;var D=Math.exp;for(c=0,l=0,u=-a;c<e;c++,l+=e,u++){p=l;f=p+y;v=f+y;for(h=0,m=u*u,g=a;h<e;h++,p++,f++,v++,g--){d=m+g*g;if(d>i){o[p]=0}var k=D(n*d);r[p]*=k;r[f]*=k;r[v]*=k;S+=r[p];w+=r[f];M+=r[v];x+=k}}S/=x;w/=x;M/=x;var T=Math.sqrt((S*S+w*w+M*M)/3);return{patch:t,mean:[S/T,w/T,M/T],mask:s}},getImagePatch_old:function(t,r,e){var a=t.sigma;var i,n,s=0,o=Math.abs,h,c=Infinity;for(i=0,n=this.nScale;i<n;i++){h=this.scale[i].sigma-a;if(o(h)<c&&h<=0){c=o(h);s=i}}var l=r===true?this.scale[s].blur:this.scale[s].gray;var p=t.x,f=t.y,v=Math.round(t.factorSize*a);var u=Math.round;var g=u(p-v),m=u(p+v);var d=u(f-v),y=u(f+v);if(g<0||d<0){return null}else if(m>l.getSize(1)-1){return null}else if(y>l.getSize(0)-1){return null}var S=l.get([d,y],[g,m]);if(c>.01){var w=this.scale[s].sigma;a=Math.sqrt(a*a-w*w);S=S.gaussian(a)}return S},getViewOnImagePatch:function(t){var r=t.sigma;var e,a,i=0,n=Math.abs,s,o=Infinity;for(e=0,a=this.nScale;e<a;e++){s=this.scale[e].sigma-r;if(n(s)<o&&s<=0){o=n(s);i=e}}var h=this.scale[i],c=h.gray;var l=t.x,p=t.y,f=Math.round(t.factorSize*r);var v=Math.round;var u=v(l-f),g=v(l+f);var m=v(p-f),d=v(p+f);if(u<0||m<0){return null}else if(g>c.getSize(1)-1){return null}else if(d>c.getSize(0)-1){return null}return{norm:h.gradient.norm,phase:h.gradient.phase,view:c.getView().select([m,d],[u,g])}},extractMainOrientations:function(t){this.algorithm=t||this.algorithm;if(!this.keypoints){throw new Error("ScaleSpace: Keypoints have to be computed.")}var r=this.keypoints;var e,a,i=[],n,s;for(e=0,a=r.length;e<a;e++){var o=r[e];var h=this.getViewOnImagePatch(o);if(h!==null){var c=o.extractMainOrientation(h,this.algorithm);for(n=0,s=c.length;n<s;n++){var l=o.getCopy();l.orientation=c[n];i.push(l)}}}this.keypoints=i;return this},extractDescriptors:function(r){r=r||t.Keypoint.prototype.descriptors;var e=function(t,r){var e=t.nBin*t.nSector;var a=new Float32Array(r*e);var i,n=[];for(i=0;i<r;i++){n.push(a.subarray(i*e,(i+1)*e))}n.data=a;return n};if(!this.keypoints){throw new Error("ScaleSpace: Keypoints have to be computed.")}var a=this.keypoints;var i,n,s,o={},h;for(i=0;i<r.length;i++){h=r[i].name;o[h]=e(r[i],a.length)}this.descriptorsData=o;for(n=0,s=a.length;n<s;n++){var c=a[n];var l=this.getImagePatch_old(c,true);l=this.normalizePatch(l);var p=[];for(i=0;i<r.length;i++){h=r[i].name;p[h]=o[h][n]}c.extractDescriptors(l,r,p)}return this}};t.ScaleSpace=r})(Matching);var root=typeof window==="undefined"?module.exports:window;(function(t){function r(r){this.scaleSpaces=[];this.matchs=[];this.matchsList=[];var e;for(e=0;e<r.length;e++){this.scaleSpaces[e]=new t.ScaleSpace(r[e])}}r.prototype={threshold:.7,computeScaleSpace:function(t,r,e){var a,i;Tools.tic();for(a=0,i=this.scaleSpaces.length;a<i;a++){var n=this.scaleSpaces[a];n.computeScaleSpace(t,r,e);n.precomputeMaxLaplacian();n.precomputeHarris()}console.log("Compute Scale Space: ",Tools.toc());return this},applyScaleSpaceThreshold:function(t,r){var e,a;Tools.tic();for(e=0,a=this.scaleSpaces.length;e<a;e++){var i=this.scaleSpaces[e];i.laplacianThreshold(t);i.harrisThreshold(r)}console.log("Compute Thresholds: ",Tools.toc());for(e=0;e<a;e++){var i=this.scaleSpaces[e];console.log("	","Scalespace["+e+"]:",i.keypoints.length,"keypoints")}return this},computeMainOrientations:function(r){r=r||t.Keypoint.prototype.algorithm;var e,a;Tools.tic();for(e=0,a=this.scaleSpaces.length;e<a;e++){var i=this.scaleSpaces[e];i.extractMainOrientations(r)}console.log("Compute Main orientations: ",Tools.toc());for(e=0;e<a;e++){var i=this.scaleSpaces[e];console.log("	","Scalespace["+e+"]:",i.keypoints.length,"keypoints")}return this},computeDescriptors:function(t){var r,e;Tools.tic();for(r=0,e=this.scaleSpaces.length;r<e;r++){this.scaleSpaces[r].extractDescriptors(t)}console.log("Compute Descriptors: ",Tools.toc());return this},computeMatchs:function(r,e,a,i){Tools.tic();var n=this.scaleSpaces[r].keypoints;var s=this.scaleSpaces[e].keypoints;var o,h,c,l;var p=[];for(o=0,h=n.length;o<h;o++){var f=n[o].match(s,a,i);for(c=0,l=f.length;c<l;c++){f[c].k1.number=o}p.push(f)}var v=Array.prototype.concat.apply([],p);this.matchs=this.matchs||[];this.matchs[r]=this.matchs[r]||[];this.matchs[r][e]=v.sort(t.Match.compar);console.log("Matching time : ",Tools.toc());return this},thresholdMatchs:function(r,e,a,i){a=a||this.threshold;Tools.tic();var n=[],s=this.scaleSpaces[r].keypoints,o=this.scaleSpaces[e].keypoints,h=t.Keypoint.prototype.criterion;if(h==="NN-AC"||h==="AC"){a/=s.length*o.length}var c,l,p=this.matchs[r][e];if(i){p=p[i]}for(c=0,l=p.length;c<l;c++){if(p[c].distance<a){n.push(p[c])}}this.matchsList[r]=this.matchsList[r]||[];this.matchsList[r][e]=n;console.log("	","matchsList["+r+"]["+e+"]:",n.length,"matchs.");console.log("Threshold matchs time : ",Tools.toc());return this},match:function(t,r){Tools.tic();this.computeScaleSpace().applyScaleSpaceThreshold().computeMainOrientations().computeDescriptors().computeMatchs(t,r).thresholdMatchs(t,r);console.log("Global match time : ",Tools.toc());return this},matchsToString:function(t,r,e){var a=this.matchs[t][r];a=e!==undefined?a[e]:a;var i,n,s="";for(i=0,n=a.length;i<n;i++){s+=a[i].toString()+"\n"}return s}};t.Sift=r})(Matching);var root=typeof window==="undefined"?module.exports:window;(function(t){var r=function(t,r,e,a){r=r.rdivide(r.max());var i=t.getData(),n=r.getData();var s=i.length;var o=new i.constructor(s*4);var h=o.subarray(0,s);var c=o.subarray(s,s*2);var l=o.subarray(s*2,s*3);var p=o.subarray(s*3,s*4);if(a){var f=Matrix.toMatrix(i);f=f["-"](a);var v=f["<"](0);f.set(v,f.get(v)["+"](1));h.set(f.getData())}else{h.set(i)}l.set(n);var u=r.getSize(1),g=r.getSize(0);var m=u/2;var d,y,S,w,M;for(y=0,S=0;y<u;y++,S+=g){for(d=0,w=S,M=(y-m)*(y-m);d<g;d++,w++){c[w]=1;p[w]=1}}var x=t.getSize();x.push(4);var D=new Matrix(x,o);return D.applycform("HSV to RGB")};var e=t.Keypoint.NNDT,a=t.Keypoint.NNDR,i=t.Keypoint.NNAC,n=t.Keypoint.AC;var s=t.Match;t.getSkewMatrix=function(t,r){var e=Matrix.toMatrix,a=Math.cos,i=Math.sin;var n=function(t){return e([a(t),i(t),0,-i(t),a(t),0,0,0,1]).reshape([3,3])};var s=function(t,r){r=r||t;return e([t,0,0,0,r,0,0,0,1]).reshape([3,3])};var o=function(t,r){r=r||t;return e([1,0,0,0,1,0,t,r,1]).reshape([3,3])};var h=t.getSize(1),c=t.getSize(0);var l=Math.atan2(h,c);var p=o(h/2,c/2),f=p.inv();var v=n(-l),u=v.inv();var g=s(r,1);return p.mtimes(v).mtimes(g).mtimes(u).mtimes(f)};t.Keypoint.prototype.project=function(r){var e=Matrix.toMatrix;var a=Math.PI,i=Math.cos,n=Math.sin,s=Math.atan2;var o=Math.pow,h=Math.sqrt;var c=this.factorSize,l=this.sigma,p=this.x,f=this.y,v=this.orientation;var u=r.mtimes(e([p,f,1])).getData();u=new t.Keypoint(u[0],u[1]);var g=(v>.5?v-1:v)*2*a;var m=[p+i(g)*c*l,f-n(g)*c*l,1];var d=r.mtimes(e(m)).getData();g=s(u.y-d[1],d[0]-u.x)/(2*a);g=g<0?g+1:g;u.orientation=g;u.sigma=h(o(u.x-d[0],2)+o(u.y-d[1],2))/c;u.factorSize=c;return u};t.Keypoint.prototype.matchBenchmark=function(t,r,n){var o=function(t,r){var e={length:t.length};for(var a=0;a<r.length;a++){var i=r[a];if(t.hasOwnProperty(i)){e[i]=t[i]}}return e};var h=this.computeDistances(t);var c,l,p={};for(c in r){if(c==="NN-DT"){l=e(h)}else if(c==="NN-DR"){l=a(h)}else if(c==="NN-AC"){l=i(h)}p[c]=[new s(0,this,l[0],t[l[0]],l[1])]}for(c in n){var f;if(n.hasOwnProperty(c)){f=o(h,n[c]);l=a(f);p[c]=[new s(0,this,l[0],t[l[0]],l[1])]}}return p};t.ScaleSpace.prototype.projectKeypoints=function(t){var r=this.keypoints;var e=this.image;t=Matrix.toMatrix(t);var a=e.getSize(1)-1,i=e.getSize(0)-1;var n,s,o=[];for(n=0,s=r.length;n<s;n++){var h=r[n].project(t);var c=h.x-h.sigma*h.factorSize;var l=h.x+h.sigma*h.factorSize;var p=h.y-h.sigma*h.factorSize;var f=h.y+h.sigma*h.factorSize;if(c<0||p<0||l>a||f>i){continue}o.push(h)}return o};t.Sift.prototype.computeMatchsBenchmark=function(t,r,e,a){Tools.tic();var i=this.scaleSpaces[t].keypoints;var n=this.scaleSpaces[r].keypoints;var o,h,c,l,p,f={};for(p in e){f[p]=[]}for(p in a){f[p]=[]}for(o=0,h=i.length;o<h;o++){var v=i[o].matchBenchmark(n,e,a);for(p in f){var u=v[p];for(c=0,l=u.length;c<l;c++){u[c].k1.number=o}f[p].push(u)}}for(p in f){f[p]=Array.prototype.concat.apply([],f[p]);f[p].sort(s.compar)}this.matchs=this.matchs||[];this.matchs[t]=this.matchs[t]||[];this.matchs[t][r]=f;console.log("Matching Benchmark time : ",Tools.toc());return this};t.Sift.prototype.matchsValidation=function(t,r,e,a){var i=this.matchs[r||0][e||1];if(a){i=i[a]}var n=function(t,r,e){var a=function(t,r){var e=t.x-r.x,a=t.y-r.y;return Math.sqrt(e*e+a*a)};var i=t.project(e);var n=Math.min(i.sigma,r.sigma)*t.factorSize;return a(i,r)<n?true:false};var s,o;for(s=0,o=i.length;s<o;s++){var h=i[s];h.isValid=n(h.k1,h.k2,t)}};t.createCurves=function(t){var r=t.length;var e,a;var i=new Array(r),n=new Array(r),s=new Array(r);for(e=0,a=t.length;e<a;e++){var o=t[e];s[e]=o.distance;if(o.isValid){i[e]=1;n[e]=0}else{i[e]=0;n[e]=1}}return{"true":i,"false":n,threshold:s}};t.benchmark=function(r,e,a,i,n,s){n=n||{};s=s||{};var o,h;if(Tools.isArrayLike(r)){o=r[0];h=r[1]}else if(e){o=r;h=a.apply(r.imtransform(e))}else{throw new Error("Sift.benchmark: usage error")}var c=new t.Sift([o,h]);c.computeScaleSpace();if(i){c.scaleSpaces[0].laplacianThreshold().harrisThreshold();c.scaleSpaces[0].extractMainOrientations();console.log("	","Scalespace:",c.scaleSpaces[0].keypoints.length,"keypoints.");c.scaleSpaces[1].keypoints=c.scaleSpaces[0].projectKeypoints(e)}else{c.applyScaleSpaceThreshold().computeMainOrientations()}c.computeDescriptors().computeMatchsBenchmark(0,1,n,s);c.curves={};console.log(e);if(e){var l;for(l in c.matchs[0][1]){c.matchsValidation(e,0,1,l);c.curves[l]=t.createCurves(c.matchs[0][1][l])}}return c};t.ScaleSpace.prototype.getDescriptorPatch=function(e,a,i,n){var s=this.keypoints[e];var o=this.getImagePatch(s,true);var h=o.mask;var c,l;if(a!=="RGB"&&a!=="RGBNorm"){c=s.descriptorsData[a].descriptor;l=c.getPatch(o)}var p,f;if(i==="norm"){l=l[i];l=l.rdivide(l.max());h=h.cat(2,h,h)}else if(a==="RGB"||a==="RGBNorm"){l=a==="RGBNorm"?t.Descriptor.prototype.normalizeColor(o):o;l=l.patch;l=l.cat(2,Matrix.ones(l.size(0),l.size(1)));h=h.cat(2,h,h,h)}else if(a!==undefined){p=c.rings;f=c.sectors;if(c.relativeOrientation){l=r(l.phase,l.norm,true,s.orientation)}else{l=r(l.phase,l.norm,true)}h=h.cat(2,h,h,h)}l=l[".*"](h);var v=document.createElement("canvas");n=n||201;l.imshow(v,n/l.size(0));s=s.getCopy();s.x=n/2;s.y=n/2;s.sigma=n/2;s.factorSize=1;if(0&&s.histogram.modes){var u,g=s.histogram.modes.length;var m=s.orientation;for(u=0;u<g;u++){s.orientation=s.histogram.modes[u].phase;v.drawDescriptor(s,f,p,4)}s.orientation=m}else{v.drawDescriptor(s,f,p,4)}return Matrix.imread(v).im2single()};t.ScaleSpace.prototype.patchsToIm=function(t){var r=Matrix.zeros(this.image.getSize());var e;t=t||this.keypoints;for(e=t.length-1;e>-1;e--){var a=t[e];var i=a.x,n=a.y,s=Math.round(a.factorSize*a.sigma);var o=Math.round;var h=o(i-s),c=o(i+s);var l=o(n-s),p=o(n+s);var f=a.patch.RGBNorm||a.patch.RGB;var v=a.patch.RGB.mask;v=v.cat(2,v,v)[">"](0);var u=r.get([l,p],[h,c],[]);u.set(v,f.get(v));r.set([l,p],[h,c],[],u)}return r};t.Sift.prototype.createView=function(r,e,a){r.innerHTML="";var i=Math.floor;var n=this;a=a||r.clientWidth;e=e||r.clientHeight;r.style.setProperty("width",a);r.style.setProperty("height",e);var s=document.createElement("div");var o=document.createElement("div");s.style.setProperty("display","inline-block");s.style.setProperty("width",i(a/2)+"px");s.style.setProperty("height",e+"px");o.style.setProperty("display","inline-block");o.style.setProperty("width",i(a/2)+"px");o.style.setProperty("height",e+"px");o.style.setProperty("vertical-align","top");r.appendChild(s);r.appendChild(o);var h,c;var l=function(t){v();var r=new Plot("plotCurves",[c(a/2),c(e/2)],o);r.setLegend("auto");r.setOwnProperty("legend-display","auto");var i=["red","lime","blue","yellow","fuchsia","aqua","olive","purple","teal","maroon","green","navy","black","gray","sylver"];var n=0;for(var s in t){var h={id:s,stroke:i[n++]};var c=Matrix.toMatrix(t[s].false).cumsum().getData();var l=Matrix.toMatrix(t[s].true).cumsum().getData();r.addPath(c,l,h)}return r};var p=function(){if(c){c.getDrawing().parentNode.removeChild(c.getDrawing())}};var f=function(){p();var t,r=[];for(t=0;t<9;t++){r.push(new Plot("pDesc"+t,[i(a/6),i(e/6)],o));r[t].setOwnProperty("ticks-display",false)}return r};var v=function(){if(h){for(var t=0,r=h.length;t<r;t++){h[t].getDrawing().parentNode.removeChild(h[t].getDrawing())}}};var u="histograms";var g,m,d,y,S;g=new Plot("p",[i(a/2),e],s);m=new Plot("p1",[i(a/2),i(e/4)],o);d=new Plot("p2",[i(a/2),i(e/4)],o);h=f();g.setOwnProperty("ticks-display",false);g.setOwnProperty("preserve-ratio",true);m.setOwnProperty("ticks-display",false);m.setOwnProperty("preserve-ratio",true);d.setOwnProperty("ticks-display",false);d.setOwnProperty("preserve-ratio",true);var w=function(t,r,e,a){return this.scaleSpaces[t].getDescriptorPatch(r,e,a)}.bind(this);var M=function(t,r){t.clear();r.toImage(function(){t.remove("patch");t.addImage(this,0,0,{id:"patch"});t.setAxis()})};var x=t.Keypoint.prototype.descriptors;var D,k,T,P=[];var O={descriptor:x[0].name,align:"v",thresholdMatchs:function(t,r){this.thresholdMatchs(0,1,t,r);g.showMatchs(this.scaleSpaces[0].image,this.scaleSpaces[1].image,this.matchsList[0][1],O.align)}.bind(this),plots:[g,m,d,y,S],currentPatches:[k,T],getPatch:w,sift:this,selected:P,computeMatchs:function(t,r){var e,a={};for(e=0;e<t.length;e++){a[t[e]]={}}this.computeMatchs(0,1,undefined,a);if(r){O.thresholdMatchs(r)}}.bind(this),visual:function(t){console.log(t==="curves",this.curves);if(t==="histograms"){h=f()}else if(t==="curves"&&this.curves){console.log("toto");c=l(this.curves)}}};g.click=function(t){var r=this.getClosestPoint(t.x,t.y,false);if(D){D.data.setAttribute("stroke","red")}if(!r){return}D=r;D.data.setAttribute("stroke","lime");m.clear();d.clear();var e=parseInt(r.data.id,10);var a=n.matchsList[0][1][e];P.push(a);var i,s;k=w(0,a.k1.number,"RGB");T=w(1,a.k2.number,"RGB");i=w(0,a.k1.number,"RGBNorm");s=w(1,a.k2.number,"RGBNorm");k=k?k.cat(1,i):i;T=T?T.cat(1,s):s;var o;for(o=0;o<x.length;o++){i=w(0,a.k1.number,x[o].name);s=w(1,a.k2.number,x[o].name);

k=k?k.cat(1,i):i;T=T?T.cat(1,s):s}O.patch1=k;O.patch2=T;M(m,k);M(d,T);var c=n.scaleSpaces[0].keypoints[a.k1.number];var l=c.descriptorsData[O.descriptor].histograms;var p=Matrix.toMatrix(c.descriptorsData[O.descriptor].data).max().getDataScalar();var f=Matrix.colon(0,l[0].length-1);if(h){for(o=0;o<l.length;o++){h[o].clear();h[o].addHistogram(f.getData(),l[o],{colormap:true,"fill-opacity":.5});h[o].setAxis([-.5,0,l[o].length-.5,p])}}this.setCursor(r.x,r.y)};return O};if(typeof HTMLCanvasElement!=="undefined"){HTMLCanvasElement.prototype.drawDescriptor=function(t,r,e,a){var i=this.getContext("2d"),n=Math.PI;var s=function(t,r,e,a,i){this.beginPath();this.arc(0,0,e,t,r,false);this.arc(0,0,a,r,t,true);this.strokeStyle=i;this.stroke()}.bind(i);var o=t.x,h=t.y,c=t.orientation,l=t.sigma*t.factorSize;c=(c>.5?c-1:c)*2*n;i.lineWidth=a||Math.min(Math.max(l/36,1),5);var p="hsl(220, 100%, 70%)";i.save();i.translate(o,h);i.rotate(c);var f=l-i.lineWidth*.5;var v,u;if(e&&r){for(v=0;v<e.length;v++){if(r[v]===1){i.beginPath();i.strokeStyle=p;i.arc(0,0,e[v]*f,0,Math.PI*2,true);i.stroke()}else{var g=2*n/r[v];for(u=0;u<r[v];u++){s((u-.5)*g,(u+.5)*g,(v-1<0?0:e[v-1])*f,e[v]*f,p)}}}}else{i.beginPath();i.strokeStyle=p;i.arc(0,0,f,0,n*2,true);i.stroke()}i.beginPath();i.arc(0,0,.02*l,0,n*2,true);i.fillStyle="rgba(255,255,255)";i.lineWidth*=1.5;i.strokeStyle="rgb(255,255,255)";i.moveTo(0,0);i.lineTo(l-i.lineWidth*.5,0);i.fill();i.stroke();i.restore()}}var o=function(t){var r=function(t){var r,e=new Float32Array(t);for(r=0;r<t;r++){e[r]=r}return e};var e=function(t){var e=r(t.length);var a=function(r,e){return t[r]-t[e]};Array.prototype.sort.call(e,a);return e};var a,i={};for(a in t){if(t.hasOwnProperty(a)&&a!=="length"){var n,s;i[a]=[];for(n=0,s=t[a].length;n<s;n++){i[a][n]=e(t[a][n])}}}i.length=t.length;return i}})(Matching);