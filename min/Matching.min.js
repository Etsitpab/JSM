/**
 * This program is free software: you can redistribute it and/or modify    
 * it under the terms of the GNU General Public License as published by        
 * the Free Software Foundation, either version 3 of the License, or 
 * (at your option) any later version.
 * 
 * This program is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU General Public License for more details.
 * 
 * You should have received a copy of the GNU General Public License
 * along with this program.  If not, see <http://www.gnu.org/licenses/>.
 * 
 * @author Baptiste Mazin     <baptiste.mazin@telecom-paristech.fr> 
 * @author Guillaume Tartavel <guillaume.tartavel@telecom-paristech.fr> 
 */
var Matching={};if(typeof window==="undefined"){var JSM=require("../modules/JSM.js");var Matrix=JSM.Matrix;var Tools=JSM.Tools;module.exports.Matching=Matching}var root=typeof window==="undefined"?module.exports:window;(function(t){function e(t,e){var r=t.nBin,a=t.nSector,i=[];var n=e||new Float32Array(r*a);var s;for(s=0;s<a;s++){i[s]=n.subarray(s*r,(s+1)*r)}this.descriptor=t;this.histograms=i;this.nBin=r;this.nSector=a;this.data=n;this.pps=new Float32Array(a);this.sum=new Float32Array(a)}e.prototype={extractModes:function(){var t=this.histograms;var e=this.sum;var r=this.pps;var a,i;this.modes=[];for(a=0,i=t.length;a<i;a++){var n=e[a]/r[a];this.modes[a]=extractModes(t[a],true,0,r[a],n,n*n)}return this},modesToHistograms:function(){var t=this.histograms,e;var r=this.modes,a;var i=this.nBin;var n,s,o,h;var c=Math.round;for(n=0,o=e.length;n<o;n++){e=t[n];for(s=0,h=i;s<h;s++){e[s]=0}a=r[n];for(s=0,h=a.length;s<h;s++){e[c(a[s].phase*i)]=a[s].norm}}return this},normalizeModes:function(){var t=this.modes;var e,r,a,i,n;var s=this.sum;for(e=0,n=0,a=s.length;e<a;e++){n+=s[e]}n=n>0?1/n:0;for(e=0,a=t.length;e<a;e++){for(r=0,i=t[e].length;r<i;r++){t[e][r].norm*=n}}return this},processModes:function(){var t=this.modes;var e,r,a,i;for(e=0,a=t.length;e<a;e++){if(t[e].length>1){t[e].slice(0,1)}for(r=0,i=t[e].length;r<i;r++){var n=t[e][r].phase;var s=t[e][r].norm;var o=4,h=.2;n=Math.floor(n*o)/o;s=Math.floor(s*o/h)+1;s=(s>=o?o:s)/o;t[e][r].phase=n;t[e][r].norm=s}}return this},normalizeHistograms:function(){var t=this.histograms;var e=this.pps;var r,a,i,n,s;for(r=0,i=t.length,s=0;r<i;r++){if(e[r]!==0){for(a=0,n=t[r].length;a<n;a++){t[r][a]/=e[r];s+=t[r][a]}}}s=s>0?1/s:0;for(r=0;r<i;r++){for(a=0,n=t[r].length;a<n;a++){t[r][a]*=s}}return this},thresholdHistograms:function(t){var e=this.histograms;var r,a,i,n,s;for(r=0,i=e.length,s=0;r<i;r++){for(a=1,n=e[r].length;a<n;a++){if(e[r][a]>t){e[r][a]=t}}}return this},cumulHistograms:function(){var t=this.histograms,e=this.nBin,r=this.nSector;this.cumulatedData=new Float32Array(e*r);this.cumulatedHistograms=[];var a=this.cumulatedHistograms;var i,n,s;for(i=0;i<r;i++){a[i]=this.cumulatedData.subarray(i*e,(i+1)*e);a[i][0]=t[i][0];for(n=1,s=a[i].length;n<s;n++){a[i][n]=a[i][n-1]+t[i][n]}for(n=1,s=a[i].length;n<s;n++){a[i][n]=a[i][n-1]+t[i][n]}}return this},toString:function(){var t="";var e=this.histograms;var r,a,i,n;for(r=0,i=e.length;r<i;r++){for(a=0,n=e[r].length;a<n;a++){t+=e[r][a]+" "}t+="\n"}return t}};t.DescriptorData=e})(Matching);var root=typeof window==="undefined"?module.exports:window;(function(t){var e=function(t,e){if(t<0){t+=1}var r=Math.floor(t*e+.5);return r>=e?r-e:r};function r(t){var e,r;for(e in t){if(t.hasOwnProperty(e)){this[e]=t[e]}}if(this.name===undefined){throw new Error("Descriptor: Name should be specified.")}this.nSector=0;for(e=0,r=this.sectors.length;e<r;e++){this.nSector+=this.sectors[e]}if(this.rings===undefined){this.setRingsFromSectors()}if(this.colorspace.name!=="RGB"){this.convert="RGB to "+this.colorspace.name}return this}r.prototype={nBin:8,relativeOrientation:true,sectors:[1,4,4],rings:[.25,.75,1],extractModes:false,distance:"L1",normalize:false,type:"GRADIENT",colorspace:{name:"Ohta",channels:0},setRingsFromSectors:function(){var t=[],e=this.nSector,r=this.sectors;t[0]=Math.sqrt(r[0]/e);var a,i;for(a=1,i=r.length-1;a<i;a++){t[a]=Math.sqrt(r[a]/e+t[a-1]*t[a-1])}t[a]=1;this.rings=t;return this},getDataStructure:function(t){return new DescriptorData(this,t)},getHistogramNumber:function(t,r,a,i){var n=t*t+r*r,s=0;var o=this.rings,h=this.sectors;while(n>i*i*o[s]*o[s]){s++}if(s>=o.length){throw new Error("Error getHistogramNumber: Point out of descriptor")}var c=Math.atan2(r,t)/(2*Math.PI);c=(c<0?c+1:c)-a;var l=e(c,h[s]);var p,f=l;for(p=0;p<s;p++){f+=h[p]}return f},extractWeightedHistograms:function(r,a,i){i=new t.DescriptorData(this,i);var n=i.histograms;var s=i.pps;var o=i.sum;var h=a.phase.getData(),c=a.norm.getData(),l=a.view;var p=l.getFirst(2)+l.getFirst(1),f=l.getStep(1),v=l.getFirst(0);var u=l.getSize(0),g=Math.floor(u/2),m=g*g;var d=Math.exp,y=-2/m;var w=this.relativeOrientation===true?r:0;var S=this.rings,M=this.sectors;var x=new Float32Array(S.length);for(var D=0;D<S.length;D++){x[D]=g*g*S[D]*S[D]}var k=1/(2*Math.PI);var T,P,O,b;var A,H,N,C,z;for(P=0,O=p;P<u;P++,O+=f){for(T=0,b=O+v,z=(P-g)*(P-g);T<u;T++,b++){C=z+(T-g)*(T-g);if(C>m){continue}var R=e(h[b]-w,this.nBin);var H=T-g,A=P-g;var B=0;while(C>x[B]){B++}var E=Math.atan2(H,A)*k;E=(E<0?E+1:E)-r;var I=M[B];if(E<0){E+=1}var G=Math.floor(E*I+.5);var F=G>=I?G-I:G;var L,V=F;for(L=0;L<B;L++){V+=M[L]}var K=c[b];var K=d(y*C)*c[b];s[V]++;o[V]+=K;n[V][R]+=K}}return i},normalizeColor:function(t){var e=1/t.mean[0];var r=1/t.mean[1];var a=1/t.mean[2];var i=t.patch.getCopy();var n=i.getData();var s=i.getSize(0);var o=Math.floor(s/2),h=o*o;var c,l,p,f;var v,u,g,m,d=s*s;for(l=0,p=0,v=-o;l<s;l++,p+=s,v++){for(c=0,f=p,g=v*v,u=o;c<s;c++,f++,u--){m=g+u*u;if(m>h){continue}n[f]*=e;n[f+d]*=r;n[f+2*d]*=a}}return{patch:i,mean:t.mean,mask:t.mask}},getPatch:function(t){if(this.normalize===true){}var e=this.colorspace;if(e.name!=="RGB"){t=t.applycform(this.convert)}switch(this.type){case"GRADIENT":t=t.get([],[],e.channels).gradient(0,0,1,1);break;case"WEIGHTED-HISTOGRAMS":t={norm:t.get([],[],e.weightChannel),phase:t.get([],[],e.phaseChannel)};break;default:throw new Error("Descriptor: Unknown type: "+this.type+".")}return t},extractFromPatch:function(t,e,r){var a=this.extractWeightedHistograms(t,e,r);this.data=a;if(this.extractModes===true){a.extractModes();a.normalizeModes();a.processModes()}if(this.distance==="CEMD"){a.normalizeHistograms();a.cumulHistograms()}else{a.normalizeHistograms()}return a}};(function(){var t=function(t,e,r){var a,i,n,s,o,h=new Float32Array(r);for(a=0;a<r;a++){h[a]=e[a]-t[a]}for(s=0,a=1;a<r;a++){o=h[a]-h[0];s+=o>0?o:-o}for(i=1;i<r;i++){for(n=0,a=0;a<i;a++){o=h[a]-h[i];n+=o>0?o:-o}for(a++;a<r;a++){o=h[a]-h[i];n+=o>0?o:-o}s=n<s?n:s}return s/r};var e=function(t,e,r){var a,i,n;for(i=0,n=0;n<r;n++){a=t[n]-e[n];i+=a>0?a:-a}return i/r};var a=function(t,e,r){var a,i,n;for(i=0,n=0;n<r;n++){a=t[n]-e[n];i+=a*a}return i/r};var i=Math.min,n=Math.max;function s(t,e){var r=t>e?t-e:e-t;return r>1/2?1-r:r}var o=function(t,e){var r=0,a=0,h=0,c=0,l=0,p=0,f=0,v=0;if(t.length>0){r=t[0].phase;a=t[0].norm}if(t.length>1){h=t[1].phase;c=t[1].norm}if(e.length>0){l=e[0].phase;p=e[0].norm}if(e.length>1){f=e[1].phase;v=e[1].norm}if(a+c>p+v){return o(e,t)}var u=0,g=0,m=0;var d=s(r,l),y=s(r,f);var w=s(h,l),S=s(h,f);var M=d-y;var x=w-S;var D=a+c-v;if(n(M,x)<=0){if(p>=a+c){u=a;g=c}else{if(M<=x){if(p>=a){u=a;g=p-a}else{u=p;g=0}}else{if(p>=c){u=p-c;g=c}else{u=0;g=p}}}}else if(i(M,x)>=0){if(D<=0){u=0;g=0}else{if(M<=x){if(D>=a){u=a;g=p-a}else{u=p;g=0}}else{if(D>=c){u=D-c;g=c}else{u=0;g=c}}}}else{if(M<=x){if(p<=a){u=p;g=0}else{if(D<=a){u=a;g=0}else{u=a;g=D-a}}}else{if(p<=c){u=0;g=p}else{if(D<=c){u=0;g=c}else{u=D-c;g=c}}}}m=u*M+g*x+a*y+c*S;m+=(p+v-a-c)*.5;return m};r.prototype.computeDistances=function(r,i){var n=this.nSector,s=this.nBin;var h,c,l=i.length;var p=[];for(h=0;h<n;h++){p[h]=new Float32Array(l)}var f,v;var u,g;if(this.distance==="L1"){g="histograms";u=e}else if(this.distance==="L2"){g="histograms";u=a}else if(this.distance==="CEMD"){g="cumulatedHistograms";u=t}else if(this.distance==="D2M"){g="modes";u=o}if(!u){throw new Error("Sift.computeDistances: Unknown distance: "+this.distance)}f=r[g];for(c=0;c<l;c++){v=i[c][g];for(h=0;h<n;h++){p[h][c]=u(f[h],v[h],s)}}return p}})();t.Descriptor=r;t.descriptorDB={R:new r({name:"R",colorspace:{name:"RGB",channels:0}}),G:new r({name:"G",colorspace:{name:"RGB",channels:1}}),B:new r({name:"B",colorspace:{name:"RGB",channels:2}}),H:new r({name:"H",colorspace:{name:"HSL",channels:0}}),S:new r({name:"S",colorspace:{name:"HSL",channels:1}}),L:new r({name:"L",colorspace:{name:"HSL",channels:2}}),SIFT:new r({name:"SIFT"}),OHTA1:new r({name:"OHTA1",colorspace:{name:"Ohta",channels:1}}),OHTA2:new r({name:"OHTA2",colorspace:{name:"Ohta",channels:2}}),OPP1:new r({name:"OPP1",colorspace:{name:"Opponent",channels:1}}),OPP2:new r({name:"OPP2",colorspace:{name:"Opponent",channels:2}}),OHTAN1:new r({name:"OHTAN1",colorspace:{name:"OhtaNorm",channels:1}}),OHTAN2:new r({name:"OHTAN2",colorspace:{name:"OhtaNorm",channels:2}}),"HUE-NORM":new r({name:"HUE-NORM",type:"WEIGHTED-HISTOGRAMS",colorspace:{name:"HSL",weightChannel:1,phaseChannel:0},normalize:true,relativeOrientation:false}),HUE:new r({name:"HUE",type:"WEIGHTED-HISTOGRAMS",colorspace:{name:"HSL",weightChannel:1,phaseChannel:0},normalize:false,relativeOrientation:false})}})(Matching);var root=typeof window==="undefined"?module.exports:window;(function(t){function e(t,e,r,a,i){this.k1=e;this.k1.number=t;this.k2=a;this.k2.number=r;this.distance=i}e.prototype.isValid=false;e.compar=function(t,e){return t.distance-e.distance};e.prototype.toString=function(){var t=this.k1.toString(true,true,false,false)+" ";t+=this.k2.toString(true,true,false,false)+" ";t+=this.distance;t+=" "+(this.isValid?1:0);return t};t.Match=e})(Matching);var root=typeof window==="undefined"?module.exports:window;(function(t){var e=function(t,e){if(t<0){t+=1}var r=Math.floor(t*e+.5);return r>=e?r-e:r};function r(t,e,r,a){this.x=t;this.y=e;this.sigma=r;this.laplacian=a}r.prototype.nBin=36;r.prototype.algorithm="max";r.prototype.factorSize=18;r.prototype.descriptors=[t.descriptorDB["SIFT"]];r.prototype.criterion="NN-DR";r.prototype.toString=function(t,e,r,a){t=t===undefined?true:t;e=e===undefined?true:e;r=r===undefined?true:r;a=a===undefined?true:a;var i="";if(t){i+=this.x+" "}if(e){i+=this.y+" "}if(r){i+=this.sigma+" "}if(this.orientation!==undefined&a){i+=" "+this.orientation}return i};r.prototype.getCopy=function(){var t=new r(this.x,this.y,this.sigma,this.laplacian);t.nScale=this.nScale;if(this.histogram){t.histogram=this.histogram}if(this.patch){t.patch=this.patch}if(this.descriptorsData){t.descriptorsData=this.descriptorsData}if(this.orientation){t.orientation=this.orientation}return t};r.prototype.extractMainOrientation=function(t,r){this.histogram=new Float32Array(this.nBin);var a=this.histogram;var i=this.nBin;r=(r||this.algorithm).toLowerCase();this.algorithm=r;var n=e;var s=t.phase.getData(),o=t.norm.getData(),h=t.view;var c=h.getFirst(1),l=h.getStep(1),p=h.getFirst(0);var f=h.getSize(0);var v=Math.floor(f/2),u=v*v;var g=0;var m=Math.exp,d=-2/u;var y,w,S,M,x,D,k;for(S=0,M=c;S<f;S++,M+=l){for(y=0,x=M+p,D=(S-v)*(S-v);y<f;y++,x++){k=D+(y-v)*(y-v);if(k>u){continue}if(x>=s.length){console.log(x,s.length,y,S,M);throw new Error}var T=n(s[x],i);g++;a[T]+=m(d*k)*o[x]}}var P=[];switch(r){case"ac":var O=0;for(y=0;y<i;y++){O+=a[y]}O=O/g;a.nPoints=g;a.lambda=O;var b=extractModes(a,true,0,g,O,O*O);a.modes=b;for(y=0,w=b.length;y<w;y++){P.push(b[y].phase)}return P;case"max":var A=0;for(y=0,w=a.length;y<w;y++){if(a[y]>a[A]){A=y}}return[A/i];default:throw new Error("Keypoint.extractMainOrientation: "+"Wrong algorithm choice: "+this.algorithm+".")}};r.prototype.extractDescriptors=function(t,e,r){this.descriptors=e||this.descriptors;e=this.descriptors;this.descriptorsData={};var a,i,n,s;var o,h=this.orientation;for(a=0,i=e.length;a<i;a++){n=e[a];s=n.name;o=n.extractFromPatch(h,t,r[s]);this.descriptorsData[s]=o}return this};r.prototype.computeDistances=function(t,e){e=e||this.descriptorsData;var r=function(t,e){var r=[],a,i;for(a=0,i=t.length;a<i;a++){r[a]=t[a].descriptorsData[e]}return r};var a={length:t.length};var i;for(i in e){if(e.hasOwnProperty(i)){var n=this.descriptorsData[i];var s=r(t,i);var o=n.descriptor;a[i]=o.computeDistances(n,s)}}return a};var a=function(t,e){var r=t.length;var i=e.length;if(r<i){return a(e,t)}var n=new Float32Array(r+i-1),s=n.length;var o,h,c,l,p,f,v;for(p=0,f=i-1;p<f;p++){for(v=0,h=0,c=p+1,l=p;h<c;h++,l--){v+=t[h]*e[l]}n[p]=v}for(p=i-1,o=0,f=r;p<f;p++,o++){for(v=0,h=o,c=p+1,l=i-1;h<c;h++,l--){v+=t[h]*e[l]}n[p]=v}for(p=r,o=r-i+1;p<s;p++,o++){for(v=0,h=o,l=i-1;h<r;h++,l--){v+=t[h]*e[l]}n[p]=v}return n};var i=function(t,e,r){var a=Math.round;var i,n=t.length;var s=new Float32Array(e);for(i=0;i<n;i++){var o=a(t[i]*r);if(o>=e){s[e-1]++}else{s[o]++}}var h=1/n;for(i=0;i<e;i++){s[i]*=h}return s};var n=function(t,e){var r=t.length,a=new Float32Array(r),i,n,s,o,h;for(o in t){if(t.hasOwnProperty(o)){var c=t[o];for(n=0;n<r;n++){h=t[o].length;for(i=0,s=0;s<h;s++){i+=c[s][n]}a[n]+=i}}}if(e){e=1/e;for(n=0;n<r;n++){a[n]*=e}}return a};var s=function(t,e,r){var a={};var n,s,o;var h=new Float32Array(t.length);var c=function(t,e){var r,a;for(r=0,a=e.length;r<a;r++){t[r]+=e[r]}return t};for(s in t){if(t.hasOwnProperty(s)&&s!=="length"){a[s]=[];for(n=0,o=t[s].length;n<o;n++){a[s][n]=i(t[s][n],e,r);h=c(h,t[s][n])}}}return{histograms:a,sum:h}};var o=function(t){var e;var r,i,n;for(r in t){if(t.hasOwnProperty(r)){i=0;if(e===undefined){e=t[r][0];i=1}for(n=t[r].length;i<n;i++){e=a(e,t[r][i])}}}for(i=1,n=e.length;i<n;i++){e[i]+=e[i-1]}return e};var h=function(t){var e=n(t);var r,a,i=0,s=e[0];for(r=1,a=e.length;r<a;r++){if(e[r]<s){s=e[r];i=r}}return[i,s]};var c=function(t){var e=n(t);var r=0,a=e[0];var i,s;if(e[1]<a){i=r;s=a;r=1;a=e[1]}else{i=1;s=e[1]}var o,h;for(o=2,h=e.length;o<h;o++){if(e[o]<s){if(e[o]<a){s=a;i=r;r=o;a=e[o]}else{s=e[o];i=o}}}return[r,a/s]};var l=100,p=.15,f=l/p;var v=function(t){var e=s(t,l,f);var r=e.histograms,a=e.sum;var i=o(r);var n,h,c=0,p=a[0];for(n=1,h=a.length;n<h;n++){if(a[n]<p){c=n;p=a[n]}}var v=Math.round(p*f);p=i[v]*a.length;return[c,p]};var u=function(t){var e=s(t,l,f);var r=e.histograms,a=e.sum;var i=o(r);var n,h,c=[],p=Math.round;for(n=0,h=a.length;n<h;n++){var v=p(a[n]*f);var u=i[v]*h;if(u<10){c.push([n,u])}}return c};r.NNDT=h;r.NNAC=v;r.NNDR=c;r.AC=u;r.prototype.match=function(e,r,a){r=r||this.criterion;var i=this.computeDistances(e,a);var n,s=[];if(r==="NN-DT"){n=h(i);s.push(new t.Match(0,this,n[0],e[n[0]],n[1]))}else if(r==="NN-DR"){n=c(i);s.push(new t.Match(0,this,n[0],e[n[0]],n[1]))}else if(r==="NN-AC"){n=v(i);s.push(new t.Match(0,this,n[0],e[n[0]],n[1]))}else if(r==="AC"){var o=u(i);var l,p;for(l=0,p=o.length;l<p;l++){n=o[l];s.push(new Match(0,this,n[0],e[n[0]],n[1]))}}return s};t.Keypoint=r})(Matching);var root=typeof window==="undefined"?module.exports:window;(function(t){function e(t,e,r,a){if(t instanceof Matrix!==true){throw new Error("ScaleSpace: Image must be provided.")}this.image=t.im2single();if(e!==undefined){this.nScale=e}if(r!==undefined){this.sigmaInit=r}if(a!==undefined){this.scaleRatio=a}this.scale=[]}e.prototype={nScale:9,sigmaInit:.63,scaleRatio:1.26,lapThresh:.004,harrisThresh:1e4,keypointsToString:function(){var t,e,r=this.keypoints;var a="";for(t=0,e=r.length;t<e;t++){a+=r[t].toString()+"\n"}return a},descriptorsToString:function(t){var e,r,a=this.keypoints;var i="";for(e=0,r=a.length;e<r;e++){i+=a[e].descriptorsData[t].toString()}return i},getImage:function(t,e,r,a){if(e===undefined){e=this.image;return r===true?e:Matrix.rdivide(e,e.max())}var t=this.scale[t];if(e==="blur"||e==="gray"){e=t[e]}else if(e==="phase-norm"){}else{e=t.gradient[e]}return r===true?Matrix.rdivide(e,e.max()):e},computeScaleSpace:function(t,e,r){this.nScale=t||this.nScale;this.sigmaInit=e||this.sigmaInit;this.scaleRatio=r||this.scaleRatio;t=this.nScale;e=this.sigmaInit;r=this.scaleRatio;var a=this.image;var i;for(i=0;i<t;i++){var n={};n.sigma=e*Math.pow(r,i);n.blur=a.gaussian(n.sigma);n.gray=n.blur.rgb2gray();n.gradient=n.gray.gradient(1,1,1,1,1);var s=Math.pow(n.sigma,2);n.gradient.laplacian.abs().times(s);this.scale[i]=n}return this},precomputeMaxLaplacian:function(){var e=this.scale;e.maxLap=[];var r=[0,0,0];var a=this.image.getView();var i=a.getStep(1),n=a.getEnd(1);var s=a.getEnd(0);var o;var h,c,l,p,f,v,u,g,m,d,y,w,S;for(h=1,c=e.length-1;h<c;h++){r[0]=e[h-1].gradient.laplacian.getData();r[1]=e[h].gradient.laplacian.getData();r[2]=e[h+1].gradient.laplacian.getData();for(l=i,p=n-i,w=1;l<p;l+=i,w++){for(f=l+1,v=l+s-1,S=1;f<v;f++,S++){var M=r[1][f];for(o=true,u=0;u<3;u++){var x=r[u];for(g=f-i,m=f+2*i;g<m;g+=i){for(d=g-1,y=g+2;d<y;d++){if(M<x[d]){o=false;g=m;u=3;break}}}}if(o){var D=new t.Keypoint(w,S,e[h].sigma,M);D.nScale=h;e.maxLap.push(D)}}}}return this},precomputeHarris:function(){var t=this.scale;var e=this.image.size(1);var r=this.image.size(0);var a,i,n;for(a=1,i=this.nScale-1;a<i;a++){var s=t[a].gradient;s.xy=new Matrix([r,e],"single");var o=s.xy.getData();var h=s.x.getData();var c=s.y.getData();for(n=r*e;n--;n){o[n]=h[n]*c[n];h[n]*=h[n];c[n]*=c[n]}var l=t[a].sigma*1.4;s.xy=s.xy.gaussian(l);s.x=s.x.gaussian(l);s.y=s.y.gaussian(l)}return this},laplacianThreshold:function(t){this.lapThresh=t||this.lapThresh;t=this.lapThresh;var e=this.scale,r=this.image.size(0);var a,i,n=[];for(a=0,i=e.maxLap.length;a<i;a++){var s=e.maxLap[a];var o=e[s.nScale].gradient.laplacian.getData();var h=o[s.x*r+s.y];if(h>t){n.push(s)}}this.keypoints=n;return this},harrisThreshold:function(t){this.harrisThresh=t||this.harrisThresh;t=this.harrisThresh;function e(t,e,r,a,i){return 4228250625*(t*e-r*r-.04*(t+e)*(t+e))-.2*i/(a*a*a*a)}var r=this;var a=this.image.getSize(0);var i,n,s=[];for(i=0,n=r.keypoints.length;i<n;i++){var o=r.keypoints[i];var h=r.scale[o.nScale];var c=h.gradient.x.getData()[o.x*a+o.y];var l=h.gradient.y.getData()[o.x*a+o.y];var p=h.gradient.xy.getData()[o.x*a+o.y];if(e(c,l,p,h.sigma,t)>0){s.push(o)}}this.keypoints=s;return this},getViewOnImagePatch:function(t,e,r,a){var i=t.sigma;var n,s,o=0,h=Math.abs,c,l=Infinity;for(n=0,s=this.nScale;n<s;n++){c=this.scale[n].sigma-i;if(h(c)<l&&c<=0){l=h(c);o=n}}var p=this.scale[o],f=p["gray"],v=p.gradient,u=[];var g=t.x,m=t.y,d=Math.round(t.factorSize*i);var y=Math.round;var w=y(g-d),S=y(g+d);var M=y(m-d),x=y(m+d);if(w<0||M<0){return null}else if(S>f.getSize(1)-1){return null}else if(x>f.getSize(0)-1){return null}var D=f.getView().select([M,x],[w,S]);if(e instanceof Object){var k=e.name;if(p[k]===undefined){p[k]={image:Matrix.applycform(p["blur"],"RGB to "+k)}}f=p[k].image;if(r==="GRADIENT"){if(p[k].gradient===undefined){p[k].gradient=f.gradient(0,0,1,1);p[k].gradientView=p[k].gradient.norm.getView()}v=p[k].gradient;D=p[k].gradientView.restore().select([M,x],[w,S],e.channels)}else if(r==="WEIGHTED-HISTOGRAMS"){if(p[k].colorChannels===undefined){p[k].colorChannels={norm:f.get([],[],e.weightChannel),phase:f.get([],[],e.phaseChannel)};p[k].colorChannelsView=p[k].colorChannels.norm.getView()}v=p[k].colorChannels;D=p[k].colorChannelsView.restore().select([M,x],[w,S],0)}else{D=f.getView().select([M,x],[w,S],e.channels)}}if(a===true){}return{norm:v.norm,phase:v.phase,image:f,view:D}},extractMainOrientations:function(t){this.algorithm=t||this.algorithm;if(!this.keypoints){throw new Error("ScaleSpace: Keypoints have to be computed.")}var e=this.keypoints;var r,a,i=[],n,s;for(r=0,a=e.length;r<a;r++){var o=e[r];var h=this.getViewOnImagePatch(o,"gray");if(h!==null){var c=o.extractMainOrientation(h,this.algorithm);for(n=0,s=c.length;n<s;n++){var l=o.getCopy();l.orientation=c[n];i.push(l)}}}this.keypoints=i;return this},extractDescriptors:function(e){e=e||t.Keypoint.prototype.descriptors;var r=function(t,e){var r=t.nBin*t.nSector;var a=new Float32Array(e*r);var i,n=[];for(i=0;i<e;i++){n.push(a.subarray(i*r,(i+1)*r))}n.data=a;return n};if(!this.keypoints){throw new Error("ScaleSpace: Keypoints have to be computed.")}var a=this.keypoints;var i,n,s,o={},h;for(i=0;i<e.length;i++){h=e[i].name;o[h]=r(e[i],a.length)}this.descriptorsData=o;for(n=0,s=a.length;n<s;n++){a[n].descriptorsData=a[n].descriptorsData||{}}for(i=0;i<e.length;i++){var c=e[i],h=c.name,l=o[h],p=c.colorspace,f=c.type;for(n=0,s=a.length;n<s;n++){var v=a[n],u=this.getViewOnImagePatch(v,p,f);v.descriptorsData[h]=c.extractFromPatch(v.orientation,u,l[n])}}return this}};t.ScaleSpace=e})(Matching);var root=typeof window==="undefined"?module.exports:window;(function(t){function e(e){this.scaleSpaces=[];this.matchs=[];this.matchsList=[];var r;for(r=0;r<e.length;r++){this.scaleSpaces[r]=new t.ScaleSpace(e[r])}}e.prototype={threshold:.7,computeScaleSpace:function(t,e,r){var a,i;Tools.tic();for(a=0,i=this.scaleSpaces.length;a<i;a++){var n=this.scaleSpaces[a];n.computeScaleSpace(t,e,r);n.precomputeMaxLaplacian();n.precomputeHarris()}console.log("Compute Scale Space: ",Tools.toc(),"ms");return this},applyScaleSpaceThreshold:function(t,e){var r,a;Tools.tic();for(r=0,a=this.scaleSpaces.length;r<a;r++){var i=this.scaleSpaces[r];i.laplacianThreshold(t);i.harrisThreshold(e)}console.log("Compute Thresholds: ",Tools.toc(),"ms");for(r=0;r<a;r++){var i=this.scaleSpaces[r];console.log("	","Scalespace["+r+"]:",i.keypoints.length,"keypoints")}return this},computeMainOrientations:function(e){e=e||t.Keypoint.prototype.algorithm;var r,a;Tools.tic();for(r=0,a=this.scaleSpaces.length;r<a;r++){var i=this.scaleSpaces[r];i.extractMainOrientations(e)}console.log("Compute Main orientations: ",Tools.toc(),"ms");for(r=0;r<a;r++){var i=this.scaleSpaces[r];console.log("	","Scalespace["+r+"]:",i.keypoints.length,"keypoints")}return this},computeDescriptors:function(t){var e,r;Tools.tic();for(e=0,r=this.scaleSpaces.length;e<r;e++){this.scaleSpaces[e].extractDescriptors(t)}console.log("Compute Descriptors: ",Tools.toc(),"ms");return this},computeMatchs:function(e,r,a,i){Tools.tic();var n=this.scaleSpaces[e].keypoints;var s=this.scaleSpaces[r].keypoints;var o,h,c,l;var p=[];for(o=0,h=n.length;o<h;o++){var f=n[o].match(s,a,i);for(c=0,l=f.length;c<l;c++){f[c].k1.number=o}p.push(f)}var v=Array.prototype.concat.apply([],p);this.matchs=this.matchs||[];this.matchs[e]=this.matchs[e]||[];this.matchs[e][r]=v.sort(t.Match.compar);console.log("Matching time : ",Tools.toc(),"ms");return this},thresholdMatchs:function(e,r,a,i){a=a||this.threshold;Tools.tic();var n=[],s=this.scaleSpaces[e].keypoints,o=this.scaleSpaces[r].keypoints,h=t.Keypoint.prototype.criterion;if(h==="NN-AC"||h==="AC"){a/=s.length*o.length}var c,l,p=this.matchs[e][r];if(i){p=p[i]}for(c=0,l=p.length;c<l;c++){if(p[c].distance<a){n.push(p[c])}}this.matchsList[e]=this.matchsList[e]||[];this.matchsList[e][r]=n;console.log("	","matchsList["+e+"]["+r+"]:",n.length,"matchs.");console.log("Threshold matchs time : ",Tools.toc(),"ms");return this},match:function(t,e){Tools.tic();this.computeScaleSpace().applyScaleSpaceThreshold().computeMainOrientations().computeDescriptors().computeMatchs(t,e).thresholdMatchs(t,e);console.log("Global match time : ",Tools.toc(),"ms");return this},matchsToString:function(t,e,r){var a=this.matchs[t][e];a=r!==undefined?a[r]:a;var i,n,s="";for(i=0,n=a.length;i<n;i++){s+=a[i].toString()+"\n"}return s}};t.Sift=e})(Matching);var root=typeof window==="undefined"?module.exports:window;(function(t){var e=function(t,e,r,a){e=e.rdivide(e.max());var i=t.getData(),n=e.getData();var s=i.length;var o=new i.constructor(s*4);var h=o.subarray(0,s);var c=o.subarray(s,s*2);var l=o.subarray(s*2,s*3);var p=o.subarray(s*3,s*4);if(a){var f=Matrix.toMatrix(i);f=f["-"](a);var v=f["<"](0);f.set(v,f.get(v)["+"](1));h.set(f.getData())}else{h.set(i)}l.set(n);var u=e.getSize(1),g=e.getSize(0);var m=u/2;var d,y,w,S,M;for(y=0,w=0;y<u;y++,w+=g){for(d=0,S=w,M=(y-m)*(y-m);d<g;d++,S++){c[S]=1;p[S]=1}}var x=t.getSize();x.push(4);var D=new Matrix(x,o);return D.applycform("HSV to RGB")};var r=t.Keypoint.NNDT,a=t.Keypoint.NNDR,i=t.Keypoint.NNAC,n=t.Keypoint.AC;var s=t.Match;t.getSkewMatrix=function(t,e){var r=Matrix.toMatrix,a=Math.cos,i=Math.sin;var n=function(t){return r([a(t),i(t),0,-i(t),a(t),0,0,0,1]).reshape([3,3])};var s=function(t,e){e=e||t;return r([t,0,0,0,e,0,0,0,1]).reshape([3,3])};var o=function(t,e){e=e||t;return r([1,0,0,0,1,0,t,e,1]).reshape([3,3])};var h=t.getSize(1),c=t.getSize(0);var l=Math.atan2(h,c);var p=o(h/2,c/2),f=p.inv();var v=n(-l),u=v.inv();var g=s(e,1);return p.mtimes(v).mtimes(g).mtimes(u).mtimes(f)};t.Keypoint.prototype.project=function(e){var r=Matrix.toMatrix;var a=Math.PI,i=Math.cos,n=Math.sin,s=Math.atan2;var o=Math.pow,h=Math.sqrt;var c=this.factorSize,l=this.sigma,p=this.x,f=this.y,v=this.orientation;var u=e.mtimes(r([p,f,1])).getData();u=new t.Keypoint(u[0],u[1]);var g=(v>.5?v-1:v)*2*a;var m=[p+i(g)*c*l,f-n(g)*c*l,1];var d=e.mtimes(r(m)).getData();g=s(u.y-d[1],d[0]-u.x)/(2*a);g=g<0?g+1:g;u.orientation=g;u.sigma=h(o(u.x-d[0],2)+o(u.y-d[1],2))/c;u.factorSize=c;return u};t.Keypoint.prototype.matchBenchmark=function(t,e,n){var o=function(t,e){var r={length:t.length};for(var a=0;a<e.length;a++){var i=e[a];if(t.hasOwnProperty(i)){r[i]=t[i]}}return r};var h=this.computeDistances(t);var c,l,p={};for(c in e){if(c==="NN-DT"){l=r(h)}else if(c==="NN-DR"){l=a(h)}else if(c==="NN-AC"){l=i(h)}p[c]=[new s(0,this,l[0],t[l[0]],l[1])]}for(c in n){var f;if(n.hasOwnProperty(c)){f=o(h,n[c]);l=a(f);p[c]=[new s(0,this,l[0],t[l[0]],l[1])]}}return p};t.ScaleSpace.prototype.projectKeypoints=function(t){var e=this.keypoints;var r=this.image;t=Matrix.toMatrix(t);var a=r.getSize(1)-1,i=r.getSize(0)-1;var n,s,o=[];for(n=0,s=e.length;n<s;n++){var h=e[n].project(t);var c=h.x-h.sigma*h.factorSize;var l=h.x+h.sigma*h.factorSize;var p=h.y-h.sigma*h.factorSize;var f=h.y+h.sigma*h.factorSize;if(c<0||p<0||l>a||f>i){continue}o.push(h)}return o};t.Sift.prototype.computeMatchsBenchmark=function(t,e,r,a){Tools.tic();var i=this.scaleSpaces[t].keypoints;var n=this.scaleSpaces[e].keypoints;var o,h,c,l,p,f={};for(p in r){f[p]=[]}for(p in a){f[p]=[]}for(o=0,h=i.length;o<h;o++){var v=i[o].matchBenchmark(n,r,a);for(p in f){var u=v[p];for(c=0,l=u.length;c<l;c++){u[c].k1.number=o}f[p].push(u)}}for(p in f){f[p]=Array.prototype.concat.apply([],f[p]);f[p].sort(s.compar)}this.matchs=this.matchs||[];this.matchs[t]=this.matchs[t]||[];this.matchs[t][e]=f;console.log("Matching time : ",Tools.toc(),"ms");return this};t.Sift.prototype.matchsValidation=function(t,e,r,a){var i=this.matchs[e||0][r||1];if(a){i=i[a]}var n=function(t,e,r){var a=function(t,e){var r=t.x-e.x,a=t.y-e.y;return Math.sqrt(r*r+a*a)};var i=t.project(r);var n=Math.min(i.sigma,e.sigma)*t.factorSize;return a(i,e)<n?true:false};var s,o;for(s=0,o=i.length;s<o;s++){var h=i[s];h.isValid=n(h.k1,h.k2,t)}};t.createCurves=function(t){var e=t.length;var r,a;var i=new Array(e),n=new Array(e),s=new Array(e);for(r=0,a=t.length;r<a;r++){var o=t[r];s[r]=o.distance;if(o.isValid){i[r]=1;n[r]=0}else{i[r]=0;n[r]=1}}return{"true":i,"false":n,threshold:s}};t.benchmark=function(e,r,a,i,n,s){n=n||{};s=s||{};var o,h;if(Tools.isArrayLike(e)){o=e[0];h=e[1]}else if(r){o=e;h=a.apply(e.imtransform(r))}else{throw new Error("Sift.benchmark: usage error")}Tools.tic();var c=new t.Sift([o,h]);c.computeScaleSpace();if(i){c.scaleSpaces[0].laplacianThreshold().harrisThreshold();c.scaleSpaces[0].extractMainOrientations();console.log("	","Scalespace:",c.scaleSpaces[0].keypoints.length,"keypoints.");c.scaleSpaces[1].keypoints=c.scaleSpaces[0].projectKeypoints(r)}else{c.applyScaleSpaceThreshold().computeMainOrientations()}c.computeDescriptors().computeMatchsBenchmark(0,1,n,s);c.curves={};if(r){var l;for(l in c.matchs[0][1]){c.matchsValidation(r,0,1,l);c.curves[l]=t.createCurves(c.matchs[0][1][l])}}console.log("Benchmark time:",Tools.toc(),"ms");return c};t.ScaleSpace.prototype.getDescriptorPatch=function(t,r,a,i){var n=this.keypoints[t];var s=this.getViewOnImagePatch(n,{name:"RGB",channels:[]});s=s.image.extractViewFrom(s.view);var o=s.mask;var h,c;if(r!=="RGB"&&r!=="RGBNorm"){h=n.descriptorsData[r].descriptor;c=this.getViewOnImagePatch(n,h.colorspace,h.type,h.normalize);c.phase=c.phase.extractViewFrom(c.view);c.norm=c.norm.extractViewFrom(c.view)}var l,p;if(a==="norm"){c=c[a];c=c.rdivide(c.max())}else if(r==="RGB"||r==="RGBNorm"){c=s;c=c.cat(2,Matrix.ones(c.size(0),c.size(1)))}else if(r!==undefined){l=h.rings;p=h.sectors;if(h.relativeOrientation){c=e(c.phase,c.norm,true,n.orientation)}else{c=e(c.phase,c.norm,true)}}var f=document.createElement("canvas");i=i||201;c.imshow(f,i/c.size(0));n=n.getCopy();n.x=i/2;n.y=i/2;n.sigma=i/2;n.factorSize=1;if(0&&n.histogram.modes){var v,u=n.histogram.modes.length;var g=n.orientation;for(v=0;v<u;v++){n.orientation=n.histogram.modes[v].phase;f.drawDescriptor(n,p,l,4)}n.orientation=g}else{f.drawDescriptor(n,p,l,4)}return Matrix.imread(f).im2single()};t.Sift.prototype.createView=function(e,r,a){e.innerHTML="";var i=Math.floor;var n=this;a=a||e.clientWidth-50;r=r||e.clientHeight;e.style.setProperty("width",a);e.style.setProperty("height",r);var s=document.createElement("div");var o=document.createElement("div");s.style.setProperty("display","inline-block");s.style.setProperty("width",i(a/2)+"px");s.style.setProperty("height",r+"px");o.style.setProperty("display","inline-block");o.style.setProperty("width",i(a/2)+"px");o.style.setProperty("height",r+"px");o.style.setProperty("vertical-align","top");e.appendChild(s);e.appendChild(o);var h,c;var l=function(t){v();var e=new Plot("plotCurves",[c(a/2),c(r/2)],o);e.setLegend("auto");e.setOwnProperty("legend-display","auto");var i=["red","lime","blue","yellow","fuchsia","aqua","olive","purple","teal","maroon","green","navy","black","gray","sylver"];var n=0;for(var s in t){var h={id:s,stroke:i[n++]};var c=Matrix.toMatrix(t[s].false).cumsum().getData();var l=Matrix.toMatrix(t[s].true).cumsum().getData();e.addPath(c,l,h)}return e};var p=function(){if(c){c.getDrawing().parentNode.removeChild(c.getDrawing())}};var f=function(){p();var t,e=[];for(t=0;t<9;t++){e.push(new Plot("pDesc"+t,[i(a/6),i(r/6)],o));e[t].setOwnProperty("ticks-display",false)}return e};var v=function(){if(h){for(var t=0,e=h.length;t<e;t++){h[t].getDrawing().parentNode.removeChild(h[t].getDrawing())}}};var u="histograms";var g,m,d,y,w;g=new Plot("p",[i(a/2),r],s);m=new Plot("p1",[i(a/2),i(r/4)],o);d=new Plot("p2",[i(a/2),i(r/4)],o);h=f();g.setOwnProperty("ticks-display",false);g.setOwnProperty("preserve-ratio",true);m.setOwnProperty("ticks-display",false);m.setOwnProperty("preserve-ratio",true);d.setOwnProperty("ticks-display",false);d.setOwnProperty("preserve-ratio",true);var S=function(t,e,r,a){return this.scaleSpaces[t].getDescriptorPatch(e,r,a)}.bind(this);var M=function(t,e){t.clear();e.toImage(function(){t.remove("patch");t.addImage(this,0,0,{id:"patch"});t.setAxis()})};var x=t.Keypoint.prototype.descriptors;var D,k,T,P=[];var O={descriptor:x[0].name,align:"v",thresholdMatchs:function(t,e){this.thresholdMatchs(0,1,t,e);g.showMatchs(this.scaleSpaces[0].image,this.scaleSpaces[1].image,this.matchsList[0][1],O.align)}.bind(this),plots:[g,m,d,y,w],currentPatches:[k,T],getPatch:S,sift:this,selected:P,computeMatchs:function(t,e){var r,a={};for(r=0;r<t.length;r++){a[t[r]]={}}this.computeMatchs(0,1,undefined,a);if(e){O.thresholdMatchs(e)}}.bind(this),visual:function(t){console.log(t==="curves",this.curves);if(t==="histograms"){h=f()}else if(t==="curves"&&this.curves){c=l(this.curves)}}};g.click=function(t){var e=this.getClosestPoint(t.x,t.y,false);if(D){D.data.setAttribute("stroke","red")}if(!e){return}D=e;D.data.setAttribute("stroke","lime");m.clear();d.clear();var r=parseInt(e.data.id,10);var a=n.matchsList[0][1][r];P.push(a);var i,s;k=S(0,a.k1.number,"RGB");T=S(1,a.k2.number,"RGB");i=S(0,a.k1.number,"RGBNorm");s=S(1,a.k2.number,"RGBNorm");k=k?k.cat(1,i):i;T=T?T.cat(1,s):s;var o;for(o=0;o<x.length;o++){i=S(0,a.k1.number,x[o].name);s=S(1,a.k2.number,x[o].name);k=k?k.cat(1,i):i;T=T?T.cat(1,s):s}O.patch1=k;O.patch2=T;M(m,k);M(d,T);var c=n.scaleSpaces[0].keypoints[a.k1.number];var l=c.descriptorsData[O.descriptor].histograms;var p=Matrix.toMatrix(c.descriptorsData[O.descriptor].data).max().getDataScalar();var f=Matrix.colon(0,l[0].length-1);if(h){for(o=0;o<l.length;o++){h[o].clear();h[o].addHistogram(f.getData(),l[o],{colormap:true,"fill-opacity":.5});h[o].setAxis([-.5,0,l[o].length-.5,p])}}this.setCursor(e.x,e.y)};return O};if(typeof HTMLCanvasElement!=="undefined"){HTMLCanvasElement.prototype.drawDescriptor=function(t,e,r,a){var i=this.getContext("2d"),n=Math.PI;var s=function(t,e,r,a,i){this.beginPath();this.arc(0,0,r,t,e,false);this.arc(0,0,a,e,t,true);this.strokeStyle=i;this.stroke()}.bind(i);var o=t.x,h=t.y,c=t.orientation,l=t.sigma*t.factorSize;c=(c>.5?c-1:c)*2*n;i.lineWidth=a||Math.min(Math.max(l/36,1),5);

var p="hsl(220, 100%, 70%)";i.save();i.translate(o,h);i.rotate(c);var f=l-i.lineWidth*.5;var v,u;if(r&&e){for(v=0;v<r.length;v++){if(e[v]===1){i.beginPath();i.strokeStyle=p;i.arc(0,0,r[v]*f,0,Math.PI*2,true);i.stroke()}else{var g=2*n/e[v];for(u=0;u<e[v];u++){s((u-.5)*g,(u+.5)*g,(v-1<0?0:r[v-1])*f,r[v]*f,p)}}}}else{i.beginPath();i.strokeStyle=p;i.arc(0,0,f,0,n*2,true);i.stroke()}i.beginPath();i.arc(0,0,.02*l,0,n*2,true);i.fillStyle="rgba(255,255,255)";i.lineWidth*=1.5;i.strokeStyle="rgb(255,255,255)";i.moveTo(0,0);i.lineTo(l-i.lineWidth*.5,0);i.fill();i.stroke();i.restore()}}var o=function(t){var e=function(t){var e,r=new Float32Array(t);for(e=0;e<t;e++){r[e]=e}return r};var r=function(t){var r=e(t.length);var a=function(e,r){return t[e]-t[r]};Array.prototype.sort.call(r,a);return r};var a,i={};for(a in t){if(t.hasOwnProperty(a)&&a!=="length"){var n,s;i[a]=[];for(n=0,s=t[a].length;n<s;n++){i[a][n]=r(t[a][n])}}}i.length=t.length;return i}})(Matching);