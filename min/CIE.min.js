/**
 * This program is free software: you can redistribute it and/or modify    
 * it under the terms of the GNU General Public License as published by        
 * the Free Software Foundation, either version 3 of the License, or 
 * (at your option) any later version.
 * 
 * This program is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU General Public License for more details.
 * 
 * You should have received a copy of the GNU General Public License
 * along with this program.  If not, see <http://www.gnu.org/licenses/>.
 * 
 * @author Baptiste Mazin     <baptiste.mazin@telecom-paristech.fr> 
 * @author Guillaume Tartavel <guillaume.tartavel@telecom-paristech.fr> 
 */
(function(r){"use strict";var t={VonKries:[.3897,-.2298,0,.689,1.1834,0,-.0787,.0464,1],Bradford:[.8951,-.7502,.0389,.2664,1.7135,-.0685,-.1614,.0367,1.0296],CAT02:[.7328,-.7036,.003,.4296,1.6975,.0136,-.1624,.0061,.9834]};var n={getIlluminantList:function(){return["A","B","C","D50","D55","D65","D75","E","F1","F2","F3","F4","F5","F6","F7","F8","F9","F10","F11","F12"]},setIlluminant:function(r){if(r===undefined){n.currentIlluminant="D65"}else{try{n.getIlluminant(r)}catch(e){throw new Error("CIE.setIlluminant: "+e.message)}n.currentIlluminant=r}return n},setPrimaries:function(r){if(r===undefined){n.currentPrimaries="sRGB"}else{try{n.getPrimaries(r)}catch(e){throw new Error("CIE.setPrimaries: "+e.message)}n.currentPrimaries=r}return n},getIlluminant:function(e,t){if(e===undefined||e==="current"){return n.getIlluminant(n.currentIlluminant,t)}t=t||"xyY";var a={A:{stdIll:[.44757,.40745,1],CCT:2856},B:{stdIll:[.34842,.35161,1],CCT:4874},C:{stdIll:[.31006,.31616,1],CCT:6774},D50:{stdIll:[.34567,.3585,1],CCT:5003},D55:{stdIll:[.33242,.34743,1],CCT:5503},D65:{stdIll:[.31271,.32902,1],CCT:6504},D75:{stdIll:[.29902,.31485,1],CCT:7504},E:{stdIll:[1/3,1/3,1],CCT:5454},F1:{stdIll:[.3131,.33727,1],CCT:6430},F2:{stdIll:[.37208,.37529,1],CCT:4230},F3:{stdIll:[.4091,.3943,1],CCT:3450},F4:{stdIll:[.44018,.40329,1],CCT:2940},F5:{stdIll:[.31379,.34531,1],CCT:6350},F6:{stdIll:[.3779,.38835,1],CCT:4150},F7:{stdIll:[.31292,.32933,1],CCT:6500},F8:{stdIll:[.34588,.35875,1],CCT:5e3},F9:{stdIll:[.37417,.37281,1],CCT:4150},F10:{stdIll:[.34609,.35986,1],CCT:5e3},F11:{stdIll:[.38052,.37713,1],CCT:4e3},F12:{stdIll:[.43695,.40441,1],CCT:3e3}};var i=a[e];if(!i){throw new Error("CIE.getIlluminant: "+e+" is an invalid illuminant request.")}if(t!=="xyY"){try{i.stdIll=r.Colorspaces["xyY to "+t](i.stdIll)}catch(l){throw new Error("CIE.getIlluminant: "+l.message)}}return i.stdIll},getPrimaries:function(e,t){if(e===undefined||e==="current"){return n.getPrimaries(n.currentPrimaries,t)}t=t||"xyY";var a;if(e==="CIE 1931"){a=[.73467,.26533,1,.27375,.71741,1,.16658,.00885,1]}else if(e==="sRGB"){a=[.64,.33,1,.3,.6,1,.15,.06,1]}else if(e==="Adobe RGB 1998"){a=[.64,.33,1,.21,.71,1,.15,.06,1]}else if(e==="NTSC"){a=[.67,.33,1,.21,.71,1,.14,.08,1]}else{throw new Error("CIE.getPrimaries: "+e+" is an invalid primaries request.")}if(t!=="xyY"){try{var i=n.currentPrimaries;n.setPrimaries(e);a=r.Colorspaces["xyY to "+t](a,3,1,3);n.setPrimaries(i)}catch(l){throw new Error("CIE.getPrimaries: "+l.message)}}return a},getXYZTransform:function(e){var t=n.getIlluminant(),a=n.getPrimaries();return r.Colorspaces.getXYZTransform(e,t,a)},getIlluminantConversionMatrix:function(e,a,i){var l="CIE.getIlluminantConversionMatrix: ";var o=function(r){if(typeof r==="string"){return n.getIlluminant(r)}if(typeof r==="number"){return n["CCT to xyY"](r)}if(!a.length){throw new Error(l+"Illuminant must be a string, "+"a number or an Array.")}return Array.prototype.slice.apply(r)};a=a===undefined?n.getIlluminant():o(a);e=o(e);i=i===undefined?"CAT02":i;i=t[i];if(i===undefined){throw new Error(l+"Available models are "+"'VonKries', 'Bradford' and 'CAT02'")}var s=new Matrix([3,3],i);var u=s.inv();var C=s.mtimes(r.Colorspaces["xyY to XYZ"](a));var c=s.mtimes(r.Colorspaces["xyY to XYZ"](e));var g=Matrix.diag(c["./"](C));var m=n.getXYZTransform(),f=m.inv();return f.mtimes(u.mtimes(g.mtimes(s.mtimes(m))))},getDaylightChromaticity:function(r){var e,t;if(r>=4e3&&r<=7e3){e=.244063+.09911*1e3/r+2.9678*1e6/(r*r)-4.607*1e9/(r*r*r)}else if(r>7e3&&r<=25e3){e=.23704+.24748*1e3/r+1.9018*1e6/(r*r)-2.0064*1e9/(r*r*r)}else{throw new Error("CIE.getDaylightChromaticity: Color temperature "+"must be in range [4000, 25000]")}t=2.87*e-3*e*e-.275;return[e,t,1]},getPlanckianChromaticity:function(r){var e=0,t=0,n=Math.pow;if(1667<=r&&r<=4e3){e=-266123900/n(r,3)-234358/n(r,2)+877.6956/r+.17991;if(1667<=r&&r<=2222){t=-1.1063814*n(e,3)-1.3481102*n(e,2)+2.18555832*e-.20219683}else if(1667<=r&&r<=4e3){t=-.9549476*n(e,3)-1.37418593*n(e,2)+2.09137015*e-.16748867}}else if(1667<=r&&r<=25e3){e=-3025846900/n(r,3)+2107037.9/n(r,2)+222.6347/r+.24039;t=3.081758*n(e,3)-5.8733867*n(e,2)+3.75112997*e-.37001483}else{throw new Error("CIE.getPlanckianChromaticity: Color temperature "+"must be in range [1667, 25000]")}return[e,t,1]},getSpectrumLocus:function(e){e=e||"xyY";var t;var a=n.getCMF();var i=a.lambda,l=a.x,o=a.y,s=a.z;var u=new Float64Array((i.length+1)*3),C=u.subarray(0,i.length+1),c=u.subarray(i.length+1,(i.length+1)*2),g=u.subarray((i.length+1)*2,(i.length+1)*3);for(t=i.length;t--;t){var m=1/(l[t]+o[t]+s[t]);if(m){C[t]=l[t]*m;c[t]=o[t]*m}g[t]=1}C[i.length]=C[0];c[i.length]=c[0];g[i.length]=g[0];if(e!=="xyY"){var f;try{var v=n.currentPrimaries;var h=n.currentIlluminant;n.setPrimaries("CIE 1931");n.setIlluminant("E");f=r.Colorspaces["xyY to "+e];n.setPrimaries(v);n.setIlluminant(h)}catch(y){throw new Error("CIE.getPlanckianLocus: "+y.message)}f(u,i.length+1,1,3)}var I=[];I[0]=C;I[1]=c;I.lambda=i;return I},getIlluminantLocus:function(t,a,i){a=a||"xyY";t=t.toLowerCase();var l,o,s,u=n.getDaylightChromaticity;var C,c;if(t==="planckian"){u=n.getPlanckianChromaticity;C=1e6/1667;c=1e6/25e3}else if(t==="daylight"){u=n.getDaylightChromaticity;C=1e6/4e3;c=1e6/25e3}else{throw new Error("CIE.getIlluminantuminantLocus: Undefined locus.")}if(!i){i=[];for(l=0,s=C;s>c;l++,s-=5){i[l]=1e6/s}i=new Float64Array(i)}var g=new Float64Array(i.length*3);var m=g.subarray(0,i.length),f=g.subarray(i.length,i.length*2),v=g.subarray(i.length*2);for(l=0,o=i.length;l<o;l++){var h=u(i[l]);m[l]=h[0];f[l]=h[1];v[l]=1}if(a!=="xyY"){var y=r.Colorspaces["xyY to "+a];if(!Tools.isSet(y)){throw new Error("CIE.getIlluminantLocus: "+e.message)}var I=y(g,i.length,i.length,1)}var d=[m,f];d.CCT=i;return d},getPlanckianLocus:function(r){return n.getIlluminantLocus("planckian",r)},getDaylightLocus:function(r){return n.getIlluminantLocus("daylight",r)},getDaylightSpectrum:function(r){var e=n.getDaylightChromaticity(r);var t=e[0],a=e[1];var i=1/(.0241+.2562*t-.7341*a);var l=(-1.3515-1.7703*t+5.9114*a)*i;var o=(.03-31.4424*t+30.0717*a)*i;var s=new Float64Array(n.daylightSpectrum.S0);var u,C;var c=n.daylightSpectrum.S1;var g=n.daylightSpectrum.S2;var m=0;for(u=0,C=s.length;u<C;u++){s[u]+=l*c[u]+o*g[u];m+=s[u]}m=1/m;for(u=0,C=s.length;u<C;u++){s[u]*=m}return s},getPlanckianSpectrum:function(r,e){e=Array.prototype.slice.apply(e);var t,a;if(!e){e=new Float32Array(n.colorMatchingFunctions["CIE 1931 XYZ"].lambda)}var i=Math.exp,l=4.995569628905151e-24,o=.014403434782609;var s=function(e){e=e*1e-9;return l/(e*e*e*e*e*(i(o/(r*e))-1))};var u=0;for(t=0,a=e.length;t<a;t++){var C=s(e[t]);e[t]=C;u+=C}u=1/u;for(t=0,a=e.length;t<a;t++){e[t]*=u}return e},"xyY to CCT":function(r){var e=.3366,t=.1735;var n=-949.86315,a=6253.80338,i=28.70599,l=4e-5;var o=.92159,s=.20039,u=.07125;o=1/o;s=1/s;u=1/u;var C=r[0],c=r[1];var g=Math.floor,m=Math.exp;var f=(C-e)/(c-t);var v=g(n+a*m(-f*o)+i*m(-f*s)+l*m(-f*u));if(v<1e3){v=NaN}else if(v>25e3){v=NaN}return v},getIsoCCTLine:function(e,t,a){a=a||"xyY";var i,l,o;i=r.Colorspaces["xyY to 1960 uvY"];l=n["CCT to xyY"];o=function(r){return i(l(r))};var s=1;var u=o(e),C=u[0],c=u[1];var g=o(1e6/(1e6/e+s)),m=g[0],f=g[1];var v=o(1e6/(1e6/e-s)),h=v[0],y=v[1];var I=-(m-h)/(f-y),d=c-I*C;m=C+t/Math.sqrt(1+I*I);f=m*I+d;h=C-t/Math.sqrt(1+I*I);y=h*I+d;var p,w;if(a==="xyY"){var Y=r.Colorspaces["1960 uvY to xyY"];p=Y([m,f,.5]);w=Y([h,y,.5]);return{x:[p[0],w[0]],y:[p[1],w[1]]}}else if(a!=="1960 uvY"){i=r.Colorspaces["1960 uvY to xyY"];l=r.Colorspaces["xyY to "+a];p=l(i([m,f,.5]));w=l(i([h,y,.5]));return{x:[p[0],w[0]],y:[p[1],w[1]]}}else{return{x:[m,h],y:[f,y]}}},getXYZColorMatchingFunction:function(r,e){r=r.toUpperCase();var t,n=Math.exp;if(r==="X"){t=function(r){var e=(r-442)*(r<442?.0624:.0374);var t=(r-599.8)*(r<599.8?.0264:.0323);var a=(r-501.1)*(r<501.1?.049:.0382);return.362*n(-.5*e*e)+1.056*n(-.5*t*t)-.065*n(-.5*a*a)}}else if(r==="Y"){t=function(r){var e=(r-568.8)*(r<568.8?.0213:.0247);var t=(r-530.9)*(r<530.9?.0613:.0322);return.821*n(-.5*e*e)+.286*n(-.5*t*t)}}else if(r==="Z"){t=function(r){var e=(r-437)*(r<437?.0845:.0278);var t=(r-459)*(r<459?.0385:.0725);return 1.217*n(-.5*e*e)+.681*n(-.5*t*t)}}else{throw new Error("CIE.getXYZColorMatchingFunction: Invalid primary.")}var a,i,l=new Float32Array(e.length);for(a=0,i=l.length;a<i;a++){l[a]=t(e[a])}return l}};n["CCT to xyY"]=n.getPlanckianChromaticity;n.setIlluminant();n.setPrimaries();r.CIE=n})(Matrix);