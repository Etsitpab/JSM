/**
 * This program is free software: you can redistribute it and/or modify    
 * it under the terms of the GNU General Public License as published by        
 * the Free Software Foundation, either version 3 of the License, or 
 * (at your option) any later version.
 * 
 * This program is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU General Public License for more details.
 * 
 * You should have received a copy of the GNU General Public License
 * along with this program.  If not, see <http://www.gnu.org/licenses/>.
 * 
 * @author Baptiste Mazin     <baptiste.mazin@telecom-paristech.fr> 
 * @author Guillaume Tartavel <guillaume.tartavel@telecom-paristech.fr> 
 */
(function(r){"use strict";var t={VonKries:[.3897,-.2298,0,.689,1.1834,0,-.0787,.0464,1],Bradford:[.8951,-.7502,.0389,.2664,1.7135,-.0685,-.1614,.0367,1.0296],CAT02:[.7328,-.7036,.003,.4296,1.6975,.0136,-.1624,.0061,.9834]};var e={getIlluminantList:function(){return["A","B","C","D50","D55","D65","D75","E","F1","F2","F3","F4","F5","F6","F7","F8","F9","F10","F11","F12"]},setIlluminant:function(r){if(r===undefined){e.currentIlluminant="D65"}else{try{e.getIlluminant(r)}catch(t){throw new Error("CIE.setIlluminant: "+t.message)}e.currentIlluminant=r}return e},setPrimaries:function(r){if(r===undefined){e.currentPrimaries="sRGB"}else{try{e.getPrimaries(r)}catch(t){throw new Error("CIE.setPrimaries: "+t.message)}e.currentPrimaries=r}return e},getIlluminant:function(t,n){if(t===undefined||t==="current"){return e.getIlluminant(e.currentIlluminant,n)}n=n||"xyY";var a={A:{stdIll:[.44757,.40745,1],CCT:2856},B:{stdIll:[.34842,.35161,1],CCT:4874},C:{stdIll:[.31006,.31616,1],CCT:6774},D50:{stdIll:[.34567,.3585,1],CCT:5003},D55:{stdIll:[.33242,.34743,1],CCT:5503},D65:{stdIll:[.31271,.32902,1],CCT:6504},D75:{stdIll:[.29902,.31485,1],CCT:7504},E:{stdIll:[1/3,1/3,1],CCT:5454},F1:{stdIll:[.3131,.33727,1],CCT:6430},F2:{stdIll:[.37208,.37529,1],CCT:4230},F3:{stdIll:[.4091,.3943,1],CCT:3450},F4:{stdIll:[.44018,.40329,1],CCT:2940},F5:{stdIll:[.31379,.34531,1],CCT:6350},F6:{stdIll:[.3779,.38835,1],CCT:4150},F7:{stdIll:[.31292,.32933,1],CCT:6500},F8:{stdIll:[.34588,.35875,1],CCT:5e3},F9:{stdIll:[.37417,.37281,1],CCT:4150},F10:{stdIll:[.34609,.35986,1],CCT:5e3},F11:{stdIll:[.38052,.37713,1],CCT:4e3},F12:{stdIll:[.43695,.40441,1],CCT:3e3}};var i=a[t];if(!i){throw new Error("CIE.getIlluminant: "+t+" is an invalid illuminant request.")}if(n!=="xyY"){try{i.stdIll=r.Colorspaces["xyY to "+n](i.stdIll)}catch(l){throw new Error("CIE.getIlluminant: "+l.message)}}return i.stdIll},getPrimaries:function(t,n){if(t===undefined||t==="current"){return e.getPrimaries(e.currentPrimaries,n)}n=n||"xyY";var a;if(t==="CIE 1931"){a=[.73467,.26533,1,.27375,.71741,1,.16658,.00885,1]}else if(t==="sRGB"){a=[.64,.33,1,.3,.6,1,.15,.06,1]}else if(t==="Adobe RGB 1998"){a=[.64,.33,1,.21,.71,1,.15,.06,1]}else if(t==="NTSC"){a=[.67,.33,1,.21,.71,1,.14,.08,1]}else{throw new Error("CIE.getPrimaries: "+t+" is an invalid primaries request.")}if(n!=="xyY"){try{var i=e.currentPrimaries;e.setPrimaries(t);a.R=r.Colorspaces["xyY to "+n](a.R);a.G=r.Colorspaces["xyY to "+n](a.G);a.B=r.Colorspaces["xyY to "+n](a.B);e.setPrimaries(i)}catch(l){throw new Error("CIE.getPrimaries: "+l.message)}}return a},getXYZTransform:function(t){var n=e.getIlluminant(),a=e.getPrimaries();return r.Colorspaces.getXYZTransform(t,n,a)},getIlluminantConversionMatrix:function(n,a,i){var l="CIE.getIlluminantConversionMatrix: ";var o=function(r){if(typeof r==="string"){return e.getIlluminant(r)}if(typeof r==="number"){return e["CCT to xyY"](r)}if(!a.length){throw new Error(l+"Illuminant must be a string, "+"a number or an Array.")}return Array.prototype.slice.apply(r)};a=a===undefined?e.getIlluminant():o(a);n=o(n);i=i===undefined?"CAT02":i;i=t[i];if(i===undefined){throw new Error(l+"Available models are "+"'VonKries', 'Bradford' and 'CAT02'")}var s=new Matrix([3,3],i);var u=s.inv();var c=s.mtimes(r.Colorspaces["xyY to XYZ"](a));var C=s.mtimes(r.Colorspaces["xyY to XYZ"](n));var m=Matrix.diag(C["./"](c));var g=e.getXYZTransform(),v=g.inv();return v.mtimes(u.mtimes(m.mtimes(s.mtimes(g))))},getDaylightChromaticity:function(r){var t,e;if(r>=4e3&&r<=7e3){t=.244063+.09911*1e3/r+2.9678*1e6/(r*r)-4.607*1e9/(r*r*r)}else if(r>7e3&&r<=25e3){t=.23704+.24748*1e3/r+1.9018*1e6/(r*r)-2.0064*1e9/(r*r*r)}else{throw new Error("CIE.getDaylightChromaticity: Color temperature "+"must be in range [4000, 25000]")}e=2.87*t-3*t*t-.275;return[t,e,1]},getPlanckianChromaticity:function(r){var t=0,e=0,n=Math.pow;if(1667<=r&&r<=4e3){t=-266123900/n(r,3)-234358/n(r,2)+877.6956/r+.17991;if(1667<=r&&r<=2222){e=-1.1063814*n(t,3)-1.3481102*n(t,2)+2.18555832*t-.20219683}else if(1667<=r&&r<=4e3){e=-.9549476*n(t,3)-1.37418593*n(t,2)+2.09137015*t-.16748867}}else if(1667<=r&&r<=25e3){t=-3025846900/n(r,3)+2107037.9/n(r,2)+222.6347/r+.24039;e=3.081758*n(t,3)-5.8733867*n(t,2)+3.75112997*t-.37001483}else{throw new Error("CIE.getPlanckianChromaticity: Color temperature "+"must be in range [1667, 25000]")}return[t,e,1]},getSpectrumLocus:function(t){t=t||"xyY";var n;var a=e.colorMatchingFunctions["CIE 1931 XYZ"].lambda;var i=e.colorMatchingFunctions["CIE 1931 XYZ"].x;var l=e.colorMatchingFunctions["CIE 1931 XYZ"].y;var o=e.colorMatchingFunctions["CIE 1931 XYZ"].z;var s=new Float64Array(a.length+1);var u=new Float64Array(a.length+1);for(n=a.length;n--;n){var c=1/(i[n]+l[n]+o[n]);if(c){s[n]=i[n]*c;u[n]=l[n]*c}}s[a.length]=s[0];u[a.length]=u[0];if(t!=="xyY"){var C;try{var m=e.currentPrimaries;var g=e.currentIlluminant;e.setPrimaries("CIE 1931");e.setIlluminant("E");C=r.Colorspaces["xyY to "+t];e.setPrimaries(m);e.setIlluminant(g)}catch(v){throw new Error("CIE.getPlanckianLocus: "+v.message)}for(n=s.length;n--;n){var f=C([s[n],u[n],1]);s[n]=f[0];u[n]=f[1]}}var y=[];y[0]=s;y[1]=u;y.lambda=a;return y},getIlluminantLocus:function(t,n,a){n=n||"xyY";t=t.toLowerCase();var i,l,o,s=e.getDaylightChromaticity;var u,c;if(t==="planckian"){s=e.getPlanckianChromaticity;u=1e6/1667;c=1e6/25e3}else if(t==="daylight"){s=e.getDaylightChromaticity;u=1e6/4e3;c=1e6/25e3}else{throw new Error("CIE.getIlluminantuminantLocus: Undefined locus.")}if(!a){a=[];for(i=0,o=u;o>c;i++,o-=5){a[i]=1e6/o}a=new Float64Array(a)}var C=new Float64Array(a.length),m=new Float64Array(a.length);for(i=0,l=a.length;i<l;i++){var g=s(a[i]);C[i]=g[0];m[i]=g[1]}if(n!=="xyY"){var v;try{v=r.Colorspaces["xyY to "+n]}catch(f){throw new Error("CIE.getIlluminantLocus: "+f.message)}for(i=C.length;i--;i){var y=v([C[i],m[i],1]);C[i]=y[0];m[i]=y[1]}}var h=[C,m];h.CCT=a;return h},getPlanckianLocus:function(r){return e.getIlluminantLocus("planckian",r)},getDaylightLocus:function(r){return e.getIlluminantLocus("daylight",r)},getDaylightSpectrum:function(r){var t=e.getDaylightChromaticity(r);var n=t[0],a=t[1];var i=1/(.0241+.2562*n-.7341*a);var l=(-1.3515-1.7703*n+5.9114*a)*i;var o=(.03-31.4424*n+30.0717*a)*i;var s=new Float64Array(e.daylightSpectrum.S0);var u,c;var C=e.daylightSpectrum.S1;var m=e.daylightSpectrum.S2;var g=0;for(u=0,c=s.length;u<c;u++){s[u]+=l*C[u]+o*m[u];g+=s[u]}g=1/g;for(u=0,c=s.length;u<c;u++){s[u]*=g}return s},getPlanckianSpectrum:function(r,t){t=Array.prototype.slice.apply(t);var n,a;if(!t){t=new Float32Array(e.colorMatchingFunctions["CIE 1931 XYZ"].lambda)}var i=Math.exp,l=4.995569628905151e-24,o=.014403434782609;var s=function(t){t=t*1e-9;return l/(t*t*t*t*t*(i(o/(r*t))-1))};var u=0;for(n=0,a=t.length;n<a;n++){var c=s(t[n]);t[n]=c;u+=c}u=1/u;for(n=0,a=t.length;n<a;n++){t[n]*=u}return t},"xyY to CCT":function(r){var t=.3366,e=.1735;var n=-949.86315,a=6253.80338,i=28.70599,l=4e-5;var o=.92159,s=.20039,u=.07125;o=1/o;s=1/s;u=1/u;var c=r[0],C=r[1];var m=Math.floor,g=Math.exp;var v=(c-t)/(C-e);var f=m(n+a*g(-v*o)+i*g(-v*s)+l*g(-v*u));if(f<1e3){f=NaN}else if(f>25e3){f=NaN}return f},getIsoCCTLine:function(t,n,a){a=a||"xyY";var i,l,o;i=r.Colorspaces["xyY to 1960 uvY"];l=e["CCT to xyY"];o=function(r){return i(l(r))};var s=1;var u=o(t),c=u[0],C=u[1];var m=o(1e6/(1e6/t+s)),g=m[0],v=m[1];var f=o(1e6/(1e6/t-s)),y=f[0],h=f[1];var I=-(g-y)/(v-h),d=C-I*c;g=c+n/Math.sqrt(1+I*I);v=g*I+d;y=c-n/Math.sqrt(1+I*I);h=y*I+d;var Y,p;if(a==="xyY"){var w=r.Colorspaces["1960 uvY to xyY"];Y=w([g,v,.5]);p=w([y,h,.5]);return{x:[Y[0],p[0]],y:[Y[1],p[1]]}}else if(a!=="1960 uvY"){i=r.Colorspaces["1960 uvY to xyY"];l=r.Colorspaces["xyY to "+a];Y=l(i([g,v,.5]));p=l(i([y,h,.5]));return{x:[Y[0],p[0]],y:[Y[1],p[1]]}}else{return{x:[g,y],y:[v,h]}}},getXYZColorMatchingFunction:function(r,t){r=r.toUpperCase();var e,n=Math.exp;if(r==="X"){e=function(r){var t=(r-442)*(r<442?.0624:.0374);var e=(r-599.8)*(r<599.8?.0264:.0323);var a=(r-501.1)*(r<501.1?.049:.0382);return.362*n(-.5*t*t)+1.056*n(-.5*e*e)-.065*n(-.5*a*a)}}else if(r==="Y"){e=function(r){var t=(r-568.8)*(r<568.8?.0213:.0247);var e=(r-530.9)*(r<530.9?.0613:.0322);return.821*n(-.5*t*t)+.286*n(-.5*e*e)}}else if(r==="Z"){e=function(r){var t=(r-437)*(r<437?.0845:.0278);var e=(r-459)*(r<459?.0385:.0725);return 1.217*n(-.5*t*t)+.681*n(-.5*e*e)}}else{throw new Error("CIE.getXYZColorMatchingFunction: Invalid primary.")}var a,i,l=new Float32Array(t.length);for(a=0,i=l.length;a<i;a++){l[a]=e(t[a])}return l}};e["CCT to xyY"]=e.getPlanckianChromaticity;e.setIlluminant();e.setPrimaries();r.CIE=e})(Matrix);