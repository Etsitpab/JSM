/**
 * This program is free software: you can redistribute it and/or modify    
 * it under the terms of the GNU General Public License as published by        
 * the Free Software Foundation, either version 3 of the License, or 
 * (at your option) any later version.
 * 
 * This program is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU General Public License for more details.
 * 
 * You should have received a copy of the GNU General Public License
 * along with this program.  If not, see <http://www.gnu.org/licenses/>.
 * 
 * @author Baptiste Mazin     <baptiste.mazin@telecom-paristech.fr> 
 * @author Guillaume Tartavel <guillaume.tartavel@telecom-paristech.fr> 
 */
var Matrix=Matrix||{};Matrix.prototype=Matrix.prototype||{};(function(){"use strict";var a=function(a,t){t=t.getData();var r=a.get([],[],0)["./"](t[0]*Math.sqrt(3));var e=a.get([],[],1)["./"](t[1]*Math.sqrt(3));var i=a.get([],[],2)["./"](t[2]*Math.sqrt(3));return r.cat(2,e,i)};var t=function(a){var t,r,e,i,s;t=a.getSize(0);r=a.getSize(1);e=Matrix.zeros(t,r,3);s=a.get([1,t-1],[]).cat(0,a.get([t-1],[]));e.set([],[],0,s);e.set([],[],1,a);s=a.get(0,[]).cat(0,a.get([0,t-2],[]));e.set([],[],2,s);i=e.max(2);s=i.get([],[1,r-1]).cat(1,a.get([],[r-1]));e.set([],[],0,s);e.set([],[],1,i);s=i.get([],0).cat(1,i.get([],[0,r-2]));e.set([],[],2,s);e=e.max(2);return e.cat(2,e,e)};Matrix.prototype.colorConstancy=function(a,t){if(a===undefined){a="grey_edge"}a=a.toLowerCase();var r,e,i;if(a==="grey_world"){r=0;e=1;i=0}else if(a==="max_rgb"){r=0;e=-1;i=0}else if(a==="shades_of_grey"){r=0;e=5;i=0}else if(a==="grey_edge"){r=1;e=5;i=2}return this.general_cc(r,e,i,t)};Matrix.prototype.general_cc=function(r,e,i,s){if(r===undefined){r=0}if(e===undefined){e=1}if(i===undefined){i=1}var n=this.im2double();s=s||Matrix.zeros(n.getSize(0),n.getSize(1),1);s=s["+"](n.max(2)[">="](1));s=t(s);s=s["==="](0);if(r===0&&i!==0){n=n.gaussian(i)}if(r>0){n=n.gaussianGradient(i).norm}n.abs();var o;var g=n.getSize();var v=n[".*"](s).reshape([g[0]*g[1],g[2]]);if(e!==-1){v=e===1?v:v[".^"](e);o=v.sum(0)[".^"](1/e)}else{o=v.max(0)}var m=o[".*"](o).sum().sqrt();o=o["./"](m);var c=o;c.mask=s;c.im=v.reshape(n.getSize())[".*"](s);c.imcor=a(this.im2double(),o);return c}})();Matrix.prototype.miredHistogram=function(a){"use strict";var t={k:3,delta:.01,sigma:0,bins:200,m:50,M:500,s:.97,eps:0};var r;for(r in a){if(a.hasOwnProperty(r)){t[r]=a[r]}}var e=this.im2single();var i=Matrix.applycform(e,"RGB to XYZ");var s=Matrix.applycform(i,"xyz2xyl");var n=s.im2CCT();var o=Matrix.ldivide(n,1e6);var g=Matrix.applycform(s,"xyY to 1960 uvY").get([],[],[0,1]);var v=Matrix.applycform(n.CCT2im(),"xyY to 1960 uvY").get([],[],[0,1]);var m=g["-"](v)[".^"](2).sum(2)[".^"](.5);var c=i.get([],[],1);var u=c[">"](0)["&&"](c["<"](t.s));var M=c[".^"](t.k);var l=n[">"](2e3)["&&"](n["<"](2e4));var x=m["<"](t.delta);var f=u[".*"](l)[".*"](x);var h=o[".*"](f);var p=M[".*"](f);var d=getHistograms(h.getData(),p.getData(),t.bins,t.m,t.M);d.histw=Matrix.toMatrix(d.histw);d.hist=Matrix.toMatrix(d.hist);var y=Matrix.linspace(t.m,t.M,t.bins);if(t.sigma!==undefined&&t.sigma>1){var C=Matrix.Kernel.gaussian(t.sigma);d.histw=d.histw.conv(C,"same");d.hist=d.hist.conv(C,"same")}var w=d.histw.max();var D=d.histw.amax().getDataScalar();var b=Math.max(D-(t.sigma||2),0);var z=Math.min(D+(t.sigma||2),y.numel()-1);var k=[new Mode(b,z,0,d.histw.getData())];k=k.concat(extractModes(d.histw.getData(),false,0,d.M,d.mu,d.sigma));var B=function(a,t){var r=o[">="](Math.floor(y.value([a])));var e=o["<="](Math.ceil(y.value([t])));var i=r["&&"](e);var n=p.get(i);var g=n.sum().getDataScalar();var v=s.get([],[],0).get(i).getData();var m=s.get([],[],1).get(i).getData();n=n.getData();var c,u,M=0,l=0;for(c=0,u=v.length;c<u;c++){M+=v[c]*n[c];l+=m[c]*n[c]}return[M/g,l/g,1]};var G=function(a){var t=Matrix.Colorspaces["xyY to XYZ"];var r=Matrix.Colorspaces["XYZ to LinearRGB"];var e=r(t(a.slice()));var i=e[0]+e[1]+e[2];e[0]=e[0]*3/i;e[1]=e[1]*3/i;e[2]=e[2]*3/i;return e};for(r=0;r<k.length;r++){k[r].CCT=1e6/(k[r].phase*(t.M-t.m)+t.m);k[r].illxy=B(k[r].bins[0],k[r].bins[1]);k[r].RGB=G(k[r].illxy)}var S=Matrix.times(f,M);return{histogramWeighted:Matrix.toMatrix(d.histw),histogram:Matrix.toMatrix(d.hist),scale:y,modes:k,maskBrightness:M,maskDist:x,mask:f,weights:p,maskCCT:l,im:e,maskEnd:S,mired:o,distances:m,M:d.M,mu:d.mu,sigma:d.sigma}};function angularError(a,t){"use strict";var r=Math.sqrt(a[0]*a[0]+a[1]*a[1]+a[2]*a[2]);var e=Math.sqrt(t[0]*t[0]+t[1]*t[1]+t[2]*t[2]);var i=r*e;var s=a[0]*t[0]+a[1]*t[1]+a[2]*t[2];var n=s/i;n=n>1?1:n;return Math.acos(n)/(2*Math.PI)*360}var correctImage=function(a,t,r){"use strict";r=r||Matrix.CIE.getIlluminant("D65");var e=Matrix.CIE.getIlluminantConversionMatrix(r,t);a=Matrix.applycform(a,"sRGB to LinearRGB").applycform(e).applycform("LinearRGB to sRGB");return a};function bin2color(a,t){"use strict";var r=a[".*"](t[0]),e=a[".*"](t[1]),i=a[".*"](t[2]);return r.cat(2,e,i)}