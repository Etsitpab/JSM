/**
 * This program is free software: you can redistribute it and/or modify    
 * it under the terms of the GNU General Public License as published by        
 * the Free Software Foundation, either version 3 of the License, or 
 * (at your option) any later version.
 * 
 * This program is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU General Public License for more details.
 * 
 * You should have received a copy of the GNU General Public License
 * along with this program.  If not, see <http://www.gnu.org/licenses/>.
 * 
 * @author Baptiste Mazin     <baptiste.mazin@telecom-paristech.fr> 
 * @author Guillaume Tartavel <guillaume.tartavel@telecom-paristech.fr> 
 */
var Matrix=Matrix||{};Matrix.prototype=Matrix.prototype||{};(function(){"use strict";var t=function(t,a){a=a.getData();var r=t.select([],[],0)["./"](a[0]*Math.sqrt(3));var e=t.select([],[],1)["./"](a[1]*Math.sqrt(3));var i=t.select([],[],2)["./"](a[2]*Math.sqrt(3));return r.cat(2,e,i)};var a=function(t){var a,r,e,i,s;a=t.getSize(0);r=t.getSize(1);e=Matrix.zeros(a,r,3);s=t.select([1,a-1],[]).cat(0,t.select([a-1],[]));e=e.set([],[],0,s);e=e.set([],[],1,t);s=t.select(0,[]).cat(0,t.select([0,a-2],[]));e=e.set([],[],2,s);i=e.max([],2)[0];s=i.select([],[1,r-1]).cat(1,t.select([],[r-1]));e=e.set([],[],0,s);e=e.set([],[],1,i);s=i.select([],0).cat(1,i.select([],[0,r-2]));e=e.set([],[],2,s);e=e.max([],2)[0];return e.cat(2,e,e)};Matrix.prototype.colorConstancy=function(t,a){if(t===undefined){t="grey_edge"}t=t.toLowerCase();var r,e,i;if(t==="grey_world"){r=0;e=1;i=0}else if(t==="max_rgb"){r=0;e=-1;i=0}else if(t==="shades_of_grey"){r=0;e=5;i=0}else if(t==="grey_edge"){r=1;e=5;i=2}return this.general_cc(r,e,i,a)};Matrix.prototype.general_cc=function(r,e,i,s){if(r===undefined){r=0}if(e===undefined){e=1}if(i===undefined){i=1}var n=this.im2double();s=s||Matrix.zeros(n.getSize(0),n.getSize(1),1);s=s["+"](n.max([],2)[0][">="](1));s=a(s);s=s["==="](0);if(r===0&&i!==0){n=n.gaussian(i)}if(r>0){n=n.gaussianGradient(i).norm}n.abs();var o;var c=n.getSize();var v=n[".*"](s).reshape([c[0]*c[1],c[2]]);if(e!==-1){v=e===1?v:v[".^"](e);o=v.sum()[".^"](1/e)}else{o=v.max()[0]}var m=o[".*"](o).sum().sqrt();o=o["./"](m);var l=o;l.mask=s;l.im=v.reshape(n.getSize())[".*"](s);l.imcor=t(this.im2double(),o);return l}})();Matrix.prototype.miredHistogram=function(t){"use strict";var a={k:3,delta:.01,sigma:0,bins:200,m:50,M:500,s:.97,eps:0};var r;for(r in t){if(t.hasOwnProperty(r)){a[r]=t[r]}}var e=this.im2single();var i=Matrix.applycform(e,"RGB to XYZ");var s=Matrix.applycform(i,"xyz2xyl");var n=s.im2CCT();var o=Matrix.ldivide(n,1e6);var c=Matrix.applycform(s,"xyY to 1960 uvY").select([],[],[0,1]);var v=Matrix.applycform(n.CCT2im(),"xyY to 1960 uvY").select([],[],[0,1]);var m=c["-"](v)[".^"](2).sum(2)[".^"](.5);var l=i.select([],[],[1]);var g=l[">"](0)["&&"](l["<"](a.s));var u=l[".^"](a.k);var M=n[">"](2e3)["&&"](n["<"](2e4));var f=m["<"](a.delta);var x=g[".*"](M)[".*"](f);var h=o[".*"](x);var p=u[".*"](x);var d=getHistograms(h.getData(),p.getData(),a.bins,a.m,a.M);d.histw=Matrix.toMatrix(d.histw);d.hist=Matrix.toMatrix(d.hist);var y=Matrix.linspace(a.m,a.M,a.bins);if(a.sigma!==undefined&&a.sigma>1){var C=Matrix.Kernel.gaussian(a.sigma);d.histw=d.histw.conv(C,"same");d.hist=d.hist.conv(C,"same")}var w=d.histw.max();var D=w[1].getData()[0];var b=Math.max(D-(a.sigma||2),0);var z=Math.min(D+(a.sigma||2),y.numel()-1);var k=[new Mode(b,z,0,d.histw.getData())];k=k.concat(extractModes(d.histw.getData(),false,0,d.M,d.mu,d.sigma));var B=function(t,a){var r=o[">="](Math.floor(y.value([t])));var e=o["<="](Math.ceil(y.value([a])));var i=r["&&"](e);var n=p.select(i);var c=n.sum2();var v=s.select([],[],0).select(i).getData();var m=s.select([],[],1).select(i).getData();n=n.getData();var l,g,u=0,M=0;for(l=0,g=v.length;l<g;l++){u+=v[l]*n[l];M+=m[l]*n[l]}return[u/c,M/c,1]};var G=function(t){var a=Colorspaces.getConversionFunction("xyY to XYZ");var r=Colorspaces.getConversionFunction("XYZ to LinearRGB");var e=r(a(t));var i=e[0]+e[1]+e[2];e[0]=e[0]*3/i;e[1]=e[1]*3/i;e[2]=e[2]*3/i;return e};for(r=0;r<k.length;r++){k[r].CCT=1e6/(k[r].phase*(a.M-a.m)+a.m);k[r].illxy=B(k[r].bins[0],k[r].bins[1]);k[r].RGB=G(k[r].illxy)}var Y=Matrix.times(x,u);return{histogramWeighted:Matrix.toMatrix(d.histw),histogram:Matrix.toMatrix(d.hist),scale:y,modes:k,maskBrightness:u,maskDist:f,mask:x,weights:p,maskCCT:M,im:e,maskEnd:Y,mired:o,distances:m,M:d.M,mu:d.mu,sigma:d.sigma}};function angularError(t,a){"use strict";var r=Math.sqrt(t[0]*t[0]+t[1]*t[1]+t[2]*t[2]);var e=Math.sqrt(a[0]*a[0]+a[1]*a[1]+a[2]*a[2]);var i=r*e;var s=t[0]*a[0]+t[1]*a[1]+t[2]*a[2];var n=s/i;n=n>1?1:n;return Math.acos(n)/(2*Math.PI)*360}var correctImage=function(t,a,r){"use strict";r=r||CIE.getIlluminant("D65");var e=CIE.getIlluminantConversionMatrix(r,a);t=Matrix.applycform(t,"sRGB to LinearRGB").applycform(e).applycform("LinearRGB to sRGB");return t};function bin2color(t,a){"use strict";var r=t[".*"](a[0]),e=t[".*"](a[1]),i=t[".*"](a[2]);return r.cat(2,e,i)}